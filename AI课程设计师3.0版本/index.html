<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI课程设计师 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-slow': 'bounce 2s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-bubble {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* 隐藏滚动条 - 保持美观性 */
        .custom-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        .custom-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* 可选：悬停时显示细滚动条的版本 */
        .custom-scrollbar-hover {
            scrollbar-width: thin; /* Firefox */
        }
        .custom-scrollbar-hover::-webkit-scrollbar {
            width: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .custom-scrollbar-hover::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar-hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .custom-scrollbar-hover:hover::-webkit-scrollbar {
            opacity: 1;
        }
        .custom-scrollbar-hover:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* 暗色模式 */
        .dark .custom-scrollbar-hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .custom-scrollbar-hover:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 大纲卡片切换动画 */
        #currentOutlineCard {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            #outlineModal .flex {
                flex-direction: column;
            }
            #outlineModal .w-96 {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-top: 1px solid rgb(229 231 235);
                max-height: 50vh;
            }
            .dark #outlineModal .w-96 {
                border-top-color: rgb(55 65 81);
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- 顶部导航栏 -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">AI课程设计师</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon dark:hidden text-base"></i>
                        <i class="fas fa-sun hidden dark:inline text-base"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

        <!-- 主要内容区域 -->
    <div class="h-screen flex flex-col">
        <!-- 聊天对话区域 -->
        <div id="chatContainer" class="flex-1 bg-gray-50 dark:bg-gray-900 overflow-hidden">
            <!-- 聊天消息区域 -->
            <div id="messagesContainer" class="h-full overflow-y-auto px-6 py-8 space-y-8 max-w-4xl mx-auto custom-scrollbar">
                <!-- AI欢迎消息 -->
                <div class="flex items-start space-x-4 chat-bubble">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm">
                        <p class="text-gray-800 dark:text-gray-200 leading-relaxed text-base">
                            Hi~, 我是您的AI课程设计师。能为您效劳我感到非常荣幸！
                        </p>
                        <p class="text-gray-800 dark:text-gray-200 leading-relaxed mt-4 text-base">
                            为了开始创作，请先用一句话告诉我，您今天想创建一个关于什么主题的课程呢？
                        </p>
                    </div>
                </div>

                <!-- 课程需求输入区域 -->
                <div class="flex items-start space-x-4 chat-bubble">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 max-w-5xl shadow-sm">
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                                描述您的课程需求
                            </h3>
                            <p class="text-gray-600 dark:text-gray-400 text-base">
                                请详细描述您想要创建的课程，包括主题、目标受众、预期效果等
                            </p>
                        </div>
                        
                        <div class="relative mb-8">
                            <textarea 
                                id="courseRequirementInput" 
                                placeholder="例如：我想为新入职的销售人员创建一门CRM系统培训课程，帮助他们快速掌握客户管理和销售流程，课程时长大约2-3小时，包含实操演示..."
                                class="w-full p-5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-200 text-base"
                                rows="4"
                                style="min-height: 120px;"
                            ></textarea>
                            <div class="absolute bottom-4 right-4">
                                <button id="submitRequirement" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-magic text-base"></i>
                                    <span class="text-base">开始创建</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-8 flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-2"></i>
                                描述越详细，AI生成的课程越符合您的需求
                            </span>
                            <span id="charCount" class="text-sm text-gray-400">0/1000</span>
                        </div>
                        
                        <!-- 分隔线 -->
                        <div class="flex items-center my-8">
                            <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                            <span class="px-6 text-base text-gray-500 dark:text-gray-400">或者从以下热门主题中选择一个快速开始</span>
                            <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                </div>

                <!-- 主题建议 -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="新员工销售技能培训">
                                    <i class="fas fa-handshake text-blue-500 mr-3"></i>新员工销售技能培训
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="数字化营销策略与实践">
                                    <i class="fas fa-chart-line text-green-500 mr-3"></i>数字化营销策略与实践
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="项目管理实战训练">
                                    <i class="fas fa-tasks text-purple-500 mr-3"></i>项目管理实战训练
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="客户服务与沟通技巧">
                                    <i class="fas fa-comments text-orange-500 mr-3"></i>客户服务与沟通技巧
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="领导力发展与团队管理">
                                    <i class="fas fa-users text-indigo-500 mr-3"></i>领导力发展与团队管理
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="数据分析与商业洞察">
                                    <i class="fas fa-chart-bar text-red-500 mr-3"></i>数据分析与商业洞察
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="产品培训与知识更新">
                                    <i class="fas fa-box text-teal-500 mr-3"></i>产品培训与知识更新
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="安全生产与风险管理">
                                    <i class="fas fa-shield-alt text-yellow-500 mr-3"></i>安全生产与风险管理
                                </button>
                            </div>
                        
                        <div class="text-center">
                                <button id="moreTopics" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-base font-medium transition-colors py-2 px-4">
                                    <i class="fas fa-plus mr-2"></i>更多主题
                                </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div id="inputArea" class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-end space-x-4">
                        <div class="flex-1 relative">
                            <textarea 
                                id="messageInput" 
                                placeholder="输入您的课程主题..."
                                class="w-full p-4 pr-14 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none text-base"
                                rows="1"
                                style="min-height: 48px; max-height: 120px;"
                            ></textarea>
                            <button id="sendButton" class="absolute right-3 bottom-3 w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-md flex items-center justify-center transition-colors">
                                <i class="fas fa-paper-plane text-base"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 隐藏的文件输入 -->
        <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.ppt,.pptx">

        <!-- 详细大纲编辑区域（初始隐藏） -->
        <div id="detailOutlineArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">详细课程大纲</h3>
            <p class="text-base text-gray-600 dark:text-gray-400 mb-8">您可以拖拽调整顺序或修改标题</p>
            
            <div id="outlineEditor" class="space-y-4">
                <!-- 大纲项目将动态生成 -->
            </div>
            
            <div class="flex justify-center mt-8">
                <button id="confirmOutline" class="px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors text-base">
                    确认大纲
                </button>
            </div>
        </div>

        <!-- 生成进度区域（初始隐藏） -->
        <div id="progressArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce-slow">
                    <i class="fas fa-magic text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">魔法正在进行中...</h3>
                <p class="text-base text-gray-600 dark:text-gray-400 mb-8">正在为您生成完整的课程内容，预计需要1-2分钟</p>
                
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-6">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div id="progressText" class="text-base text-gray-600 dark:text-gray-400">
                    ✨ 正在分析课程结构...
                </div>
            </div>
        </div>

        <!-- 课程预览区域（初始隐藏） -->
        <div id="previewArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-check text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">🎉 课程创建完成！</h3>
                <p class="text-base text-gray-600 dark:text-gray-400">您的《新销售CRM系统入门培训》课程已生成完毕</p>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-8 mb-8">
                <div class="flex items-center space-x-6">
                    <div class="w-20 h-20 bg-white dark:bg-gray-800 rounded-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-blue-500 text-3xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">新销售CRM系统入门培训</h4>
                        <p class="text-base text-gray-600 dark:text-gray-400 mb-3">4个章节 • 预计学习时间2小时 • 包含练习题</p>
                        <div class="flex items-center space-x-4 mt-3">
                            <span class="text-sm px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full">理论讲解</span>
                            <span class="text-sm px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full">实操演示</span>
                            <span class="text-sm px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-full">随堂练习</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center space-x-6">
                <button id="previewCourse" class="px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-eye mr-2"></i>预览课程
                </button>
                <button id="editCourse" class="px-8 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-edit mr-2"></i>编辑内容
                </button>
                <button id="publishCourse" class="px-8 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-rocket mr-2"></i>发布课程
                </button>
            </div>
        </div>
    </div>

    <!-- AI助手悬浮球（初始隐藏） -->
    <div id="aiAssistant" class="hidden fixed bottom-8 right-8 w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full shadow-lg cursor-pointer hover:scale-110 transition-transform z-50">
        <div class="w-full h-full flex items-center justify-center">
            <i class="fas fa-robot text-white text-xl"></i>
        </div>
    </div>

    <!-- 大纲预览微调模态窗口 -->
    <div id="outlineModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- 模态窗口头部 -->
            <div class="flex items-center justify-between p-8 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-4">
                    <div id="modalIcon" class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-white text-base"></i>
                    </div>
                    <div>
                        <h3 id="modalTitle" class="text-xl font-semibold text-gray-900 dark:text-white">方案A：标准流程型大纲</h3>
                        <p id="modalSubtitle" class="text-base text-gray-500 dark:text-gray-400">预览与微调</p>
                    </div>
                </div>
                <button id="closeModal" class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-times text-gray-500 dark:text-gray-400 text-base"></i>
                </button>
            </div>

            <!-- 模态窗口内容 -->
            <div class="flex flex-1 overflow-hidden">
                <!-- 左侧：大纲编辑区域 -->
                <div class="flex-1 min-w-0 p-8 overflow-y-auto border-r border-gray-200 dark:border-gray-700 custom-scrollbar">
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">课程大纲</h4>
                    <div id="modalOutlineContent" class="space-y-6 pb-8">
                        <!-- 大纲内容将动态加载 -->
                    </div>
                </div>
                
                <!-- 右侧：高级设置区域 -->
                <div class="w-96 min-w-96 p-8 overflow-y-auto bg-gray-50 dark:bg-gray-750 custom-scrollbar">
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 sticky top-0 bg-gray-50 dark:bg-gray-750 pb-2 z-10">高级设置</h4>
                    
                    <!-- 课程基本信息 -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">课程时长</label>
                            <select id="courseDuration" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="1-2">1-2小时</option>
                                <option value="2-4" selected>2-4小时</option>
                                <option value="4-8">4-8小时</option>
                                <option value="1-day">1天</option>
                                <option value="2-days">2天</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">难度级别</label>
                            <select id="courseDifficulty" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="beginner" selected>入门级</option>
                                <option value="intermediate">中级</option>
                                <option value="advanced">高级</option>
                                <option value="expert">专家级</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">教学方式</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="theory" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">理论讲解</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="practice" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">实操演示</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="exercise" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">随堂练习</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="case" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">案例分析</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="groupwork" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">小组讨论</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">目标人数</label>
                            <select id="targetAudience" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="5-10">5-10人</option>
                                <option value="10-20" selected>10-20人</option>
                                <option value="20-50">20-50人</option>
                                <option value="50+">50人以上</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">课程语言</label>
                            <select id="courseLanguage" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="zh" selected>中文</option>
                                <option value="en">英文</option>
                                <option value="zh-en">中英双语</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">评估方式</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="quiz" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">课堂测验</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="assignment" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">课后作业</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="project" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">项目实践</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="feedback" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">反馈调研</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">其他需求</label>
                            <textarea id="otherRequirements" placeholder="请输入其他特殊需求..." class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none" rows="3"></textarea>
                        </div>
                        
                        <!-- 预设模板 -->
                        <div class="border-t border-gray-200 dark:border-gray-600 pt-6 mt-8 pb-8">
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-4">快速模板</label>
                            <div class="space-y-3">
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="basic">
                                    📚 基础培训模板
                                </button>
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="intensive">
                                    🚀 强化训练模板
                                </button>
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="workshop">
                                    🛠️ 工作坊模板
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模态窗口底部 -->
            <div class="flex items-center justify-between p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 shadow-lg">
                <div class="text-base text-gray-600 dark:text-gray-400 flex-1 mr-6">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span class="hidden sm:inline">您可以编辑章节标题和小节内容，也可以拖拽调整顺序</span>
                    <span class="sm:hidden">可编辑和拖拽排序</span>
                </div>
                <div class="flex space-x-4 flex-shrink-0">
                    <button id="resetOutline" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors text-base border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                    <button id="confirmModalOutline" class="px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors text-base shadow-sm">
                        <i class="fas fa-check mr-2"></i>确认选择
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑大纲模态窗口 -->
    <div id="editOutlineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-edit text-blue-500 mr-2"></i>编辑课程大纲
                </h3>
                <button id="closeEditModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                <!-- 课程基本信息编辑 -->
                <div class="mb-6">
                    <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>课程基本信息
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">课程标题</label>
                            <input type="text" id="editCourseTitle" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="请输入课程标题">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">课程描述</label>
                            <textarea id="editCourseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="请输入课程描述"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">预计时长</label>
                            <input type="text" id="editCourseDuration" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="如：2小时">
                        </div>
                    </div>
                </div>

                <!-- 章节编辑 -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-base font-semibold text-gray-900 dark:text-white">
                            <i class="fas fa-list-ul text-blue-500 mr-2"></i>课程章节
                        </h4>
                        <button id="addChapterInModal" class="px-3 py-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                            <i class="fas fa-plus mr-1"></i>添加章节
                        </button>
                    </div>
                    
                    <div id="editableChaptersContainer" class="space-y-4">
                        <!-- 章节内容将在这里动态生成 -->
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="cancelEditOutline" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    取消
                </button>
                <button id="saveEditOutline" class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded font-medium transition-colors">
                    保存修改
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局状态管理
        const AppState = {
            currentStep: 1,
            courseTitle: '',
            uploadedFiles: [],
            selectedOutline: null,
            courseContent: null,
            detailedRequirements: null,
            currentQuestionStep: 1,
            isCollectingRequirements: false,
            currentOutlineOptions: null,
            currentOutlineType: 'A'
        };

        // DOM元素引用
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            messagesContainer: document.getElementById('messagesContainer'),
            fileInput: document.getElementById('fileInput'),
            detailOutlineArea: document.getElementById('detailOutlineArea'),
            outlineEditor: document.getElementById('outlineEditor'),
            confirmOutline: document.getElementById('confirmOutline'),
            progressArea: document.getElementById('progressArea'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            previewArea: document.getElementById('previewArea'),
            aiAssistant: document.getElementById('aiAssistant'),
            courseRequirementInput: document.getElementById('courseRequirementInput'),
            submitRequirement: document.getElementById('submitRequirement'),
            charCount: document.getElementById('charCount')
        };

        // 主题切换功能
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', theme === 'dark');
            
            elements.themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        // 添加消息到聊天区域
        function addMessage(content, isUser = false, isHtml = false, isSpecial = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-4 chat-bubble ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            
            const avatarClass = isUser 
                ? 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0'
                : 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0';
            
            const avatarIcon = isUser ? 'fas fa-user' : 'fas fa-robot';
            
            let bubbleClass, contentClass;
            if (isSpecial) {
                bubbleClass = 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-0 max-w-6xl shadow-sm';
                contentClass = '';
            } else {
                bubbleClass = isUser 
                    ? 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm'
                    : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm';
                contentClass = 'text-gray-800 dark:text-gray-200 leading-relaxed text-base';
            }
            
            messageDiv.innerHTML = `
                <div class="${avatarClass}">
                    <i class="${avatarIcon} text-white text-sm"></i>
                </div>
                <div class="${bubbleClass}">
                    <div class="${contentClass}">
                        ${isHtml ? content : content}
                    </div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            
            return messageDiv;
        }

        // 开始逐步收集需求
        function startStepByStepRequirements() {
            AppState.isCollectingRequirements = true;
            AppState.currentStep = 1.5;
            askNextQuestion();
        }

        // 提问下一个问题
        function askNextQuestion() {
            const questions = [
                {
                    id: 'coreGoal',
                    question: '🎯 首先，让我们定义课程的核心目标：学完这门课，学员应该能独立做什么具体的事？',
                    description: '这是整个课程的"北极星"，请尽可能具体地描述一个可衡量的学习成果',
                    allowCustom: true,
                    customPlaceholder: '例如：独立完成一份月度销售数据分析报告 / 成功处理一次客户投诉 / 使用Photoshop设计一张标准海报',
                    options: [
                        { text: '独立完成标准化的工作流程', value: 'workflow' },
                        { text: '熟练使用特定工具或系统', value: 'tool-usage' },
                        { text: '解决某类专业问题', value: 'problem-solving' },
                        { text: '掌握特定技能或方法', value: 'skill-mastery' }
                    ]
                },
                {
                    id: 'learnerPersona',
                    question: '🧑‍🤝‍🧑 您的学员是谁？请描述他们的职位、经验水平和现有知识背景',
                    description: '这将决定内容的深度、案例的贴切度和语言风格',
                    options: [
                        { text: '刚入职的新员工，零基础或基础薄弱', value: 'new-employee' },
                        { text: '工作1-3年的初级员工，有基本了解', value: 'junior-employee' },
                        { text: '工作3-5年的中级员工，懂理论缺实战', value: 'mid-employee' },
                        { text: '工作5年以上的资深员工，需要更新知识', value: 'senior-employee' },
                        { text: '管理层人员，需要全局性理解', value: 'management' },
                        { text: '技术专家，需要深度专业知识', value: 'expert' }
                    ]
                },
                {
                    id: 'contentSource',
                    question: '📚 课程的核心知识主要来自哪里？',
                    description: '这将帮助AI决定是整理现有资料还是全新创作内容',
                    options: [
                        { text: '我有现成的文档/PPT/视频资料', value: 'existing-materials' },
                        { text: '我希望AI帮我从零开始创作核心内容', value: 'ai-creation' },
                        { text: '混合方式：部分现有资料 + 部分AI创作', value: 'hybrid-content' }
                    ]
                },
                {
                    id: 'teachingActivities',
                    question: '👨‍🏫 您偏好哪种教学活动的组合？（可多选）',
                    description: 'AI将根据这个组合，在大纲中穿插不同类型的内容模块',
                    isMultiple: true,
                    options: [
                        { text: '视频讲解（录制讲解或演示视频）', value: 'video-lecture' },
                        { text: '文章阅读（结构化的文字内容）', value: 'article-reading' },
                        { text: '案例分析（真实业务场景讨论）', value: 'case-analysis' },
                        { text: '小组讨论（团队协作和思维碰撞）', value: 'group-discussion' },
                        { text: '实操练习（动手操作和技能训练）', value: 'hands-on-practice' },
                        { text: '嘉宾分享（行业专家经验分享）', value: 'guest-sharing' },
                        { text: '角色扮演（模拟真实工作场景）', value: 'role-playing' }
                    ]
                },
                {
                    id: 'assessmentMethod',
                    question: '✍️ 您希望如何检验学习效果？',
                    description: '这是设计课程"闭环"的关键，让大纲不仅有输入还有输出',
                    options: [
                        { text: '每个重要知识点后都需要小练习', value: 'frequent-tests' },
                        { text: '只需要期末有一次综合性考试', value: 'final-exam' },
                        { text: '通过实际项目来检验学习成果', value: 'project-assessment' },
                        { text: '这是非考核的自学课程', value: 'no-assessment' }
                    ]
                },
                {
                    id: 'certification',
                    question: '📜 学员完成学习后，是否需要获得某种学习凭证？',
                    description: '这将影响课程结构和最终的认证流程设计',
                    options: [
                        { text: '需要正式的结业证书', value: 'formal-certificate' },
                        { text: '只需要学习记录和完成证明', value: 'completion-record' },
                        { text: '无需任何凭证，重在学习过程', value: 'no-certification' }
                    ]
                },
                {
                    id: 'managementLevel',
                    question: '🔒 最后，课程的学习过程需要被严格管理吗？',
                    description: '这将决定课程结构是"线性闯关式"还是"开放自由式"',
                    options: [
                        { text: '需要严格管理，这是正式的必修课程', value: 'strict-management' },
                        { text: '适度管理，有一定约束但允许灵活学习', value: 'moderate-management' },
                        { text: '不需要管理，鼓励学员自由探索', value: 'flexible-learning' }
                    ]
                }
            ];

            if (AppState.currentQuestionStep <= questions.length) {
                const currentQuestion = questions[AppState.currentQuestionStep - 1];
                showQuestionCard(currentQuestion);
            } else {
                // 所有问题完成，显示总结
                finishRequirementsCollection();
            }
        }

        // 显示问题卡片
        function showQuestionCard(questionData) {
            const questionCard = `
                <div class="p-6">
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
                        <div class="flex items-start space-x-4 mb-6">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-semibold text-base">${AppState.currentQuestionStep}</span>
                    </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
                                    ${questionData.question}
                                </h3>
                                ${questionData.description ? `
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">
                                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>${questionData.description}
                                    </p>
                                ` : ''}
                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span>第 ${AppState.currentQuestionStep} 题，共 7 题</span>
                                    <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${(AppState.currentQuestionStep / 7) * 100}%"></div>
                            </div>
                            </div>
                        </div>
                    </div>
                        
                        <div class="space-y-3 mb-6" id="questionOptions">
                            ${generateQuestionOptions(questionData)}
                        </div>
                        
                        ${questionData.allowCustom ? `
                            <div class="mb-6">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-edit mr-2 text-blue-500"></i>或者，请具体描述：
                                    </h4>
                                    <textarea id="customInput" placeholder="${questionData.customPlaceholder}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" rows="3"></textarea>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center">
                            <button id="skipQuestion" class="px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm">
                                <i class="fas fa-forward mr-2"></i>跳过这题
                            </button>
                            <button id="nextQuestion" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-arrow-right mr-2"></i>${AppState.currentQuestionStep === 7 ? '完成收集' : '下一题'}
                        </button>
                        </div>
                    </div>
                </div>
            `;
            
            const cardElement = addMessage(questionCard, false, true, true);
            initQuestionCard(cardElement, questionData);
        }

        // 生成问题选项
        function generateQuestionOptions(questionData) {
            return questionData.options.map((option, index) => {
                const inputType = questionData.isMultiple ? 'checkbox' : 'radio';
                const inputName = questionData.isMultiple ? `${questionData.id}[]` : questionData.id;
                
                return `
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors option-item">
                        <input type="${inputType}" name="${inputName}" value="${option.value}" class="mr-3 ${questionData.isMultiple ? 'rounded' : ''} border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-gray-900 dark:text-white text-sm">${option.text}</span>
                    </label>
                `;
            }).join('');
        }

        // 初始化问题卡片事件
        function initQuestionCard(cardElement, questionData) {
            const nextBtn = cardElement.querySelector('#nextQuestion');
            const skipBtn = cardElement.querySelector('#skipQuestion');
            const customInput = cardElement.querySelector('#customInput');
            const options = cardElement.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            
            // 初始状态下一题按钮禁用
            if (!questionData.isMultiple) {
                nextBtn.disabled = true;
            }
            
            // 监听选项变化
            options.forEach(option => {
                option.addEventListener('change', () => {
                    if (questionData.isMultiple) {
                        // 多选题，只要有选择就启用按钮
                        const checkedOptions = cardElement.querySelectorAll('input:checked');
                        nextBtn.disabled = checkedOptions.length === 0 && (!customInput || !customInput.value.trim());
                    } else {
                        // 单选题，选择后启用按钮
                        nextBtn.disabled = false;
                    }
                });
            });
            
            // 监听自定义输入
            if (customInput) {
                customInput.addEventListener('input', () => {
                    if (questionData.isMultiple) {
                        const checkedOptions = cardElement.querySelectorAll('input:checked');
                        nextBtn.disabled = checkedOptions.length === 0 && !customInput.value.trim();
                    } else {
                        nextBtn.disabled = !customInput.value.trim();
                        // 清除其他选项
                        if (customInput.value.trim()) {
                            options.forEach(opt => opt.checked = false);
                        }
                    }
                });
            }
            
            // 下一题按钮事件
            nextBtn.addEventListener('click', () => {
                handleQuestionAnswer(cardElement, questionData);
            });
            
            // 跳过按钮事件
            skipBtn.addEventListener('click', () => {
                AppState.currentQuestionStep++;
                askNextQuestion();
            });
        }

        // 在问题中显示文件上传区域
        function showFileUploadInQuestion() {
            const uploadCard = `
                <div class="p-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-6 shadow-sm">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-upload text-white text-2xl"></i>
                    </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                                为了让课程内容精准、有料，您可以上传相关资料：
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                支持文档、PPT、PDF等格式，AI将智能分析并整合到课程设计中
                            </p>
                                 </div>
                        
                        <div class="border-2 border-dashed border-blue-300 dark:border-blue-600 rounded-xl p-8 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors" id="questionUploadArea">
                            <div class="mb-4">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                                <p class="text-gray-700 dark:text-gray-300 font-medium">点击选择文件或拖拽到这里</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">支持 PDF, DOC, DOCX, PPT, PPTX</p>
                                 </div>
                            <input type="file" id="questionFileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt">
                             </div>
                        
                        <div id="questionUploadedFiles" class="mt-4 space-y-2 hidden">
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">已上传文件：</p>
                                     </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button id="skipQuestionUpload" class="px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm">
                                <i class="fas fa-forward mr-2"></i>跳过上传
                            </button>
                            <button id="continueAfterUpload" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i>继续问答
                            </button>
                                         </div>
                                         </div>
                                     </div>
            `;
            
            const cardElement = addMessage(uploadCard, false, true, true);
            initQuestionFileUpload(cardElement);
        }

        // 初始化问题中的文件上传功能
        function initQuestionFileUpload(cardElement) {
            const uploadArea = cardElement.querySelector('#questionUploadArea');
            const fileInput = cardElement.querySelector('#questionFileInput');
            const uploadedFilesDiv = cardElement.querySelector('#questionUploadedFiles');
            const skipBtn = cardElement.querySelector('#skipQuestionUpload');
            const continueBtn = cardElement.querySelector('#continueAfterUpload');
            
            // 点击上传区域
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 文件选择处理
            fileInput.addEventListener('change', (e) => {
                handleQuestionFileSelect(e.target.files, uploadedFilesDiv);
            });
            
            // 拖拽上传处理
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                handleQuestionFileSelect(e.dataTransfer.files, uploadedFilesDiv);
            });
            
            // 跳过上传
            skipBtn.addEventListener('click', () => {
                AppState.currentQuestionStep++;
                setTimeout(() => {
                    askNextQuestion();
                }, 500);
            });
            
            // 继续问答
            continueBtn.addEventListener('click', () => {
                // 禁用上传卡片
                cardElement.style.opacity = '0.6';
                cardElement.style.pointerEvents = 'none';
                
                if (AppState.uploadedFiles.length > 0) {
                    addMessage(`已上传 ${AppState.uploadedFiles.length} 个文件，将在生成课程时参考这些资料。`, true);
                }
                
                AppState.currentQuestionStep++;
                setTimeout(() => {
                    askNextQuestion();
                }, 800);
            });
        }

        // 处理问题中的文件选择
        function handleQuestionFileSelect(files, uploadedFilesDiv) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB限制
                    alert(`文件 ${file.name} 超过10MB大小限制`);
                    return;
                }
                
                // 添加到已上传文件列表
                AppState.uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                });
                
                // 显示上传的文件
                displayQuestionUploadedFile(file, uploadedFilesDiv);
            });
            
            // 显示已上传文件区域
            if (AppState.uploadedFiles.length > 0) {
                uploadedFilesDiv.classList.remove('hidden');
            }
        }

        // 显示问题中上传的文件
        function displayQuestionUploadedFile(file, container) {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600';
            fileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center">
                        <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 text-sm"></i>
                                 </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${file.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
                                     <div class="flex items-center space-x-2">
                    <span class="text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-2 py-1 rounded">已上传</span>
                    <button class="remove-file-btn text-gray-400 hover:text-red-500 transition-colors" title="移除文件">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                                     </div>
            `;
            
            // 移除文件按钮
            const removeBtn = fileItem.querySelector('.remove-file-btn');
            removeBtn.addEventListener('click', () => {
                const index = AppState.uploadedFiles.findIndex(f => f.name === file.name);
                if (index > -1) {
                    AppState.uploadedFiles.splice(index, 1);
                }
                fileItem.remove();
                
                // 如果没有文件了，隐藏文件列表
                if (AppState.uploadedFiles.length === 0) {
                    container.classList.add('hidden');
                }
            });
            
            container.appendChild(fileItem);
        }

        // 处理问题答案
        function handleQuestionAnswer(cardElement, questionData) {
            const customInput = cardElement.querySelector('#customInput');
            let answer;
            
            if (questionData.isMultiple) {
                // 多选题
                const checkedOptions = cardElement.querySelectorAll('input:checked');
                answer = {};
                checkedOptions.forEach(option => {
                    answer[option.value] = true;
                });
            } else {
                // 单选题
                const selectedOption = cardElement.querySelector('input:checked');
                answer = selectedOption ? selectedOption.value : (customInput ? customInput.value.trim() : '');
            }
            
            // 保存答案
            AppState.detailedRequirements[questionData.id] = answer;
            
            // 显示用户的回答
            let answerText = '';
            if (questionData.isMultiple) {
                const selectedTexts = [];
                Object.keys(answer).forEach(key => {
                    const option = questionData.options.find(opt => opt.value === key);
                    if (option) selectedTexts.push(option.text.split('（')[0]);
                });
                answerText = selectedTexts.join('、');
            } else {
                const option = questionData.options.find(opt => opt.value === answer);
                answerText = option ? option.text.split('（')[0] : answer;
            }
            
            addMessage(answerText, true);
            
            // 特殊处理：如果是内容来源问题且选择了需要上传文件的选项
            if (questionData.id === 'contentSource' && 
                (answer === 'existing-materials' || answer === 'hybrid-content')) {
                
                // 禁用当前卡片
                const form = cardElement.querySelector('.bg-white');
                if (form) {
                    form.style.opacity = '0.6';
                    form.style.pointerEvents = 'none';
                }
                
                // 显示文件上传区域
                setTimeout(() => {
                    showFileUploadInQuestion();
                }, 800);
                return;
            }
            
            // 禁用当前卡片
            const form = cardElement.querySelector('.bg-white');
            if (form) {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';
            }
            
            // 继续下一个问题
            AppState.currentQuestionStep++;
            setTimeout(() => {
                askNextQuestion();
            }, 800);
        }

        // 完成需求收集
        function finishRequirementsCollection() {
            AppState.isCollectingRequirements = false;
            
            addMessage('🎉 完美！我已经完成了对您课程需求的深度调研。通过这7个核心问题，我对您的课程设计目标有了清晰、全面的理解。');
            
            setTimeout(() => {
                // 检查是否已经上传了文件
                if (AppState.uploadedFiles && AppState.uploadedFiles.length > 0) {
                    addMessage(`太好了！您已经上传了 ${AppState.uploadedFiles.length} 个参考资料，我将结合这些内容来设计课程。`);
                } else {
                    addMessage('基于您提供的详细需求信息，我将为您智能生成专业的课程内容。');
                }
                
                setTimeout(() => {
                    // 显示需求分析汇报（无论是否有文件）
                    showRequirementAnalysisReport();
                }, 800);
            }, 800);
        }

        // 根据需求生成课程大纲
        function generateCourseOutlineFromRequirements() {
            const requirements = AppState.detailedRequirements;
            
            // 显示生成进度
            addMessage('⚡ 正在分析您的需求，智能生成课程结构...');
            
            setTimeout(() => {
                // 根据需求生成智能大纲
                const outlineOptions = generateSmartOutlineOptions(requirements);
                
                // 显示动态生成的大纲选择卡片
                addOutlineSelectionCard(outlineOptions);
                
                AppState.currentStep = 3;
            }, 2000);
        }

        // 智能生成课程大纲
        function createSmartOutline(requirements) {
            const coreGoal = requirements.coreGoal || '';
            const learnerPersona = requirements.learnerPersona || '';
            const contentSource = requirements.contentSource || '';
            const teachingActivities = requirements.teachingActivities || {};
            const assessmentMethod = requirements.assessmentMethod || '';
            const certification = requirements.certification || '';
            const managementLevel = requirements.managementLevel || '';
            
            // 基于需求生成智能大纲
            let outline = {
                title: AppState.courseTitle || '专业技能培训课程',
                description: generateCourseDescription(requirements),
                estimatedDuration: estimateCourseDuration(requirements),
                chapters: []
            };
            
            // 根据不同的学员类型和目标生成不同的章节结构
            if (learnerPersona === 'new-employee' || learnerPersona === 'junior-employee') {
                // 新员工/初级员工 - 基础入门型大纲
                outline.chapters = generateBeginnerOutline(requirements);
            } else if (learnerPersona === 'mid-employee' || learnerPersona === 'senior-employee') {
                // 中高级员工 - 进阶实战型大纲
                outline.chapters = generateAdvancedOutline(requirements);
            } else if (learnerPersona === 'management') {
                // 管理层 - 战略管理型大纲
                outline.chapters = generateManagementOutline(requirements);
            } else if (learnerPersona === 'expert') {
                // 专家级 - 深度专业型大纲
                outline.chapters = generateExpertOutline(requirements);
            } else {
                // 默认标准大纲
                outline.chapters = generateStandardOutline(requirements);
            }
            
            // 根据评估方式调整章节
            adjustChaptersForAssessment(outline.chapters, assessmentMethod, teachingActivities);
            
            return outline;
        }

        // 生成课程描述
        function generateCourseDescription(requirements) {
            const goal = requirements.coreGoal || '掌握专业技能';
            const persona = getLearnerPersonaDisplayText(requirements.learnerPersona || '');
            
            return `本课程专为${persona}设计，旨在帮助学员${goal.length > 50 ? goal : getCoreGoalDisplayText(goal)}。通过系统化的学习和实践，学员将能够熟练掌握相关技能并应用到实际工作中。`;
        }

        // 估算课程时长
        function estimateCourseDuration(requirements) {
            const persona = requirements.learnerPersona;
            const activities = requirements.teachingActivities || {};
            const assessment = requirements.assessmentMethod;
            
            let baseDuration = 2; // 基础2小时
            
            // 根据学员类型调整
            if (persona === 'new-employee') baseDuration += 1;
            if (persona === 'expert') baseDuration += 2;
            if (persona === 'management') baseDuration += 0.5;
            
            // 根据教学活动调整
            if (activities['hands-on-practice']) baseDuration += 1;
            if (activities['case-analysis']) baseDuration += 0.5;
            if (activities['group-discussion']) baseDuration += 0.5;
            if (activities['role-playing']) baseDuration += 1;
            
            // 根据评估方式调整
            if (assessment === 'project-assessment') baseDuration += 1;
            if (assessment === 'frequent-tests') baseDuration += 0.5;
            
            return `${Math.ceil(baseDuration)}小时`;
        }

        // 生成新员工/初级员工大纲
        function generateBeginnerOutline(requirements) {
            const topic = AppState.courseTitle || '专业技能';
            return [
                {
                    title: `${topic}基础认知`,
                    subtitle: '建立正确的理解和认知',
                    sections: [
                        '基本概念与重要性',
                        '核心原理与框架',
                        '常见误区与注意事项'
                    ]
                },
                {
                    title: '核心技能入门',
                    subtitle: '掌握基础操作和方法',
                    sections: [
                        '基础操作演示',
                        '标准流程介绍',
                        '实操练习指导'
                    ]
                },
                {
                    title: '实践应用训练',
                    subtitle: '通过练习巩固技能',
                    sections: [
                        '场景模拟练习',
                        '常见问题处理',
                        '技能熟练度训练'
                    ]
                },
                {
                    title: '总结提升',
                    subtitle: '巩固学习成果',
                    sections: [
                        '知识点回顾',
                        '技能自测评估',
                        '持续学习指导'
                    ]
                }
            ];
        }

        // 生成中高级员工大纲
        function generateAdvancedOutline(requirements) {
            const topic = AppState.courseTitle || '专业技能';
            return [
                {
                    title: `${topic}进阶理论`,
                    subtitle: '深入理解核心理念',
                    sections: [
                        '高级理论框架',
                        '最佳实践分析',
                        '行业趋势洞察'
                    ]
                },
                {
                    title: '高效方法技巧',
                    subtitle: '掌握进阶技能和技巧',
                    sections: [
                        '高级功能应用',
                        '效率提升技巧',
                        '自动化工具使用'
                    ]
                },
                {
                    title: '复杂场景实战',
                    subtitle: '解决复杂业务问题',
                    sections: [
                        '复杂案例分析',
                        '问题诊断与解决',
                        '实战项目演练'
                    ]
                },
                {
                    title: '专业能力进阶',
                    subtitle: '成为领域专家',
                    sections: [
                        '专业认证准备',
                        '持续改进方法',
                        '知识分享与传承'
                    ]
                }
            ];
        }

        // 生成管理层大纲
        function generateManagementOutline(requirements) {
            const topic = AppState.courseTitle || '专业技能';
            return [
                {
                    title: `${topic}战略视角`,
                    subtitle: '从管理角度理解重要性',
                    sections: [
                        '业务价值分析',
                        '组织影响评估',
                        '投资回报分析'
                    ]
                },
                {
                    title: '团队能力建设',
                    subtitle: '提升团队整体能力',
                    sections: [
                        '团队技能评估',
                        '培训体系规划',
                        '能力发展路径'
                    ]
                },
                {
                    title: '管理实施策略',
                    subtitle: '有效推进和管理',
                    sections: [
                        '实施计划制定',
                        '变革管理方法',
                        '效果监控机制'
                    ]
                },
                {
                    title: '持续优化改进',
                    subtitle: '建立长效机制',
                    sections: [
                        '绩效评估体系',
                        '持续改进流程',
                        '最佳实践沉淀'
                    ]
                }
            ];
        }

        // 生成专家级大纲
        function generateExpertOutline(requirements) {
            const topic = AppState.courseTitle || '专业技能';
            return [
                {
                    title: `${topic}前沿技术`,
                    subtitle: '掌握最新技术发展',
                    sections: [
                        '前沿技术趋势',
                        '创新应用案例',
                        '技术演进路径'
                    ]
                },
                {
                    title: '深度技术实践',
                    subtitle: '解决技术难题',
                    sections: [
                        '高难度技术挑战',
                        '性能优化策略',
                        '架构设计原则'
                    ]
                },
                {
                    title: '行业解决方案',
                    subtitle: '构建专业解决方案',
                    sections: [
                        '行业特定需求',
                        '定制化解决方案',
                        '方案实施与优化'
                    ]
                },
                {
                    title: '专业影响力',
                    subtitle: '成为行业领导者',
                    sections: [
                        '技术分享与布道',
                        '行业标准制定',
                        '创新研究方向'
                    ]
                }
            ];
        }

        // 生成标准大纲
        function generateStandardOutline(requirements) {
            const topic = AppState.courseTitle || '专业技能';
            return [
                {
                    title: `${topic}概述`,
                    subtitle: '全面了解基础知识',
                    sections: [
                        '基础概念介绍',
                        '应用场景分析',
                        '学习目标设定'
                    ]
                },
                {
                    title: '核心技能掌握',
                    subtitle: '学习核心操作技能',
                    sections: [
                        '核心功能详解',
                        '操作流程演示',
                        '实践操作训练'
                    ]
                },
                {
                    title: '应用实践',
                    subtitle: '在实际场景中应用',
                    sections: [
                        '典型案例分析',
                        '实际问题解决',
                        '综合练习项目'
                    ]
                },
                {
                    title: '总结与提升',
                    subtitle: '巩固学习成果',
                    sections: [
                        '知识点总结',
                        '技能评估测试',
                        '后续学习建议'
                    ]
                }
            ];
        }

        // 根据评估方式调整章节
        function adjustChaptersForAssessment(chapters, assessmentMethod, teachingActivities) {
            // 如果需要频繁测试，在每章后添加测试环节
            if (assessmentMethod === 'frequent-tests') {
                chapters.forEach(chapter => {
                    chapter.sections.push('本章知识检测');
                });
            }
            
            // 如果需要项目评估，确保最后一章包含项目
            if (assessmentMethod === 'project-assessment') {
                const lastChapter = chapters[chapters.length - 1];
                if (!lastChapter.sections.some(s => s.includes('项目'))) {
                    lastChapter.sections.push('综合项目实践');
                }
            }
            
            // 如果包含小组讨论，在合适的章节添加讨论环节
            if (teachingActivities['group-discussion']) {
                if (chapters.length >= 2) {
                    chapters[1].sections.push('小组讨论与分享');
                }
            }
            
            // 如果包含角色扮演，添加模拟练习
            if (teachingActivities['role-playing']) {
                if (chapters.length >= 3) {
                    chapters[2].sections.push('角色扮演练习');
                }
            }
        }

        // 创建可编辑的大纲卡片
        function createEditableOutlineCard(outline) {
            const outlineCard = `
                <div class="p-4">
                                         <!-- 课程基本信息 -->
                     <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg p-3 mb-4">
                         <div class="flex items-start space-x-2">
                             <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center flex-shrink-0">
                                 <i class="fas fa-graduation-cap text-white text-sm"></i>
                                         </div>
                             <div class="flex-1">
                                 <h3 class="text-base font-bold text-gray-900 dark:text-white mb-1">${outline.title}</h3>
                                 <p class="text-gray-600 dark:text-gray-400 text-xs mb-2">${outline.description}</p>
                                 <div class="flex items-center space-x-3 text-xs">
                                     <div class="flex items-center space-x-1">
                                         <i class="fas fa-clock text-blue-500 text-xs"></i>
                                         <span class="text-gray-700 dark:text-gray-300">预计时长：<span class="font-medium">${outline.estimatedDuration}</span></span>
                                         </div>
                                     <div class="flex items-center space-x-1">
                                         <i class="fas fa-list-ol text-green-500 text-xs"></i>
                                         <span class="text-gray-700 dark:text-gray-300">章节数量：<span class="font-medium">${outline.chapters.length}章</span></span>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>

                                         <!-- 课程大纲 -->
                     <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                         <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                             <div class="flex items-center justify-between">
                                 <h4 class="text-base font-semibold text-gray-900 dark:text-white">
                                     <i class="fas fa-list-ul text-blue-500 mr-1 text-xs"></i>课程大纲
                                 </h4>
                                     <div class="flex items-center space-x-2">
                                     <button id="editOutline" class="px-3 py-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                         <i class="fas fa-edit mr-1 text-xs"></i>编辑
                                     </button>
                                     <button id="previewOutline" class="px-3 py-1 text-xs bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                         <i class="fas fa-eye mr-1 text-xs"></i>预览
                                     </button>
                                     </div>
                                         </div>
                                         </div>
                        
                        <div id="viewOnlyOutlineContainer" class="p-3 space-y-2">
                            ${generateViewOnlyChapters(outline.chapters)}
                                     </div>
                        
                                                 <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750 rounded-b-lg">
                             <div class="flex justify-between items-center">
                                 <div class="text-xs text-gray-600 dark:text-gray-400">
                                     <i class="fas fa-info-circle mr-1 text-xs"></i>
                                     点击"编辑"按钮在弹窗中修改课程内容
                                 </div>
                                 <div class="flex space-x-2">
                                     <button id="regenerateOutline" class="px-3 py-1 text-xs text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                         <i class="fas fa-sync-alt mr-1 text-xs"></i>重新生成
                                     </button>
                                     <button id="confirmFinalOutline" class="px-4 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded font-medium transition-colors">
                                         <i class="fas fa-check mr-1 text-xs"></i>确认大纲
                                     </button>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            `;
            
            return outlineCard;
        }

        // 生成章节浏览模式
        function generateViewOnlyChapters(chapters) {
            return chapters.map((chapter, chapterIndex) => `
                <div class="chapter-item bg-gray-50 dark:bg-gray-700 rounded p-2 border border-gray-200 dark:border-gray-600 mb-2" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-2">
                        <div class="w-6 h-6 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-xs">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h5 class="chapter-title text-sm font-medium text-gray-900 dark:text-white mb-1">${chapter.title}</h5>
                            <p class="chapter-subtitle text-xs text-gray-600 dark:text-gray-400 mb-2">${chapter.subtitle}</p>
                            
                            <div class="sections-container space-y-1">
                                ${generateViewOnlySections(chapter.sections, chapterIndex)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 生成小节浏览模式
        function generateViewOnlySections(sections, chapterIndex) {
            return sections.map((section, sectionIndex) => `
                <div class="section-item flex items-center space-x-2 p-1 bg-white dark:bg-gray-600 rounded" data-section-index="${sectionIndex}">
                    <div class="w-4 h-4 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                        <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionIndex + 1}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="section-title text-xs text-gray-700 dark:text-gray-200">${section}</div>
                    </div>
                </div>
            `).join('');
        }

        // 初始化可编辑大纲
        function initEditableOutline(cardElement, outline) {
            if (!cardElement) return;
            
            // 保存原始大纲数据
            AppState.currentOutline = outline;
            
            // 初始化拖拽排序
            initChapterDragAndDrop(cardElement);
            
            // 初始化编辑功能
            initOutlineEditing(cardElement);
            
            // 初始化按钮事件
            initOutlineButtons(cardElement);
        }

        // 初始化章节拖拽排序
        function initChapterDragAndDrop(container) {
            const chapterItems = container.querySelectorAll('.chapter-item');
            
            chapterItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.chapterIndex);
                    item.classList.add('opacity-50');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(item.dataset.chapterIndex);
                    
                    if (draggedIndex !== targetIndex) {
                        reorderChapters(container, draggedIndex, targetIndex);
                    }
                });
            });
        }

        // 重新排序章节
        function reorderChapters(container, fromIndex, toIndex) {
            const outlineContainer = container.querySelector('#editableOutlineContainer');
            const items = Array.from(outlineContainer.children);
            const draggedItem = items[fromIndex];
            const targetItem = items[toIndex];
            
            if (fromIndex < toIndex) {
                targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedItem, targetItem);
            }
            
            // 更新索引和编号
            updateChapterIndexes(outlineContainer);
        }

        // 更新章节索引
        function updateChapterIndexes(container) {
            const chapterItems = container.querySelectorAll('.chapter-item');
            chapterItems.forEach((item, index) => {
                item.dataset.chapterIndex = index;
                const numberSpan = item.querySelector('.w-12 span');
                numberSpan.textContent = index + 1;
                
                // 更新小节编号
                const sectionItems = item.querySelectorAll('.section-item');
                sectionItems.forEach((section, sectionIndex) => {
                    const sectionNumber = section.querySelector('.w-8 span');
                    sectionNumber.textContent = `${index + 1}.${sectionIndex + 1}`;
                });
            });
        }

        // 初始化大纲编辑功能
        function initOutlineEditing(cardElement) {
            // 可编辑字段的样式处理
            const editableFields = cardElement.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                field.addEventListener('focus', () => {
                    field.classList.add('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
                });
                
                field.addEventListener('blur', () => {
                    field.classList.remove('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
                });
                
                // 阻止回车键换行
                field.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        field.blur();
                    }
                });
            });
            
            // 添加小节按钮
            const addSectionBtns = cardElement.querySelectorAll('.add-section-btn');
            addSectionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    addNewSection(e.target.closest('.chapter-item'));
                });
            });
            
            // 删除章节按钮
            const deleteChapterBtns = cardElement.querySelectorAll('.delete-chapter-btn');
            deleteChapterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteChapter(e.target.closest('.chapter-item'), cardElement);
                });
            });
            
            // 删除小节按钮
            const deleteSectionBtns = cardElement.querySelectorAll('.delete-section-btn');
            deleteSectionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteSection(e.target.closest('.section-item'));
                });
            });
        }

        // 添加新小节
        function addNewSection(chapterItem) {
            const sectionsContainer = chapterItem.querySelector('.sections-container');
            const chapterIndex = parseInt(chapterItem.dataset.chapterIndex);
            const sectionCount = sectionsContainer.children.length;
            
            const newSectionHtml = generateEditableSections(['新小节'], chapterIndex).replace(
                `${chapterIndex + 1}.1`,
                `${chapterIndex + 1}.${sectionCount + 1}`
            );
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newSectionHtml;
            const newSection = tempDiv.firstElementChild;
            
            sectionsContainer.appendChild(newSection);
            
            // 初始化新小节的事件
            initSectionEvents(newSection);
            
            // 自动聚焦到新小节标题
            const titleField = newSection.querySelector('.section-title');
            titleField.focus();
            titleField.select();
        }

        // 删除章节
        function deleteChapter(chapterItem, cardElement) {
            const container = cardElement.querySelector('#editableOutlineContainer');
            if (container.children.length > 1) {
                chapterItem.remove();
                updateChapterIndexes(container);
                updateChapterCount(cardElement);
            } else {
                alert('至少需要保留一个章节');
            }
        }

        // 删除小节
        function deleteSection(sectionItem) {
            const sectionsContainer = sectionItem.parentElement;
            if (sectionsContainer.children.length > 1) {
                sectionItem.remove();
                updateSectionNumbers(sectionsContainer);
            } else {
                alert('至少需要保留一个小节');
            }
        }

        // 更新小节编号
        function updateSectionNumbers(sectionsContainer) {
            const chapterIndex = parseInt(sectionsContainer.closest('.chapter-item').dataset.chapterIndex);
            const sectionItems = sectionsContainer.querySelectorAll('.section-item');
            
            sectionItems.forEach((section, index) => {
                section.dataset.sectionIndex = index;
                const numberSpan = section.querySelector('.w-8 span');
                numberSpan.textContent = `${chapterIndex + 1}.${index + 1}`;
            });
        }

        // 更新章节计数
        function updateChapterCount(cardElement) {
            const chapterCount = cardElement.querySelectorAll('.chapter-item').length;
            const countSpan = cardElement.querySelector('.text-gray-700 .font-medium');
            if (countSpan) {
                countSpan.textContent = `${chapterCount}章`;
            }
        }

        // 初始化小节事件
        function initSectionEvents(sectionElement) {
            const deleteBtn = sectionElement.querySelector('.delete-section-btn');
            const editableField = sectionElement.querySelector('.editable-field');
            
            deleteBtn.addEventListener('click', () => {
                deleteSection(sectionElement);
            });
            
            editableField.addEventListener('focus', () => {
                editableField.classList.add('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
            });
            
            editableField.addEventListener('blur', () => {
                editableField.classList.remove('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
            });
            
            editableField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    editableField.blur();
                }
            });
        }

        // 初始化大纲按钮事件
        function initOutlineButtons(cardElement) {
            const editBtn = cardElement.querySelector('#editOutline');
            const previewBtn = cardElement.querySelector('#previewOutline');
            const regenerateBtn = cardElement.querySelector('#regenerateOutline');
            const confirmBtn = cardElement.querySelector('#confirmFinalOutline');
            
            // 编辑大纲
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    openEditOutlineModal();
                });
            }
            
            // 预览大纲
            if (previewBtn) {
                previewBtn.addEventListener('click', () => {
                    previewCurrentOutline();
                });
            }
            
            // 重新生成
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', () => {
                    regenerateCurrentOutline();
                });
            }
            
            // 确认大纲
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    confirmFinalOutline(cardElement);
                });
            }
        }

        // 添加新章节
        function addNewChapter(cardElement) {
            const container = cardElement.querySelector('#editableOutlineContainer');
            const chapterCount = container.children.length;
            
            const newChapter = {
                title: '新章节',
                subtitle: '章节描述',
                sections: ['新小节']
            };
            
            const newChapterHtml = generateEditableChapters([newChapter]).replace(
                'data-chapter-index="0"',
                `data-chapter-index="${chapterCount}"`
            ).replace('text-lg">1<', `text-lg">${chapterCount + 1}<`);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newChapterHtml;
            const newChapterElement = tempDiv.firstElementChild;
            
            container.appendChild(newChapterElement);
            
            // 初始化新章节的事件
            initNewChapterEvents(newChapterElement);
            updateChapterCount(cardElement);
            
            // 自动聚焦到新章节标题
            const titleField = newChapterElement.querySelector('.chapter-title');
            titleField.focus();
            titleField.select();
        }

        // 初始化新章节事件
        function initNewChapterEvents(chapterElement) {
            // 重新初始化所有编辑功能
            initOutlineEditing(chapterElement.closest('.p-8'));
        }

        // 预览当前大纲
        function previewCurrentOutline() {
            showOutlinePreviewModal(AppState.currentOutline);
        }

        // 重新生成大纲
        function regenerateCurrentOutline() {
            addMessage('⚡ 正在重新生成课程大纲，请稍候...');
            
            setTimeout(() => {
                // 重新生成大纲
                const newOutline = createSmartOutline(AppState.detailedRequirements);
                
                // 更新当前大纲数据
                AppState.currentOutline = newOutline;
                
                // 更新显示
                updateOutlineDisplay();
                
                addMessage('✨ 大纲已重新生成！我基于您的需求生成了全新的课程结构。');
            }, 2000);
        }

        // 打开编辑大纲模态窗口
        function openEditOutlineModal() {
            const modal = document.getElementById('editOutlineModal');
            const currentOutline = AppState.currentOutline;
            
            // 填充当前数据
            document.getElementById('editCourseTitle').value = currentOutline.title;
            document.getElementById('editCourseDescription').value = currentOutline.description;
            document.getElementById('editCourseDuration').value = currentOutline.estimatedDuration;
            
            // 生成可编辑的章节
            generateEditableChaptersInModal(currentOutline.chapters);
            
            // 显示模态窗口
            modal.classList.remove('hidden');
            
            // 初始化模态窗口事件
            initEditModalEvents();
        }

        // 在模态窗口中生成可编辑章节
        function generateEditableChaptersInModal(chapters) {
            const container = document.getElementById('editableChaptersContainer');
            container.innerHTML = chapters.map((chapter, chapterIndex) => `
                <div class="chapter-edit-item border border-gray-200 dark:border-gray-600 rounded-lg p-4" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-sm">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">章节标题</label>
                                <input type="text" class="chapter-title-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${chapter.title}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">章节描述</label>
                                <input type="text" class="chapter-subtitle-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${chapter.subtitle}">
                            </div>
                        </div>
                                     <div class="flex items-center space-x-2">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="添加小节">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除章节">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                                     </div>
                                         </div>
                    
                    <div class="sections-edit-container space-y-2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">小节列表</label>
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-edit-item flex items-center space-x-2" data-section-index="${sectionIndex}">
                                <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                    <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                         </div>
                                <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${section}">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除小节">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                                     </div>
                        `).join('')}
                                 </div>
                             </div>
            `).join('');
        }

        // 初始化编辑模态窗口事件
        function initEditModalEvents() {
            // 关闭模态窗口
            document.getElementById('closeEditModal').onclick = closeEditModal;
            document.getElementById('cancelEditOutline').onclick = closeEditModal;
            
            // 保存修改
            document.getElementById('saveEditOutline').onclick = saveEditOutline;
            
            // 添加章节
            document.getElementById('addChapterInModal').onclick = addChapterInModal;
            
            // 章节和小节操作事件
            initChapterSectionEvents();
        }

        // 初始化章节和小节操作事件
        function initChapterSectionEvents() {
            const container = document.getElementById('editableChaptersContainer');
            
            // 删除章节
            container.addEventListener('click', (e) => {
                if (e.target.closest('.delete-chapter-btn')) {
                    const chapterItem = e.target.closest('.chapter-edit-item');
                    chapterItem.remove();
                    updateChapterNumbers();
                }
            });
            
            // 添加小节
            container.addEventListener('click', (e) => {
                if (e.target.closest('.add-section-btn')) {
                    const chapterItem = e.target.closest('.chapter-edit-item');
                    const sectionsContainer = chapterItem.querySelector('.sections-edit-container');
                    const chapterIndex = parseInt(chapterItem.dataset.chapterIndex);
                    const sectionCount = sectionsContainer.querySelectorAll('.section-edit-item').length;
                    
                    const newSectionHtml = `
                        <div class="section-edit-item flex items-center space-x-2" data-section-index="${sectionCount}">
                            <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionCount + 1}</span>
                            </div>
                            <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="新小节">
                            <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除小节">
                                <i class="fas fa-times text-xs"></i>
                                 </button>
                        </div>
                    `;
                    sectionsContainer.insertAdjacentHTML('beforeend', newSectionHtml);
                }
            });
            
            // 删除小节
            container.addEventListener('click', (e) => {
                if (e.target.closest('.delete-section-btn')) {
                    const sectionItem = e.target.closest('.section-edit-item');
                    sectionItem.remove();
                    updateSectionNumbers();
                }
            });
        }

        // 添加章节到模态窗口
        function addChapterInModal() {
            const container = document.getElementById('editableChaptersContainer');
            const chapterCount = container.children.length;
            
            const newChapterHtml = `
                <div class="chapter-edit-item border border-gray-200 dark:border-gray-600 rounded-lg p-4" data-chapter-index="${chapterCount}">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-sm">${chapterCount + 1}</span>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">章节标题</label>
                                <input type="text" class="chapter-title-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="新章节">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">章节描述</label>
                                <input type="text" class="chapter-subtitle-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="章节描述">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="添加小节">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除章节">
                                <i class="fas fa-trash text-xs"></i>
                                 </button>
                             </div>
                         </div>

                    <div class="sections-edit-container space-y-2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">小节列表</label>
                        <div class="section-edit-item flex items-center space-x-2" data-section-index="0">
                            <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterCount + 1}.1</span>
                            </div>
                            <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="新小节">
                            <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除小节">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newChapterHtml);
        }

        // 更新章节编号
        function updateChapterNumbers() {
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            chapterItems.forEach((item, index) => {
                item.dataset.chapterIndex = index;
                const numberSpan = item.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
                
                // 更新小节编号
                updateSectionNumbers();
            });
        }

        // 更新小节编号
        function updateSectionNumbers() {
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            chapterItems.forEach((chapterItem, chapterIndex) => {
                const sectionItems = chapterItem.querySelectorAll('.section-edit-item');
                sectionItems.forEach((sectionItem, sectionIndex) => {
                    sectionItem.dataset.sectionIndex = sectionIndex;
                    const numberSpan = sectionItem.querySelector('.w-6 span');
                    numberSpan.textContent = `${chapterIndex + 1}.${sectionIndex + 1}`;
                });
            });
        }

        // 关闭编辑模态窗口
        function closeEditModal() {
            document.getElementById('editOutlineModal').classList.add('hidden');
        }

        // 保存编辑修改
        function saveEditOutline() {
            // 收集编辑后的数据
            const title = document.getElementById('editCourseTitle').value.trim();
            const description = document.getElementById('editCourseDescription').value.trim();
            const duration = document.getElementById('editCourseDuration').value.trim();
            
            const chapters = [];
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            
            chapterItems.forEach(item => {
                const chapterTitle = item.querySelector('.chapter-title-input').value.trim();
                const chapterSubtitle = item.querySelector('.chapter-subtitle-input').value.trim();
                const sections = [];
                
                const sectionInputs = item.querySelectorAll('.section-title-input');
                sectionInputs.forEach(input => {
                    if (input.value.trim()) {
                        sections.push(input.value.trim());
                    }
                });
                
                if (chapterTitle) {
                    chapters.push({
                        title: chapterTitle,
                        subtitle: chapterSubtitle,
                        sections: sections
                    });
                }
            });
            
            // 更新当前大纲数据
            AppState.currentOutline = {
                title: title,
                description: description,
                estimatedDuration: duration,
                chapters: chapters
            };
            
            // 更新显示
            updateOutlineDisplay();
            
            // 关闭模态窗口
            closeEditModal();
            
            addMessage('✅ 大纲修改已保存！您可以继续预览或确认最终大纲。');
        }

        // 更新大纲显示
        function updateOutlineDisplay() {
            const currentCard = document.querySelector('.p-4'); // 找到当前的大纲卡片
            if (currentCard) {
                // 更新基本信息
                const titleElement = currentCard.querySelector('h3');
                const descElement = currentCard.querySelector('p');
                const durationElement = currentCard.querySelector('.fas.fa-clock').nextElementSibling;
                const chapterCountElement = currentCard.querySelector('.fas.fa-list-ol').nextElementSibling;
                
                if (titleElement) titleElement.textContent = AppState.currentOutline.title;
                if (descElement) descElement.textContent = AppState.currentOutline.description;
                if (durationElement) durationElement.innerHTML = `预计时长：<span class="font-medium">${AppState.currentOutline.estimatedDuration}</span>`;
                if (chapterCountElement) chapterCountElement.innerHTML = `章节数量：<span class="font-medium">${AppState.currentOutline.chapters.length}章</span>`;
                
                // 更新章节显示
                const outlineContainer = currentCard.querySelector('#viewOnlyOutlineContainer');
                if (outlineContainer) {
                    outlineContainer.innerHTML = generateViewOnlyChapters(AppState.currentOutline.chapters);
                }
            }
        }

        // 确认最终大纲
        function confirmFinalOutline(cardElement) {
            const finalOutline = AppState.currentOutline;
            AppState.selectedOutline = 'custom';
            AppState.finalOutline = finalOutline;
            
            // 禁用编辑
            cardElement.style.pointerEvents = 'none';
            cardElement.style.opacity = '0.8';
            
            addMessage('🎉 太棒了！课程大纲已确认完成。');
            
            setTimeout(() => {
                // 检查是否已经上传了文件
                if (AppState.uploadedFiles && AppState.uploadedFiles.length > 0) {
                    addMessage('很好！您已经上传了参考资料，现在开始生成完整的课程内容：');
                    setTimeout(() => {
                        startFinalCourseGeneration();
                    }, 1000);
                } else {
                    addMessage('接下来，如果您有相关的参考资料，可以上传给我进一步优化课程内容：');
                    
                    setTimeout(() => {
                        const uploadCard = addFileUploadCard();
                        AppState.currentStep = 4;
                        initChatFileUpload(uploadCard);
                    }, 1000);
                }
            }, 1000);
        }



        // 添加详细需求收集卡片到聊天（保留原函数以防其他地方调用）
        function addDetailedRequirementsCard() {
            const detailsCard = `
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-clipboard-list text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-3">
                            课程详细需求调研
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400 text-base max-w-2xl mx-auto">
                            请填写以下信息，这将帮助我为您生成更加精准、实用的课程内容
                        </p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 rounded-2xl border border-gray-200 dark:border-gray-600 p-8 shadow-lg">
                        <form id="detailedRequirementsForm" class="space-y-8">
                            <!-- 基础设置 -->
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-3">
                                        <i class="fas fa-cog text-blue-500 mr-3"></i>基础设置
                                    </h4>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">课程时长偏好</label>
                                        <select id="detailDuration" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">请选择时长</option>
                                            <option value="30min">30分钟（简短介绍）</option>
                                            <option value="1hour">1小时（快速入门）</option>
                                            <option value="2-3hours">2-3小时（标准培训）</option>
                                            <option value="half-day">半天（4小时深度培训）</option>
                                            <option value="full-day">全天（8小时综合培训）</option>
                                            <option value="2-3days">2-3天（系统性培训）</option>
                                            <option value="custom">自定义时长</option>
                                        </select>
                                    </div>
                                    
                                    <div id="customDurationDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">自定义时长</label>
                                        <input type="text" id="customDuration" placeholder="例如：5小时、1周、10节课等" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">期望章节数量</label>
                                        <select id="chapterCount" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">AI智能推荐</option>
                                            <option value="3">3个章节（简洁型）</option>
                                            <option value="4">4个章节（标准型）</option>
                                            <option value="5">5个章节（详细型）</option>
                                            <option value="6">6个章节（完整型）</option>
                                            <option value="8">8个章节（深度型）</option>
                                            <option value="custom">自定义数量</option>
                                        </select>
                                    </div>
                                    
                                    <div id="customChapterDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">自定义章节数</label>
                                        <input type="number" id="customChapterCount" min="2" max="20" placeholder="输入章节数量" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">难度级别</label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="beginner" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">入门级</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">零基础友好</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="intermediate" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">中级</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">有一定基础</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="advanced" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">高级</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">深度专业</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="mixed" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">混合级别</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">循序渐进</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 教学内容 -->
                                <div class="space-y-6">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-3">
                                        <i class="fas fa-graduation-cap text-green-500 mr-3"></i>教学内容
                                    </h4>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">教学方式（可多选）</label>
                                        <div class="space-y-3">
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeTheory" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">理论讲解</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">概念介绍、原理解释</div>
                                 </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includePractice" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">实操演示</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">步骤演示、操作指导</div>
                             </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeCases" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">案例分析</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">真实案例、问题分析</div>
                                     </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeGroup" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">小组讨论</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">团队协作、思维碰撞</div>
                                         </div>
                                            </label>
                                         </div>
                                     </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">评估方式（可多选）</label>
                                        <div class="space-y-3">
                                            <label class="flex items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeQuiz" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">随堂测验</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">选择题、判断题等快速检测</div>
                                 </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeAssignment" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">课后作业</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">练习题、实践任务</div>
                                     </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeProject" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">项目实践</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">综合项目、实际应用</div>
                                         </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeFeedback" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">反馈评估</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">学员反馈、效果评估</div>
                                         </div>
                                            </label>
                                     </div>
                                 </div>
                                     </div>
                                         </div>
                            
                            <!-- 目标受众详细信息 -->
                            <div class="border-t border-gray-200 dark:border-gray-600 pt-8">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">
                                    <i class="fas fa-users text-purple-500 mr-3"></i>目标受众详细信息
                                </h4>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">预期学员数量</label>
                                        <select id="audienceSize" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">请选择人数规模</option>
                                            <option value="1-5">1-5人（小型）</option>
                                            <option value="6-15">6-15人（中型）</option>
                                            <option value="16-30">16-30人（大型）</option>
                                            <option value="30+">30+人（批量培训）</option>
                                        </select>
                                         </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">学员背景水平</label>
                                        <select id="audienceBackground" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">请选择背景水平</option>
                                            <option value="zero">零基础小白</option>
                                            <option value="basic">有基础了解</option>
                                            <option value="experienced">有一定经验</option>
                                            <option value="mixed">水平参差不齐</option>
                                        </select>
                                     </div>
                                 </div>
                            </div>
                            
                            <!-- 特殊需求 -->
                            <div class="border-t border-gray-200 dark:border-gray-600 pt-8">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">
                                    <i class="fas fa-star text-yellow-500 mr-3"></i>特殊需求与偏好
                                </h4>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">课程交付形式</label>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="offline" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">线下面授</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">现场培训</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="online" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">在线直播</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">远程授课</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="hybrid" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">混合模式</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">线上+线下</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">其他特殊需求或要求</label>
                                        <textarea id="specialRequirements" placeholder="例如：需要配置具体的操作环境、有特定的合规要求、需要多语言支持、有行业特殊标准等..." class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- 提交按钮 -->
                        <div class="flex justify-center mt-10 pt-8 border-t border-gray-200 dark:border-gray-600">
                            <button id="submitDetailedRequirements" class="px-10 py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-xl font-semibold text-base transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-rocket mr-3"></i>
                                完成需求收集，开始设计课程
                            </button>
                        </div>
                        
                        <div class="text-center mt-4">
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                所有字段都是可选的，AI会根据您填写的信息生成更精准的课程内容
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            return addMessage(detailsCard, false, true, true);
        }

        // 添加文件上传卡片到聊天
        function addFileUploadCard() {
            const uploadCard = `
                <div class="p-6">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-4">
                        为了让课程内容精准、有料，您可以上传相关资料：
                    </div>
                    <div id="chatUploadArea" class="border-2 border-dashed border-blue-300 dark:border-blue-600 rounded-xl p-6 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors cursor-pointer">
                        <div class="space-y-3">
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-cloud-upload-alt text-blue-500 text-lg"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-300 text-sm">点击选择文件或拖拽到这里</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">支持 PDF, DOC, DOCX, PPT, PPTX</p>
                            </div>
                        </div>
                    </div>
                    <div id="chatUploadedFiles" class="mt-3 space-y-2"></div>
                    <div class="flex justify-end mt-4">
                        <button id="skipUpload" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                            跳过上传
                        </button>
                    </div>
                </div>
            `;
            
            return addMessage(uploadCard, false, true, true);
        }

        // 生成智能大纲选项
        function generateSmartOutlineOptions(requirements) {
            const courseTitle = AppState.courseTitle || '专业技能培训';
            const coreGoal = requirements.coreGoal || '';
            const learnerPersona = requirements.learnerPersona || '';
            const teachingActivities = requirements.teachingActivities || {};
            
            // 生成方案A：标准流程型大纲
            const optionA = generateStandardOutlineOption(courseTitle, requirements);
            
            // 生成方案B：实践任务型大纲
            const optionB = generateTaskBasedOutlineOption(courseTitle, requirements);
            
            return { optionA, optionB };
        }

        // 生成标准流程型大纲
        function generateStandardOutlineOption(courseTitle, requirements) {
            const chapters = [];
            const topic = courseTitle.replace(/课程|培训|学习/g, '').trim();
            
            // 第一章：基础理论
            chapters.push({
                title: `${topic}基础认知`,
                sections: [
                    `${topic}基本概念与重要性`,
                    `核心原理与理论框架`,
                    `行业标准与最佳实践`
                ]
            });
            
            // 第二章：核心技能
            if (requirements.learnerPersona === 'new-employee') {
                chapters.push({
                    title: `${topic}入门操作`,
                    sections: [
                        '基础操作流程详解',
                        '常用工具和方法',
                        '操作规范与注意事项'
                    ]
                });
            } else {
                chapters.push({
                    title: `${topic}核心技能`,
                    sections: [
                        '高级操作技巧',
                        '效率提升方法',
                        '专业工具应用'
                    ]
                });
            }
            
            // 第三章：实践应用
            chapters.push({
                title: `${topic}实践应用`,
                sections: [
                    '典型场景分析',
                    '问题诊断与解决',
                    '实际案例演练'
                ]
            });
            
            // 第四章：总结提升
            const finalChapterTitle = requirements.assessmentMethod === 'project-assessment' ? 
                `${topic}项目实战` : `${topic}总结提升`;
            chapters.push({
                title: finalChapterTitle,
                sections: [
                    requirements.assessmentMethod === 'project-assessment' ? '综合项目设计' : '知识点系统回顾',
                    requirements.assessmentMethod === 'project-assessment' ? '项目实施与评估' : '技能自测与评估',
                    '持续学习与改进'
                ]
            });
            
            return chapters;
        }

        // 生成任务导向型大纲
        function generateTaskBasedOutlineOption(courseTitle, requirements) {
            const tasks = [];
            const topic = courseTitle.replace(/课程|培训|学习/g, '').trim();
            
            // 任务一：基础入门
            if (requirements.learnerPersona === 'new-employee') {
                tasks.push({
                    title: `任务一：初识${topic}系统`,
                    sections: [
                        `${topic}环境配置准备`,
                        '基础功能体验实践'
                    ]
                });
            } else {
                tasks.push({
                    title: `任务一：${topic}核心功能掌握`,
                    sections: [
                        '关键功能深度体验',
                        '高级设置与配置'
                    ]
                });
            }
            
            // 任务二：核心操作
            tasks.push({
                title: `任务二：完成核心${topic}操作`,
                sections: [
                    '标准流程实操练习',
                    '常见问题处理实践'
                ]
            });
            
            // 任务三：进阶应用
            const advancedTaskTitle = requirements.teachingActivities['case-analysis'] ? 
                `任务三：${topic}案例分析实战` : `任务三：${topic}进阶应用`;
            tasks.push({
                title: advancedTaskTitle,
                sections: [
                    requirements.teachingActivities['case-analysis'] ? '真实案例分析演练' : '复杂场景操作实践',
                    '解决方案设计与实施'
                ]
            });
            
            // 任务四：成果展示
            const finalTaskTitle = requirements.assessmentMethod === 'project-assessment' ? 
                `任务四：${topic}综合项目交付` : `任务四：${topic}技能验证`;
            tasks.push({
                title: finalTaskTitle,
                sections: [
                    requirements.assessmentMethod === 'project-assessment' ? '项目成果展示' : '技能测试与评估',
                    '经验总结与分享'
                ]
            });
            
            return tasks;
        }

        // 生成大纲项目HTML
        function generateOutlineItemsHTML(items, color = 'blue') {
            return items.map((item, index) => `
                                 <div class="space-y-1">
                                     <div class="flex items-center space-x-2">
                        <div class="w-1 h-1 bg-${color}-400 rounded-full"></div>
                        <span class="font-medium">${item.title}</span>
                                     </div>
                                     <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                        ${item.sections.map((section, sIndex) => `
                                         <div class="flex items-center space-x-1.5">
                                             <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                <span>${index + 1}.${sIndex + 1} ${section}</span>
                                         </div>
                        `).join('')}
                                         </div>
                                     </div>
            `).join('');
        }

        // 添加大纲选择卡片到聊天（单卡片形式）
        function addOutlineSelectionCard(outlineOptions) {
            // 使用默认值，防止outlineOptions为undefined
            const defaultOptions = {
                optionA: [
                    {
                        title: `${AppState.courseTitle || '专业技能'}基础认知`,
                        sections: ['基本概念与重要性', '核心原理与理论框架', '行业标准与最佳实践']
                    }
                ],
                optionB: [
                    {
                        title: `任务一：掌握${AppState.courseTitle || '专业技能'}核心功能`,
                        sections: ['关键功能深度体验', '高级设置与配置']
                    }
                ]
            };
            
            const options = outlineOptions || defaultOptions;
            
            // 存储大纲选项到全局状态，方便切换
            AppState.currentOutlineOptions = options;
            AppState.currentOutlineType = 'A'; // 默认显示方案A
            
            const outlineCard = `
                <div class="p-6 max-w-4xl mx-auto" id="outlineSelectionCard">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-6 text-center">
                        我为您精心策划了课程大纲，请查看并选择：
                                 </div>
                    
                    <!-- 单个大纲卡片容器 -->
                    <div class="max-w-2xl mx-auto">
                        <div id="currentOutlineCard" class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-6 shadow-sm">
                            <!-- 动态内容将在这里填充 -->
                             </div>
                    </div>
                    
                    <!-- 操作按钮区域 -->
                    <div class="mt-6 flex flex-col items-center space-y-4">
                        <!-- 切换方案按钮 -->
                        <button id="switchOutlineOption" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 rounded-lg transition-colors font-medium text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>换个方案
                                 </button>
                        
                        <!-- 重新生成按钮 -->
                        <button id="regenerateOutlines" class="px-4 py-1.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-xs underline transition-colors">
                            对以上方案不满意？点击重新生成其他选项
                                 </button>
                             </div>
                         </div>
            `;
            
            const cardElement = addMessage(outlineCard, false, true, true);
            
            // 初始化单卡片大纲功能
            setTimeout(() => {
                initSingleOutlineCard(cardElement);
            }, 100);
            
            return cardElement;
        }

        // 初始化单卡片大纲功能
        function initSingleOutlineCard(cardElement) {
            if (!cardElement) return;
            
            const currentCard = cardElement.querySelector('#currentOutlineCard');
            const switchBtn = cardElement.querySelector('#switchOutlineOption');
            const regenerateBtn = cardElement.querySelector('#regenerateOutlines');
            
            // 渲染当前大纲
            function renderCurrentOutline() {
                const isOptionA = AppState.currentOutlineType === 'A';
                const currentOption = isOptionA ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
                const color = isOptionA ? 'blue' : 'green';
                const icon = isOptionA ? 'fas fa-list' : 'fas fa-tasks';
                const title = isOptionA ? '方案A：标准流程型大纲' : '方案B：基于任务的实践大纲';
                const subtitle = isOptionA ? 'AI推荐' : '实践导向';
                const bgColor = isOptionA ? 'blue' : 'green';
                
                currentCard.innerHTML = `
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-${bgColor}-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="${icon} text-white text-sm"></i>
                    </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white text-base">${title}</h4>
                            <p class="text-sm text-${bgColor}-500 dark:text-${bgColor}-400">${subtitle}</p>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300 ml-11">
                        ${generateOutlineItemsHTML(currentOption, color)}
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button class="outline-select-btn px-4 py-2 bg-${bgColor}-500 hover:bg-${bgColor}-600 text-white text-sm rounded-lg font-medium transition-colors" data-option="${AppState.currentOutlineType}">
                            选择此方案
                        </button>
                        <button class="outline-preview-btn px-4 py-2 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-sm rounded-lg font-medium transition-colors" data-option="${AppState.currentOutlineType}">
                            <i class="fas fa-eye mr-2"></i>预览微调
                        </button>
                    </div>
                `;
                
                // 重新绑定按钮事件
                bindOutlineCardEvents(currentCard);
            }
            
            // 切换方案
            switchBtn.addEventListener('click', () => {
                AppState.currentOutlineType = AppState.currentOutlineType === 'A' ? 'B' : 'A';
                
                // 添加切换动画
                currentCard.style.opacity = '0.5';
                currentCard.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    renderCurrentOutline();
                    currentCard.style.opacity = '1';
                    currentCard.style.transform = 'scale(1)';
                }, 200);
            });
            
            // 重新生成大纲
            regenerateBtn.addEventListener('click', () => {
                addMessage('⚡ 正在为您重新生成课程大纲方案...');
                
                setTimeout(() => {
                    // 重新生成大纲选项
                    const newOptions = generateSmartOutlineOptions(AppState.detailedRequirements);
                    AppState.currentOutlineOptions = newOptions;
                    AppState.currentOutlineType = 'A'; // 重置为方案A
                    
                    renderCurrentOutline();
                    addMessage('✨ 全新的课程大纲已生成！您可以查看新方案或继续切换查看。');
                }, 1500);
            });
            
            // 初始渲染
            renderCurrentOutline();
        }

                 // 绑定大纲卡片事件
        function bindOutlineCardEvents(cardElement) {
            const selectBtn = cardElement.querySelector('.outline-select-btn');
            const previewBtn = cardElement.querySelector('.outline-preview-btn');
            
            if (selectBtn) {
                selectBtn.addEventListener('click', (e) => {
                    const option = e.target.getAttribute('data-option');
                    handleOutlineSelection(option);
                });
            }
            
            if (previewBtn) {
                previewBtn.addEventListener('click', (e) => {
                    const option = e.target.getAttribute('data-option');
                    handleOutlinePreview(option);
                });
            }
        }

        // 处理大纲选择
        function handleOutlineSelection(option) {
            const selectedOutline = option === 'A' ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
            const outlineType = option === 'A' ? '标准流程型' : '基于任务的实践型';
            
            // 显示方案确认对话框
            showOutlineConfirmDialog(option, selectedOutline, outlineType);
        }

        // 显示方案确认对话框
        function showOutlineConfirmDialog(option, selectedOutline, outlineType) {
            // 获取方案特点描述
            const outlineFeatures = getOutlineFeatures(option, outlineType);
            
            // 创建确认对话框
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-${option === 'A' ? 'blue' : 'green'}-100 dark:bg-${option === 'A' ? 'blue' : 'green'}-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-${option === 'A' ? 'list' : 'tasks'} text-${option === 'A' ? 'blue' : 'green'}-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">确认选择方案${option}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${outlineType}大纲</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>方案特点总结
                            </h4>
                            <div class="space-y-2 text-sm">
                                ${outlineFeatures.map(feature => `
                                    <div class="flex items-start space-x-2">
                                        <div class="w-1.5 h-1.5 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-gray-700 dark:text-gray-300">${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                                <span class="text-sm text-blue-700 dark:text-blue-300">
                                    选择后将保存该方案并跳转到课程创建页面
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-xs text-gray-500 dark:text-gray-400 mb-6">
                            <div class="flex justify-between">
                                <span>章节数量：</span>
                                <span class="font-medium">${selectedOutline.length}个章节</span>
                            </div>
                            <div class="flex justify-between">
                                <span>适用对象：</span>
                                <span class="font-medium">${getTargetAudience(option)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>学习方式：</span>
                                <span class="font-medium">${getLearningStyle(option)}</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelSelection" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>重新选择
                            </button>
                            <button id="confirmSelection" class="flex-1 px-4 py-3 bg-${option === 'A' ? 'blue' : 'green'}-500 hover:bg-${option === 'A' ? 'blue' : 'green'}-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-check mr-2"></i>确认选择
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // 绑定事件
            document.getElementById('cancelSelection').addEventListener('click', () => {
                confirmModal.remove();
            });
            
            document.getElementById('confirmSelection').addEventListener('click', () => {
                confirmModal.remove();
                
                // 执行原有的选择逻辑
                AppState.selectedOutline = selectedOutline;
                AppState.selectedOutlineType = option;
                
                addMessage(`✅ 您选择了方案${option}：${outlineType}大纲。正在跳转到课程创建页面...`, true);
                
                setTimeout(() => {
                    // 保存选择的大纲数据到sessionStorage，以便在course-creation页面使用
                    const courseData = {
                        selectedOutline: selectedOutline,
                        selectedOutlineType: option,
                        outlineTypeName: outlineType,
                        detailedRequirements: AppState.detailedRequirements || {},
                        currentOutlineOptions: AppState.currentOutlineOptions || {}
                    };
                    
                    sessionStorage.setItem('courseData', JSON.stringify(courseData));
                    
                    // 跳转到课程创建页面
                    window.location.href = 'course-creation.html';
                }, 800);
            });
            
            // 点击背景关闭
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.remove();
                }
            });
        }

        // 获取方案特点描述
        function getOutlineFeatures(option, outlineType) {
            const features = {
                'A': [
                    '系统性学习路径：从基础概念到高级应用，循序渐进',
                    '理论与实践结合：既有概念讲解，也有操作演示',
                    '标准化流程：适合企业培训和规范化教学',
                    '知识体系完整：涵盖核心功能的全面讲解',
                    '易于理解掌握：适合初学者建立完整知识框架'
                ],
                'B': [
                    '任务驱动学习：通过实际工作场景学习应用',
                    '即学即用：每个模块都对应具体工作任务',
                    '实操性强：重点在于实际操作和问题解决',
                    '贴近工作实际：学完即可在工作中直接应用',
                    '学习效果明显：能够快速提升实际工作能力'
                ],
                'C': [
                    '分层递进设计：从基础到精通的四个层次',
                    '能力层级清晰：每层都有明确的能力目标',
                    '循序渐进学习：符合认知规律的学习路径',
                    '全面技能覆盖：从基础操作到高级分析',
                    '长期学习规划：适合系统性能力提升'
                ],
                'D': [
                    '场景化教学：基于真实工作场景设计',
                    '情境学习法：在具体情境中掌握知识技能',
                    '实战导向：每个场景都是实际工作情况',
                    '问题解决能力：培养实际问题的处理能力',
                    '学以致用：学习内容直接对应工作需求'
                ]
            };
            
            return features[option] || features['A'];
        }

        // 获取目标受众
        function getTargetAudience(option) {
            const audiences = {
                'A': '新员工、初学者',
                'B': '有基础的实操人员',
                'C': '希望系统提升的员工',
                'D': '需要解决具体问题的员工'
            };
            return audiences[option] || audiences['A'];
        }

        // 获取学习方式
        function getLearningStyle(option) {
            const styles = {
                'A': '理论+实操结合',
                'B': '任务驱动实践',
                'C': '分层递进学习',
                'D': '场景化应用'
            };
            return styles[option] || styles['A'];
        }

        // 处理大纲预览
        function handleOutlinePreview(option) {
            const selectedOutline = option === 'A' ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
            const outlineType = option === 'A' ? '标准流程型' : '基于任务的实践型';
            
            addMessage(`正在为您展示方案${option}的详细预览与编辑界面...`);
            
            setTimeout(() => {
                showOutlineEditModal(selectedOutline, outlineType, option);
            }, 800);
        }

        // 显示可编辑的大纲模态框
        function showOutlineEditModal(outline, type, option) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- 模态框头部 -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-${option === 'A' ? 'list' : 'tasks'} text-white text-base"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">方案${option}：${type}大纲</h3>
                                <p class="text-base text-gray-500 dark:text-gray-400">预览与微调编辑</p>
                            </div>
                        </div>
                        <button class="modal-close p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <i class="fas fa-times text-gray-500 dark:text-gray-400 text-base"></i>
                        </button>
                    </div>

                    <!-- 模态框内容 -->
                    <div class="flex flex-1 overflow-hidden">
                        <!-- 左侧：大纲编辑区域 -->
                        <div class="flex-1 min-w-0 p-6 overflow-y-auto custom-scrollbar">
                            <div class="mb-4 flex items-center justify-between">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">课程大纲</h4>
                                <button id="addChapterBtn" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-1"></i>添加章节
                                </button>
                            </div>
                            <div id="editableOutlineContent" class="space-y-4">
                                <!-- 可编辑大纲内容将在这里生成 -->
                            </div>
                        </div>
                        
                        <!-- 右侧：设置区域 -->
                        <div class="w-80 min-w-80 p-6 overflow-y-auto bg-gray-50 dark:bg-gray-750 border-l border-gray-200 dark:border-gray-700 custom-scrollbar">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">课程设置</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">课程时长</label>
                                    <select id="editCourseDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                        <option value="1-2">1-2小时</option>
                                        <option value="2-4" selected>2-4小时</option>
                                        <option value="4-8">4-8小时</option>
                                        <option value="1-day">1天</option>
                                        <option value="2-days">2天</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">难度级别</label>
                                    <select id="editCourseDifficulty" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                        <option value="beginner" selected>入门级</option>
                                        <option value="intermediate">中级</option>
                                        <option value="advanced">高级</option>
                                        <option value="expert">专家级</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">教学方式</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editTheory" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">理论讲解</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editPractice" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">实操演示</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editExercise" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">随堂练习</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editCase" class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">案例分析</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">其他需求</label>
                                    <textarea id="editOtherRequirements" placeholder="请输入其他特殊需求..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 模态框底部 -->
                    <div class="flex items-center justify-between p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            可以编辑章节标题、小节内容，拖拽调整顺序
                        </div>
                        <div class="flex space-x-3">
                            <button class="modal-close px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                                取消
                            </button>
                            <button id="confirmEditedOutline" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors" data-option="${option}">
                                <i class="fas fa-check mr-1"></i>确认选择
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // 生成可编辑的大纲内容
            generateEditableOutlineContent(outline, option);
            
            // 绑定事件
            bindEditModalEvents(modal, option);
        }
        
        // 生成可编辑的大纲内容
        function generateEditableOutlineContent(outline, option) {
            const container = document.getElementById('editableOutlineContent');
            const color = option === 'A' ? 'blue' : 'green';
            
            container.innerHTML = outline.map((chapter, chapterIndex) => `
                <div class="chapter-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 group" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-3 mb-3">
                        <div class="w-8 h-8 bg-${color}-100 dark:bg-${color}-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-${color}-600 dark:text-${color}-400 font-semibold text-sm">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" value="${chapter.title}" class="chapter-title w-full font-medium text-gray-900 dark:text-white bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="章节标题">
                        </div>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="添加小节">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除章节">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                            <div class="drag-handle p-1 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="拖拽排序">
                                <i class="fas fa-grip-vertical text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="sections-container ml-11 space-y-2">
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section" data-section-index="${sectionIndex}">
                                <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                <input type="text" value="${section}" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="小节内容">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="删除小节">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            // 初始化拖拽功能
            initDragAndDrop();
            // 绑定编辑事件
            bindEditEvents();
        }
        
        // 绑定编辑模态框事件
        function bindEditModalEvents(modal, option) {
            // 关闭事件
            modal.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.style.overflow = 'auto';
                });
            });
            
            // 确认选择事件
            const confirmBtn = modal.querySelector('#confirmEditedOutline');
            confirmBtn.addEventListener('click', () => {
                const editedOutline = getEditedOutlineData();
                const settings = getEditedSettings();
                
                // 保存编辑后的大纲数据
                if (option === 'A') {
                    AppState.currentOutlineOptions.optionA = editedOutline;
                } else {
                    AppState.currentOutlineOptions.optionB = editedOutline;
                }
                
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
                
                // 显示编辑后方案的确认对话框
                const outlineType = option === 'A' ? '标准流程型' : '基于任务的实践型';
                showEditedOutlineConfirmDialog(option, editedOutline, outlineType, settings);
            });
        }

        // 显示编辑后方案的确认对话框
        function showEditedOutlineConfirmDialog(option, editedOutline, outlineType, settings) {
            // 获取编辑后的方案特点
            const editedFeatures = getEditedOutlineFeatures(editedOutline, settings);
            
            // 创建确认对话框
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-${option === 'A' ? 'blue' : 'green'}-100 dark:bg-${option === 'A' ? 'blue' : 'green'}-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-edit text-${option === 'A' ? 'blue' : 'green'}-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">确认选择编辑后的方案${option}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${outlineType}大纲（已自定义编辑）</p>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 mb-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-magic text-orange-500"></i>
                                <span class="font-medium text-orange-700 dark:text-orange-300">您的自定义修改</span>
                            </div>
                            <div class="text-sm text-orange-700 dark:text-orange-300">
                                基于原方案进行了个性化编辑，更符合您的具体需求
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-list-check text-${option === 'A' ? 'blue' : 'green'}-500 mr-2"></i>编辑后方案总结
                            </h4>
                            <div class="space-y-3">
                                ${editedFeatures.map(feature => `
                                    <div class="flex items-start space-x-2">
                                        <div class="w-1.5 h-1.5 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-sm text-gray-700 dark:text-gray-300">${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">章节数量</div>
                                <div class="font-medium text-gray-900 dark:text-white">${editedOutline.chapters ? editedOutline.chapters.length : editedOutline.length || 0}个章节</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">课程时长</div>
                                <div class="font-medium text-gray-900 dark:text-white">${getDurationText(settings.duration || '2-4')}</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-6">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                                <span class="text-sm text-blue-700 dark:text-blue-300">
                                    确认后将保存您的个性化方案并跳转到课程创建页面
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelEditedSelection" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>继续编辑
                            </button>
                            <button id="confirmEditedSelection" class="flex-1 px-4 py-3 bg-${option === 'A' ? 'blue' : 'green'}-500 hover:bg-${option === 'A' ? 'blue' : 'green'}-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-check mr-2"></i>确认选择
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // 绑定事件
            document.getElementById('cancelEditedSelection').addEventListener('click', () => {
                confirmModal.remove();
                // 可以在这里重新打开编辑模态框，但现在先简单关闭
            });
            
            document.getElementById('confirmEditedSelection').addEventListener('click', () => {
                confirmModal.remove();
                
                // 执行原有的选择逻辑
                addMessage(`✅ 您已确认选择方案${option}：${outlineType}大纲（已编辑）。正在跳转到课程创建页面...`, true);
                
                setTimeout(() => {
                    // 保存选择的大纲数据到sessionStorage，以便在course-creation页面使用
                    const courseData = {
                        selectedOutline: editedOutline,
                        selectedOutlineType: option,
                        outlineTypeName: outlineType,
                        detailedRequirements: AppState.detailedRequirements || {},
                        currentOutlineOptions: AppState.currentOutlineOptions || {},
                        editedSettings: settings || {}
                    };
                    
                    sessionStorage.setItem('courseData', JSON.stringify(courseData));
                    
                    // 跳转到课程创建页面
                    window.location.href = 'course-creation.html';
                }, 800);
            });
            
            // 点击背景关闭
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.remove();
                }
            });
        }

        // 获取编辑后方案的特点
        function getEditedOutlineFeatures(editedOutline, settings) {
            const features = [];
            
            // 安全获取章节数量
            const chapterCount = editedOutline.chapters ? editedOutline.chapters.length : (editedOutline.length || 0);
            
            // 基于章节数量
            if (chapterCount <= 3) {
                features.push('精简高效：内容紧凑，重点突出，适合快速学习');
            } else if (chapterCount <= 5) {
                features.push('结构合理：章节安排适中，学习节奏舒适');
            } else {
                features.push('内容丰富：涵盖面广泛，知识体系完整深入');
            }
            
            // 基于设置
            const difficulty = settings ? settings.difficulty : 'intermediate';
            if (difficulty === 'beginner') {
                features.push('入门友好：内容由浅入深，适合零基础学员');
            } else if (difficulty === 'intermediate') {
                features.push('进阶提升：适合有一定基础的学员深入学习');
            } else if (difficulty === 'advanced') {
                features.push('高级专业：内容深度较大，适合资深人员');
            }
            
            // 基于教学方式
            const teachingMethods = [];
            if (settings && settings.theory) teachingMethods.push('理论讲解');
            if (settings && settings.practice) teachingMethods.push('实操演示');
            if (settings && settings.exercise) teachingMethods.push('随堂练习');
            if (settings && settings.case) teachingMethods.push('案例分析');
            
            if (teachingMethods.length > 0) {
                features.push(`多元化教学：结合${teachingMethods.join('、')}等方式`);
            } else {
                // 提供默认的教学方式描述
                features.push('多元化教学：理论与实践相结合');
            }
            
            // 基于时长
            const duration = settings ? settings.duration : '2-4';
            if (duration === '1-2') {
                features.push('短时高效：1-2小时快速掌握核心要点');
            } else if (duration === '2-4') {
                features.push('适中时长：2-4小时系统学习，时间安排合理');
            } else if (duration && duration.includes('day')) {
                features.push('深度培训：全天或多天深入学习，内容扎实');
            }
            
            // 个性化特点
            features.push('个性化定制：根据您的具体需求调整优化');
            
            return features;
        }


        
        // 绑定编辑事件
        function bindEditEvents() {
            // 添加小节按钮
            document.querySelectorAll('.add-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const chapterItem = btn.closest('.chapter-item');
                    addNewSection(chapterItem);
                });
            });
            
            // 删除章节按钮
            document.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const chapterItem = btn.closest('.chapter-item');
                    if (confirm('确定要删除这个章节吗？')) {
                        chapterItem.remove();
                        updateChapterNumbers();
                    }
                });
            });
            
            // 删除小节按钮
            document.querySelectorAll('.delete-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sectionItem = btn.closest('.section-item');
                    sectionItem.remove();
                    updateSectionNumbers();
                });
            });
        }
        
        // 添加新章节
        function addNewChapter(option) {
            const container = document.getElementById('editableOutlineContent');
            const chapterIndex = container.children.length;
            const color = option === 'A' ? 'blue' : 'green';
            
            const newChapter = document.createElement('div');
            newChapter.className = 'chapter-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 group';
            newChapter.dataset.chapterIndex = chapterIndex;
            newChapter.innerHTML = `
                <div class="flex items-start space-x-3 mb-3">
                    <div class="w-8 h-8 bg-${color}-100 dark:bg-${color}-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-${color}-600 dark:text-${color}-400 font-semibold text-sm">${chapterIndex + 1}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <input type="text" value="新章节" class="chapter-title w-full font-medium text-gray-900 dark:text-white bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="章节标题">
                    </div>
                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="添加小节">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                        <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="删除章节">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                        <div class="drag-handle p-1 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="拖拽排序">
                            <i class="fas fa-grip-vertical text-xs"></i>
                        </div>
                    </div>
                </div>
                <div class="sections-container ml-11 space-y-2">
                    <div class="section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section" data-section-index="0">
                        <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.1</span>
                        <input type="text" value="新内容" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="小节内容">
                        <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="删除小节">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newChapter);
            bindEditEvents();
            updateChapterNumbers();
            
            // 聚焦到新章节标题
            newChapter.querySelector('.chapter-title').focus();
            newChapter.querySelector('.chapter-title').select();
        }
        
        // 添加新小节
        function addNewSection(chapterItem) {
            const sectionsContainer = chapterItem.querySelector('.sections-container');
            const chapterIndex = Array.from(chapterItem.parentNode.children).indexOf(chapterItem);
            const sectionIndex = sectionsContainer.children.length;
            const option = document.getElementById('confirmEditedOutline').dataset.option;
            const color = option === 'A' ? 'blue' : 'green';
            
            const newSection = document.createElement('div');
            newSection.className = 'section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section';
            newSection.dataset.sectionIndex = sectionIndex;
            newSection.innerHTML = `
                <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.${sectionIndex + 1}</span>
                <input type="text" value="新内容" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="小节内容">
                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="删除小节">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            
            sectionsContainer.appendChild(newSection);
            bindEditEvents();
            updateSectionNumbers();
            
            // 聚焦到新小节
            newSection.querySelector('.section-title').focus();
            newSection.querySelector('.section-title').select();
        }
        
        // 更新章节编号
        function updateChapterNumbers() {
            const chapters = document.querySelectorAll('.chapter-item');
            chapters.forEach((chapter, index) => {
                const numberSpan = chapter.querySelector('.w-8 span');
                if (numberSpan) {
                    numberSpan.textContent = index + 1;
                }
                chapter.dataset.chapterIndex = index;
                updateSectionNumbers(chapter);
            });
        }
        
        // 更新小节编号
        function updateSectionNumbers(chapterItem = null) {
            const chapters = chapterItem ? [chapterItem] : document.querySelectorAll('.chapter-item');
            chapters.forEach((chapter, chapterIndex) => {
                if (!chapterItem) {
                    chapterIndex = Array.from(chapter.parentNode.children).indexOf(chapter);
                }
                const sections = chapter.querySelectorAll('.section-item');
                sections.forEach((section, sectionIndex) => {
                    const numberSpan = section.querySelector('.text-xs.font-mono');
                    if (numberSpan) {
                        numberSpan.textContent = `${chapterIndex + 1}.${sectionIndex + 1}`;
                    }
                    section.dataset.sectionIndex = sectionIndex;
                });
            });
        }
        
        // 初始化拖拽功能
        function initDragAndDrop() {
            let draggedElement = null;
            
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    draggedElement = handle.closest('.chapter-item');
                    draggedElement.draggable = true;
                    draggedElement.style.opacity = '0.5';
                });
            });
            
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item) {
                        const rect = item.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        if (e.clientY < midpoint) {
                            item.parentNode.insertBefore(draggedElement, item);
                        } else {
                            item.parentNode.insertBefore(draggedElement, item.nextSibling);
                        }
                    }
                });
                
                item.addEventListener('dragend', () => {
                    if (draggedElement) {
                        draggedElement.style.opacity = '1';
                        draggedElement.draggable = false;
                        draggedElement = null;
                        updateChapterNumbers();
                    }
                });
            });
        }
        
        // 获取编辑后的大纲数据
        function getEditedOutlineData() {
            const chapters = [];
            const chapterItems = document.querySelectorAll('.chapter-item');
            
            if (chapterItems.length === 0) {
                // 如果没有找到章节项，返回默认结构
                return {
                    chapters: [
                        {
                            title: '第一章 基础知识',
                            sections: ['基础概念', '核心原理']
                        }
                    ]
                };
            }
            
            chapterItems.forEach(chapterItem => {
                const titleInput = chapterItem.querySelector('.chapter-title');
                const title = titleInput ? titleInput.value : '';
                const sections = [];
                
                chapterItem.querySelectorAll('.section-title').forEach(sectionInput => {
                    if (sectionInput.value && sectionInput.value.trim()) {
                        sections.push(sectionInput.value.trim());
                    }
                });
                
                if (title.trim()) {
                    chapters.push({
                        title: title.trim(),
                        sections: sections.length > 0 ? sections : ['内容小节']
                    });
                }
            });
            
            return {
                chapters: chapters.length > 0 ? chapters : [
                    {
                        title: '第一章 基础知识',
                        sections: ['基础概念', '核心原理']
                    }
                ]
            };
        }
        
        // 获取编辑后的设置
        function getEditedSettings() {
            // 安全获取设置值，提供默认值
            const getDuration = () => {
                const el = document.getElementById('editCourseDuration');
                return el ? el.value : '2-4';
            };
            
            const getDifficulty = () => {
                const el = document.getElementById('editCourseDifficulty');
                return el ? el.value : 'intermediate';
            };
            
            const getChecked = (id) => {
                const el = document.getElementById(id);
                return el ? el.checked : false;
            };
            
            const getTextValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            
            return {
                duration: getDuration(),
                difficulty: getDifficulty(),
                theory: getChecked('editTheory'),
                practice: getChecked('editPractice'),
                exercise: getChecked('editExercise'),
                case: getChecked('editCase'),
                otherRequirements: getTextValue('editOtherRequirements')
            };
        }

        // 处理用户输入
        function handleUserInput() {
            const message = elements.messageInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            elements.messageInput.value = '';
            
            // 根据当前步骤处理不同逻辑
            setTimeout(() => {
                if (AppState.currentStep === 1) {
                    handleCourseTopicInput(message);
                } else if (AppState.isCollectingRequirements) {
                    // 在需求收集阶段，可以通过文本回答
                    handleTextAnswerDuringCollection(message);
                }
            }, 500);
        }

        // 处理需求收集阶段的文本回答
        function handleTextAnswerDuringCollection(message) {
            // 用户可以通过文本回答当前问题
            addMessage('收到您的回答！让我为您匹配最合适的选项，或者您也可以点击上面的选项按钮。');
        }

        // 处理课程主题输入
        function handleCourseTopicInput(topic) {
            AppState.courseTitle = topic;
            
            // 初始化逐步收集的状态
            AppState.detailedRequirements = {
                duration: '',
                chapterCount: '',
                difficulty: '',
                teachingMethods: {},
                assessment: {},
                audience: {},
                deliveryFormat: '',
                specialRequirements: ''
            };
            AppState.currentQuestionStep = 1;
            
            addMessage(`好的，"${topic}"，这个主题非常棒！`);
            
            setTimeout(() => {
                addMessage('为了为您量身定制最合适的课程，我需要再了解几个关键信息。让我们一步一步来：');
                
                setTimeout(() => {
                    startStepByStepRequirements();
                }, 800);
            }, 1000);
        }

        // 初始化聊天内的文件上传
        function initChatFileUpload(cardElement) {
            if (!cardElement) return;
            
            const uploadArea = cardElement.querySelector('#chatUploadArea');
            const uploadedFiles = cardElement.querySelector('#chatUploadedFiles');
            const skipButton = cardElement.querySelector('#skipUpload');
            
            if (!uploadArea) return;
            
            // 点击上传
            uploadArea.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            // 跳过上传
            skipButton.addEventListener('click', () => {
                addMessage('好的，我们直接开始生成完整的课程内容。基于您确认的大纲和详细需求，我将为您创建专业的课程。');
                
                setTimeout(() => {
                    startFinalCourseGeneration();
                }, 1000);
            });
            
            // 文件选择
            const handleChatFiles = (event) => {
                const files = Array.from(event.target.files);
                
                files.forEach(file => {
                    if (AppState.uploadedFiles.find(f => f.name === file.name)) return;
                    
                    AppState.uploadedFiles.push(file);
                    addChatFileToUI(file, uploadedFiles);
                });
                
                if (AppState.uploadedFiles.length > 0) {
                    setTimeout(() => {
                        processChatUploadedFiles(cardElement);
                    }, 1000);
                }
            };
            
            elements.fileInput.addEventListener('change', handleChatFiles);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'dark:border-blue-500');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'dark:border-blue-500');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'dark:border-blue-500');
                handleChatFiles({ target: { files: e.dataTransfer.files } });
            });
        }

        // 添加文件到聊天UI
        function addChatFileToUI(file, container) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-500';
            
            const fileTypeIcons = {
                'pdf': 'fas fa-file-pdf text-red-500',
                'doc': 'fas fa-file-word text-blue-500',
                'docx': 'fas fa-file-word text-blue-500',
                'ppt': 'fas fa-file-powerpoint text-orange-500',
                'pptx': 'fas fa-file-powerpoint text-orange-500'
            };
            
            const extension = file.name.split('.').pop().toLowerCase();
            const iconClass = fileTypeIcons[extension] || 'fas fa-file text-gray-500';
            
            fileDiv.innerHTML = `
                <i class="${iconClass} text-sm"></i>
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-gray-900 dark:text-white text-sm truncate">${file.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
                <button class="text-gray-400 hover:text-red-500 transition-colors text-sm" onclick="removeChatFile('${file.name}', this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(fileDiv);
        }

        // 移除聊天文件
        function removeChatFile(fileName, buttonElement) {
            AppState.uploadedFiles = AppState.uploadedFiles.filter(f => f.name !== fileName);
            buttonElement.parentElement.remove();
        }

        // 初始化详细需求收集
        function initDetailedRequirements(cardElement) {
            if (!cardElement) return;
            
            const submitBtn = cardElement.querySelector('#submitDetailedRequirements');
            const detailDuration = cardElement.querySelector('#detailDuration');
            const chapterCount = cardElement.querySelector('#chapterCount');
            const customDurationDiv = cardElement.querySelector('#customDurationDiv');
            const customChapterDiv = cardElement.querySelector('#customChapterDiv');
            
            // 处理自定义时长显示/隐藏
            if (detailDuration) {
                detailDuration.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDurationDiv.classList.remove('hidden');
                    } else {
                        customDurationDiv.classList.add('hidden');
                    }
                });
            }
            
            // 处理自定义章节数显示/隐藏
            if (chapterCount) {
                chapterCount.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customChapterDiv.classList.remove('hidden');
                    } else {
                        customChapterDiv.classList.add('hidden');
                    }
                });
            }
            
            // 处理提交按钮
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    handleDetailedRequirementsSubmit(cardElement);
                });
            }
        }

        // 处理详细需求提交
        function handleDetailedRequirementsSubmit(cardElement) {
            const requirements = collectDetailedRequirements(cardElement);
            
            // 保存需求数据到应用状态
            AppState.detailedRequirements = requirements;
            
            // 添加提交反馈
            addMessage('太棒了！我已经收到了您的详细需求信息。让我来为您总结一下：');
            
            setTimeout(() => {
                const summary = generateRequirementsSummary(requirements);
                addMessage(summary, false, true);
                
                setTimeout(() => {
                    const uploadCard = addFileUploadCard();
                    AppState.currentStep = 2;
                    initChatFileUpload(uploadCard);
                }, 1000);
            }, 800);
            
            // 禁用表单，防止重复提交
            const form = cardElement.querySelector('#detailedRequirementsForm');
            if (form) {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';
            }
            
            const submitBtn = cardElement.querySelector('#submitDetailedRequirements');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check mr-3"></i>需求已收集完成';
                submitBtn.disabled = true;
                submitBtn.className = submitBtn.className.replace('from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700', 'bg-green-500');
            }
        }

        // 收集详细需求数据
        function collectDetailedRequirements(cardElement) {
            const getValue = (selector) => {
                const element = cardElement.querySelector(selector);
                return element ? element.value : '';
            };
            
            const getChecked = (selector) => {
                const element = cardElement.querySelector(selector);
                return element ? element.checked : false;
            };
            
            const getRadioValue = (name) => {
                const element = cardElement.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            
            return {
                duration: getValue('#detailDuration') === 'custom' ? getValue('#customDuration') : getValue('#detailDuration'),
                chapterCount: getValue('#chapterCount') === 'custom' ? getValue('#customChapterCount') : getValue('#chapterCount'),
                difficulty: getRadioValue('difficulty'),
                teachingMethods: {
                    theory: getChecked('#includeTheory'),
                    practice: getChecked('#includePractice'),
                    cases: getChecked('#includeCases'),
                    group: getChecked('#includeGroup')
                },
                assessment: {
                    quiz: getChecked('#includeQuiz'),
                    assignment: getChecked('#includeAssignment'),
                    project: getChecked('#includeProject'),
                    feedback: getChecked('#includeFeedback')
                },
                audience: {
                    size: getValue('#audienceSize'),
                    background: getValue('#audienceBackground')
                },
                deliveryFormat: getRadioValue('deliveryFormat'),
                specialRequirements: getValue('#specialRequirements')
            };
        }

        // 生成需求总结
        function generateRequirementsSummary(requirements) {
            let summary = '<div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 rounded-xl p-8 space-y-5">';
            summary += '<h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6"><i class="fas fa-clipboard-check text-blue-500 mr-3"></i>课程需求总结报告</h4>';
            
            // 第一部分：课程的"灵魂"
            summary += '<div class="border-l-4 border-blue-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">📋 第一部分：课程的"灵魂"（目标与学员）</h5>';
            
            if (requirements.coreGoal) {
                const goalText = requirements.coreGoal.length > 50 ? requirements.coreGoal : getCoreGoalDisplayText(requirements.coreGoal);
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-bullseye text-blue-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>核心目标：</strong>${goalText}</span></div>`;
            }
            
            if (requirements.learnerPersona) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-users text-purple-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>学员画像：</strong>${getLearnerPersonaDisplayText(requirements.learnerPersona)}</span></div>`;
            }
            summary += '</div>';
            
            // 第二部分：课程的"血肉"
            summary += '<div class="border-l-4 border-green-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">🎨 第二部分：课程的"血肉"（内容与交互）</h5>';
            
            if (requirements.contentSource) {
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-book text-green-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>内容来源：</strong>${getContentSourceDisplayText(requirements.contentSource)}</span></div>`;
            }
            
            if (requirements.teachingActivities && Object.keys(requirements.teachingActivities).length > 0) {
                const selectedActivities = Object.entries(requirements.teachingActivities)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => getTeachingActivityDisplayText(key));
                if (selectedActivities.length > 0) {
                    summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-chalkboard-teacher text-orange-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>教学活动：</strong>${selectedActivities.join('、')}</span></div>`;
                }
            }
            
            if (requirements.assessmentMethod) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-clipboard-check text-red-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>评估方式：</strong>${getAssessmentMethodDisplayText(requirements.assessmentMethod)}</span></div>`;
            }
            summary += '</div>';
            
            // 第三部分：课程的"规则"
            summary += '<div class="border-l-4 border-yellow-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">⚙️ 第三部分：课程的"规则"（交付与管理）</h5>';
            
            if (requirements.certification) {
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-certificate text-yellow-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>认证要求：</strong>${getCertificationDisplayText(requirements.certification)}</span></div>`;
            }
            
            if (requirements.managementLevel) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-cogs text-indigo-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>管理严格度：</strong>${getManagementLevelDisplayText(requirements.managementLevel)}</span></div>`;
            }
            summary += '</div>';
            
            // AI智能建议
            summary += '<div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
            summary += '<h6 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i>AI智能建议</h6>';
            summary += '<p class="text-sm text-gray-600 dark:text-gray-400">基于您的需求，我将为您生成符合专业教学设计原则的课程大纲，确保每个环节都能有效达成您设定的学习目标。</p>';
            summary += '</div>';
            
            summary += '</div>';
            return summary;
        }

        // 显示文本转换函数
        function getCoreGoalDisplayText(goal) {
            const goalMap = {
                'workflow': '独立完成标准化的工作流程',
                'tool-usage': '熟练使用特定工具或系统',
                'problem-solving': '解决某类专业问题',
                'skill-mastery': '掌握特定技能或方法'
            };
            return goalMap[goal] || goal;
        }

        function getLearnerPersonaDisplayText(persona) {
            const personaMap = {
                'new-employee': '刚入职的新员工，零基础或基础薄弱',
                'junior-employee': '工作1-3年的初级员工，有基本了解',
                'mid-employee': '工作3-5年的中级员工，懂理论缺实战',
                'senior-employee': '工作5年以上的资深员工，需要更新知识',
                'management': '管理层人员，需要全局性理解',
                'expert': '技术专家，需要深度专业知识'
            };
            return personaMap[persona] || persona;
        }

        function getContentSourceDisplayText(source) {
            const sourceMap = {
                'existing-materials': '现成的文档/PPT/视频资料',
                'external-links': '外部网站、文章或视频',
                'ai-creation': 'AI从零开始创作',
                'hybrid-content': '混合方式（现有资料 + AI创作）'
            };
            return sourceMap[source] || source;
        }

        function getTeachingActivityDisplayText(activity) {
            const activityMap = {
                'video-lecture': '视频讲解',
                'article-reading': '文章阅读',
                'case-analysis': '案例分析',
                'group-discussion': '小组讨论',
                'hands-on-practice': '实操练习',
                'guest-sharing': '嘉宾分享',
                'role-playing': '角色扮演'
            };
            return activityMap[activity] || activity;
        }

        function getAssessmentMethodDisplayText(method) {
            const methodMap = {
                'frequent-tests': '每个重要知识点后都有小练习',
                'final-exam': '期末综合性考试',
                'project-assessment': '通过实际项目检验学习成果',
                'no-assessment': '非考核的自学课程'
            };
            return methodMap[method] || method;
        }

        function getCertificationDisplayText(cert) {
            const certMap = {
                'formal-certificate': '正式的结业证书',
                'completion-record': '学习记录和完成证明',
                'no-certification': '无需任何凭证'
            };
            return certMap[cert] || cert;
        }

        function getManagementLevelDisplayText(level) {
            const levelMap = {
                'strict-management': '严格管理，正式必修课程',
                'moderate-management': '适度管理，允许灵活学习',
                'flexible-learning': '不需要管理，自由探索'
            };
            return levelMap[level] || level;
        }

        // 处理聊天上传的文件
        function processChatUploadedFiles(cardElement) {
            addMessage('收到！文件已上传。我正在快速"阅读"和"消化"它们，请稍等片刻...');
            
            setTimeout(() => {
                addMessage(`📄 文件分析完成！<br/>
                    ${AppState.uploadedFiles.map(file => `✅ ${file.name}: 内容清晰，质量很高。`).join('<br/>')}<br/><br/>
                    素材非常完美！现在让我汇报一下分析结果。`, false, true);
                
                setTimeout(() => {
                    // 显示需求分析汇报
                    showRequirementAnalysisReport();
                }, 1500);
            }, 2000);
        }

        // 显示需求分析汇报
        function showRequirementAnalysisReport() {
            addMessage('📊 让我向您汇报分析结果：');
            
            setTimeout(() => {
                // 生成需求分析报告卡片
                const analysisReport = generateRequirementAnalysisReport();
                const reportCard = addMessage(analysisReport, false, true, true);
                
                // 初始化报告确认按钮
                initAnalysisReportActions(reportCard);
            }, 800);
        }

        // 生成需求分析报告
        function generateRequirementAnalysisReport() {
            const requirements = AppState.detailedRequirements || {};
            const uploadedFilesInfo = AppState.uploadedFiles || [];
            
            // 分析用户需求
            const analysisData = analyzeUserRequirements(requirements, uploadedFilesInfo);
            
            return `
                <div class="p-4 max-w-3xl mx-auto">
                    <!-- 标题区域 -->
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-chart-line text-blue-500 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">需求分析报告</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">基于您的详细需求和上传资料的深度分析</p>
                    </div>
                    
                    <!-- 主要内容网格 -->
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- 课程目标分析 -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-bullseye text-blue-500 mr-2 text-sm"></i>课程目标分析
                            </h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>主题：</strong>${AppState.courseTitle || '专业技能培训'}
                                    </span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>目标：</strong>${analysisData.coreGoal}
                                    </span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>学员：</strong>${analysisData.targetLearners}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 教学设计 -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-cogs text-green-500 mr-2 text-sm"></i>教学设计
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.teachingDesign.slice(0,3).map(item => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-green-500 rounded-full"></div>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- 资料分析 -->
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-file-alt text-purple-500 mr-2 text-sm"></i>资料分析
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.materialAnalysis.slice(0,3).map(item => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-500 rounded-full"></div>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- 预期课程特色 -->
                        <div class="bg-gradient-to-br from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-star text-yellow-500 mr-2 text-sm"></i>课程特色
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.courseFeatures.slice(0,3).map(feature => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-yellow-500 rounded-full"></div>
                                        <span>${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 课程规模预估 - 紧凑版 -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center justify-center">
                            <i class="fas fa-ruler text-gray-500 mr-2 text-sm"></i>课程规模预估
                        </h4>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-blue-500">${analysisData.estimatedDuration}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">预计时长</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-green-500">${analysisData.estimatedChapters}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">章节数量</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-purple-500">${analysisData.difficultyLevel}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">难度等级</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-orange-500">${uploadedFilesInfo.length}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">参考资料</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 确认按钮 -->
                    <div class="text-center">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <p class="text-xs text-blue-700 dark:text-blue-300 mb-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                以上是基于您的需求和资料进行的智能分析
                            </p>
                            <p class="text-xs text-blue-600 dark:text-blue-400">
                                确认无误后，我将为您生成对应的课程大纲方案
                            </p>
                        </div>
                        
                        <div class="flex justify-center space-x-3">
                            <button id="modifyRequirements" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm">
                                <i class="fas fa-edit mr-1"></i>需要调整
                            </button>
                            <button id="confirmAnalysis" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors text-sm">
                                <i class="fas fa-check mr-1"></i>确认无误，生成大纲
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 分析用户需求
        function analyzeUserRequirements(requirements, uploadedFiles) {
            const analysis = {
                coreGoal: getCoreGoalAnalysis(requirements.coreGoal),
                targetLearners: getTargetLearnersAnalysis(requirements.learnerPersona),
                teachingDesign: getTeachingDesignAnalysis(requirements),
                materialAnalysis: getMaterialAnalysis(uploadedFiles),
                courseFeatures: getCourseFeatures(requirements, uploadedFiles),
                estimatedDuration: getEstimatedDuration(requirements),
                estimatedChapters: getEstimatedChapters(requirements),
                difficultyLevel: getDifficultyLevel(requirements.learnerPersona)
            };
            
            return analysis;
        }

        // 获取核心目标分析
        function getCoreGoalAnalysis(coreGoal) {
            if (!coreGoal) return '帮助学员掌握专业技能，提升工作能力';
            
            if (coreGoal.includes('workflow') || coreGoal.includes('流程')) {
                return '熟练掌握标准化工作流程，提升工作效率';
            } else if (coreGoal.includes('tool-usage') || coreGoal.includes('工具')) {
                return '精通相关工具的使用，能够独立完成日常工作';
            } else if (coreGoal.includes('problem-solving') || coreGoal.includes('解决')) {
                return '培养分析和解决实际问题的能力';
            } else if (coreGoal.includes('skill-mastery') || coreGoal.includes('技能')) {
                return '系统掌握核心技能，达到专业水准';
            }
            
            return coreGoal.length > 50 ? coreGoal.substring(0, 50) + '...' : coreGoal;
        }

        // 获取目标学员分析
        function getTargetLearnersAnalysis(learnerPersona) {
            const personas = {
                'new-employee': '新入职员工（零基础或基础薄弱）',
                'junior-employee': '初级员工（工作1-3年，有基本了解）',
                'mid-employee': '中级员工（工作3-5年，懂理论缺实战）',
                'senior-employee': '资深员工（工作5年以上，需要更新知识）',
                'management': '管理层人员（需要全局性理解）',
                'expert': '技术专家（需要深度专业知识）'
            };
            
            return personas[learnerPersona] || '各层级员工，根据不同基础分层教学';
        }

        // 获取教学设计分析
        function getTeachingDesignAnalysis(requirements) {
            const designs = [];
            
            if (requirements.teachingActivities) {
                if (requirements.teachingActivities['interactive-lecture']) {
                    designs.push('互动式讲解，增强参与度');
                }
                if (requirements.teachingActivities['hands-on-practice']) {
                    designs.push('实操练习为主，边学边做');
                }
                if (requirements.teachingActivities['case-analysis']) {
                    designs.push('案例分析驱动，贴近实际');
                }
                if (requirements.teachingActivities['group-discussion']) {
                    designs.push('小组讨论交流，促进思考');
                }
                if (requirements.teachingActivities['role-playing']) {
                    designs.push('角色扮演模拟，情境化学习');
                }
            }
            
            if (designs.length === 0) {
                designs.push('理论与实践相结合');
                designs.push('循序渐进的学习路径');
                designs.push('多元化教学方法');
            }
            
            return designs;
        }

        // 获取资料分析
        function getMaterialAnalysis(uploadedFiles) {
            const analysis = [];
            
            if (uploadedFiles.length === 0) {
                analysis.push('基于AI智能生成内容');
                analysis.push('参考行业最佳实践');
                analysis.push('结合通用业务场景');
            } else {
                analysis.push(`已上传${uploadedFiles.length}个专业资料`);
                
                const fileTypes = uploadedFiles.map(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf', 'doc', 'docx'].includes(ext)) return '文档资料';
                    if (['ppt', 'pptx'].includes(ext)) return 'PPT资料';
                    if (['xls', 'xlsx'].includes(ext)) return '表格数据';
                    return '其他资料';
                });
                
                const uniqueTypes = [...new Set(fileTypes)];
                analysis.push(`包含${uniqueTypes.join('、')}等类型`);
                analysis.push('将深度融入课程设计');
            }
            
            return analysis;
        }

        // 获取课程特色
        function getCourseFeatures(requirements, uploadedFiles) {
            const features = [];
            
            // 基于学员类型确定特色
            if (requirements.learnerPersona === 'new-employee') {
                features.push('零基础友好，循序渐进');
                features.push('大量实例演示和练习');
            } else if (requirements.learnerPersona === 'expert') {
                features.push('高深度专业内容');
                features.push('前沿技术和趋势');
            } else {
                features.push('理论与实践并重');
                features.push('注重实际应用能力');
            }
            
            // 基于教学活动确定特色
            if (requirements.teachingActivities?.['hands-on-practice']) {
                features.push('实操性强，学以致用');
            }
            if (requirements.teachingActivities?.['case-analysis']) {
                features.push('案例丰富，贴近实际');
            }
            
            // 基于上传文件确定特色
            if (uploadedFiles.length > 0) {
                features.push('融入企业实际资料');
                features.push('定制化程度高');
            }
            
            // 确保至少有4个特色
            while (features.length < 4) {
                const additionalFeatures = [
                    '内容体系完整',
                    '学习路径清晰',
                    '互动性强',
                    '可操作性强',
                    '知识点覆盖全面',
                    '实用性强'
                ];
                
                for (const feature of additionalFeatures) {
                    if (!features.includes(feature) && features.length < 4) {
                        features.push(feature);
                    }
                }
            }
            
            return features;
        }

        // 获取预估时长
        function getEstimatedDuration(requirements) {
            if (requirements.learnerPersona === 'new-employee') return '3-4小时';
            if (requirements.learnerPersona === 'expert') return '4-6小时';
            if (requirements.learnerPersona === 'management') return '2-3小时';
            return '2-4小时';
        }

        // 获取预估章节数
        function getEstimatedChapters(requirements) {
            if (requirements.learnerPersona === 'new-employee') return '4-5章';
            if (requirements.learnerPersona === 'expert') return '5-6章';
            if (requirements.learnerPersona === 'management') return '3-4章';
            return '4-5章';
        }

        // 获取难度等级
        function getDifficultyLevel(learnerPersona) {
            if (learnerPersona === 'new-employee') return '入门级';
            if (learnerPersona === 'junior-employee') return '初级';
            if (learnerPersona === 'mid-employee') return '中级';
            if (learnerPersona === 'senior-employee') return '中高级';
            if (learnerPersona === 'management') return '管理级';
            if (learnerPersona === 'expert') return '专家级';
            return '中级';
        }

        // 初始化分析报告操作
        function initAnalysisReportActions(reportCard) {
            const modifyBtn = reportCard.querySelector('#modifyRequirements');
            const confirmBtn = reportCard.querySelector('#confirmAnalysis');
            
            if (modifyBtn) {
                modifyBtn.addEventListener('click', () => {
                    showRequirementAdjustmentInput();
                });
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    addMessage('✅ 分析确认完成！现在基于这些需求为您生成专业的课程大纲方案...', true);
                    
                    setTimeout(() => {
                        generateCourseOutlineFromRequirements();
                    }, 1000);
                });
            }
        }

        // 显示需求调整输入界面
        function showRequirementAdjustmentInput() {
            addMessage('好的，请告诉我您希望调整的具体内容：');
            
            setTimeout(() => {
                const adjustmentInput = generateAdjustmentInputCard();
                const inputCard = addMessage(adjustmentInput, false, true, true);
                
                // 初始化调整输入功能
                initAdjustmentInput(inputCard);
            }, 800);
        }

        // 生成调整输入卡片
        function generateAdjustmentInputCard() {
            return `
                <div class="p-6 max-w-5xl mx-auto">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-edit text-orange-500 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">需求调整</h3>
                        <p class="text-gray-600 dark:text-gray-400">请详细描述您希望调整的内容</p>
                    </div>
                    
                    <!-- 常见调整选项 -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                            <i class="fas fa-list text-blue-500 mr-2"></i>常见调整项目（可点击快速选择）
                        </h4>
                        <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-3">
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="target">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">目标学员调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">修改学员类型、基础水平等</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="duration">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">课程时长调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">增加或减少课程时长</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="difficulty">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">难度等级调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">提高或降低课程难度</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="focus">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">重点内容调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">强调特定功能或技能</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="teaching">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">教学方式调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">改变教学活动和互动方式</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="assessment">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">评估方式调整</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">修改考核和评估方法</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 详细调整说明输入框 -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                            <i class="fas fa-comment-dots text-green-500 mr-2"></i>详细调整说明
                        </h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <textarea 
                                id="adjustmentInput" 
                                class="w-full h-28 p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                                placeholder="请详细描述您希望调整的内容，例如：&#10;• 希望增加更多实操练习环节&#10;• 目标学员改为有2年经验的中级员工&#10;• 课程时长调整为4-6小时&#10;• 重点强调数据分析功能的使用&#10;• 增加团队协作相关的内容"
                                maxlength="500"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-lightbulb mr-1"></i>您也可以点击上方的常见调整项目快速填入
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <span id="charCount">0</span>/500字
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提交按钮 -->
                    <div class="text-center">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-700 dark:text-blue-300 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                我将根据您的调整要求重新分析需求
                            </p>
                            <p class="text-xs text-blue-600 dark:text-blue-400">
                                调整完成后会重新生成分析报告
                            </p>
                        </div>
                        
                        <div class="flex justify-center space-x-4">
                            <button id="cancelAdjustment" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-times mr-2"></i>取消调整
                            </button>
                            <button id="submitAdjustment" class="px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors" disabled>
                                <i class="fas fa-paper-plane mr-2"></i>提交调整要求
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 初始化调整输入功能
        function initAdjustmentInput(inputCard) {
            const textarea = inputCard.querySelector('#adjustmentInput');
            const charCount = inputCard.querySelector('#charCount');
            const submitBtn = inputCard.querySelector('#submitAdjustment');
            const cancelBtn = inputCard.querySelector('#cancelAdjustment');
            const quickBtns = inputCard.querySelectorAll('.adjustment-quick-btn');
            
            // 字符计数和按钮状态控制
            if (textarea && charCount && submitBtn) {
                textarea.addEventListener('input', () => {
                    const length = textarea.value.length;
                    charCount.textContent = length;
                    
                    // 控制提交按钮状态
                    if (length > 10) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                // 自动聚焦
                setTimeout(() => {
                    textarea.focus();
                }, 100);
            }
            
            // 快速选择按钮
            quickBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const suggestions = getAdjustmentSuggestions(type);
                    
                    // 添加到输入框
                    const currentValue = textarea.value;
                    const newValue = currentValue ? `${currentValue}\n• ${suggestions}` : `• ${suggestions}`;
                    textarea.value = newValue;
                    
                    // 触发input事件更新字符计数
                    textarea.dispatchEvent(new Event('input'));
                    
                    // 高亮选中的按钮
                    btn.classList.add('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-blue-900/30');
                    setTimeout(() => {
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-blue-900/30');
                    }, 2000);
                });
            });
            
            // 取消按钮
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    addMessage('已取消调整，保持当前分析结果。');
                });
            }
            
            // 提交按钮
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const adjustmentText = textarea.value.trim();
                    if (adjustmentText.length > 10) {
                        processAdjustmentRequest(adjustmentText);
                    }
                });
            }
        }

        // 获取调整建议文本
        function getAdjustmentSuggestions(type) {
            const suggestions = {
                'target': '目标学员调整为[具体描述，如：有3年工作经验的中级员工]',
                'duration': '课程时长调整为[具体时长，如：4-6小时]',
                'difficulty': '难度等级调整为[具体等级，如：中高级]',
                'focus': '重点强调[具体内容，如：数据分析和报表功能]',
                'teaching': '教学方式调整为[具体方式，如：增加更多实操练习和案例分析]',
                'assessment': '评估方式调整为[具体方式，如：项目实战评估]'
            };
            
            return suggestions[type] || '请描述具体的调整需求';
        }

        // 处理调整请求
        function processAdjustmentRequest(adjustmentText) {
            addMessage('✅ 收到您的调整要求！我正在重新分析和调整需求...', true);
            
            setTimeout(() => {
                // 分析调整内容并更新需求
                updateRequirementsBasedOnAdjustment(adjustmentText);
                
                addMessage('📝 需求调整完成！基于您的要求，我已经更新了分析结果：');
                
                setTimeout(() => {
                    // 重新生成并显示分析报告
                    showRequirementAnalysisReport();
                }, 1000);
            }, 1500);
        }

        // 基于调整内容更新需求
        function updateRequirementsBasedOnAdjustment(adjustmentText) {
            if (!AppState.detailedRequirements) {
                AppState.detailedRequirements = {};
            }
            
            const text = adjustmentText.toLowerCase();
            
            // 分析学员类型调整
            if (text.includes('新员工') || text.includes('新入职') || text.includes('零基础')) {
                AppState.detailedRequirements.learnerPersona = 'new-employee';
            } else if (text.includes('初级') || text.includes('1-3年')) {
                AppState.detailedRequirements.learnerPersona = 'junior-employee';
            } else if (text.includes('中级') || text.includes('3-5年')) {
                AppState.detailedRequirements.learnerPersona = 'mid-employee';
            } else if (text.includes('高级') || text.includes('资深') || text.includes('5年以上')) {
                AppState.detailedRequirements.learnerPersona = 'senior-employee';
            } else if (text.includes('管理') || text.includes('领导')) {
                AppState.detailedRequirements.learnerPersona = 'management';
            } else if (text.includes('专家') || text.includes('技术专家')) {
                AppState.detailedRequirements.learnerPersona = 'expert';
            }
            
            // 分析时长调整
            if (text.includes('1-2小时') || text.includes('1小时') || text.includes('2小时')) {
                AppState.detailedRequirements.duration = '1-2';
            } else if (text.includes('2-4小时') || text.includes('3小时') || text.includes('4小时')) {
                AppState.detailedRequirements.duration = '2-4';
            } else if (text.includes('4-8小时') || text.includes('6小时') || text.includes('8小时')) {
                AppState.detailedRequirements.duration = '4-8';
            } else if (text.includes('1天') || text.includes('一天')) {
                AppState.detailedRequirements.duration = '1-day';
            } else if (text.includes('2天') || text.includes('两天')) {
                AppState.detailedRequirements.duration = '2-days';
            }
            
            // 分析教学活动调整
            if (!AppState.detailedRequirements.teachingActivities) {
                AppState.detailedRequirements.teachingActivities = {};
            }
            
            if (text.includes('实操') || text.includes('动手') || text.includes('练习')) {
                AppState.detailedRequirements.teachingActivities['hands-on-practice'] = true;
            }
            if (text.includes('案例') || text.includes('实例')) {
                AppState.detailedRequirements.teachingActivities['case-analysis'] = true;
            }
            if (text.includes('讨论') || text.includes('交流')) {
                AppState.detailedRequirements.teachingActivities['group-discussion'] = true;
            }
            if (text.includes('角色') || text.includes('模拟')) {
                AppState.detailedRequirements.teachingActivities['role-playing'] = true;
            }
            if (text.includes('互动') || text.includes('讲解')) {
                AppState.detailedRequirements.teachingActivities['interactive-lecture'] = true;
            }
            
            // 记录原始调整文本
            AppState.detailedRequirements.adjustmentRequest = adjustmentText;
        }

        // 开始最终课程生成
        function startFinalCourseGeneration() {
            addMessage('现在开始为您生成完整的课程内容！');
            
            setTimeout(() => {
                addMessage('魔法正在进行中...我将根据您确认的大纲和上传的资料，生成一门专业完整的课程。这个过程大约需要1-2分钟。');
                
                elements.progressArea.classList.remove('hidden');
                AppState.currentStep = 5;
                startCourseGeneration();
            }, 1000);
        }

        // 显示大纲选择
        function showOutlineSelection() {
            let contextMessage = `根据您"${AppState.courseTitle}"的目标`;
            
            // 添加详细需求信息到上下文
            if (AppState.detailedRequirements) {
                const req = AppState.detailedRequirements;
                let details = [];
                
                if (req.duration) details.push(`时长为${getDurationDisplayText(req.duration)}`);
                if (req.chapterCount) details.push(`包含${req.chapterCount}${isNaN(req.chapterCount) ? '' : '个章节'}`);
                if (req.difficulty) details.push(`面向${getDifficultyDisplayText(req.difficulty)}学员`);
                
                if (details.length > 0) {
                    contextMessage += `，以及您要求的${details.join('、')}`;
                }
            }
            
            if (AppState.uploadedFiles.length > 0) {
                contextMessage += `和您提供的${AppState.uploadedFiles.length}个专业文件`;
            }
            
            addMessage(contextMessage + '，我为您精心策划了两种不同风格的课程大纲。这些方案都会充分融入您的详细需求：');
            
            setTimeout(() => {
                const outlineCard = addOutlineSelectionCard();
                AppState.currentStep = 3;
                
                // 初始化聊天内的大纲选择功能
                initChatOutlineSelection(outlineCard);
            }, 1000);
        }

        // 初始化聊天内的大纲选择
        function initChatOutlineSelection(cardElement) {
            if (!cardElement) return;
            
            // 选择方案按钮
            const selectButtons = cardElement.querySelectorAll('.outline-select-btn');
            selectButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedOption = button.dataset.option;
                    AppState.selectedOutline = selectedOption;
                    
                    // 高亮选中的卡片
                    const allCards = cardElement.querySelectorAll('.outline-option-chat');
                    allCards.forEach(card => {
                        card.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                        card.classList.remove('ring-2', 'ring-green-500', 'border-green-500');
                    });
                    
                    const selectedCard = button.closest('.outline-option-chat');
                    if (selectedOption === 'A') {
                        selectedCard.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                    } else {
                        selectedCard.classList.add('ring-2', 'ring-green-500', 'border-green-500');
                    }
                    
                    // 跳转到课程创建页面
                    setTimeout(() => {
                        const courseData = {
                            title: AppState.courseTitle,
                            outline: selectedOption,
                            files: AppState.uploadedFiles.map(f => f.name)
                        };
                        
                        // 将数据存储到sessionStorage
                        sessionStorage.setItem('courseData', JSON.stringify(courseData));
                        
                        // 跳转到新页面
                        window.location.href = 'course-creation.html';
                    }, 500);
                });
            });

            // 预览微调按钮
            const previewButtons = cardElement.querySelectorAll('.outline-preview-btn');
            previewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const option = button.dataset.option;
                    showOutlineModal(option);
                });
            });

            // 重新生成方案按钮
            const regenerateButton = cardElement.querySelector('#regenerateOutlines');
            if (regenerateButton) {
                regenerateButton.addEventListener('click', () => {
                    regenerateOutlineOptions(cardElement);
                });
            }
        }

        // 重新生成大纲方案
        function regenerateOutlineOptions(cardElement) {
            const regenerateButton = cardElement.querySelector('#regenerateOutlines');
            const originalText = regenerateButton.innerHTML;
            
            // 显示加载状态
            regenerateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>生成中...';
            regenerateButton.disabled = true;
            regenerateButton.className = regenerateButton.className.replace('hover:text-blue-600 dark:hover:text-blue-400 hover:border-blue-400 dark:hover:border-blue-500', '');
            
            // 模拟生成过程
            setTimeout(() => {
                // 添加AI消息提示正在重新生成
                addMessage('好的，让我为您重新生成其他的课程大纲方案...');
                
                setTimeout(() => {
                    // 生成新的大纲选择卡片
                    const newOutlineCard = generateAlternativeOutlines();
                    const newCardElement = addMessage(newOutlineCard, false, true, true);
                    
                    // 隐藏原卡片
                    cardElement.style.opacity = '0.3';
                    cardElement.style.pointerEvents = 'none';
                    
                    // 初始化新卡片的事件
                    initChatOutlineSelection(newCardElement);
                    
                    addMessage('新的方案已生成！您可以从这些全新的角度来设计您的课程。');
                }, 1500);
            }, 800);
        }

        // 生成备选的大纲方案
        function generateAlternativeOutlines() {
            const alternativeOutlines = `
                <div class="p-6">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-6 text-center">
                        🎯 为您重新设计了两种全新的课程大纲结构：
                    </div>
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- 方案C -->
                        <div class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-4 hover:border-purple-400 dark:hover:border-purple-500 hover:shadow-md transition-all" data-option="C">
                            <div class="flex items-start space-x-3 mb-3">
                                <div class="w-6 h-6 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-layers text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">方案C：分层递进型大纲</h4>
                                    <p class="text-xs text-purple-500 dark:text-purple-400">循序渐进</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-xs text-gray-600 dark:text-gray-300 ml-9">
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">基础层：CRM认知建立</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>什么是CRM及其价值</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>我们的CRM系统介绍</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">应用层：核心功能掌握</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>客户管理核心操作</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>销售流程管理技巧</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">提升层：高效工作方法</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>自动化工具的使用</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>批量操作与快捷技巧</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">精通层：数据驱动决策</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>报表分析与业绩洞察</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>持续优化改进策略</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button class="outline-select-btn px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg font-medium transition-colors" data-option="C">
                                    选择此方案
                                </button>
                                <button class="outline-preview-btn px-3 py-1.5 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs rounded-lg font-medium transition-colors" data-option="C">
                                    <i class="fas fa-eye mr-1"></i>预览微调
                                </button>
                            </div>
                        </div>

                        <!-- 方案D -->
                        <div class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-4 hover:border-orange-400 dark:hover:border-orange-500 hover:shadow-md transition-all" data-option="D">
                            <div class="flex items-start space-x-3 mb-3">
                                <div class="w-6 h-6 bg-orange-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-lightbulb text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">方案D：场景化应用大纲</h4>
                                    <p class="text-xs text-orange-500 dark:text-orange-400">情境教学</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-xs text-gray-600 dark:text-gray-300 ml-9">
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">场景一：新客户开发</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>潜在客户识别与录入</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>初次接触信息记录</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">场景二：客户跟进维护</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>跟进任务制定与执行</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>客户互动历史管理</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">场景三：销售机会转化</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>商机识别与评估</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>成交过程全程追踪</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">场景四：客户价值挖掘</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>客户价值分析评估</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>交叉销售机会发现</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button class="outline-select-btn px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded-lg font-medium transition-colors" data-option="D">
                                    选择此方案
                                </button>
                                <button class="outline-preview-btn px-3 py-1.5 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs rounded-lg font-medium transition-colors" data-option="D">
                                    <i class="fas fa-eye mr-1"></i>预览微调
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 重新生成按钮区域 -->
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600 text-center">
                        <button id="regenerateOutlines" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 rounded-lg transition-colors font-medium text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>换个方案
                        </button>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">仍然不满意？继续生成更多选项</p>
                    </div>
                </div>
            `;
            
            return alternativeOutlines;
        }

        // 显示详细大纲
        function showDetailOutline(option) {
            addMessage(`很棒的选择！"${option === 'A' ? '标准流程型' : '基于任务的实践'}"大纲非常适合体系化的学习。`);
            
            setTimeout(() => {
                addMessage('这是详细的章节安排，您可以在下方直接拖拽排序或修改标题。确认无误后，我们就可以开始填充内容了。');
                
                elements.detailOutlineArea.classList.remove('hidden');
                generateDetailOutline(option);
            }, 1000);
        }

        // 生成详细大纲
        function generateDetailOutline(option) {
            const outlines = {
                'A': [
                    { title: 'CRM系统核心理念', subtitle: '了解CRM的基本概念和价值' },
                    { title: '客户信息录入与管理', subtitle: '学习客户数据的规范化管理' },
                    { title: '销售线索跟进与转化', subtitle: '掌握线索管理和转化技巧' },
                    { title: '销售数据分析与报表', subtitle: '利用数据优化销售策略' }
                ],
                'B': [
                    { title: '录入你的第一个客户', subtitle: '实操：客户信息录入流程' },
                    { title: '创建并跟进销售线索', subtitle: '实操：线索创建和状态管理' },
                    { title: '完成销售记录', subtitle: '实操：销售流程记录和更新' },
                    { title: '查看和分析销售报表', subtitle: '实操：数据分析和报表生成' }
                ],
                'C': [
                    { title: 'CRM认知建立', subtitle: '基础层：建立正确的CRM理念' },
                    { title: '核心功能掌握', subtitle: '应用层：掌握核心操作技能' },
                    { title: '高效工作方法', subtitle: '提升层：学习高效使用技巧' },
                    { title: '数据驱动决策', subtitle: '精通层：基于数据优化决策' }
                ],
                'D': [
                    { title: '新客户开发', subtitle: '场景一：完整的客户开发流程' },
                    { title: '客户跟进维护', subtitle: '场景二：系统化的客户维护' },
                    { title: '销售机会转化', subtitle: '场景三：商机管理与转化' },
                    { title: '客户价值挖掘', subtitle: '场景四：深度挖掘客户价值' }
                ]
            };
            
            const selectedOutline = outlines[option];
            elements.outlineEditor.innerHTML = '';
            
            selectedOutline.forEach((item, index) => {
                const outlineItem = document.createElement('div');
                outlineItem.className = 'outline-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 cursor-move hover:shadow-md transition-shadow';
                outlineItem.draggable = true;
                outlineItem.dataset.index = index;
                
                outlineItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 dark:text-blue-400 font-semibold">${index + 1}</span>
                        </div>
                        <div class="flex-1">
                            <input type="text" value="${item.title}" class="w-full font-semibold text-gray-900 dark:text-white bg-transparent border-none focus:ring-0 p-0">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${item.subtitle}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                            <button class="text-gray-400 hover:text-red-500 transition-colors" onclick="removeOutlineItem(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                elements.outlineEditor.appendChild(outlineItem);
            });
            
            initDragAndDrop();
        }

        // 初始化拖拽排序
        function initDragAndDrop() {
            const outlineItems = elements.outlineEditor.querySelectorAll('.outline-item');
            
            outlineItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    item.classList.add('opacity-50');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = e.dataTransfer.getData('text/plain');
                    const targetIndex = item.dataset.index;
                    
                    if (draggedIndex !== targetIndex) {
                        reorderOutlineItems(draggedIndex, targetIndex);
                    }
                });
            });
        }

        // 重新排序大纲项目
        function reorderOutlineItems(fromIndex, toIndex) {
            const items = Array.from(elements.outlineEditor.children);
            const draggedItem = items[fromIndex];
            const targetItem = items[toIndex];
            
            if (fromIndex < toIndex) {
                targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedItem, targetItem);
            }
            
            // 更新索引
            Array.from(elements.outlineEditor.children).forEach((item, index) => {
                item.dataset.index = index;
                const numberSpan = item.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
            });
        }

        // 确认大纲
        function confirmOutline() {
            addMessage('收到！大纲已最终确认。');
            
            setTimeout(() => {
                addMessage('现在，魔法即将开始！我将根据这份大纲，为您生成一门完整的课程。这个过程大约需要1-2分钟，我会实时向您"直播"我的创作进度。');
                
                elements.progressArea.classList.remove('hidden');
                AppState.currentStep = 4;
                startCourseGeneration();
            }, 1000);
        }

        // 开始课程生成
        function startCourseGeneration() {
            const progressSteps = [
                { text: '✨ 正在分析课程结构...', progress: 20 },
                { text: '✨ 正在生成"第一章"内容...', progress: 40 },
                { text: '✨ 正在为"第二章"设计随堂练习题...', progress: 60 },
                { text: '✨ 正在寻找合适的配图...', progress: 80 },
                { text: '✨ 正在完善课程细节...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const updateProgress = () => {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    elements.progressText.textContent = step.text;
                    elements.progressBar.style.width = step.progress + '%';
                    currentStep++;
                    
                    setTimeout(updateProgress, 1500);
                } else {
                    setTimeout(() => {
                        showCoursePreview();
                    }, 1000);
                }
            };
            
            updateProgress();
        }

        // 显示课程预览
        function showCoursePreview() {
            addMessage('叮！您的《' + AppState.courseTitle + '》课程初稿已全部生成完毕！');
            
            setTimeout(() => {
                addMessage('您现在可以预览和编辑每一个细节。');
                elements.previewArea.classList.remove('hidden');
                elements.aiAssistant.classList.remove('hidden');
            }, 1000);
        }

        // 初始化预览区域按钮
        function initPreviewButtons() {
            document.getElementById('previewCourse').addEventListener('click', () => {
                alert('课程预览功能开发中...');
            });
            
            document.getElementById('editCourse').addEventListener('click', () => {
                alert('课程编辑功能开发中...');
            });
            
            document.getElementById('publishCourse').addEventListener('click', () => {
                alert('🎉 课程发布成功！您的课程已经可以分享给团队成员了。');
            });
        }

        // 消息输入自适应高度
        function initMessageInput() {
            elements.messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            elements.messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleUserInput();
                }
            });
        }

        // 初始化主题建议
        function initTopicSuggestions() {
            // 主题建议点击事件
            const topicSuggestions = document.querySelectorAll('.topic-suggestion');
            topicSuggestions.forEach(button => {
                button.addEventListener('click', () => {
                    const topic = button.dataset.topic;
                    elements.messageInput.value = topic;
                    
                    // 添加选中效果
                    topicSuggestions.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'dark:border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/30');
                    });
                    button.classList.add('border-blue-500', 'dark:border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/30');
                    
                    // 自动提交
                    setTimeout(() => {
                        handleUserInput();
                    }, 300);
                });
            });

            // 更多主题按钮
            const moreTopicsBtn = document.getElementById('moreTopics');
            if (moreTopicsBtn) {
                moreTopicsBtn.addEventListener('click', () => {
                    showMoreTopics();
                });
            }
        }

        // 显示更多主题选项
        function showMoreTopics() {
            const moreTopics = [
                { icon: 'fas fa-graduation-cap', color: 'text-blue-500', text: '员工入职培训体系' },
                { icon: 'fas fa-language', color: 'text-green-500', text: '跨文化沟通与合作' },
                { icon: 'fas fa-brain', color: 'text-purple-500', text: '创新思维与问题解决' },
                { icon: 'fas fa-heart', color: 'text-red-500', text: '心理健康与压力管理' },
                { icon: 'fas fa-laptop', color: 'text-indigo-500', text: '办公软件高效使用' },
                { icon: 'fas fa-microscope', color: 'text-teal-500', text: '质量控制与工艺改进' },
                { icon: 'fas fa-leaf', color: 'text-green-600', text: '可持续发展与环保意识' },
                { icon: 'fas fa-rocket', color: 'text-orange-500', text: '职业发展规划指导' }
            ];

            const moreTopicsHtml = `
                <div class="p-4">
                    <p class="text-gray-800 dark:text-gray-200 leading-relaxed mb-4">
                        更多课程主题推荐：
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${moreTopics.map(topic => `
                            <button class="topic-suggestion text-left p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-sm" data-topic="${topic.text}">
                                <i class="${topic.icon} ${topic.color} mr-2"></i>${topic.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage(moreTopicsHtml, false, true, true);
            
            setTimeout(() => {
                initTopicSuggestions();
            }, 100);
        }

        // 显示大纲预览模态窗口
        function showOutlineModal(option) {
            const modal = document.getElementById('outlineModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalOutlineContent');
            
            // 设置模态窗口样式和标题
            if (option === 'A') {
                modalIcon.className = 'w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-list text-white text-sm"></i>';
                modalTitle.textContent = '方案A：标准流程型大纲';
            } else if (option === 'B') {
                modalIcon.className = 'w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-tasks text-white text-sm"></i>';
                modalTitle.textContent = '方案B：基于任务的实践大纲';
            } else if (option === 'C') {
                modalIcon.className = 'w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-layers text-white text-sm"></i>';
                modalTitle.textContent = '方案C：分层递进型大纲';
            } else if (option === 'D') {
                modalIcon.className = 'w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-lightbulb text-white text-sm"></i>';
                modalTitle.textContent = '方案D：场景化应用大纲';
            }
            
            // 生成详细的可编辑大纲
            generateEditableOutline(option, modalContent);
            
            // 显示模态窗口
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 生成可编辑的大纲内容
        function generateEditableOutline(option, container) {
            const outlines = {
                'A': [
                    {
                        title: 'CRM系统核心理念',
                        subtitle: '了解CRM的基本概念和价值',
                        sections: ['CRM基本概念与价值', '系统架构与模块介绍']
                    },
                    {
                        title: '客户信息录入与管理',
                        subtitle: '学习客户数据的规范化管理',
                        sections: ['客户信息标准化录入', '客户分类与标签管理']
                    },
                    {
                        title: '销售线索跟进与转化',
                        subtitle: '掌握线索管理和转化技巧',
                        sections: ['线索创建与状态管理', '跟进记录与转化技巧']
                    },
                    {
                        title: '销售数据分析与报表',
                        subtitle: '利用数据优化销售策略',
                        sections: ['数据统计与可视化', '报表生成与分析应用']
                    }
                ],
                'B': [
                    {
                        title: '录入你的第一个客户',
                        subtitle: '实操：客户信息录入流程',
                        sections: ['客户信息收集准备', '系统录入操作实践']
                    },
                    {
                        title: '创建并跟进销售线索',
                        subtitle: '实操：线索创建和状态管理',
                        sections: ['线索创建与分配', '跟进计划制定与执行']
                    },
                    {
                        title: '完成销售记录',
                        subtitle: '实操：销售流程记录和更新',
                        sections: ['销售机会记录', '成交流程管理']
                    },
                    {
                        title: '查看和分析销售报表',
                        subtitle: '实操：数据分析和报表生成',
                        sections: ['报表数据解读', '业绩分析与改进建议']
                    }
                ],
                'C': [
                    {
                        title: 'CRM认知建立',
                        subtitle: '基础层：建立正确的CRM理念',
                        sections: ['什么是CRM及其价值', '我们的CRM系统介绍']
                    },
                    {
                        title: '核心功能掌握',
                        subtitle: '应用层：掌握核心操作技能',
                        sections: ['客户管理核心操作', '销售流程管理技巧']
                    },
                    {
                        title: '高效工作方法',
                        subtitle: '提升层：学习高效使用技巧',
                        sections: ['自动化工具的使用', '批量操作与快捷技巧']
                    },
                    {
                        title: '数据驱动决策',
                        subtitle: '精通层：基于数据优化决策',
                        sections: ['报表分析与业绩洞察', '持续优化改进策略']
                    }
                ],
                'D': [
                    {
                        title: '新客户开发',
                        subtitle: '场景一：完整的客户开发流程',
                        sections: ['潜在客户识别与录入', '初次接触信息记录']
                    },
                    {
                        title: '客户跟进维护',
                        subtitle: '场景二：系统化的客户维护',
                        sections: ['跟进任务制定与执行', '客户互动历史管理']
                    },
                    {
                        title: '销售机会转化',
                        subtitle: '场景三：商机管理与转化',
                        sections: ['商机识别与评估', '成交过程全程追踪']
                    },
                    {
                        title: '客户价值挖掘',
                        subtitle: '场景四：深度挖掘客户价值',
                        sections: ['客户价值分析评估', '交叉销售机会发现']
                    }
                ]
            };

            const selectedOutline = outlines[option];
            container.innerHTML = '';

            selectedOutline.forEach((chapter, chapterIndex) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-item bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-6 shadow-sm hover:shadow-md transition-all duration-200 group';
                chapterDiv.draggable = true;
                chapterDiv.dataset.index = chapterIndex;

                chapterDiv.innerHTML = `
                    <div class="flex items-start space-x-4 mb-4">
                        <div class="w-10 h-10 bg-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-100 dark:bg-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-900/30 rounded-lg flex items-center justify-center flex-shrink-0 transition-colors">
                            <span class="text-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-600 dark:text-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-400 font-semibold text-base">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" value="${chapter.title}" class="chapter-title w-full font-semibold text-gray-900 dark:text-white bg-transparent border-none focus:ring-0 p-0 text-lg mb-2 focus:outline-none">
                            <input type="text" value="${chapter.subtitle}" class="chapter-subtitle w-full text-base text-gray-600 dark:text-gray-400 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                        </div>
                        <div class="flex items-center space-x-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="add-section-btn p-2 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded-lg transition-all" title="添加小节">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                            <button class="delete-chapter-btn p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-all" title="删除章节">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                            <div class="p-2 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="拖拽排序">
                                <i class="fas fa-grip-vertical text-sm"></i>
                            </div>
                        </div>
                    </div>
                    <div class="sections-container ml-14 space-y-3">
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-item flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-all group">
                                <div class="w-8 h-8 bg-gray-200 dark:bg-gray-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-gray-600 dark:text-gray-300 text-sm font-medium">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                </div>
                                <input type="text" value="${section}" class="section-title flex-1 text-base text-gray-700 dark:text-gray-200 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover:opacity-100" title="删除小节">
                                    <i class="fas fa-times text-sm"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(chapterDiv);
            });

            // 初始化编辑功能
            initModalOutlineEditor(container, option);
            
            // 初始化模板按钮事件（需要延迟执行以确保DOM元素已加载）
            setTimeout(() => {
                initTemplateButtons();
            }, 100);
        }

        // 初始化模板按钮事件
        function initTemplateButtons() {
            const templateButtons = document.querySelectorAll('.template-btn');
            templateButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const templateType = btn.dataset.template;
                    applyTemplate(templateType);
                    
                    // 添加视觉反馈
                    btn.style.background = '#dbeafe';
                    setTimeout(() => {
                        btn.style.background = '';
                    }, 200);
                });
            });
        }

        // 初始化模态窗口的编辑功能
        function initModalOutlineEditor(container, option) {
            // 添加小节按钮
            container.querySelectorAll('.add-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const chapterItem = e.target.closest('.chapter-item');
                    const sectionsContainer = chapterItem.querySelector('.sections-container');
                    const chapterIndex = parseInt(chapterItem.dataset.index);
                    const sectionCount = sectionsContainer.children.length;
                    
                    const newSection = document.createElement('div');
                    newSection.className = 'section-item flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-all group';
                    newSection.innerHTML = `
                        <div class="w-8 h-8 bg-gray-200 dark:bg-gray-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-medium">${chapterIndex + 1}.${sectionCount + 1}</span>
                        </div>
                        <input type="text" value="新小节" class="section-title flex-1 text-base text-gray-700 dark:text-gray-200 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                        <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover:opacity-100" title="删除小节">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    `;
                    
                    sectionsContainer.appendChild(newSection);
                    initSectionDeleteButton(newSection.querySelector('.delete-section-btn'));
                });
            });

            // 删除章节按钮
            container.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (container.children.length > 1) {
                        e.target.closest('.chapter-item').remove();
                        updateChapterNumbers(container);
                    } else {
                        alert('至少需要保留一个章节');
                    }
                });
            });

            // 删除小节按钮
            container.querySelectorAll('.delete-section-btn').forEach(btn => {
                initSectionDeleteButton(btn);
            });
        }

        function initSectionDeleteButton(btn) {
            btn.addEventListener('click', (e) => {
                const sectionItem = e.target.closest('.section-item');
                const sectionsContainer = sectionItem.parentElement;
                
                if (sectionsContainer.children.length > 1) {
                    sectionItem.remove();
                    updateSectionNumbers(sectionsContainer);
                } else {
                    alert('至少需要保留一个小节');
                }
            });
        }

        function updateChapterNumbers(container) {
            Array.from(container.children).forEach((chapter, index) => {
                chapter.dataset.index = index;
                const numberSpan = chapter.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
                updateSectionNumbers(chapter.querySelector('.sections-container'));
            });
        }

        function updateSectionNumbers(sectionsContainer) {
            const chapterIndex = parseInt(sectionsContainer.closest('.chapter-item').dataset.index);
            Array.from(sectionsContainer.children).forEach((section, index) => {
                const numberSpan = section.querySelector('span');
                numberSpan.textContent = `${chapterIndex + 1}.${index + 1}`;
            });
        }

        // 初始化模态窗口事件
        function initModalEvents() {
            const modal = document.getElementById('outlineModal');
            const closeBtn = document.getElementById('closeModal');
            const confirmBtn = document.getElementById('confirmModalOutline');
            const resetBtn = document.getElementById('resetOutline');

            // 关闭模态窗口
            const closeModal = () => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            };

            closeBtn.addEventListener('click', closeModal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // 确认选择
            confirmBtn.addEventListener('click', () => {
                // 获取编辑后的大纲数据和高级设置
                const editedOutline = getEditedOutlineData();
                const advancedSettings = getAdvancedSettings();
                
                // 显示保存提示
                showSaveConfirmation(editedOutline, advancedSettings);
            });

            // 重置大纲
            resetBtn.addEventListener('click', () => {
                const titleText = modal.querySelector('#modalTitle').textContent;
                let option = 'A';
                if (titleText.includes('方案A')) option = 'A';
                else if (titleText.includes('方案B')) option = 'B';
                else if (titleText.includes('方案C')) option = 'C';
                else if (titleText.includes('方案D')) option = 'D';
                
                const container = document.getElementById('modalOutlineContent');
                generateEditableOutline(option, container);
                resetAdvancedSettings();
            });
        }

        // 获取高级设置数据
        function getAdvancedSettings() {
            return {
                duration: document.getElementById('courseDuration')?.value || '2-4',
                difficulty: document.getElementById('courseDifficulty')?.value || 'beginner',
                teachingMethods: {
                    theory: document.getElementById('theory')?.checked || false,
                    practice: document.getElementById('practice')?.checked || false,
                    exercise: document.getElementById('exercise')?.checked || false,
                    case: document.getElementById('case')?.checked || false,
                    groupwork: document.getElementById('groupwork')?.checked || false
                },
                targetAudience: document.getElementById('targetAudience')?.value || '10-20',
                language: document.getElementById('courseLanguage')?.value || 'zh',
                assessment: {
                    quiz: document.getElementById('quiz')?.checked || false,
                    assignment: document.getElementById('assignment')?.checked || false,
                    project: document.getElementById('project')?.checked || false,
                    feedback: document.getElementById('feedback')?.checked || false
                },
                otherRequirements: document.getElementById('otherRequirements')?.value || ''
            };
        }

        // 重置高级设置
        function resetAdvancedSettings() {
            document.getElementById('courseDuration').value = '2-4';
            document.getElementById('courseDifficulty').value = 'beginner';
            document.getElementById('theory').checked = true;
            document.getElementById('practice').checked = true;
            document.getElementById('exercise').checked = true;
            document.getElementById('case').checked = false;
            document.getElementById('groupwork').checked = false;
            document.getElementById('targetAudience').value = '10-20';
            document.getElementById('courseLanguage').value = 'zh';
            document.getElementById('quiz').checked = true;
            document.getElementById('assignment').checked = false;
            document.getElementById('project').checked = false;
            document.getElementById('feedback').checked = true;
            document.getElementById('otherRequirements').value = '';
        }

        // 应用快速模板
        function applyTemplate(templateType) {
            switch(templateType) {
                case 'basic':
                    document.getElementById('courseDuration').value = '2-4';
                    document.getElementById('courseDifficulty').value = 'beginner';
                    document.getElementById('theory').checked = true;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = false;
                    document.getElementById('groupwork').checked = false;
                    document.getElementById('quiz').checked = true;
                    document.getElementById('assignment').checked = false;
                    document.getElementById('project').checked = false;
                    document.getElementById('feedback').checked = true;
                    break;
                case 'intensive':
                    document.getElementById('courseDuration').value = '1-day';
                    document.getElementById('courseDifficulty').value = 'intermediate';
                    document.getElementById('theory').checked = true;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = true;
                    document.getElementById('groupwork').checked = true;
                    document.getElementById('quiz').checked = true;
                    document.getElementById('assignment').checked = true;
                    document.getElementById('project').checked = true;
                    document.getElementById('feedback').checked = true;
                    break;
                case 'workshop':
                    document.getElementById('courseDuration').value = '4-8';
                    document.getElementById('courseDifficulty').value = 'intermediate';
                    document.getElementById('theory').checked = false;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = true;
                    document.getElementById('groupwork').checked = true;
                    document.getElementById('quiz').checked = false;
                    document.getElementById('assignment').checked = false;
                    document.getElementById('project').checked = true;
                    document.getElementById('feedback').checked = true;
                    break;
            }
        }

        // 获取编辑后的大纲数据
        function getEditedOutlineData() {
            const container = document.getElementById('modalOutlineContent');
            const option = document.getElementById('modalTitle').textContent.includes('方案A') ? 'A' : 'B';
            const chapters = [];

            Array.from(container.children).forEach(chapterItem => {
                const chapterTitle = chapterItem.querySelector('.chapter-title').value;
                const chapterSubtitle = chapterItem.querySelector('.chapter-subtitle').value;
                const sections = [];

                chapterItem.querySelectorAll('.section-title').forEach(sectionInput => {
                    sections.push(sectionInput.value);
                });

                chapters.push({
                    title: chapterTitle,
                    subtitle: chapterSubtitle,
                    sections: sections
                });
            });

            return {
                option: option,
                chapters: chapters
            };
        }

        // 显示保存确认提示
        function showSaveConfirmation(editedOutline, advancedSettings) {
            // 关闭当前模态窗口
            const modal = document.getElementById('outlineModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';

            // 创建保存确认模态窗口
            const saveModal = document.createElement('div');
            saveModal.id = 'saveConfirmModal';
            saveModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            saveModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-save text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">保存课程设置</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">您的课程大纲和设置即将保存</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">课程大纲：</span>
                                    <span class="font-medium text-gray-900 dark:text-white">方案${editedOutline.option}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">章节数量：</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${editedOutline.chapters.length}个章节</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">课程时长：</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${getDurationText(advancedSettings.duration)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">难度等级：</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${getDifficultyText(advancedSettings.difficulty)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center text-gray-600 dark:text-gray-400 text-sm mb-6">
                            <i class="fas fa-info-circle mr-1"></i>
                            点击确认将保存设置并开始生成完整课程内容
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelSave" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-times mr-2"></i>取消
                            </button>
                            <button id="confirmSave" class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-rocket mr-2"></i>确认并生成
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(saveModal);
            
            // 绑定事件
            document.getElementById('cancelSave').addEventListener('click', () => {
                saveModal.remove();
                // 重新打开大纲编辑模态窗口
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
            
            document.getElementById('confirmSave').addEventListener('click', () => {
                // 保存数据到sessionStorage
                const courseData = {
                    title: AppState.courseTitle || '新课程',
                    outline: editedOutline.option,
                    outlineData: editedOutline,
                    advancedSettings: advancedSettings,
                    createdAt: new Date().toISOString(),
                    uploadedFiles: AppState.uploadedFiles || []
                };
                
                sessionStorage.setItem('courseCreationData', JSON.stringify(courseData));
                
                // 显示跳转提示
                saveModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-check text-green-500 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">保存成功！</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">正在跳转到课程生成页面...</p>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%" id="jumpProgress"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 进度条动画
                const progressBar = document.getElementById('jumpProgress');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 20;
                    progressBar.style.width = progress + '%';
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                            saveModal.remove();
                            // 跳转到course-creation页面
                            window.location.href = 'course-creation.html';
                        }, 300);
                    }
                }, 200);
            });
            
            // 点击背景关闭
            saveModal.addEventListener('click', (e) => {
                if (e.target === saveModal) {
                    document.getElementById('cancelSave').click();
                }
            });
        }

        // 获取时长文本
        function getDurationText(duration) {
            const durationMap = {
                '1-2': '1-2小时',
                '2-4': '2-4小时',
                '4-8': '4-8小时',
                '1-day': '1天',
                '2-3-days': '2-3天',
                'custom': '自定义'
            };
            
            // 处理undefined或空值的情况
            if (!duration) {
                return '2-4小时'; // 默认值
            }
            
            return durationMap[duration] || duration;
        }

        // 获取难度文本
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                'beginner': '初级',
                'intermediate': '中级',
                'advanced': '高级',
                'expert': '专家级'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        // 初始化需求输入框
        function initRequirementInput() {
            if (!elements.courseRequirementInput || !elements.submitRequirement || !elements.charCount) return;
            
            // 字符计数功能
            elements.courseRequirementInput.addEventListener('input', function() {
                const text = this.value;
                const charCount = text.length;
                elements.charCount.textContent = `${charCount}/1000`;
                
                // 根据字符数改变颜色
                if (charCount > 1000) {
                    elements.charCount.classList.add('text-red-500');
                    elements.charCount.classList.remove('text-gray-400');
                } else if (charCount > 800) {
                    elements.charCount.classList.add('text-yellow-500');
                    elements.charCount.classList.remove('text-gray-400', 'text-red-500');
                } else {
                    elements.charCount.classList.add('text-gray-400');
                    elements.charCount.classList.remove('text-red-500', 'text-yellow-500');
                }
                
                // 启用/禁用提交按钮
                elements.submitRequirement.disabled = charCount === 0 || charCount > 1000;
            });

            // 自适应高度
            elements.courseRequirementInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            // 提交按钮点击事件
            elements.submitRequirement.addEventListener('click', () => {
                handleRequirementSubmit();
            });

            // 回车提交（Ctrl+Enter）
            elements.courseRequirementInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    handleRequirementSubmit();
                }
            });

            // 初始化按钮状态
            elements.submitRequirement.disabled = true;
        }

        // 处理需求提交
        function handleRequirementSubmit() {
            const requirement = elements.courseRequirementInput.value.trim();
            if (!requirement || requirement.length > 1000) return;

            // 添加用户消息
            addMessage(requirement, true);
            
            // 清空输入框
            elements.courseRequirementInput.value = '';
            elements.charCount.textContent = '0/1000';
            elements.submitRequirement.disabled = true;
            
            // 隐藏需求输入区域和主题建议
            hideRequirementInputArea();
            
            // 处理AI回复
            setTimeout(() => {
                handleDetailedRequirement(requirement);
            }, 500);
        }

        // 隐藏需求输入区域
        function hideRequirementInputArea() {
            const requirementCard = document.querySelector('.chat-bubble:nth-child(2)'); // 需求输入卡片
            const topicCard = document.querySelector('.chat-bubble:nth-child(3)'); // 主题建议卡片
            
            if (requirementCard) {
                requirementCard.style.opacity = '0.5';
                requirementCard.style.pointerEvents = 'none';
            }
            if (topicCard) {
                topicCard.style.opacity = '0.5';
                topicCard.style.pointerEvents = 'none';
            }
        }

        // 处理详细需求
        function handleDetailedRequirement(requirement) {
            AppState.courseTitle = extractCourseTitle(requirement);
            
            // 初始化逐步收集的状态
            AppState.detailedRequirements = {
                duration: '',
                chapterCount: '',
                difficulty: '',
                teachingMethods: {},
                assessment: {},
                audience: {},
                deliveryFormat: '',
                specialRequirements: ''
            };
            AppState.currentQuestionStep = 1;
            
            // AI分析回复
            addMessage(`太棒了！我已经理解了您的需求。您想要创建一门关于"${AppState.courseTitle}"的课程。`);
            
            setTimeout(() => {
                addMessage('让我来分析一下您的具体要求：<br/><br/>' + 
                    '📚 <strong>课程主题：</strong>' + AppState.courseTitle + '<br/>' +
                    '🎯 <strong>目标受众：</strong>' + extractTargetAudience(requirement) + '<br/>' +
                    '⏱️ <strong>预期时长：</strong>' + extractDuration(requirement) + '<br/>' +
                    '🎓 <strong>教学方式：</strong>' + extractTeachingMethod(requirement), false, true);
                
                setTimeout(() => {
                    addMessage('为了为您量身定制最合适的课程，我需要再了解几个关键信息。让我们一步一步来：');
                    
                    setTimeout(() => {
                        startStepByStepRequirements();
                    }, 800);
                }, 1000);
            }, 1000);
        }

        // 提取课程标题
        function extractCourseTitle(requirement) {
            // 简单的关键词提取逻辑，可以根据需要优化
            const keywords = ['CRM', '销售', '培训', '管理', '系统', '入门', '高级', '实战'];
            let title = '';
            
            // 寻找"创建"、"建立"等词后面的内容
            const patterns = [
                /(?:创建|建立|设计|制作).*?([^，。！？\n]+?)(?:课程|培训|教程)/,
                /([^，。！？\n]*?)(?:课程|培训|教程)/,
                /关于([^，。！？\n]+?)的/
            ];
            
            for (let pattern of patterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    title = match[1].trim();
                    break;
                }
            }
            
            return title || '新课程培训';
        }

        // 提取目标受众
        function extractTargetAudience(requirement) {
            const audiencePatterns = [
                /(?:为|给|针对)([^，。！？\n]*?)(?:创建|设计|制作)/,
                /(新员工|老员工|销售|管理|技术|客服|财务|HR).*?人员/,
                /(入职|新手|初级|中级|高级|资深).*?人员/
            ];
            
            for (let pattern of audiencePatterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            
            return '团队成员';
        }

        // 提取时长
        function extractDuration(requirement) {
            const durationPatterns = [
                /(?:时长|持续|需要).*?(\d+[-~到]\d+)\s*(?:小时|hour)/,
                /(\d+)\s*(?:小时|hour)/,
                /(\d+)\s*(?:天|day)/
            ];
            
            for (let pattern of durationPatterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    return match[1] + (requirement.includes('天') ? '天' : '小时');
                }
            }
            
            return '2-3小时';
        }

        // 提取教学方式
        function extractTeachingMethod(requirement) {
            const methods = [];
            if (requirement.includes('实操') || requirement.includes('实践') || requirement.includes('操作')) {
                methods.push('实操演示');
            }
            if (requirement.includes('理论') || requirement.includes('概念') || requirement.includes('知识')) {
                methods.push('理论讲解');
            }
            if (requirement.includes('练习') || requirement.includes('作业') || requirement.includes('测试')) {
                methods.push('随堂练习');
            }
            if (requirement.includes('案例') || requirement.includes('例子')) {
                methods.push('案例分析');
            }
            
            return methods.length > 0 ? methods.join('、') : '理论讲解、实操演示';
        }

        // 初始化应用
        function initApp() {
            initTheme();
            initMessageInput();
            initRequirementInput();
            initTopicSuggestions();
            initPreviewButtons();
            initModalEvents();
            
            // 绑定事件监听器
            elements.sendButton.addEventListener('click', handleUserInput);
            elements.confirmOutline.addEventListener('click', confirmOutline);
            
            // AI助手悬浮球点击事件
            elements.aiAssistant.addEventListener('click', () => {
                alert('AI助手功能开发中，将为您提供智能建议和帮助！');
            });
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html> 