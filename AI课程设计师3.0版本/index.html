<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯¾ç¨‹è®¾è®¡å¸ˆ 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-slow': 'bounce 2s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-bubble {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* éšè—æ»šåŠ¨æ¡ - ä¿æŒç¾è§‚æ€§ */
        .custom-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        .custom-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* å¯é€‰ï¼šæ‚¬åœæ—¶æ˜¾ç¤ºç»†æ»šåŠ¨æ¡çš„ç‰ˆæœ¬ */
        .custom-scrollbar-hover {
            scrollbar-width: thin; /* Firefox */
        }
        .custom-scrollbar-hover::-webkit-scrollbar {
            width: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .custom-scrollbar-hover::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar-hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .custom-scrollbar-hover:hover::-webkit-scrollbar {
            opacity: 1;
        }
        .custom-scrollbar-hover:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* æš—è‰²æ¨¡å¼ */
        .dark .custom-scrollbar-hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .custom-scrollbar-hover:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* å¤§çº²å¡ç‰‡åˆ‡æ¢åŠ¨ç”» */
        #currentOutlineCard {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            #outlineModal .flex {
                flex-direction: column;
            }
            #outlineModal .w-96 {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-top: 1px solid rgb(229 231 235);
                max-height: 50vh;
            }
            .dark #outlineModal .w-96 {
                border-top-color: rgb(55 65 81);
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">AIè¯¾ç¨‹è®¾è®¡å¸ˆ</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="p-3 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon dark:hidden text-base"></i>
                        <i class="fas fa-sun hidden dark:inline text-base"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="h-screen flex flex-col">
        <!-- èŠå¤©å¯¹è¯åŒºåŸŸ -->
        <div id="chatContainer" class="flex-1 bg-gray-50 dark:bg-gray-900 overflow-hidden">
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div id="messagesContainer" class="h-full overflow-y-auto px-6 py-8 space-y-8 max-w-4xl mx-auto custom-scrollbar">
                <!-- AIæ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex items-start space-x-4 chat-bubble">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm">
                        <p class="text-gray-800 dark:text-gray-200 leading-relaxed text-base">
                            Hi~, æˆ‘æ˜¯æ‚¨çš„AIè¯¾ç¨‹è®¾è®¡å¸ˆã€‚èƒ½ä¸ºæ‚¨æ•ˆåŠ³æˆ‘æ„Ÿåˆ°éå¸¸è£å¹¸ï¼
                        </p>
                        <p class="text-gray-800 dark:text-gray-200 leading-relaxed mt-4 text-base">
                            ä¸ºäº†å¼€å§‹åˆ›ä½œï¼Œè¯·å…ˆç”¨ä¸€å¥è¯å‘Šè¯‰æˆ‘ï¼Œæ‚¨ä»Šå¤©æƒ³åˆ›å»ºä¸€ä¸ªå…³äºä»€ä¹ˆä¸»é¢˜çš„è¯¾ç¨‹å‘¢ï¼Ÿ
                        </p>
                    </div>
                </div>

                <!-- è¯¾ç¨‹éœ€æ±‚è¾“å…¥åŒºåŸŸ -->
                <div class="flex items-start space-x-4 chat-bubble">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-8 max-w-5xl shadow-sm">
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>
                                æè¿°æ‚¨çš„è¯¾ç¨‹éœ€æ±‚
                            </h3>
                            <p class="text-gray-600 dark:text-gray-400 text-base">
                                è¯·è¯¦ç»†æè¿°æ‚¨æƒ³è¦åˆ›å»ºçš„è¯¾ç¨‹ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€ç›®æ ‡å—ä¼—ã€é¢„æœŸæ•ˆæœç­‰
                            </p>
                        </div>
                        
                        <div class="relative mb-8">
                            <textarea 
                                id="courseRequirementInput" 
                                placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³ä¸ºæ–°å…¥èŒçš„é”€å”®äººå‘˜åˆ›å»ºä¸€é—¨CRMç³»ç»ŸåŸ¹è®­è¯¾ç¨‹ï¼Œå¸®åŠ©ä»–ä»¬å¿«é€ŸæŒæ¡å®¢æˆ·ç®¡ç†å’Œé”€å”®æµç¨‹ï¼Œè¯¾ç¨‹æ—¶é•¿å¤§çº¦2-3å°æ—¶ï¼ŒåŒ…å«å®æ“æ¼”ç¤º..."
                                class="w-full p-5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-200 text-base"
                                rows="4"
                                style="min-height: 120px;"
                            ></textarea>
                            <div class="absolute bottom-4 right-4">
                                <button id="submitRequirement" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-magic text-base"></i>
                                    <span class="text-base">å¼€å§‹åˆ›å»º</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-8 flex items-center justify-between">
                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-2"></i>
                                æè¿°è¶Šè¯¦ç»†ï¼ŒAIç”Ÿæˆçš„è¯¾ç¨‹è¶Šç¬¦åˆæ‚¨çš„éœ€æ±‚
                            </span>
                            <span id="charCount" class="text-sm text-gray-400">0/1000</span>
                        </div>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div class="flex items-center my-8">
                            <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                            <span class="px-6 text-base text-gray-500 dark:text-gray-400">æˆ–è€…ä»ä»¥ä¸‹çƒ­é—¨ä¸»é¢˜ä¸­é€‰æ‹©ä¸€ä¸ªå¿«é€Ÿå¼€å§‹</span>
                            <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                </div>

                <!-- ä¸»é¢˜å»ºè®® -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="æ–°å‘˜å·¥é”€å”®æŠ€èƒ½åŸ¹è®­">
                                    <i class="fas fa-handshake text-blue-500 mr-3"></i>æ–°å‘˜å·¥é”€å”®æŠ€èƒ½åŸ¹è®­
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="æ•°å­—åŒ–è¥é”€ç­–ç•¥ä¸å®è·µ">
                                    <i class="fas fa-chart-line text-green-500 mr-3"></i>æ•°å­—åŒ–è¥é”€ç­–ç•¥ä¸å®è·µ
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="é¡¹ç›®ç®¡ç†å®æˆ˜è®­ç»ƒ">
                                    <i class="fas fa-tasks text-purple-500 mr-3"></i>é¡¹ç›®ç®¡ç†å®æˆ˜è®­ç»ƒ
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="å®¢æˆ·æœåŠ¡ä¸æ²Ÿé€šæŠ€å·§">
                                    <i class="fas fa-comments text-orange-500 mr-3"></i>å®¢æˆ·æœåŠ¡ä¸æ²Ÿé€šæŠ€å·§
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="é¢†å¯¼åŠ›å‘å±•ä¸å›¢é˜Ÿç®¡ç†">
                                    <i class="fas fa-users text-indigo-500 mr-3"></i>é¢†å¯¼åŠ›å‘å±•ä¸å›¢é˜Ÿç®¡ç†
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="æ•°æ®åˆ†æä¸å•†ä¸šæ´å¯Ÿ">
                                    <i class="fas fa-chart-bar text-red-500 mr-3"></i>æ•°æ®åˆ†æä¸å•†ä¸šæ´å¯Ÿ
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="äº§å“åŸ¹è®­ä¸çŸ¥è¯†æ›´æ–°">
                                    <i class="fas fa-box text-teal-500 mr-3"></i>äº§å“åŸ¹è®­ä¸çŸ¥è¯†æ›´æ–°
                                </button>
                            <button class="topic-suggestion text-left p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-base" data-topic="å®‰å…¨ç”Ÿäº§ä¸é£é™©ç®¡ç†">
                                    <i class="fas fa-shield-alt text-yellow-500 mr-3"></i>å®‰å…¨ç”Ÿäº§ä¸é£é™©ç®¡ç†
                                </button>
                            </div>
                        
                        <div class="text-center">
                                <button id="moreTopics" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-base font-medium transition-colors py-2 px-4">
                                    <i class="fas fa-plus mr-2"></i>æ›´å¤šä¸»é¢˜
                                </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div id="inputArea" class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-end space-x-4">
                        <div class="flex-1 relative">
                            <textarea 
                                id="messageInput" 
                                placeholder="è¾“å…¥æ‚¨çš„è¯¾ç¨‹ä¸»é¢˜..."
                                class="w-full p-4 pr-14 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none text-base"
                                rows="1"
                                style="min-height: 48px; max-height: 120px;"
                            ></textarea>
                            <button id="sendButton" class="absolute right-3 bottom-3 w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-md flex items-center justify-center transition-colors">
                                <i class="fas fa-paper-plane text-base"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.ppt,.pptx">

        <!-- è¯¦ç»†å¤§çº²ç¼–è¾‘åŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
        <div id="detailOutlineArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">è¯¦ç»†è¯¾ç¨‹å¤§çº²</h3>
            <p class="text-base text-gray-600 dark:text-gray-400 mb-8">æ‚¨å¯ä»¥æ‹–æ‹½è°ƒæ•´é¡ºåºæˆ–ä¿®æ”¹æ ‡é¢˜</p>
            
            <div id="outlineEditor" class="space-y-4">
                <!-- å¤§çº²é¡¹ç›®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="flex justify-center mt-8">
                <button id="confirmOutline" class="px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors text-base">
                    ç¡®è®¤å¤§çº²
                </button>
            </div>
        </div>

        <!-- ç”Ÿæˆè¿›åº¦åŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
        <div id="progressArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <div class="text-center">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce-slow">
                    <i class="fas fa-magic text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">é­”æ³•æ­£åœ¨è¿›è¡Œä¸­...</h3>
                <p class="text-base text-gray-600 dark:text-gray-400 mb-8">æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹å†…å®¹ï¼Œé¢„è®¡éœ€è¦1-2åˆ†é’Ÿ</p>
                
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-6">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <div id="progressText" class="text-base text-gray-600 dark:text-gray-400">
                    âœ¨ æ­£åœ¨åˆ†æè¯¾ç¨‹ç»“æ„...
                </div>
            </div>
        </div>

        <!-- è¯¾ç¨‹é¢„è§ˆåŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰ -->
        <div id="previewArea" class="hidden mt-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-md rounded-2xl border border-gray-200 dark:border-gray-700 shadow-xl p-8">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-check text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">ğŸ‰ è¯¾ç¨‹åˆ›å»ºå®Œæˆï¼</h3>
                <p class="text-base text-gray-600 dark:text-gray-400">æ‚¨çš„ã€Šæ–°é”€å”®CRMç³»ç»Ÿå…¥é—¨åŸ¹è®­ã€‹è¯¾ç¨‹å·²ç”Ÿæˆå®Œæ¯•</p>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-8 mb-8">
                <div class="flex items-center space-x-6">
                    <div class="w-20 h-20 bg-white dark:bg-gray-800 rounded-xl shadow-md flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-blue-500 text-3xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">æ–°é”€å”®CRMç³»ç»Ÿå…¥é—¨åŸ¹è®­</h4>
                        <p class="text-base text-gray-600 dark:text-gray-400 mb-3">4ä¸ªç« èŠ‚ â€¢ é¢„è®¡å­¦ä¹ æ—¶é—´2å°æ—¶ â€¢ åŒ…å«ç»ƒä¹ é¢˜</p>
                        <div class="flex items-center space-x-4 mt-3">
                            <span class="text-sm px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full">ç†è®ºè®²è§£</span>
                            <span class="text-sm px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full">å®æ“æ¼”ç¤º</span>
                            <span class="text-sm px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-full">éšå ‚ç»ƒä¹ </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center space-x-6">
                <button id="previewCourse" class="px-8 py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-eye mr-2"></i>é¢„è§ˆè¯¾ç¨‹
                </button>
                <button id="editCourse" class="px-8 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-edit mr-2"></i>ç¼–è¾‘å†…å®¹
                </button>
                <button id="publishCourse" class="px-8 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold transition-colors text-base">
                    <i class="fas fa-rocket mr-2"></i>å‘å¸ƒè¯¾ç¨‹
                </button>
            </div>
        </div>
    </div>

    <!-- AIåŠ©æ‰‹æ‚¬æµ®çƒï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="aiAssistant" class="hidden fixed bottom-8 right-8 w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full shadow-lg cursor-pointer hover:scale-110 transition-transform z-50">
        <div class="w-full h-full flex items-center justify-center">
            <i class="fas fa-robot text-white text-xl"></i>
        </div>
    </div>

    <!-- å¤§çº²é¢„è§ˆå¾®è°ƒæ¨¡æ€çª—å£ -->
    <div id="outlineModal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- æ¨¡æ€çª—å£å¤´éƒ¨ -->
            <div class="flex items-center justify-between p-8 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-4">
                    <div id="modalIcon" class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-list text-white text-base"></i>
                    </div>
                    <div>
                        <h3 id="modalTitle" class="text-xl font-semibold text-gray-900 dark:text-white">æ–¹æ¡ˆAï¼šæ ‡å‡†æµç¨‹å‹å¤§çº²</h3>
                        <p id="modalSubtitle" class="text-base text-gray-500 dark:text-gray-400">é¢„è§ˆä¸å¾®è°ƒ</p>
                    </div>
                </div>
                <button id="closeModal" class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-times text-gray-500 dark:text-gray-400 text-base"></i>
                </button>
            </div>

            <!-- æ¨¡æ€çª—å£å†…å®¹ -->
            <div class="flex flex-1 overflow-hidden">
                <!-- å·¦ä¾§ï¼šå¤§çº²ç¼–è¾‘åŒºåŸŸ -->
                <div class="flex-1 min-w-0 p-8 overflow-y-auto border-r border-gray-200 dark:border-gray-700 custom-scrollbar">
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">è¯¾ç¨‹å¤§çº²</h4>
                    <div id="modalOutlineContent" class="space-y-6 pb-8">
                        <!-- å¤§çº²å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šé«˜çº§è®¾ç½®åŒºåŸŸ -->
                <div class="w-96 min-w-96 p-8 overflow-y-auto bg-gray-50 dark:bg-gray-750 custom-scrollbar">
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 sticky top-0 bg-gray-50 dark:bg-gray-750 pb-2 z-10">é«˜çº§è®¾ç½®</h4>
                    
                    <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">è¯¾ç¨‹æ—¶é•¿</label>
                            <select id="courseDuration" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="1-2">1-2å°æ—¶</option>
                                <option value="2-4" selected>2-4å°æ—¶</option>
                                <option value="4-8">4-8å°æ—¶</option>
                                <option value="1-day">1å¤©</option>
                                <option value="2-days">2å¤©</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">éš¾åº¦çº§åˆ«</label>
                            <select id="courseDifficulty" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="beginner" selected>å…¥é—¨çº§</option>
                                <option value="intermediate">ä¸­çº§</option>
                                <option value="advanced">é«˜çº§</option>
                                <option value="expert">ä¸“å®¶çº§</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">æ•™å­¦æ–¹å¼</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="theory" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">ç†è®ºè®²è§£</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="practice" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">å®æ“æ¼”ç¤º</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="exercise" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">éšå ‚ç»ƒä¹ </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="case" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">æ¡ˆä¾‹åˆ†æ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="groupwork" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">å°ç»„è®¨è®º</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">ç›®æ ‡äººæ•°</label>
                            <select id="targetAudience" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="5-10">5-10äºº</option>
                                <option value="10-20" selected>10-20äºº</option>
                                <option value="20-50">20-50äºº</option>
                                <option value="50+">50äººä»¥ä¸Š</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">è¯¾ç¨‹è¯­è¨€</label>
                            <select id="courseLanguage" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                <option value="zh" selected>ä¸­æ–‡</option>
                                <option value="en">è‹±æ–‡</option>
                                <option value="zh-en">ä¸­è‹±åŒè¯­</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">è¯„ä¼°æ–¹å¼</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="quiz" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">è¯¾å ‚æµ‹éªŒ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="assignment" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">è¯¾åä½œä¸š</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="project" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">é¡¹ç›®å®è·µ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="feedback" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-base text-gray-700 dark:text-gray-300">åé¦ˆè°ƒç ”</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-3">å…¶ä»–éœ€æ±‚</label>
                            <textarea id="otherRequirements" placeholder="è¯·è¾“å…¥å…¶ä»–ç‰¹æ®Šéœ€æ±‚..." class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none" rows="3"></textarea>
                        </div>
                        
                        <!-- é¢„è®¾æ¨¡æ¿ -->
                        <div class="border-t border-gray-200 dark:border-gray-600 pt-6 mt-8 pb-8">
                            <label class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-4">å¿«é€Ÿæ¨¡æ¿</label>
                            <div class="space-y-3">
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="basic">
                                    ğŸ“š åŸºç¡€åŸ¹è®­æ¨¡æ¿
                                </button>
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="intensive">
                                    ğŸš€ å¼ºåŒ–è®­ç»ƒæ¨¡æ¿
                                </button>
                                <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors text-base" data-template="workshop">
                                    ğŸ› ï¸ å·¥ä½œåŠæ¨¡æ¿
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€çª—å£åº•éƒ¨ -->
            <div class="flex items-center justify-between p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 shadow-lg">
                <div class="text-base text-gray-600 dark:text-gray-400 flex-1 mr-6">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span class="hidden sm:inline">æ‚¨å¯ä»¥ç¼–è¾‘ç« èŠ‚æ ‡é¢˜å’Œå°èŠ‚å†…å®¹ï¼Œä¹Ÿå¯ä»¥æ‹–æ‹½è°ƒæ•´é¡ºåº</span>
                    <span class="sm:hidden">å¯ç¼–è¾‘å’Œæ‹–æ‹½æ’åº</span>
                </div>
                <div class="flex space-x-4 flex-shrink-0">
                    <button id="resetOutline" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors text-base border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-undo mr-2"></i>é‡ç½®
                    </button>
                    <button id="confirmModalOutline" class="px-8 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors text-base shadow-sm">
                        <i class="fas fa-check mr-2"></i>ç¡®è®¤é€‰æ‹©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¤§çº²æ¨¡æ€çª—å£ -->
    <div id="editOutlineModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-edit text-blue-500 mr-2"></i>ç¼–è¾‘è¯¾ç¨‹å¤§çº²
                </h3>
                <button id="closeEditModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ç¼–è¾‘ -->
                <div class="mb-6">
                    <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">
                        <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è¯¾ç¨‹æ ‡é¢˜</label>
                            <input type="text" id="editCourseTitle" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="è¯·è¾“å…¥è¯¾ç¨‹æ ‡é¢˜">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è¯¾ç¨‹æè¿°</label>
                            <textarea id="editCourseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="è¯·è¾“å…¥è¯¾ç¨‹æè¿°"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é¢„è®¡æ—¶é•¿</label>
                            <input type="text" id="editCourseDuration" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="å¦‚ï¼š2å°æ—¶">
                        </div>
                    </div>
                </div>

                <!-- ç« èŠ‚ç¼–è¾‘ -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-base font-semibold text-gray-900 dark:text-white">
                            <i class="fas fa-list-ul text-blue-500 mr-2"></i>è¯¾ç¨‹ç« èŠ‚
                        </h4>
                        <button id="addChapterInModal" class="px-3 py-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                            <i class="fas fa-plus mr-1"></i>æ·»åŠ ç« èŠ‚
                        </button>
                    </div>
                    
                    <div id="editableChaptersContainer" class="space-y-4">
                        <!-- ç« èŠ‚å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="cancelEditOutline" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="saveEditOutline" class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded font-medium transition-colors">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const AppState = {
            currentStep: 1,
            courseTitle: '',
            uploadedFiles: [],
            selectedOutline: null,
            courseContent: null,
            detailedRequirements: null,
            currentQuestionStep: 1,
            isCollectingRequirements: false,
            currentOutlineOptions: null,
            currentOutlineType: 'A'
        };

        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            messagesContainer: document.getElementById('messagesContainer'),
            fileInput: document.getElementById('fileInput'),
            detailOutlineArea: document.getElementById('detailOutlineArea'),
            outlineEditor: document.getElementById('outlineEditor'),
            confirmOutline: document.getElementById('confirmOutline'),
            progressArea: document.getElementById('progressArea'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            previewArea: document.getElementById('previewArea'),
            aiAssistant: document.getElementById('aiAssistant'),
            courseRequirementInput: document.getElementById('courseRequirementInput'),
            submitRequirement: document.getElementById('submitRequirement'),
            charCount: document.getElementById('charCount')
        };

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', theme === 'dark');
            
            elements.themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(content, isUser = false, isHtml = false, isSpecial = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-4 chat-bubble ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            
            const avatarClass = isUser 
                ? 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0'
                : 'w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0';
            
            const avatarIcon = isUser ? 'fas fa-user' : 'fas fa-robot';
            
            let bubbleClass, contentClass;
            if (isSpecial) {
                bubbleClass = 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-0 max-w-6xl shadow-sm';
                contentClass = '';
            } else {
                bubbleClass = isUser 
                    ? 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm'
                    : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-lg shadow-sm';
                contentClass = 'text-gray-800 dark:text-gray-200 leading-relaxed text-base';
            }
            
            messageDiv.innerHTML = `
                <div class="${avatarClass}">
                    <i class="${avatarIcon} text-white text-sm"></i>
                </div>
                <div class="${bubbleClass}">
                    <div class="${contentClass}">
                        ${isHtml ? content : content}
                    </div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageDiv);
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            
            return messageDiv;
        }

        // å¼€å§‹é€æ­¥æ”¶é›†éœ€æ±‚
        function startStepByStepRequirements() {
            AppState.isCollectingRequirements = true;
            AppState.currentStep = 1.5;
            askNextQuestion();
        }

        // æé—®ä¸‹ä¸€ä¸ªé—®é¢˜
        function askNextQuestion() {
            const questions = [
                {
                    id: 'coreGoal',
                    question: 'ğŸ¯ é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰è¯¾ç¨‹çš„æ ¸å¿ƒç›®æ ‡ï¼šå­¦å®Œè¿™é—¨è¯¾ï¼Œå­¦å‘˜åº”è¯¥èƒ½ç‹¬ç«‹åšä»€ä¹ˆå…·ä½“çš„äº‹ï¼Ÿ',
                    description: 'è¿™æ˜¯æ•´ä¸ªè¯¾ç¨‹çš„"åŒ—ææ˜Ÿ"ï¼Œè¯·å°½å¯èƒ½å…·ä½“åœ°æè¿°ä¸€ä¸ªå¯è¡¡é‡çš„å­¦ä¹ æˆæœ',
                    allowCustom: true,
                    customPlaceholder: 'ä¾‹å¦‚ï¼šç‹¬ç«‹å®Œæˆä¸€ä»½æœˆåº¦é”€å”®æ•°æ®åˆ†ææŠ¥å‘Š / æˆåŠŸå¤„ç†ä¸€æ¬¡å®¢æˆ·æŠ•è¯‰ / ä½¿ç”¨Photoshopè®¾è®¡ä¸€å¼ æ ‡å‡†æµ·æŠ¥',
                    options: [
                        { text: 'ç‹¬ç«‹å®Œæˆæ ‡å‡†åŒ–çš„å·¥ä½œæµç¨‹', value: 'workflow' },
                        { text: 'ç†Ÿç»ƒä½¿ç”¨ç‰¹å®šå·¥å…·æˆ–ç³»ç»Ÿ', value: 'tool-usage' },
                        { text: 'è§£å†³æŸç±»ä¸“ä¸šé—®é¢˜', value: 'problem-solving' },
                        { text: 'æŒæ¡ç‰¹å®šæŠ€èƒ½æˆ–æ–¹æ³•', value: 'skill-mastery' }
                    ]
                },
                {
                    id: 'learnerPersona',
                    question: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘ æ‚¨çš„å­¦å‘˜æ˜¯è°ï¼Ÿè¯·æè¿°ä»–ä»¬çš„èŒä½ã€ç»éªŒæ°´å¹³å’Œç°æœ‰çŸ¥è¯†èƒŒæ™¯',
                    description: 'è¿™å°†å†³å®šå†…å®¹çš„æ·±åº¦ã€æ¡ˆä¾‹çš„è´´åˆ‡åº¦å’Œè¯­è¨€é£æ ¼',
                    options: [
                        { text: 'åˆšå…¥èŒçš„æ–°å‘˜å·¥ï¼Œé›¶åŸºç¡€æˆ–åŸºç¡€è–„å¼±', value: 'new-employee' },
                        { text: 'å·¥ä½œ1-3å¹´çš„åˆçº§å‘˜å·¥ï¼Œæœ‰åŸºæœ¬äº†è§£', value: 'junior-employee' },
                        { text: 'å·¥ä½œ3-5å¹´çš„ä¸­çº§å‘˜å·¥ï¼Œæ‡‚ç†è®ºç¼ºå®æˆ˜', value: 'mid-employee' },
                        { text: 'å·¥ä½œ5å¹´ä»¥ä¸Šçš„èµ„æ·±å‘˜å·¥ï¼Œéœ€è¦æ›´æ–°çŸ¥è¯†', value: 'senior-employee' },
                        { text: 'ç®¡ç†å±‚äººå‘˜ï¼Œéœ€è¦å…¨å±€æ€§ç†è§£', value: 'management' },
                        { text: 'æŠ€æœ¯ä¸“å®¶ï¼Œéœ€è¦æ·±åº¦ä¸“ä¸šçŸ¥è¯†', value: 'expert' }
                    ]
                },
                {
                    id: 'contentSource',
                    question: 'ğŸ“š è¯¾ç¨‹çš„æ ¸å¿ƒçŸ¥è¯†ä¸»è¦æ¥è‡ªå“ªé‡Œï¼Ÿ',
                    description: 'è¿™å°†å¸®åŠ©AIå†³å®šæ˜¯æ•´ç†ç°æœ‰èµ„æ–™è¿˜æ˜¯å…¨æ–°åˆ›ä½œå†…å®¹',
                    options: [
                        { text: 'æˆ‘æœ‰ç°æˆçš„æ–‡æ¡£/PPT/è§†é¢‘èµ„æ–™', value: 'existing-materials' },
                        { text: 'æˆ‘å¸Œæœ›AIå¸®æˆ‘ä»é›¶å¼€å§‹åˆ›ä½œæ ¸å¿ƒå†…å®¹', value: 'ai-creation' },
                        { text: 'æ··åˆæ–¹å¼ï¼šéƒ¨åˆ†ç°æœ‰èµ„æ–™ + éƒ¨åˆ†AIåˆ›ä½œ', value: 'hybrid-content' }
                    ]
                },
                {
                    id: 'teachingActivities',
                    question: 'ğŸ‘¨â€ğŸ« æ‚¨åå¥½å“ªç§æ•™å­¦æ´»åŠ¨çš„ç»„åˆï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰',
                    description: 'AIå°†æ ¹æ®è¿™ä¸ªç»„åˆï¼Œåœ¨å¤§çº²ä¸­ç©¿æ’ä¸åŒç±»å‹çš„å†…å®¹æ¨¡å—',
                    isMultiple: true,
                    options: [
                        { text: 'è§†é¢‘è®²è§£ï¼ˆå½•åˆ¶è®²è§£æˆ–æ¼”ç¤ºè§†é¢‘ï¼‰', value: 'video-lecture' },
                        { text: 'æ–‡ç« é˜…è¯»ï¼ˆç»“æ„åŒ–çš„æ–‡å­—å†…å®¹ï¼‰', value: 'article-reading' },
                        { text: 'æ¡ˆä¾‹åˆ†æï¼ˆçœŸå®ä¸šåŠ¡åœºæ™¯è®¨è®ºï¼‰', value: 'case-analysis' },
                        { text: 'å°ç»„è®¨è®ºï¼ˆå›¢é˜Ÿåä½œå’Œæ€ç»´ç¢°æ’ï¼‰', value: 'group-discussion' },
                        { text: 'å®æ“ç»ƒä¹ ï¼ˆåŠ¨æ‰‹æ“ä½œå’ŒæŠ€èƒ½è®­ç»ƒï¼‰', value: 'hands-on-practice' },
                        { text: 'å˜‰å®¾åˆ†äº«ï¼ˆè¡Œä¸šä¸“å®¶ç»éªŒåˆ†äº«ï¼‰', value: 'guest-sharing' },
                        { text: 'è§’è‰²æ‰®æ¼”ï¼ˆæ¨¡æ‹ŸçœŸå®å·¥ä½œåœºæ™¯ï¼‰', value: 'role-playing' }
                    ]
                },
                {
                    id: 'assessmentMethod',
                    question: 'âœï¸ æ‚¨å¸Œæœ›å¦‚ä½•æ£€éªŒå­¦ä¹ æ•ˆæœï¼Ÿ',
                    description: 'è¿™æ˜¯è®¾è®¡è¯¾ç¨‹"é—­ç¯"çš„å…³é”®ï¼Œè®©å¤§çº²ä¸ä»…æœ‰è¾“å…¥è¿˜æœ‰è¾“å‡º',
                    options: [
                        { text: 'æ¯ä¸ªé‡è¦çŸ¥è¯†ç‚¹åéƒ½éœ€è¦å°ç»ƒä¹ ', value: 'frequent-tests' },
                        { text: 'åªéœ€è¦æœŸæœ«æœ‰ä¸€æ¬¡ç»¼åˆæ€§è€ƒè¯•', value: 'final-exam' },
                        { text: 'é€šè¿‡å®é™…é¡¹ç›®æ¥æ£€éªŒå­¦ä¹ æˆæœ', value: 'project-assessment' },
                        { text: 'è¿™æ˜¯éè€ƒæ ¸çš„è‡ªå­¦è¯¾ç¨‹', value: 'no-assessment' }
                    ]
                },
                {
                    id: 'certification',
                    question: 'ğŸ“œ å­¦å‘˜å®Œæˆå­¦ä¹ åï¼Œæ˜¯å¦éœ€è¦è·å¾—æŸç§å­¦ä¹ å‡­è¯ï¼Ÿ',
                    description: 'è¿™å°†å½±å“è¯¾ç¨‹ç»“æ„å’Œæœ€ç»ˆçš„è®¤è¯æµç¨‹è®¾è®¡',
                    options: [
                        { text: 'éœ€è¦æ­£å¼çš„ç»“ä¸šè¯ä¹¦', value: 'formal-certificate' },
                        { text: 'åªéœ€è¦å­¦ä¹ è®°å½•å’Œå®Œæˆè¯æ˜', value: 'completion-record' },
                        { text: 'æ— éœ€ä»»ä½•å‡­è¯ï¼Œé‡åœ¨å­¦ä¹ è¿‡ç¨‹', value: 'no-certification' }
                    ]
                },
                {
                    id: 'managementLevel',
                    question: 'ğŸ”’ æœ€åï¼Œè¯¾ç¨‹çš„å­¦ä¹ è¿‡ç¨‹éœ€è¦è¢«ä¸¥æ ¼ç®¡ç†å—ï¼Ÿ',
                    description: 'è¿™å°†å†³å®šè¯¾ç¨‹ç»“æ„æ˜¯"çº¿æ€§é—¯å…³å¼"è¿˜æ˜¯"å¼€æ”¾è‡ªç”±å¼"',
                    options: [
                        { text: 'éœ€è¦ä¸¥æ ¼ç®¡ç†ï¼Œè¿™æ˜¯æ­£å¼çš„å¿…ä¿®è¯¾ç¨‹', value: 'strict-management' },
                        { text: 'é€‚åº¦ç®¡ç†ï¼Œæœ‰ä¸€å®šçº¦æŸä½†å…è®¸çµæ´»å­¦ä¹ ', value: 'moderate-management' },
                        { text: 'ä¸éœ€è¦ç®¡ç†ï¼Œé¼“åŠ±å­¦å‘˜è‡ªç”±æ¢ç´¢', value: 'flexible-learning' }
                    ]
                }
            ];

            if (AppState.currentQuestionStep <= questions.length) {
                const currentQuestion = questions[AppState.currentQuestionStep - 1];
                showQuestionCard(currentQuestion);
            } else {
                // æ‰€æœ‰é—®é¢˜å®Œæˆï¼Œæ˜¾ç¤ºæ€»ç»“
                finishRequirementsCollection();
            }
        }

        // æ˜¾ç¤ºé—®é¢˜å¡ç‰‡
        function showQuestionCard(questionData) {
            const questionCard = `
                <div class="p-6">
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
                        <div class="flex items-start space-x-4 mb-6">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-semibold text-base">${AppState.currentQuestionStep}</span>
                    </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
                                    ${questionData.question}
                                </h3>
                                ${questionData.description ? `
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4 leading-relaxed">
                                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>${questionData.description}
                                    </p>
                                ` : ''}
                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span>ç¬¬ ${AppState.currentQuestionStep} é¢˜ï¼Œå…± 7 é¢˜</span>
                                    <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${(AppState.currentQuestionStep / 7) * 100}%"></div>
                            </div>
                            </div>
                        </div>
                    </div>
                        
                        <div class="space-y-3 mb-6" id="questionOptions">
                            ${generateQuestionOptions(questionData)}
                        </div>
                        
                        ${questionData.allowCustom ? `
                            <div class="mb-6">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-edit mr-2 text-blue-500"></i>æˆ–è€…ï¼Œè¯·å…·ä½“æè¿°ï¼š
                                    </h4>
                                    <textarea id="customInput" placeholder="${questionData.customPlaceholder}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none" rows="3"></textarea>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center">
                            <button id="skipQuestion" class="px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm">
                                <i class="fas fa-forward mr-2"></i>è·³è¿‡è¿™é¢˜
                            </button>
                            <button id="nextQuestion" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-arrow-right mr-2"></i>${AppState.currentQuestionStep === 7 ? 'å®Œæˆæ”¶é›†' : 'ä¸‹ä¸€é¢˜'}
                        </button>
                        </div>
                    </div>
                </div>
            `;
            
            const cardElement = addMessage(questionCard, false, true, true);
            initQuestionCard(cardElement, questionData);
        }

        // ç”Ÿæˆé—®é¢˜é€‰é¡¹
        function generateQuestionOptions(questionData) {
            return questionData.options.map((option, index) => {
                const inputType = questionData.isMultiple ? 'checkbox' : 'radio';
                const inputName = questionData.isMultiple ? `${questionData.id}[]` : questionData.id;
                
                return `
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors option-item">
                        <input type="${inputType}" name="${inputName}" value="${option.value}" class="mr-3 ${questionData.isMultiple ? 'rounded' : ''} border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-gray-900 dark:text-white text-sm">${option.text}</span>
                    </label>
                `;
            }).join('');
        }

        // åˆå§‹åŒ–é—®é¢˜å¡ç‰‡äº‹ä»¶
        function initQuestionCard(cardElement, questionData) {
            const nextBtn = cardElement.querySelector('#nextQuestion');
            const skipBtn = cardElement.querySelector('#skipQuestion');
            const customInput = cardElement.querySelector('#customInput');
            const options = cardElement.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            
            // åˆå§‹çŠ¶æ€ä¸‹ä¸€é¢˜æŒ‰é’®ç¦ç”¨
            if (!questionData.isMultiple) {
                nextBtn.disabled = true;
            }
            
            // ç›‘å¬é€‰é¡¹å˜åŒ–
            options.forEach(option => {
                option.addEventListener('change', () => {
                    if (questionData.isMultiple) {
                        // å¤šé€‰é¢˜ï¼Œåªè¦æœ‰é€‰æ‹©å°±å¯ç”¨æŒ‰é’®
                        const checkedOptions = cardElement.querySelectorAll('input:checked');
                        nextBtn.disabled = checkedOptions.length === 0 && (!customInput || !customInput.value.trim());
                    } else {
                        // å•é€‰é¢˜ï¼Œé€‰æ‹©åå¯ç”¨æŒ‰é’®
                        nextBtn.disabled = false;
                    }
                });
            });
            
            // ç›‘å¬è‡ªå®šä¹‰è¾“å…¥
            if (customInput) {
                customInput.addEventListener('input', () => {
                    if (questionData.isMultiple) {
                        const checkedOptions = cardElement.querySelectorAll('input:checked');
                        nextBtn.disabled = checkedOptions.length === 0 && !customInput.value.trim();
                    } else {
                        nextBtn.disabled = !customInput.value.trim();
                        // æ¸…é™¤å…¶ä»–é€‰é¡¹
                        if (customInput.value.trim()) {
                            options.forEach(opt => opt.checked = false);
                        }
                    }
                });
            }
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®äº‹ä»¶
            nextBtn.addEventListener('click', () => {
                handleQuestionAnswer(cardElement, questionData);
            });
            
            // è·³è¿‡æŒ‰é’®äº‹ä»¶
            skipBtn.addEventListener('click', () => {
                AppState.currentQuestionStep++;
                askNextQuestion();
            });
        }

        // åœ¨é—®é¢˜ä¸­æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
        function showFileUploadInQuestion() {
            const uploadCard = `
                <div class="p-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-6 shadow-sm">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-upload text-white text-2xl"></i>
                    </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                                ä¸ºäº†è®©è¯¾ç¨‹å†…å®¹ç²¾å‡†ã€æœ‰æ–™ï¼Œæ‚¨å¯ä»¥ä¸Šä¼ ç›¸å…³èµ„æ–™ï¼š
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                æ”¯æŒæ–‡æ¡£ã€PPTã€PDFç­‰æ ¼å¼ï¼ŒAIå°†æ™ºèƒ½åˆ†æå¹¶æ•´åˆåˆ°è¯¾ç¨‹è®¾è®¡ä¸­
                            </p>
                                 </div>
                        
                        <div class="border-2 border-dashed border-blue-300 dark:border-blue-600 rounded-xl p-8 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors" id="questionUploadArea">
                            <div class="mb-4">
                                <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                                <p class="text-gray-700 dark:text-gray-300 font-medium">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°è¿™é‡Œ</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">æ”¯æŒ PDF, DOC, DOCX, PPT, PPTX</p>
                                 </div>
                            <input type="file" id="questionFileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt">
                             </div>
                        
                        <div id="questionUploadedFiles" class="mt-4 space-y-2 hidden">
                            <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å·²ä¸Šä¼ æ–‡ä»¶ï¼š</p>
                                     </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button id="skipQuestionUpload" class="px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm">
                                <i class="fas fa-forward mr-2"></i>è·³è¿‡ä¸Šä¼ 
                            </button>
                            <button id="continueAfterUpload" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-arrow-right mr-2"></i>ç»§ç»­é—®ç­”
                            </button>
                                         </div>
                                         </div>
                                     </div>
            `;
            
            const cardElement = addMessage(uploadCard, false, true, true);
            initQuestionFileUpload(cardElement);
        }

        // åˆå§‹åŒ–é—®é¢˜ä¸­çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function initQuestionFileUpload(cardElement) {
            const uploadArea = cardElement.querySelector('#questionUploadArea');
            const fileInput = cardElement.querySelector('#questionFileInput');
            const uploadedFilesDiv = cardElement.querySelector('#questionUploadedFiles');
            const skipBtn = cardElement.querySelector('#skipQuestionUpload');
            const continueBtn = cardElement.querySelector('#continueAfterUpload');
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', (e) => {
                handleQuestionFileSelect(e.target.files, uploadedFilesDiv);
            });
            
            // æ‹–æ‹½ä¸Šä¼ å¤„ç†
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                handleQuestionFileSelect(e.dataTransfer.files, uploadedFilesDiv);
            });
            
            // è·³è¿‡ä¸Šä¼ 
            skipBtn.addEventListener('click', () => {
                AppState.currentQuestionStep++;
                setTimeout(() => {
                    askNextQuestion();
                }, 500);
            });
            
            // ç»§ç»­é—®ç­”
            continueBtn.addEventListener('click', () => {
                // ç¦ç”¨ä¸Šä¼ å¡ç‰‡
                cardElement.style.opacity = '0.6';
                cardElement.style.pointerEvents = 'none';
                
                if (AppState.uploadedFiles.length > 0) {
                    addMessage(`å·²ä¸Šä¼  ${AppState.uploadedFiles.length} ä¸ªæ–‡ä»¶ï¼Œå°†åœ¨ç”Ÿæˆè¯¾ç¨‹æ—¶å‚è€ƒè¿™äº›èµ„æ–™ã€‚`, true);
                }
                
                AppState.currentQuestionStep++;
                setTimeout(() => {
                    askNextQuestion();
                }, 800);
            });
        }

        // å¤„ç†é—®é¢˜ä¸­çš„æ–‡ä»¶é€‰æ‹©
        function handleQuestionFileSelect(files, uploadedFilesDiv) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MBé™åˆ¶
                    alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBå¤§å°é™åˆ¶`);
                    return;
                }
                
                // æ·»åŠ åˆ°å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
                AppState.uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                });
                
                // æ˜¾ç¤ºä¸Šä¼ çš„æ–‡ä»¶
                displayQuestionUploadedFile(file, uploadedFilesDiv);
            });
            
            // æ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶åŒºåŸŸ
            if (AppState.uploadedFiles.length > 0) {
                uploadedFilesDiv.classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºé—®é¢˜ä¸­ä¸Šä¼ çš„æ–‡ä»¶
        function displayQuestionUploadedFile(file, container) {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600';
            fileItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center">
                        <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 text-sm"></i>
                                 </div>
                    <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${file.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                </div>
                                     <div class="flex items-center space-x-2">
                    <span class="text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-2 py-1 rounded">å·²ä¸Šä¼ </span>
                    <button class="remove-file-btn text-gray-400 hover:text-red-500 transition-colors" title="ç§»é™¤æ–‡ä»¶">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                                     </div>
            `;
            
            // ç§»é™¤æ–‡ä»¶æŒ‰é’®
            const removeBtn = fileItem.querySelector('.remove-file-btn');
            removeBtn.addEventListener('click', () => {
                const index = AppState.uploadedFiles.findIndex(f => f.name === file.name);
                if (index > -1) {
                    AppState.uploadedFiles.splice(index, 1);
                }
                fileItem.remove();
                
                // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—æ–‡ä»¶åˆ—è¡¨
                if (AppState.uploadedFiles.length === 0) {
                    container.classList.add('hidden');
                }
            });
            
            container.appendChild(fileItem);
        }

        // å¤„ç†é—®é¢˜ç­”æ¡ˆ
        function handleQuestionAnswer(cardElement, questionData) {
            const customInput = cardElement.querySelector('#customInput');
            let answer;
            
            if (questionData.isMultiple) {
                // å¤šé€‰é¢˜
                const checkedOptions = cardElement.querySelectorAll('input:checked');
                answer = {};
                checkedOptions.forEach(option => {
                    answer[option.value] = true;
                });
            } else {
                // å•é€‰é¢˜
                const selectedOption = cardElement.querySelector('input:checked');
                answer = selectedOption ? selectedOption.value : (customInput ? customInput.value.trim() : '');
            }
            
            // ä¿å­˜ç­”æ¡ˆ
            AppState.detailedRequirements[questionData.id] = answer;
            
            // æ˜¾ç¤ºç”¨æˆ·çš„å›ç­”
            let answerText = '';
            if (questionData.isMultiple) {
                const selectedTexts = [];
                Object.keys(answer).forEach(key => {
                    const option = questionData.options.find(opt => opt.value === key);
                    if (option) selectedTexts.push(option.text.split('ï¼ˆ')[0]);
                });
                answerText = selectedTexts.join('ã€');
            } else {
                const option = questionData.options.find(opt => opt.value === answer);
                answerText = option ? option.text.split('ï¼ˆ')[0] : answer;
            }
            
            addMessage(answerText, true);
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯å†…å®¹æ¥æºé—®é¢˜ä¸”é€‰æ‹©äº†éœ€è¦ä¸Šä¼ æ–‡ä»¶çš„é€‰é¡¹
            if (questionData.id === 'contentSource' && 
                (answer === 'existing-materials' || answer === 'hybrid-content')) {
                
                // ç¦ç”¨å½“å‰å¡ç‰‡
                const form = cardElement.querySelector('.bg-white');
                if (form) {
                    form.style.opacity = '0.6';
                    form.style.pointerEvents = 'none';
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                setTimeout(() => {
                    showFileUploadInQuestion();
                }, 800);
                return;
            }
            
            // ç¦ç”¨å½“å‰å¡ç‰‡
            const form = cardElement.querySelector('.bg-white');
            if (form) {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';
            }
            
            // ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜
            AppState.currentQuestionStep++;
            setTimeout(() => {
                askNextQuestion();
            }, 800);
        }

        // å®Œæˆéœ€æ±‚æ”¶é›†
        function finishRequirementsCollection() {
            AppState.isCollectingRequirements = false;
            
            addMessage('ğŸ‰ å®Œç¾ï¼æˆ‘å·²ç»å®Œæˆäº†å¯¹æ‚¨è¯¾ç¨‹éœ€æ±‚çš„æ·±åº¦è°ƒç ”ã€‚é€šè¿‡è¿™7ä¸ªæ ¸å¿ƒé—®é¢˜ï¼Œæˆ‘å¯¹æ‚¨çš„è¯¾ç¨‹è®¾è®¡ç›®æ ‡æœ‰äº†æ¸…æ™°ã€å…¨é¢çš„ç†è§£ã€‚');
            
            setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸Šä¼ äº†æ–‡ä»¶
                if (AppState.uploadedFiles && AppState.uploadedFiles.length > 0) {
                    addMessage(`å¤ªå¥½äº†ï¼æ‚¨å·²ç»ä¸Šä¼ äº† ${AppState.uploadedFiles.length} ä¸ªå‚è€ƒèµ„æ–™ï¼Œæˆ‘å°†ç»“åˆè¿™äº›å†…å®¹æ¥è®¾è®¡è¯¾ç¨‹ã€‚`);
                } else {
                    addMessage('åŸºäºæ‚¨æä¾›çš„è¯¦ç»†éœ€æ±‚ä¿¡æ¯ï¼Œæˆ‘å°†ä¸ºæ‚¨æ™ºèƒ½ç”Ÿæˆä¸“ä¸šçš„è¯¾ç¨‹å†…å®¹ã€‚');
                }
                
                setTimeout(() => {
                    // æ˜¾ç¤ºéœ€æ±‚åˆ†ææ±‡æŠ¥ï¼ˆæ— è®ºæ˜¯å¦æœ‰æ–‡ä»¶ï¼‰
                    showRequirementAnalysisReport();
                }, 800);
            }, 800);
        }

        // æ ¹æ®éœ€æ±‚ç”Ÿæˆè¯¾ç¨‹å¤§çº²
        function generateCourseOutlineFromRequirements() {
            const requirements = AppState.detailedRequirements;
            
            // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
            addMessage('âš¡ æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚ï¼Œæ™ºèƒ½ç”Ÿæˆè¯¾ç¨‹ç»“æ„...');
            
            setTimeout(() => {
                // æ ¹æ®éœ€æ±‚ç”Ÿæˆæ™ºèƒ½å¤§çº²
                const outlineOptions = generateSmartOutlineOptions(requirements);
                
                // æ˜¾ç¤ºåŠ¨æ€ç”Ÿæˆçš„å¤§çº²é€‰æ‹©å¡ç‰‡
                addOutlineSelectionCard(outlineOptions);
                
                AppState.currentStep = 3;
            }, 2000);
        }

        // æ™ºèƒ½ç”Ÿæˆè¯¾ç¨‹å¤§çº²
        function createSmartOutline(requirements) {
            const coreGoal = requirements.coreGoal || '';
            const learnerPersona = requirements.learnerPersona || '';
            const contentSource = requirements.contentSource || '';
            const teachingActivities = requirements.teachingActivities || {};
            const assessmentMethod = requirements.assessmentMethod || '';
            const certification = requirements.certification || '';
            const managementLevel = requirements.managementLevel || '';
            
            // åŸºäºéœ€æ±‚ç”Ÿæˆæ™ºèƒ½å¤§çº²
            let outline = {
                title: AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½åŸ¹è®­è¯¾ç¨‹',
                description: generateCourseDescription(requirements),
                estimatedDuration: estimateCourseDuration(requirements),
                chapters: []
            };
            
            // æ ¹æ®ä¸åŒçš„å­¦å‘˜ç±»å‹å’Œç›®æ ‡ç”Ÿæˆä¸åŒçš„ç« èŠ‚ç»“æ„
            if (learnerPersona === 'new-employee' || learnerPersona === 'junior-employee') {
                // æ–°å‘˜å·¥/åˆçº§å‘˜å·¥ - åŸºç¡€å…¥é—¨å‹å¤§çº²
                outline.chapters = generateBeginnerOutline(requirements);
            } else if (learnerPersona === 'mid-employee' || learnerPersona === 'senior-employee') {
                // ä¸­é«˜çº§å‘˜å·¥ - è¿›é˜¶å®æˆ˜å‹å¤§çº²
                outline.chapters = generateAdvancedOutline(requirements);
            } else if (learnerPersona === 'management') {
                // ç®¡ç†å±‚ - æˆ˜ç•¥ç®¡ç†å‹å¤§çº²
                outline.chapters = generateManagementOutline(requirements);
            } else if (learnerPersona === 'expert') {
                // ä¸“å®¶çº§ - æ·±åº¦ä¸“ä¸šå‹å¤§çº²
                outline.chapters = generateExpertOutline(requirements);
            } else {
                // é»˜è®¤æ ‡å‡†å¤§çº²
                outline.chapters = generateStandardOutline(requirements);
            }
            
            // æ ¹æ®è¯„ä¼°æ–¹å¼è°ƒæ•´ç« èŠ‚
            adjustChaptersForAssessment(outline.chapters, assessmentMethod, teachingActivities);
            
            return outline;
        }

        // ç”Ÿæˆè¯¾ç¨‹æè¿°
        function generateCourseDescription(requirements) {
            const goal = requirements.coreGoal || 'æŒæ¡ä¸“ä¸šæŠ€èƒ½';
            const persona = getLearnerPersonaDisplayText(requirements.learnerPersona || '');
            
            return `æœ¬è¯¾ç¨‹ä¸“ä¸º${persona}è®¾è®¡ï¼Œæ—¨åœ¨å¸®åŠ©å­¦å‘˜${goal.length > 50 ? goal : getCoreGoalDisplayText(goal)}ã€‚é€šè¿‡ç³»ç»ŸåŒ–çš„å­¦ä¹ å’Œå®è·µï¼Œå­¦å‘˜å°†èƒ½å¤Ÿç†Ÿç»ƒæŒæ¡ç›¸å…³æŠ€èƒ½å¹¶åº”ç”¨åˆ°å®é™…å·¥ä½œä¸­ã€‚`;
        }

        // ä¼°ç®—è¯¾ç¨‹æ—¶é•¿
        function estimateCourseDuration(requirements) {
            const persona = requirements.learnerPersona;
            const activities = requirements.teachingActivities || {};
            const assessment = requirements.assessmentMethod;
            
            let baseDuration = 2; // åŸºç¡€2å°æ—¶
            
            // æ ¹æ®å­¦å‘˜ç±»å‹è°ƒæ•´
            if (persona === 'new-employee') baseDuration += 1;
            if (persona === 'expert') baseDuration += 2;
            if (persona === 'management') baseDuration += 0.5;
            
            // æ ¹æ®æ•™å­¦æ´»åŠ¨è°ƒæ•´
            if (activities['hands-on-practice']) baseDuration += 1;
            if (activities['case-analysis']) baseDuration += 0.5;
            if (activities['group-discussion']) baseDuration += 0.5;
            if (activities['role-playing']) baseDuration += 1;
            
            // æ ¹æ®è¯„ä¼°æ–¹å¼è°ƒæ•´
            if (assessment === 'project-assessment') baseDuration += 1;
            if (assessment === 'frequent-tests') baseDuration += 0.5;
            
            return `${Math.ceil(baseDuration)}å°æ—¶`;
        }

        // ç”Ÿæˆæ–°å‘˜å·¥/åˆçº§å‘˜å·¥å¤§çº²
        function generateBeginnerOutline(requirements) {
            const topic = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½';
            return [
                {
                    title: `${topic}åŸºç¡€è®¤çŸ¥`,
                    subtitle: 'å»ºç«‹æ­£ç¡®çš„ç†è§£å’Œè®¤çŸ¥',
                    sections: [
                        'åŸºæœ¬æ¦‚å¿µä¸é‡è¦æ€§',
                        'æ ¸å¿ƒåŸç†ä¸æ¡†æ¶',
                        'å¸¸è§è¯¯åŒºä¸æ³¨æ„äº‹é¡¹'
                    ]
                },
                {
                    title: 'æ ¸å¿ƒæŠ€èƒ½å…¥é—¨',
                    subtitle: 'æŒæ¡åŸºç¡€æ“ä½œå’Œæ–¹æ³•',
                    sections: [
                        'åŸºç¡€æ“ä½œæ¼”ç¤º',
                        'æ ‡å‡†æµç¨‹ä»‹ç»',
                        'å®æ“ç»ƒä¹ æŒ‡å¯¼'
                    ]
                },
                {
                    title: 'å®è·µåº”ç”¨è®­ç»ƒ',
                    subtitle: 'é€šè¿‡ç»ƒä¹ å·©å›ºæŠ€èƒ½',
                    sections: [
                        'åœºæ™¯æ¨¡æ‹Ÿç»ƒä¹ ',
                        'å¸¸è§é—®é¢˜å¤„ç†',
                        'æŠ€èƒ½ç†Ÿç»ƒåº¦è®­ç»ƒ'
                    ]
                },
                {
                    title: 'æ€»ç»“æå‡',
                    subtitle: 'å·©å›ºå­¦ä¹ æˆæœ',
                    sections: [
                        'çŸ¥è¯†ç‚¹å›é¡¾',
                        'æŠ€èƒ½è‡ªæµ‹è¯„ä¼°',
                        'æŒç»­å­¦ä¹ æŒ‡å¯¼'
                    ]
                }
            ];
        }

        // ç”Ÿæˆä¸­é«˜çº§å‘˜å·¥å¤§çº²
        function generateAdvancedOutline(requirements) {
            const topic = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½';
            return [
                {
                    title: `${topic}è¿›é˜¶ç†è®º`,
                    subtitle: 'æ·±å…¥ç†è§£æ ¸å¿ƒç†å¿µ',
                    sections: [
                        'é«˜çº§ç†è®ºæ¡†æ¶',
                        'æœ€ä½³å®è·µåˆ†æ',
                        'è¡Œä¸šè¶‹åŠ¿æ´å¯Ÿ'
                    ]
                },
                {
                    title: 'é«˜æ•ˆæ–¹æ³•æŠ€å·§',
                    subtitle: 'æŒæ¡è¿›é˜¶æŠ€èƒ½å’ŒæŠ€å·§',
                    sections: [
                        'é«˜çº§åŠŸèƒ½åº”ç”¨',
                        'æ•ˆç‡æå‡æŠ€å·§',
                        'è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨'
                    ]
                },
                {
                    title: 'å¤æ‚åœºæ™¯å®æˆ˜',
                    subtitle: 'è§£å†³å¤æ‚ä¸šåŠ¡é—®é¢˜',
                    sections: [
                        'å¤æ‚æ¡ˆä¾‹åˆ†æ',
                        'é—®é¢˜è¯Šæ–­ä¸è§£å†³',
                        'å®æˆ˜é¡¹ç›®æ¼”ç»ƒ'
                    ]
                },
                {
                    title: 'ä¸“ä¸šèƒ½åŠ›è¿›é˜¶',
                    subtitle: 'æˆä¸ºé¢†åŸŸä¸“å®¶',
                    sections: [
                        'ä¸“ä¸šè®¤è¯å‡†å¤‡',
                        'æŒç»­æ”¹è¿›æ–¹æ³•',
                        'çŸ¥è¯†åˆ†äº«ä¸ä¼ æ‰¿'
                    ]
                }
            ];
        }

        // ç”Ÿæˆç®¡ç†å±‚å¤§çº²
        function generateManagementOutline(requirements) {
            const topic = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½';
            return [
                {
                    title: `${topic}æˆ˜ç•¥è§†è§’`,
                    subtitle: 'ä»ç®¡ç†è§’åº¦ç†è§£é‡è¦æ€§',
                    sections: [
                        'ä¸šåŠ¡ä»·å€¼åˆ†æ',
                        'ç»„ç»‡å½±å“è¯„ä¼°',
                        'æŠ•èµ„å›æŠ¥åˆ†æ'
                    ]
                },
                {
                    title: 'å›¢é˜Ÿèƒ½åŠ›å»ºè®¾',
                    subtitle: 'æå‡å›¢é˜Ÿæ•´ä½“èƒ½åŠ›',
                    sections: [
                        'å›¢é˜ŸæŠ€èƒ½è¯„ä¼°',
                        'åŸ¹è®­ä½“ç³»è§„åˆ’',
                        'èƒ½åŠ›å‘å±•è·¯å¾„'
                    ]
                },
                {
                    title: 'ç®¡ç†å®æ–½ç­–ç•¥',
                    subtitle: 'æœ‰æ•ˆæ¨è¿›å’Œç®¡ç†',
                    sections: [
                        'å®æ–½è®¡åˆ’åˆ¶å®š',
                        'å˜é©ç®¡ç†æ–¹æ³•',
                        'æ•ˆæœç›‘æ§æœºåˆ¶'
                    ]
                },
                {
                    title: 'æŒç»­ä¼˜åŒ–æ”¹è¿›',
                    subtitle: 'å»ºç«‹é•¿æ•ˆæœºåˆ¶',
                    sections: [
                        'ç»©æ•ˆè¯„ä¼°ä½“ç³»',
                        'æŒç»­æ”¹è¿›æµç¨‹',
                        'æœ€ä½³å®è·µæ²‰æ·€'
                    ]
                }
            ];
        }

        // ç”Ÿæˆä¸“å®¶çº§å¤§çº²
        function generateExpertOutline(requirements) {
            const topic = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½';
            return [
                {
                    title: `${topic}å‰æ²¿æŠ€æœ¯`,
                    subtitle: 'æŒæ¡æœ€æ–°æŠ€æœ¯å‘å±•',
                    sections: [
                        'å‰æ²¿æŠ€æœ¯è¶‹åŠ¿',
                        'åˆ›æ–°åº”ç”¨æ¡ˆä¾‹',
                        'æŠ€æœ¯æ¼”è¿›è·¯å¾„'
                    ]
                },
                {
                    title: 'æ·±åº¦æŠ€æœ¯å®è·µ',
                    subtitle: 'è§£å†³æŠ€æœ¯éš¾é¢˜',
                    sections: [
                        'é«˜éš¾åº¦æŠ€æœ¯æŒ‘æˆ˜',
                        'æ€§èƒ½ä¼˜åŒ–ç­–ç•¥',
                        'æ¶æ„è®¾è®¡åŸåˆ™'
                    ]
                },
                {
                    title: 'è¡Œä¸šè§£å†³æ–¹æ¡ˆ',
                    subtitle: 'æ„å»ºä¸“ä¸šè§£å†³æ–¹æ¡ˆ',
                    sections: [
                        'è¡Œä¸šç‰¹å®šéœ€æ±‚',
                        'å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆ',
                        'æ–¹æ¡ˆå®æ–½ä¸ä¼˜åŒ–'
                    ]
                },
                {
                    title: 'ä¸“ä¸šå½±å“åŠ›',
                    subtitle: 'æˆä¸ºè¡Œä¸šé¢†å¯¼è€…',
                    sections: [
                        'æŠ€æœ¯åˆ†äº«ä¸å¸ƒé“',
                        'è¡Œä¸šæ ‡å‡†åˆ¶å®š',
                        'åˆ›æ–°ç ”ç©¶æ–¹å‘'
                    ]
                }
            ];
        }

        // ç”Ÿæˆæ ‡å‡†å¤§çº²
        function generateStandardOutline(requirements) {
            const topic = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½';
            return [
                {
                    title: `${topic}æ¦‚è¿°`,
                    subtitle: 'å…¨é¢äº†è§£åŸºç¡€çŸ¥è¯†',
                    sections: [
                        'åŸºç¡€æ¦‚å¿µä»‹ç»',
                        'åº”ç”¨åœºæ™¯åˆ†æ',
                        'å­¦ä¹ ç›®æ ‡è®¾å®š'
                    ]
                },
                {
                    title: 'æ ¸å¿ƒæŠ€èƒ½æŒæ¡',
                    subtitle: 'å­¦ä¹ æ ¸å¿ƒæ“ä½œæŠ€èƒ½',
                    sections: [
                        'æ ¸å¿ƒåŠŸèƒ½è¯¦è§£',
                        'æ“ä½œæµç¨‹æ¼”ç¤º',
                        'å®è·µæ“ä½œè®­ç»ƒ'
                    ]
                },
                {
                    title: 'åº”ç”¨å®è·µ',
                    subtitle: 'åœ¨å®é™…åœºæ™¯ä¸­åº”ç”¨',
                    sections: [
                        'å…¸å‹æ¡ˆä¾‹åˆ†æ',
                        'å®é™…é—®é¢˜è§£å†³',
                        'ç»¼åˆç»ƒä¹ é¡¹ç›®'
                    ]
                },
                {
                    title: 'æ€»ç»“ä¸æå‡',
                    subtitle: 'å·©å›ºå­¦ä¹ æˆæœ',
                    sections: [
                        'çŸ¥è¯†ç‚¹æ€»ç»“',
                        'æŠ€èƒ½è¯„ä¼°æµ‹è¯•',
                        'åç»­å­¦ä¹ å»ºè®®'
                    ]
                }
            ];
        }

        // æ ¹æ®è¯„ä¼°æ–¹å¼è°ƒæ•´ç« èŠ‚
        function adjustChaptersForAssessment(chapters, assessmentMethod, teachingActivities) {
            // å¦‚æœéœ€è¦é¢‘ç¹æµ‹è¯•ï¼Œåœ¨æ¯ç« åæ·»åŠ æµ‹è¯•ç¯èŠ‚
            if (assessmentMethod === 'frequent-tests') {
                chapters.forEach(chapter => {
                    chapter.sections.push('æœ¬ç« çŸ¥è¯†æ£€æµ‹');
                });
            }
            
            // å¦‚æœéœ€è¦é¡¹ç›®è¯„ä¼°ï¼Œç¡®ä¿æœ€åä¸€ç« åŒ…å«é¡¹ç›®
            if (assessmentMethod === 'project-assessment') {
                const lastChapter = chapters[chapters.length - 1];
                if (!lastChapter.sections.some(s => s.includes('é¡¹ç›®'))) {
                    lastChapter.sections.push('ç»¼åˆé¡¹ç›®å®è·µ');
                }
            }
            
            // å¦‚æœåŒ…å«å°ç»„è®¨è®ºï¼Œåœ¨åˆé€‚çš„ç« èŠ‚æ·»åŠ è®¨è®ºç¯èŠ‚
            if (teachingActivities['group-discussion']) {
                if (chapters.length >= 2) {
                    chapters[1].sections.push('å°ç»„è®¨è®ºä¸åˆ†äº«');
                }
            }
            
            // å¦‚æœåŒ…å«è§’è‰²æ‰®æ¼”ï¼Œæ·»åŠ æ¨¡æ‹Ÿç»ƒä¹ 
            if (teachingActivities['role-playing']) {
                if (chapters.length >= 3) {
                    chapters[2].sections.push('è§’è‰²æ‰®æ¼”ç»ƒä¹ ');
                }
            }
        }

        // åˆ›å»ºå¯ç¼–è¾‘çš„å¤§çº²å¡ç‰‡
        function createEditableOutlineCard(outline) {
            const outlineCard = `
                <div class="p-4">
                                         <!-- è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ -->
                     <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg p-3 mb-4">
                         <div class="flex items-start space-x-2">
                             <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center flex-shrink-0">
                                 <i class="fas fa-graduation-cap text-white text-sm"></i>
                                         </div>
                             <div class="flex-1">
                                 <h3 class="text-base font-bold text-gray-900 dark:text-white mb-1">${outline.title}</h3>
                                 <p class="text-gray-600 dark:text-gray-400 text-xs mb-2">${outline.description}</p>
                                 <div class="flex items-center space-x-3 text-xs">
                                     <div class="flex items-center space-x-1">
                                         <i class="fas fa-clock text-blue-500 text-xs"></i>
                                         <span class="text-gray-700 dark:text-gray-300">é¢„è®¡æ—¶é•¿ï¼š<span class="font-medium">${outline.estimatedDuration}</span></span>
                                         </div>
                                     <div class="flex items-center space-x-1">
                                         <i class="fas fa-list-ol text-green-500 text-xs"></i>
                                         <span class="text-gray-700 dark:text-gray-300">ç« èŠ‚æ•°é‡ï¼š<span class="font-medium">${outline.chapters.length}ç« </span></span>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>

                                         <!-- è¯¾ç¨‹å¤§çº² -->
                     <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                         <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                             <div class="flex items-center justify-between">
                                 <h4 class="text-base font-semibold text-gray-900 dark:text-white">
                                     <i class="fas fa-list-ul text-blue-500 mr-1 text-xs"></i>è¯¾ç¨‹å¤§çº²
                                 </h4>
                                     <div class="flex items-center space-x-2">
                                     <button id="editOutline" class="px-3 py-1 text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors">
                                         <i class="fas fa-edit mr-1 text-xs"></i>ç¼–è¾‘
                                     </button>
                                     <button id="previewOutline" class="px-3 py-1 text-xs bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                                         <i class="fas fa-eye mr-1 text-xs"></i>é¢„è§ˆ
                                     </button>
                                     </div>
                                         </div>
                                         </div>
                        
                        <div id="viewOnlyOutlineContainer" class="p-3 space-y-2">
                            ${generateViewOnlyChapters(outline.chapters)}
                                     </div>
                        
                                                 <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750 rounded-b-lg">
                             <div class="flex justify-between items-center">
                                 <div class="text-xs text-gray-600 dark:text-gray-400">
                                     <i class="fas fa-info-circle mr-1 text-xs"></i>
                                     ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®åœ¨å¼¹çª—ä¸­ä¿®æ”¹è¯¾ç¨‹å†…å®¹
                                 </div>
                                 <div class="flex space-x-2">
                                     <button id="regenerateOutline" class="px-3 py-1 text-xs text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                         <i class="fas fa-sync-alt mr-1 text-xs"></i>é‡æ–°ç”Ÿæˆ
                                     </button>
                                     <button id="confirmFinalOutline" class="px-4 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded font-medium transition-colors">
                                         <i class="fas fa-check mr-1 text-xs"></i>ç¡®è®¤å¤§çº²
                                     </button>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            `;
            
            return outlineCard;
        }

        // ç”Ÿæˆç« èŠ‚æµè§ˆæ¨¡å¼
        function generateViewOnlyChapters(chapters) {
            return chapters.map((chapter, chapterIndex) => `
                <div class="chapter-item bg-gray-50 dark:bg-gray-700 rounded p-2 border border-gray-200 dark:border-gray-600 mb-2" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-2">
                        <div class="w-6 h-6 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-xs">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h5 class="chapter-title text-sm font-medium text-gray-900 dark:text-white mb-1">${chapter.title}</h5>
                            <p class="chapter-subtitle text-xs text-gray-600 dark:text-gray-400 mb-2">${chapter.subtitle}</p>
                            
                            <div class="sections-container space-y-1">
                                ${generateViewOnlySections(chapter.sections, chapterIndex)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç”Ÿæˆå°èŠ‚æµè§ˆæ¨¡å¼
        function generateViewOnlySections(sections, chapterIndex) {
            return sections.map((section, sectionIndex) => `
                <div class="section-item flex items-center space-x-2 p-1 bg-white dark:bg-gray-600 rounded" data-section-index="${sectionIndex}">
                    <div class="w-4 h-4 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                        <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionIndex + 1}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="section-title text-xs text-gray-700 dark:text-gray-200">${section}</div>
                    </div>
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–å¯ç¼–è¾‘å¤§çº²
        function initEditableOutline(cardElement, outline) {
            if (!cardElement) return;
            
            // ä¿å­˜åŸå§‹å¤§çº²æ•°æ®
            AppState.currentOutline = outline;
            
            // åˆå§‹åŒ–æ‹–æ‹½æ’åº
            initChapterDragAndDrop(cardElement);
            
            // åˆå§‹åŒ–ç¼–è¾‘åŠŸèƒ½
            initOutlineEditing(cardElement);
            
            // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
            initOutlineButtons(cardElement);
        }

        // åˆå§‹åŒ–ç« èŠ‚æ‹–æ‹½æ’åº
        function initChapterDragAndDrop(container) {
            const chapterItems = container.querySelectorAll('.chapter-item');
            
            chapterItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.chapterIndex);
                    item.classList.add('opacity-50');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(item.dataset.chapterIndex);
                    
                    if (draggedIndex !== targetIndex) {
                        reorderChapters(container, draggedIndex, targetIndex);
                    }
                });
            });
        }

        // é‡æ–°æ’åºç« èŠ‚
        function reorderChapters(container, fromIndex, toIndex) {
            const outlineContainer = container.querySelector('#editableOutlineContainer');
            const items = Array.from(outlineContainer.children);
            const draggedItem = items[fromIndex];
            const targetItem = items[toIndex];
            
            if (fromIndex < toIndex) {
                targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedItem, targetItem);
            }
            
            // æ›´æ–°ç´¢å¼•å’Œç¼–å·
            updateChapterIndexes(outlineContainer);
        }

        // æ›´æ–°ç« èŠ‚ç´¢å¼•
        function updateChapterIndexes(container) {
            const chapterItems = container.querySelectorAll('.chapter-item');
            chapterItems.forEach((item, index) => {
                item.dataset.chapterIndex = index;
                const numberSpan = item.querySelector('.w-12 span');
                numberSpan.textContent = index + 1;
                
                // æ›´æ–°å°èŠ‚ç¼–å·
                const sectionItems = item.querySelectorAll('.section-item');
                sectionItems.forEach((section, sectionIndex) => {
                    const sectionNumber = section.querySelector('.w-8 span');
                    sectionNumber.textContent = `${index + 1}.${sectionIndex + 1}`;
                });
            });
        }

        // åˆå§‹åŒ–å¤§çº²ç¼–è¾‘åŠŸèƒ½
        function initOutlineEditing(cardElement) {
            // å¯ç¼–è¾‘å­—æ®µçš„æ ·å¼å¤„ç†
            const editableFields = cardElement.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                field.addEventListener('focus', () => {
                    field.classList.add('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
                });
                
                field.addEventListener('blur', () => {
                    field.classList.remove('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
                });
                
                // é˜»æ­¢å›è½¦é”®æ¢è¡Œ
                field.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        field.blur();
                    }
                });
            });
            
            // æ·»åŠ å°èŠ‚æŒ‰é’®
            const addSectionBtns = cardElement.querySelectorAll('.add-section-btn');
            addSectionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    addNewSection(e.target.closest('.chapter-item'));
                });
            });
            
            // åˆ é™¤ç« èŠ‚æŒ‰é’®
            const deleteChapterBtns = cardElement.querySelectorAll('.delete-chapter-btn');
            deleteChapterBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteChapter(e.target.closest('.chapter-item'), cardElement);
                });
            });
            
            // åˆ é™¤å°èŠ‚æŒ‰é’®
            const deleteSectionBtns = cardElement.querySelectorAll('.delete-section-btn');
            deleteSectionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteSection(e.target.closest('.section-item'));
                });
            });
        }

        // æ·»åŠ æ–°å°èŠ‚
        function addNewSection(chapterItem) {
            const sectionsContainer = chapterItem.querySelector('.sections-container');
            const chapterIndex = parseInt(chapterItem.dataset.chapterIndex);
            const sectionCount = sectionsContainer.children.length;
            
            const newSectionHtml = generateEditableSections(['æ–°å°èŠ‚'], chapterIndex).replace(
                `${chapterIndex + 1}.1`,
                `${chapterIndex + 1}.${sectionCount + 1}`
            );
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newSectionHtml;
            const newSection = tempDiv.firstElementChild;
            
            sectionsContainer.appendChild(newSection);
            
            // åˆå§‹åŒ–æ–°å°èŠ‚çš„äº‹ä»¶
            initSectionEvents(newSection);
            
            // è‡ªåŠ¨èšç„¦åˆ°æ–°å°èŠ‚æ ‡é¢˜
            const titleField = newSection.querySelector('.section-title');
            titleField.focus();
            titleField.select();
        }

        // åˆ é™¤ç« èŠ‚
        function deleteChapter(chapterItem, cardElement) {
            const container = cardElement.querySelector('#editableOutlineContainer');
            if (container.children.length > 1) {
                chapterItem.remove();
                updateChapterIndexes(container);
                updateChapterCount(cardElement);
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç« èŠ‚');
            }
        }

        // åˆ é™¤å°èŠ‚
        function deleteSection(sectionItem) {
            const sectionsContainer = sectionItem.parentElement;
            if (sectionsContainer.children.length > 1) {
                sectionItem.remove();
                updateSectionNumbers(sectionsContainer);
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå°èŠ‚');
            }
        }

        // æ›´æ–°å°èŠ‚ç¼–å·
        function updateSectionNumbers(sectionsContainer) {
            const chapterIndex = parseInt(sectionsContainer.closest('.chapter-item').dataset.chapterIndex);
            const sectionItems = sectionsContainer.querySelectorAll('.section-item');
            
            sectionItems.forEach((section, index) => {
                section.dataset.sectionIndex = index;
                const numberSpan = section.querySelector('.w-8 span');
                numberSpan.textContent = `${chapterIndex + 1}.${index + 1}`;
            });
        }

        // æ›´æ–°ç« èŠ‚è®¡æ•°
        function updateChapterCount(cardElement) {
            const chapterCount = cardElement.querySelectorAll('.chapter-item').length;
            const countSpan = cardElement.querySelector('.text-gray-700 .font-medium');
            if (countSpan) {
                countSpan.textContent = `${chapterCount}ç« `;
            }
        }

        // åˆå§‹åŒ–å°èŠ‚äº‹ä»¶
        function initSectionEvents(sectionElement) {
            const deleteBtn = sectionElement.querySelector('.delete-section-btn');
            const editableField = sectionElement.querySelector('.editable-field');
            
            deleteBtn.addEventListener('click', () => {
                deleteSection(sectionElement);
            });
            
            editableField.addEventListener('focus', () => {
                editableField.classList.add('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
            });
            
            editableField.addEventListener('blur', () => {
                editableField.classList.remove('bg-white', 'dark:bg-gray-800', 'ring-2', 'ring-blue-500', 'ring-opacity-50');
            });
            
            editableField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    editableField.blur();
                }
            });
        }

        // åˆå§‹åŒ–å¤§çº²æŒ‰é’®äº‹ä»¶
        function initOutlineButtons(cardElement) {
            const editBtn = cardElement.querySelector('#editOutline');
            const previewBtn = cardElement.querySelector('#previewOutline');
            const regenerateBtn = cardElement.querySelector('#regenerateOutline');
            const confirmBtn = cardElement.querySelector('#confirmFinalOutline');
            
            // ç¼–è¾‘å¤§çº²
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    openEditOutlineModal();
                });
            }
            
            // é¢„è§ˆå¤§çº²
            if (previewBtn) {
                previewBtn.addEventListener('click', () => {
                    previewCurrentOutline();
                });
            }
            
            // é‡æ–°ç”Ÿæˆ
            if (regenerateBtn) {
                regenerateBtn.addEventListener('click', () => {
                    regenerateCurrentOutline();
                });
            }
            
            // ç¡®è®¤å¤§çº²
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    confirmFinalOutline(cardElement);
                });
            }
        }

        // æ·»åŠ æ–°ç« èŠ‚
        function addNewChapter(cardElement) {
            const container = cardElement.querySelector('#editableOutlineContainer');
            const chapterCount = container.children.length;
            
            const newChapter = {
                title: 'æ–°ç« èŠ‚',
                subtitle: 'ç« èŠ‚æè¿°',
                sections: ['æ–°å°èŠ‚']
            };
            
            const newChapterHtml = generateEditableChapters([newChapter]).replace(
                'data-chapter-index="0"',
                `data-chapter-index="${chapterCount}"`
            ).replace('text-lg">1<', `text-lg">${chapterCount + 1}<`);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newChapterHtml;
            const newChapterElement = tempDiv.firstElementChild;
            
            container.appendChild(newChapterElement);
            
            // åˆå§‹åŒ–æ–°ç« èŠ‚çš„äº‹ä»¶
            initNewChapterEvents(newChapterElement);
            updateChapterCount(cardElement);
            
            // è‡ªåŠ¨èšç„¦åˆ°æ–°ç« èŠ‚æ ‡é¢˜
            const titleField = newChapterElement.querySelector('.chapter-title');
            titleField.focus();
            titleField.select();
        }

        // åˆå§‹åŒ–æ–°ç« èŠ‚äº‹ä»¶
        function initNewChapterEvents(chapterElement) {
            // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰ç¼–è¾‘åŠŸèƒ½
            initOutlineEditing(chapterElement.closest('.p-8'));
        }

        // é¢„è§ˆå½“å‰å¤§çº²
        function previewCurrentOutline() {
            showOutlinePreviewModal(AppState.currentOutline);
        }

        // é‡æ–°ç”Ÿæˆå¤§çº²
        function regenerateCurrentOutline() {
            addMessage('âš¡ æ­£åœ¨é‡æ–°ç”Ÿæˆè¯¾ç¨‹å¤§çº²ï¼Œè¯·ç¨å€™...');
            
            setTimeout(() => {
                // é‡æ–°ç”Ÿæˆå¤§çº²
                const newOutline = createSmartOutline(AppState.detailedRequirements);
                
                // æ›´æ–°å½“å‰å¤§çº²æ•°æ®
                AppState.currentOutline = newOutline;
                
                // æ›´æ–°æ˜¾ç¤º
                updateOutlineDisplay();
                
                addMessage('âœ¨ å¤§çº²å·²é‡æ–°ç”Ÿæˆï¼æˆ‘åŸºäºæ‚¨çš„éœ€æ±‚ç”Ÿæˆäº†å…¨æ–°çš„è¯¾ç¨‹ç»“æ„ã€‚');
            }, 2000);
        }

        // æ‰“å¼€ç¼–è¾‘å¤§çº²æ¨¡æ€çª—å£
        function openEditOutlineModal() {
            const modal = document.getElementById('editOutlineModal');
            const currentOutline = AppState.currentOutline;
            
            // å¡«å……å½“å‰æ•°æ®
            document.getElementById('editCourseTitle').value = currentOutline.title;
            document.getElementById('editCourseDescription').value = currentOutline.description;
            document.getElementById('editCourseDuration').value = currentOutline.estimatedDuration;
            
            // ç”Ÿæˆå¯ç¼–è¾‘çš„ç« èŠ‚
            generateEditableChaptersInModal(currentOutline.chapters);
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            modal.classList.remove('hidden');
            
            // åˆå§‹åŒ–æ¨¡æ€çª—å£äº‹ä»¶
            initEditModalEvents();
        }

        // åœ¨æ¨¡æ€çª—å£ä¸­ç”Ÿæˆå¯ç¼–è¾‘ç« èŠ‚
        function generateEditableChaptersInModal(chapters) {
            const container = document.getElementById('editableChaptersContainer');
            container.innerHTML = chapters.map((chapter, chapterIndex) => `
                <div class="chapter-edit-item border border-gray-200 dark:border-gray-600 rounded-lg p-4" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-sm">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ç« èŠ‚æ ‡é¢˜</label>
                                <input type="text" class="chapter-title-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${chapter.title}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ç« èŠ‚æè¿°</label>
                                <input type="text" class="chapter-subtitle-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${chapter.subtitle}">
                            </div>
                        </div>
                                     <div class="flex items-center space-x-2">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="æ·»åŠ å°èŠ‚">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤ç« èŠ‚">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                                     </div>
                                         </div>
                    
                    <div class="sections-edit-container space-y-2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">å°èŠ‚åˆ—è¡¨</label>
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-edit-item flex items-center space-x-2" data-section-index="${sectionIndex}">
                                <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                    <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                         </div>
                                <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="${section}">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤å°èŠ‚">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                                     </div>
                        `).join('')}
                                 </div>
                             </div>
            `).join('');
        }

        // åˆå§‹åŒ–ç¼–è¾‘æ¨¡æ€çª—å£äº‹ä»¶
        function initEditModalEvents() {
            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('closeEditModal').onclick = closeEditModal;
            document.getElementById('cancelEditOutline').onclick = closeEditModal;
            
            // ä¿å­˜ä¿®æ”¹
            document.getElementById('saveEditOutline').onclick = saveEditOutline;
            
            // æ·»åŠ ç« èŠ‚
            document.getElementById('addChapterInModal').onclick = addChapterInModal;
            
            // ç« èŠ‚å’Œå°èŠ‚æ“ä½œäº‹ä»¶
            initChapterSectionEvents();
        }

        // åˆå§‹åŒ–ç« èŠ‚å’Œå°èŠ‚æ“ä½œäº‹ä»¶
        function initChapterSectionEvents() {
            const container = document.getElementById('editableChaptersContainer');
            
            // åˆ é™¤ç« èŠ‚
            container.addEventListener('click', (e) => {
                if (e.target.closest('.delete-chapter-btn')) {
                    const chapterItem = e.target.closest('.chapter-edit-item');
                    chapterItem.remove();
                    updateChapterNumbers();
                }
            });
            
            // æ·»åŠ å°èŠ‚
            container.addEventListener('click', (e) => {
                if (e.target.closest('.add-section-btn')) {
                    const chapterItem = e.target.closest('.chapter-edit-item');
                    const sectionsContainer = chapterItem.querySelector('.sections-edit-container');
                    const chapterIndex = parseInt(chapterItem.dataset.chapterIndex);
                    const sectionCount = sectionsContainer.querySelectorAll('.section-edit-item').length;
                    
                    const newSectionHtml = `
                        <div class="section-edit-item flex items-center space-x-2" data-section-index="${sectionCount}">
                            <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterIndex + 1}.${sectionCount + 1}</span>
                            </div>
                            <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="æ–°å°èŠ‚">
                            <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤å°èŠ‚">
                                <i class="fas fa-times text-xs"></i>
                                 </button>
                        </div>
                    `;
                    sectionsContainer.insertAdjacentHTML('beforeend', newSectionHtml);
                }
            });
            
            // åˆ é™¤å°èŠ‚
            container.addEventListener('click', (e) => {
                if (e.target.closest('.delete-section-btn')) {
                    const sectionItem = e.target.closest('.section-edit-item');
                    sectionItem.remove();
                    updateSectionNumbers();
                }
            });
        }

        // æ·»åŠ ç« èŠ‚åˆ°æ¨¡æ€çª—å£
        function addChapterInModal() {
            const container = document.getElementById('editableChaptersContainer');
            const chapterCount = container.children.length;
            
            const newChapterHtml = `
                <div class="chapter-edit-item border border-gray-200 dark:border-gray-600 rounded-lg p-4" data-chapter-index="${chapterCount}">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-blue-600 dark:text-blue-400 font-medium text-sm">${chapterCount + 1}</span>
                        </div>
                        <div class="flex-1 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ç« èŠ‚æ ‡é¢˜</label>
                                <input type="text" class="chapter-title-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="æ–°ç« èŠ‚">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">ç« èŠ‚æè¿°</label>
                                <input type="text" class="chapter-subtitle-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded text-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="ç« èŠ‚æè¿°">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="æ·»åŠ å°èŠ‚">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤ç« èŠ‚">
                                <i class="fas fa-trash text-xs"></i>
                                 </button>
                             </div>
                         </div>

                    <div class="sections-edit-container space-y-2">
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">å°èŠ‚åˆ—è¡¨</label>
                        <div class="section-edit-item flex items-center space-x-2" data-section-index="0">
                            <div class="w-6 h-6 bg-gray-200 dark:bg-gray-500 rounded flex items-center justify-center flex-shrink-0">
                                <span class="text-gray-600 dark:text-gray-300 text-xs">${chapterCount + 1}.1</span>
                            </div>
                            <input type="text" class="section-title-input flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" value="æ–°å°èŠ‚">
                            <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤å°èŠ‚">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newChapterHtml);
        }

        // æ›´æ–°ç« èŠ‚ç¼–å·
        function updateChapterNumbers() {
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            chapterItems.forEach((item, index) => {
                item.dataset.chapterIndex = index;
                const numberSpan = item.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
                
                // æ›´æ–°å°èŠ‚ç¼–å·
                updateSectionNumbers();
            });
        }

        // æ›´æ–°å°èŠ‚ç¼–å·
        function updateSectionNumbers() {
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            chapterItems.forEach((chapterItem, chapterIndex) => {
                const sectionItems = chapterItem.querySelectorAll('.section-edit-item');
                sectionItems.forEach((sectionItem, sectionIndex) => {
                    sectionItem.dataset.sectionIndex = sectionIndex;
                    const numberSpan = sectionItem.querySelector('.w-6 span');
                    numberSpan.textContent = `${chapterIndex + 1}.${sectionIndex + 1}`;
                });
            });
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€çª—å£
        function closeEditModal() {
            document.getElementById('editOutlineModal').classList.add('hidden');
        }

        // ä¿å­˜ç¼–è¾‘ä¿®æ”¹
        function saveEditOutline() {
            // æ”¶é›†ç¼–è¾‘åçš„æ•°æ®
            const title = document.getElementById('editCourseTitle').value.trim();
            const description = document.getElementById('editCourseDescription').value.trim();
            const duration = document.getElementById('editCourseDuration').value.trim();
            
            const chapters = [];
            const chapterItems = document.querySelectorAll('.chapter-edit-item');
            
            chapterItems.forEach(item => {
                const chapterTitle = item.querySelector('.chapter-title-input').value.trim();
                const chapterSubtitle = item.querySelector('.chapter-subtitle-input').value.trim();
                const sections = [];
                
                const sectionInputs = item.querySelectorAll('.section-title-input');
                sectionInputs.forEach(input => {
                    if (input.value.trim()) {
                        sections.push(input.value.trim());
                    }
                });
                
                if (chapterTitle) {
                    chapters.push({
                        title: chapterTitle,
                        subtitle: chapterSubtitle,
                        sections: sections
                    });
                }
            });
            
            // æ›´æ–°å½“å‰å¤§çº²æ•°æ®
            AppState.currentOutline = {
                title: title,
                description: description,
                estimatedDuration: duration,
                chapters: chapters
            };
            
            // æ›´æ–°æ˜¾ç¤º
            updateOutlineDisplay();
            
            // å…³é—­æ¨¡æ€çª—å£
            closeEditModal();
            
            addMessage('âœ… å¤§çº²ä¿®æ”¹å·²ä¿å­˜ï¼æ‚¨å¯ä»¥ç»§ç»­é¢„è§ˆæˆ–ç¡®è®¤æœ€ç»ˆå¤§çº²ã€‚');
        }

        // æ›´æ–°å¤§çº²æ˜¾ç¤º
        function updateOutlineDisplay() {
            const currentCard = document.querySelector('.p-4'); // æ‰¾åˆ°å½“å‰çš„å¤§çº²å¡ç‰‡
            if (currentCard) {
                // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                const titleElement = currentCard.querySelector('h3');
                const descElement = currentCard.querySelector('p');
                const durationElement = currentCard.querySelector('.fas.fa-clock').nextElementSibling;
                const chapterCountElement = currentCard.querySelector('.fas.fa-list-ol').nextElementSibling;
                
                if (titleElement) titleElement.textContent = AppState.currentOutline.title;
                if (descElement) descElement.textContent = AppState.currentOutline.description;
                if (durationElement) durationElement.innerHTML = `é¢„è®¡æ—¶é•¿ï¼š<span class="font-medium">${AppState.currentOutline.estimatedDuration}</span>`;
                if (chapterCountElement) chapterCountElement.innerHTML = `ç« èŠ‚æ•°é‡ï¼š<span class="font-medium">${AppState.currentOutline.chapters.length}ç« </span>`;
                
                // æ›´æ–°ç« èŠ‚æ˜¾ç¤º
                const outlineContainer = currentCard.querySelector('#viewOnlyOutlineContainer');
                if (outlineContainer) {
                    outlineContainer.innerHTML = generateViewOnlyChapters(AppState.currentOutline.chapters);
                }
            }
        }

        // ç¡®è®¤æœ€ç»ˆå¤§çº²
        function confirmFinalOutline(cardElement) {
            const finalOutline = AppState.currentOutline;
            AppState.selectedOutline = 'custom';
            AppState.finalOutline = finalOutline;
            
            // ç¦ç”¨ç¼–è¾‘
            cardElement.style.pointerEvents = 'none';
            cardElement.style.opacity = '0.8';
            
            addMessage('ğŸ‰ å¤ªæ£’äº†ï¼è¯¾ç¨‹å¤§çº²å·²ç¡®è®¤å®Œæˆã€‚');
            
            setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸Šä¼ äº†æ–‡ä»¶
                if (AppState.uploadedFiles && AppState.uploadedFiles.length > 0) {
                    addMessage('å¾ˆå¥½ï¼æ‚¨å·²ç»ä¸Šä¼ äº†å‚è€ƒèµ„æ–™ï¼Œç°åœ¨å¼€å§‹ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹å†…å®¹ï¼š');
                    setTimeout(() => {
                        startFinalCourseGeneration();
                    }, 1000);
                } else {
                    addMessage('æ¥ä¸‹æ¥ï¼Œå¦‚æœæ‚¨æœ‰ç›¸å…³çš„å‚è€ƒèµ„æ–™ï¼Œå¯ä»¥ä¸Šä¼ ç»™æˆ‘è¿›ä¸€æ­¥ä¼˜åŒ–è¯¾ç¨‹å†…å®¹ï¼š');
                    
                    setTimeout(() => {
                        const uploadCard = addFileUploadCard();
                        AppState.currentStep = 4;
                        initChatFileUpload(uploadCard);
                    }, 1000);
                }
            }, 1000);
        }



        // æ·»åŠ è¯¦ç»†éœ€æ±‚æ”¶é›†å¡ç‰‡åˆ°èŠå¤©ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        function addDetailedRequirementsCard() {
            const detailsCard = `
                <div class="p-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-clipboard-list text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-3">
                            è¯¾ç¨‹è¯¦ç»†éœ€æ±‚è°ƒç ”
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400 text-base max-w-2xl mx-auto">
                            è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä¸ºæ‚¨ç”Ÿæˆæ›´åŠ ç²¾å‡†ã€å®ç”¨çš„è¯¾ç¨‹å†…å®¹
                        </p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 rounded-2xl border border-gray-200 dark:border-gray-600 p-8 shadow-lg">
                        <form id="detailedRequirementsForm" class="space-y-8">
                            <!-- åŸºç¡€è®¾ç½® -->
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-3">
                                        <i class="fas fa-cog text-blue-500 mr-3"></i>åŸºç¡€è®¾ç½®
                                    </h4>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">è¯¾ç¨‹æ—¶é•¿åå¥½</label>
                                        <select id="detailDuration" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">è¯·é€‰æ‹©æ—¶é•¿</option>
                                            <option value="30min">30åˆ†é’Ÿï¼ˆç®€çŸ­ä»‹ç»ï¼‰</option>
                                            <option value="1hour">1å°æ—¶ï¼ˆå¿«é€Ÿå…¥é—¨ï¼‰</option>
                                            <option value="2-3hours">2-3å°æ—¶ï¼ˆæ ‡å‡†åŸ¹è®­ï¼‰</option>
                                            <option value="half-day">åŠå¤©ï¼ˆ4å°æ—¶æ·±åº¦åŸ¹è®­ï¼‰</option>
                                            <option value="full-day">å…¨å¤©ï¼ˆ8å°æ—¶ç»¼åˆåŸ¹è®­ï¼‰</option>
                                            <option value="2-3days">2-3å¤©ï¼ˆç³»ç»Ÿæ€§åŸ¹è®­ï¼‰</option>
                                            <option value="custom">è‡ªå®šä¹‰æ—¶é•¿</option>
                                        </select>
                                    </div>
                                    
                                    <div id="customDurationDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">è‡ªå®šä¹‰æ—¶é•¿</label>
                                        <input type="text" id="customDuration" placeholder="ä¾‹å¦‚ï¼š5å°æ—¶ã€1å‘¨ã€10èŠ‚è¯¾ç­‰" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">æœŸæœ›ç« èŠ‚æ•°é‡</label>
                                        <select id="chapterCount" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">AIæ™ºèƒ½æ¨è</option>
                                            <option value="3">3ä¸ªç« èŠ‚ï¼ˆç®€æ´å‹ï¼‰</option>
                                            <option value="4">4ä¸ªç« èŠ‚ï¼ˆæ ‡å‡†å‹ï¼‰</option>
                                            <option value="5">5ä¸ªç« èŠ‚ï¼ˆè¯¦ç»†å‹ï¼‰</option>
                                            <option value="6">6ä¸ªç« èŠ‚ï¼ˆå®Œæ•´å‹ï¼‰</option>
                                            <option value="8">8ä¸ªç« èŠ‚ï¼ˆæ·±åº¦å‹ï¼‰</option>
                                            <option value="custom">è‡ªå®šä¹‰æ•°é‡</option>
                                        </select>
                                    </div>
                                    
                                    <div id="customChapterDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">è‡ªå®šä¹‰ç« èŠ‚æ•°</label>
                                        <input type="number" id="customChapterCount" min="2" max="20" placeholder="è¾“å…¥ç« èŠ‚æ•°é‡" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">éš¾åº¦çº§åˆ«</label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="beginner" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">å…¥é—¨çº§</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">é›¶åŸºç¡€å‹å¥½</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="intermediate" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">ä¸­çº§</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">æœ‰ä¸€å®šåŸºç¡€</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="advanced" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">é«˜çº§</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">æ·±åº¦ä¸“ä¸š</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="difficulty" value="mixed" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">æ··åˆçº§åˆ«</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">å¾ªåºæ¸è¿›</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ•™å­¦å†…å®¹ -->
                                <div class="space-y-6">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-600 pb-3">
                                        <i class="fas fa-graduation-cap text-green-500 mr-3"></i>æ•™å­¦å†…å®¹
                                    </h4>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">æ•™å­¦æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼‰</label>
                                        <div class="space-y-3">
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeTheory" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">ç†è®ºè®²è§£</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">æ¦‚å¿µä»‹ç»ã€åŸç†è§£é‡Š</div>
                                 </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includePractice" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">å®æ“æ¼”ç¤º</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">æ­¥éª¤æ¼”ç¤ºã€æ“ä½œæŒ‡å¯¼</div>
                             </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeCases" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">æ¡ˆä¾‹åˆ†æ</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">çœŸå®æ¡ˆä¾‹ã€é—®é¢˜åˆ†æ</div>
                                     </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeGroup" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">å°ç»„è®¨è®º</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">å›¢é˜Ÿåä½œã€æ€ç»´ç¢°æ’</div>
                                         </div>
                                            </label>
                                         </div>
                                     </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">è¯„ä¼°æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼‰</label>
                                        <div class="space-y-3">
                                            <label class="flex items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeQuiz" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">éšå ‚æµ‹éªŒ</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">é€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜ç­‰å¿«é€Ÿæ£€æµ‹</div>
                                 </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeAssignment" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">è¯¾åä½œä¸š</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">ç»ƒä¹ é¢˜ã€å®è·µä»»åŠ¡</div>
                                     </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeProject" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">é¡¹ç›®å®è·µ</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">ç»¼åˆé¡¹ç›®ã€å®é™…åº”ç”¨</div>
                                         </div>
                                            </label>
                                            <label class="flex items-center p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-900/50 cursor-pointer transition-colors">
                                                <input type="checkbox" id="includeFeedback" checked class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">åé¦ˆè¯„ä¼°</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">å­¦å‘˜åé¦ˆã€æ•ˆæœè¯„ä¼°</div>
                                         </div>
                                            </label>
                                     </div>
                                 </div>
                                     </div>
                                         </div>
                            
                            <!-- ç›®æ ‡å—ä¼—è¯¦ç»†ä¿¡æ¯ -->
                            <div class="border-t border-gray-200 dark:border-gray-600 pt-8">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">
                                    <i class="fas fa-users text-purple-500 mr-3"></i>ç›®æ ‡å—ä¼—è¯¦ç»†ä¿¡æ¯
                                </h4>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">é¢„æœŸå­¦å‘˜æ•°é‡</label>
                                        <select id="audienceSize" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">è¯·é€‰æ‹©äººæ•°è§„æ¨¡</option>
                                            <option value="1-5">1-5äººï¼ˆå°å‹ï¼‰</option>
                                            <option value="6-15">6-15äººï¼ˆä¸­å‹ï¼‰</option>
                                            <option value="16-30">16-30äººï¼ˆå¤§å‹ï¼‰</option>
                                            <option value="30+">30+äººï¼ˆæ‰¹é‡åŸ¹è®­ï¼‰</option>
                                        </select>
                                         </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">å­¦å‘˜èƒŒæ™¯æ°´å¹³</label>
                                        <select id="audienceBackground" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">è¯·é€‰æ‹©èƒŒæ™¯æ°´å¹³</option>
                                            <option value="zero">é›¶åŸºç¡€å°ç™½</option>
                                            <option value="basic">æœ‰åŸºç¡€äº†è§£</option>
                                            <option value="experienced">æœ‰ä¸€å®šç»éªŒ</option>
                                            <option value="mixed">æ°´å¹³å‚å·®ä¸é½</option>
                                        </select>
                                     </div>
                                 </div>
                            </div>
                            
                            <!-- ç‰¹æ®Šéœ€æ±‚ -->
                            <div class="border-t border-gray-200 dark:border-gray-600 pt-8">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">
                                    <i class="fas fa-star text-yellow-500 mr-3"></i>ç‰¹æ®Šéœ€æ±‚ä¸åå¥½
                                </h4>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">è¯¾ç¨‹äº¤ä»˜å½¢å¼</label>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="offline" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">çº¿ä¸‹é¢æˆ</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">ç°åœºåŸ¹è®­</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="online" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">åœ¨çº¿ç›´æ’­</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">è¿œç¨‹æˆè¯¾</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                                <input type="radio" name="deliveryFormat" value="hybrid" class="mr-3 text-blue-600 focus:ring-blue-500">
                                                <div>
                                                    <div class="font-medium text-gray-900 dark:text-white text-sm">æ··åˆæ¨¡å¼</div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">çº¿ä¸Š+çº¿ä¸‹</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">å…¶ä»–ç‰¹æ®Šéœ€æ±‚æˆ–è¦æ±‚</label>
                                        <textarea id="specialRequirements" placeholder="ä¾‹å¦‚ï¼šéœ€è¦é…ç½®å…·ä½“çš„æ“ä½œç¯å¢ƒã€æœ‰ç‰¹å®šçš„åˆè§„è¦æ±‚ã€éœ€è¦å¤šè¯­è¨€æ”¯æŒã€æœ‰è¡Œä¸šç‰¹æ®Šæ ‡å‡†ç­‰..." class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- æäº¤æŒ‰é’® -->
                        <div class="flex justify-center mt-10 pt-8 border-t border-gray-200 dark:border-gray-600">
                            <button id="submitDetailedRequirements" class="px-10 py-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-xl font-semibold text-base transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-rocket mr-3"></i>
                                å®Œæˆéœ€æ±‚æ”¶é›†ï¼Œå¼€å§‹è®¾è®¡è¯¾ç¨‹
                            </button>
                        </div>
                        
                        <div class="text-center mt-4">
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼ŒAIä¼šæ ¹æ®æ‚¨å¡«å†™çš„ä¿¡æ¯ç”Ÿæˆæ›´ç²¾å‡†çš„è¯¾ç¨‹å†…å®¹
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            return addMessage(detailsCard, false, true, true);
        }

        // æ·»åŠ æ–‡ä»¶ä¸Šä¼ å¡ç‰‡åˆ°èŠå¤©
        function addFileUploadCard() {
            const uploadCard = `
                <div class="p-6">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-4">
                        ä¸ºäº†è®©è¯¾ç¨‹å†…å®¹ç²¾å‡†ã€æœ‰æ–™ï¼Œæ‚¨å¯ä»¥ä¸Šä¼ ç›¸å…³èµ„æ–™ï¼š
                    </div>
                    <div id="chatUploadArea" class="border-2 border-dashed border-blue-300 dark:border-blue-600 rounded-xl p-6 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors cursor-pointer">
                        <div class="space-y-3">
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto">
                                <i class="fas fa-cloud-upload-alt text-blue-500 text-lg"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-300 text-sm">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°è¿™é‡Œ</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">æ”¯æŒ PDF, DOC, DOCX, PPT, PPTX</p>
                            </div>
                        </div>
                    </div>
                    <div id="chatUploadedFiles" class="mt-3 space-y-2"></div>
                    <div class="flex justify-end mt-4">
                        <button id="skipUpload" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                            è·³è¿‡ä¸Šä¼ 
                        </button>
                    </div>
                </div>
            `;
            
            return addMessage(uploadCard, false, true, true);
        }

        // ç”Ÿæˆæ™ºèƒ½å¤§çº²é€‰é¡¹
        function generateSmartOutlineOptions(requirements) {
            const courseTitle = AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½åŸ¹è®­';
            const coreGoal = requirements.coreGoal || '';
            const learnerPersona = requirements.learnerPersona || '';
            const teachingActivities = requirements.teachingActivities || {};
            
            // ç”Ÿæˆæ–¹æ¡ˆAï¼šæ ‡å‡†æµç¨‹å‹å¤§çº²
            const optionA = generateStandardOutlineOption(courseTitle, requirements);
            
            // ç”Ÿæˆæ–¹æ¡ˆBï¼šå®è·µä»»åŠ¡å‹å¤§çº²
            const optionB = generateTaskBasedOutlineOption(courseTitle, requirements);
            
            return { optionA, optionB };
        }

        // ç”Ÿæˆæ ‡å‡†æµç¨‹å‹å¤§çº²
        function generateStandardOutlineOption(courseTitle, requirements) {
            const chapters = [];
            const topic = courseTitle.replace(/è¯¾ç¨‹|åŸ¹è®­|å­¦ä¹ /g, '').trim();
            
            // ç¬¬ä¸€ç« ï¼šåŸºç¡€ç†è®º
            chapters.push({
                title: `${topic}åŸºç¡€è®¤çŸ¥`,
                sections: [
                    `${topic}åŸºæœ¬æ¦‚å¿µä¸é‡è¦æ€§`,
                    `æ ¸å¿ƒåŸç†ä¸ç†è®ºæ¡†æ¶`,
                    `è¡Œä¸šæ ‡å‡†ä¸æœ€ä½³å®è·µ`
                ]
            });
            
            // ç¬¬äºŒç« ï¼šæ ¸å¿ƒæŠ€èƒ½
            if (requirements.learnerPersona === 'new-employee') {
                chapters.push({
                    title: `${topic}å…¥é—¨æ“ä½œ`,
                    sections: [
                        'åŸºç¡€æ“ä½œæµç¨‹è¯¦è§£',
                        'å¸¸ç”¨å·¥å…·å’Œæ–¹æ³•',
                        'æ“ä½œè§„èŒƒä¸æ³¨æ„äº‹é¡¹'
                    ]
                });
            } else {
                chapters.push({
                    title: `${topic}æ ¸å¿ƒæŠ€èƒ½`,
                    sections: [
                        'é«˜çº§æ“ä½œæŠ€å·§',
                        'æ•ˆç‡æå‡æ–¹æ³•',
                        'ä¸“ä¸šå·¥å…·åº”ç”¨'
                    ]
                });
            }
            
            // ç¬¬ä¸‰ç« ï¼šå®è·µåº”ç”¨
            chapters.push({
                title: `${topic}å®è·µåº”ç”¨`,
                sections: [
                    'å…¸å‹åœºæ™¯åˆ†æ',
                    'é—®é¢˜è¯Šæ–­ä¸è§£å†³',
                    'å®é™…æ¡ˆä¾‹æ¼”ç»ƒ'
                ]
            });
            
            // ç¬¬å››ç« ï¼šæ€»ç»“æå‡
            const finalChapterTitle = requirements.assessmentMethod === 'project-assessment' ? 
                `${topic}é¡¹ç›®å®æˆ˜` : `${topic}æ€»ç»“æå‡`;
            chapters.push({
                title: finalChapterTitle,
                sections: [
                    requirements.assessmentMethod === 'project-assessment' ? 'ç»¼åˆé¡¹ç›®è®¾è®¡' : 'çŸ¥è¯†ç‚¹ç³»ç»Ÿå›é¡¾',
                    requirements.assessmentMethod === 'project-assessment' ? 'é¡¹ç›®å®æ–½ä¸è¯„ä¼°' : 'æŠ€èƒ½è‡ªæµ‹ä¸è¯„ä¼°',
                    'æŒç»­å­¦ä¹ ä¸æ”¹è¿›'
                ]
            });
            
            return chapters;
        }

        // ç”Ÿæˆä»»åŠ¡å¯¼å‘å‹å¤§çº²
        function generateTaskBasedOutlineOption(courseTitle, requirements) {
            const tasks = [];
            const topic = courseTitle.replace(/è¯¾ç¨‹|åŸ¹è®­|å­¦ä¹ /g, '').trim();
            
            // ä»»åŠ¡ä¸€ï¼šåŸºç¡€å…¥é—¨
            if (requirements.learnerPersona === 'new-employee') {
                tasks.push({
                    title: `ä»»åŠ¡ä¸€ï¼šåˆè¯†${topic}ç³»ç»Ÿ`,
                    sections: [
                        `${topic}ç¯å¢ƒé…ç½®å‡†å¤‡`,
                        'åŸºç¡€åŠŸèƒ½ä½“éªŒå®è·µ'
                    ]
                });
            } else {
                tasks.push({
                    title: `ä»»åŠ¡ä¸€ï¼š${topic}æ ¸å¿ƒåŠŸèƒ½æŒæ¡`,
                    sections: [
                        'å…³é”®åŠŸèƒ½æ·±åº¦ä½“éªŒ',
                        'é«˜çº§è®¾ç½®ä¸é…ç½®'
                    ]
                });
            }
            
            // ä»»åŠ¡äºŒï¼šæ ¸å¿ƒæ“ä½œ
            tasks.push({
                title: `ä»»åŠ¡äºŒï¼šå®Œæˆæ ¸å¿ƒ${topic}æ“ä½œ`,
                sections: [
                    'æ ‡å‡†æµç¨‹å®æ“ç»ƒä¹ ',
                    'å¸¸è§é—®é¢˜å¤„ç†å®è·µ'
                ]
            });
            
            // ä»»åŠ¡ä¸‰ï¼šè¿›é˜¶åº”ç”¨
            const advancedTaskTitle = requirements.teachingActivities['case-analysis'] ? 
                `ä»»åŠ¡ä¸‰ï¼š${topic}æ¡ˆä¾‹åˆ†æå®æˆ˜` : `ä»»åŠ¡ä¸‰ï¼š${topic}è¿›é˜¶åº”ç”¨`;
            tasks.push({
                title: advancedTaskTitle,
                sections: [
                    requirements.teachingActivities['case-analysis'] ? 'çœŸå®æ¡ˆä¾‹åˆ†ææ¼”ç»ƒ' : 'å¤æ‚åœºæ™¯æ“ä½œå®è·µ',
                    'è§£å†³æ–¹æ¡ˆè®¾è®¡ä¸å®æ–½'
                ]
            });
            
            // ä»»åŠ¡å››ï¼šæˆæœå±•ç¤º
            const finalTaskTitle = requirements.assessmentMethod === 'project-assessment' ? 
                `ä»»åŠ¡å››ï¼š${topic}ç»¼åˆé¡¹ç›®äº¤ä»˜` : `ä»»åŠ¡å››ï¼š${topic}æŠ€èƒ½éªŒè¯`;
            tasks.push({
                title: finalTaskTitle,
                sections: [
                    requirements.assessmentMethod === 'project-assessment' ? 'é¡¹ç›®æˆæœå±•ç¤º' : 'æŠ€èƒ½æµ‹è¯•ä¸è¯„ä¼°',
                    'ç»éªŒæ€»ç»“ä¸åˆ†äº«'
                ]
            });
            
            return tasks;
        }

        // ç”Ÿæˆå¤§çº²é¡¹ç›®HTML
        function generateOutlineItemsHTML(items, color = 'blue') {
            return items.map((item, index) => `
                                 <div class="space-y-1">
                                     <div class="flex items-center space-x-2">
                        <div class="w-1 h-1 bg-${color}-400 rounded-full"></div>
                        <span class="font-medium">${item.title}</span>
                                     </div>
                                     <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                        ${item.sections.map((section, sIndex) => `
                                         <div class="flex items-center space-x-1.5">
                                             <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                <span>${index + 1}.${sIndex + 1} ${section}</span>
                                         </div>
                        `).join('')}
                                         </div>
                                     </div>
            `).join('');
        }

        // æ·»åŠ å¤§çº²é€‰æ‹©å¡ç‰‡åˆ°èŠå¤©ï¼ˆå•å¡ç‰‡å½¢å¼ï¼‰
        function addOutlineSelectionCard(outlineOptions) {
            // ä½¿ç”¨é»˜è®¤å€¼ï¼Œé˜²æ­¢outlineOptionsä¸ºundefined
            const defaultOptions = {
                optionA: [
                    {
                        title: `${AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½'}åŸºç¡€è®¤çŸ¥`,
                        sections: ['åŸºæœ¬æ¦‚å¿µä¸é‡è¦æ€§', 'æ ¸å¿ƒåŸç†ä¸ç†è®ºæ¡†æ¶', 'è¡Œä¸šæ ‡å‡†ä¸æœ€ä½³å®è·µ']
                    }
                ],
                optionB: [
                    {
                        title: `ä»»åŠ¡ä¸€ï¼šæŒæ¡${AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½'}æ ¸å¿ƒåŠŸèƒ½`,
                        sections: ['å…³é”®åŠŸèƒ½æ·±åº¦ä½“éªŒ', 'é«˜çº§è®¾ç½®ä¸é…ç½®']
                    }
                ]
            };
            
            const options = outlineOptions || defaultOptions;
            
            // å­˜å‚¨å¤§çº²é€‰é¡¹åˆ°å…¨å±€çŠ¶æ€ï¼Œæ–¹ä¾¿åˆ‡æ¢
            AppState.currentOutlineOptions = options;
            AppState.currentOutlineType = 'A'; // é»˜è®¤æ˜¾ç¤ºæ–¹æ¡ˆA
            
            const outlineCard = `
                <div class="p-6 max-w-4xl mx-auto" id="outlineSelectionCard">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-6 text-center">
                        æˆ‘ä¸ºæ‚¨ç²¾å¿ƒç­–åˆ’äº†è¯¾ç¨‹å¤§çº²ï¼Œè¯·æŸ¥çœ‹å¹¶é€‰æ‹©ï¼š
                                 </div>
                    
                    <!-- å•ä¸ªå¤§çº²å¡ç‰‡å®¹å™¨ -->
                    <div class="max-w-2xl mx-auto">
                        <div id="currentOutlineCard" class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-6 shadow-sm">
                            <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œå¡«å…… -->
                             </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div class="mt-6 flex flex-col items-center space-y-4">
                        <!-- åˆ‡æ¢æ–¹æ¡ˆæŒ‰é’® -->
                        <button id="switchOutlineOption" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 rounded-lg transition-colors font-medium text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>æ¢ä¸ªæ–¹æ¡ˆ
                                 </button>
                        
                        <!-- é‡æ–°ç”ŸæˆæŒ‰é’® -->
                        <button id="regenerateOutlines" class="px-4 py-1.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-xs underline transition-colors">
                            å¯¹ä»¥ä¸Šæ–¹æ¡ˆä¸æ»¡æ„ï¼Ÿç‚¹å‡»é‡æ–°ç”Ÿæˆå…¶ä»–é€‰é¡¹
                                 </button>
                             </div>
                         </div>
            `;
            
            const cardElement = addMessage(outlineCard, false, true, true);
            
            // åˆå§‹åŒ–å•å¡ç‰‡å¤§çº²åŠŸèƒ½
            setTimeout(() => {
                initSingleOutlineCard(cardElement);
            }, 100);
            
            return cardElement;
        }

        // åˆå§‹åŒ–å•å¡ç‰‡å¤§çº²åŠŸèƒ½
        function initSingleOutlineCard(cardElement) {
            if (!cardElement) return;
            
            const currentCard = cardElement.querySelector('#currentOutlineCard');
            const switchBtn = cardElement.querySelector('#switchOutlineOption');
            const regenerateBtn = cardElement.querySelector('#regenerateOutlines');
            
            // æ¸²æŸ“å½“å‰å¤§çº²
            function renderCurrentOutline() {
                const isOptionA = AppState.currentOutlineType === 'A';
                const currentOption = isOptionA ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
                const color = isOptionA ? 'blue' : 'green';
                const icon = isOptionA ? 'fas fa-list' : 'fas fa-tasks';
                const title = isOptionA ? 'æ–¹æ¡ˆAï¼šæ ‡å‡†æµç¨‹å‹å¤§çº²' : 'æ–¹æ¡ˆBï¼šåŸºäºä»»åŠ¡çš„å®è·µå¤§çº²';
                const subtitle = isOptionA ? 'AIæ¨è' : 'å®è·µå¯¼å‘';
                const bgColor = isOptionA ? 'blue' : 'green';
                
                currentCard.innerHTML = `
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-8 h-8 bg-${bgColor}-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="${icon} text-white text-sm"></i>
                    </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white text-base">${title}</h4>
                            <p class="text-sm text-${bgColor}-500 dark:text-${bgColor}-400">${subtitle}</p>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300 ml-11">
                        ${generateOutlineItemsHTML(currentOption, color)}
                    </div>
                    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button class="outline-select-btn px-4 py-2 bg-${bgColor}-500 hover:bg-${bgColor}-600 text-white text-sm rounded-lg font-medium transition-colors" data-option="${AppState.currentOutlineType}">
                            é€‰æ‹©æ­¤æ–¹æ¡ˆ
                        </button>
                        <button class="outline-preview-btn px-4 py-2 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-sm rounded-lg font-medium transition-colors" data-option="${AppState.currentOutlineType}">
                            <i class="fas fa-eye mr-2"></i>é¢„è§ˆå¾®è°ƒ
                        </button>
                    </div>
                `;
                
                // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                bindOutlineCardEvents(currentCard);
            }
            
            // åˆ‡æ¢æ–¹æ¡ˆ
            switchBtn.addEventListener('click', () => {
                AppState.currentOutlineType = AppState.currentOutlineType === 'A' ? 'B' : 'A';
                
                // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
                currentCard.style.opacity = '0.5';
                currentCard.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    renderCurrentOutline();
                    currentCard.style.opacity = '1';
                    currentCard.style.transform = 'scale(1)';
                }, 200);
            });
            
            // é‡æ–°ç”Ÿæˆå¤§çº²
            regenerateBtn.addEventListener('click', () => {
                addMessage('âš¡ æ­£åœ¨ä¸ºæ‚¨é‡æ–°ç”Ÿæˆè¯¾ç¨‹å¤§çº²æ–¹æ¡ˆ...');
                
                setTimeout(() => {
                    // é‡æ–°ç”Ÿæˆå¤§çº²é€‰é¡¹
                    const newOptions = generateSmartOutlineOptions(AppState.detailedRequirements);
                    AppState.currentOutlineOptions = newOptions;
                    AppState.currentOutlineType = 'A'; // é‡ç½®ä¸ºæ–¹æ¡ˆA
                    
                    renderCurrentOutline();
                    addMessage('âœ¨ å…¨æ–°çš„è¯¾ç¨‹å¤§çº²å·²ç”Ÿæˆï¼æ‚¨å¯ä»¥æŸ¥çœ‹æ–°æ–¹æ¡ˆæˆ–ç»§ç»­åˆ‡æ¢æŸ¥çœ‹ã€‚');
                }, 1500);
            });
            
            // åˆå§‹æ¸²æŸ“
            renderCurrentOutline();
        }

                 // ç»‘å®šå¤§çº²å¡ç‰‡äº‹ä»¶
        function bindOutlineCardEvents(cardElement) {
            const selectBtn = cardElement.querySelector('.outline-select-btn');
            const previewBtn = cardElement.querySelector('.outline-preview-btn');
            
            if (selectBtn) {
                selectBtn.addEventListener('click', (e) => {
                    const option = e.target.getAttribute('data-option');
                    handleOutlineSelection(option);
                });
            }
            
            if (previewBtn) {
                previewBtn.addEventListener('click', (e) => {
                    const option = e.target.getAttribute('data-option');
                    handleOutlinePreview(option);
                });
            }
        }

        // å¤„ç†å¤§çº²é€‰æ‹©
        function handleOutlineSelection(option) {
            const selectedOutline = option === 'A' ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
            const outlineType = option === 'A' ? 'æ ‡å‡†æµç¨‹å‹' : 'åŸºäºä»»åŠ¡çš„å®è·µå‹';
            
            // æ˜¾ç¤ºæ–¹æ¡ˆç¡®è®¤å¯¹è¯æ¡†
            showOutlineConfirmDialog(option, selectedOutline, outlineType);
        }

        // æ˜¾ç¤ºæ–¹æ¡ˆç¡®è®¤å¯¹è¯æ¡†
        function showOutlineConfirmDialog(option, selectedOutline, outlineType) {
            // è·å–æ–¹æ¡ˆç‰¹ç‚¹æè¿°
            const outlineFeatures = getOutlineFeatures(option, outlineType);
            
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-${option === 'A' ? 'blue' : 'green'}-100 dark:bg-${option === 'A' ? 'blue' : 'green'}-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-${option === 'A' ? 'list' : 'tasks'} text-${option === 'A' ? 'blue' : 'green'}-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ç¡®è®¤é€‰æ‹©æ–¹æ¡ˆ${option}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${outlineType}å¤§çº²</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>æ–¹æ¡ˆç‰¹ç‚¹æ€»ç»“
                            </h4>
                            <div class="space-y-2 text-sm">
                                ${outlineFeatures.map(feature => `
                                    <div class="flex items-start space-x-2">
                                        <div class="w-1.5 h-1.5 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-gray-700 dark:text-gray-300">${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                                <span class="text-sm text-blue-700 dark:text-blue-300">
                                    é€‰æ‹©åå°†ä¿å­˜è¯¥æ–¹æ¡ˆå¹¶è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢
                                </span>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-xs text-gray-500 dark:text-gray-400 mb-6">
                            <div class="flex justify-between">
                                <span>ç« èŠ‚æ•°é‡ï¼š</span>
                                <span class="font-medium">${selectedOutline.length}ä¸ªç« èŠ‚</span>
                            </div>
                            <div class="flex justify-between">
                                <span>é€‚ç”¨å¯¹è±¡ï¼š</span>
                                <span class="font-medium">${getTargetAudience(option)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å­¦ä¹ æ–¹å¼ï¼š</span>
                                <span class="font-medium">${getLearningStyle(option)}</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelSelection" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>é‡æ–°é€‰æ‹©
                            </button>
                            <button id="confirmSelection" class="flex-1 px-4 py-3 bg-${option === 'A' ? 'blue' : 'green'}-500 hover:bg-${option === 'A' ? 'blue' : 'green'}-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-check mr-2"></i>ç¡®è®¤é€‰æ‹©
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('cancelSelection').addEventListener('click', () => {
                confirmModal.remove();
            });
            
            document.getElementById('confirmSelection').addEventListener('click', () => {
                confirmModal.remove();
                
                // æ‰§è¡ŒåŸæœ‰çš„é€‰æ‹©é€»è¾‘
                AppState.selectedOutline = selectedOutline;
                AppState.selectedOutlineType = option;
                
                addMessage(`âœ… æ‚¨é€‰æ‹©äº†æ–¹æ¡ˆ${option}ï¼š${outlineType}å¤§çº²ã€‚æ­£åœ¨è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢...`, true);
                
                setTimeout(() => {
                    // ä¿å­˜é€‰æ‹©çš„å¤§çº²æ•°æ®åˆ°sessionStorageï¼Œä»¥ä¾¿åœ¨course-creationé¡µé¢ä½¿ç”¨
                    const courseData = {
                        selectedOutline: selectedOutline,
                        selectedOutlineType: option,
                        outlineTypeName: outlineType,
                        detailedRequirements: AppState.detailedRequirements || {},
                        currentOutlineOptions: AppState.currentOutlineOptions || {}
                    };
                    
                    sessionStorage.setItem('courseData', JSON.stringify(courseData));
                    
                    // è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢
                    window.location.href = 'course-creation.html';
                }, 800);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.remove();
                }
            });
        }

        // è·å–æ–¹æ¡ˆç‰¹ç‚¹æè¿°
        function getOutlineFeatures(option, outlineType) {
            const features = {
                'A': [
                    'ç³»ç»Ÿæ€§å­¦ä¹ è·¯å¾„ï¼šä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨ï¼Œå¾ªåºæ¸è¿›',
                    'ç†è®ºä¸å®è·µç»“åˆï¼šæ—¢æœ‰æ¦‚å¿µè®²è§£ï¼Œä¹Ÿæœ‰æ“ä½œæ¼”ç¤º',
                    'æ ‡å‡†åŒ–æµç¨‹ï¼šé€‚åˆä¼ä¸šåŸ¹è®­å’Œè§„èŒƒåŒ–æ•™å­¦',
                    'çŸ¥è¯†ä½“ç³»å®Œæ•´ï¼šæ¶µç›–æ ¸å¿ƒåŠŸèƒ½çš„å…¨é¢è®²è§£',
                    'æ˜“äºç†è§£æŒæ¡ï¼šé€‚åˆåˆå­¦è€…å»ºç«‹å®Œæ•´çŸ¥è¯†æ¡†æ¶'
                ],
                'B': [
                    'ä»»åŠ¡é©±åŠ¨å­¦ä¹ ï¼šé€šè¿‡å®é™…å·¥ä½œåœºæ™¯å­¦ä¹ åº”ç”¨',
                    'å³å­¦å³ç”¨ï¼šæ¯ä¸ªæ¨¡å—éƒ½å¯¹åº”å…·ä½“å·¥ä½œä»»åŠ¡',
                    'å®æ“æ€§å¼ºï¼šé‡ç‚¹åœ¨äºå®é™…æ“ä½œå’Œé—®é¢˜è§£å†³',
                    'è´´è¿‘å·¥ä½œå®é™…ï¼šå­¦å®Œå³å¯åœ¨å·¥ä½œä¸­ç›´æ¥åº”ç”¨',
                    'å­¦ä¹ æ•ˆæœæ˜æ˜¾ï¼šèƒ½å¤Ÿå¿«é€Ÿæå‡å®é™…å·¥ä½œèƒ½åŠ›'
                ],
                'C': [
                    'åˆ†å±‚é€’è¿›è®¾è®¡ï¼šä»åŸºç¡€åˆ°ç²¾é€šçš„å››ä¸ªå±‚æ¬¡',
                    'èƒ½åŠ›å±‚çº§æ¸…æ™°ï¼šæ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èƒ½åŠ›ç›®æ ‡',
                    'å¾ªåºæ¸è¿›å­¦ä¹ ï¼šç¬¦åˆè®¤çŸ¥è§„å¾‹çš„å­¦ä¹ è·¯å¾„',
                    'å…¨é¢æŠ€èƒ½è¦†ç›–ï¼šä»åŸºç¡€æ“ä½œåˆ°é«˜çº§åˆ†æ',
                    'é•¿æœŸå­¦ä¹ è§„åˆ’ï¼šé€‚åˆç³»ç»Ÿæ€§èƒ½åŠ›æå‡'
                ],
                'D': [
                    'åœºæ™¯åŒ–æ•™å­¦ï¼šåŸºäºçœŸå®å·¥ä½œåœºæ™¯è®¾è®¡',
                    'æƒ…å¢ƒå­¦ä¹ æ³•ï¼šåœ¨å…·ä½“æƒ…å¢ƒä¸­æŒæ¡çŸ¥è¯†æŠ€èƒ½',
                    'å®æˆ˜å¯¼å‘ï¼šæ¯ä¸ªåœºæ™¯éƒ½æ˜¯å®é™…å·¥ä½œæƒ…å†µ',
                    'é—®é¢˜è§£å†³èƒ½åŠ›ï¼šåŸ¹å…»å®é™…é—®é¢˜çš„å¤„ç†èƒ½åŠ›',
                    'å­¦ä»¥è‡´ç”¨ï¼šå­¦ä¹ å†…å®¹ç›´æ¥å¯¹åº”å·¥ä½œéœ€æ±‚'
                ]
            };
            
            return features[option] || features['A'];
        }

        // è·å–ç›®æ ‡å—ä¼—
        function getTargetAudience(option) {
            const audiences = {
                'A': 'æ–°å‘˜å·¥ã€åˆå­¦è€…',
                'B': 'æœ‰åŸºç¡€çš„å®æ“äººå‘˜',
                'C': 'å¸Œæœ›ç³»ç»Ÿæå‡çš„å‘˜å·¥',
                'D': 'éœ€è¦è§£å†³å…·ä½“é—®é¢˜çš„å‘˜å·¥'
            };
            return audiences[option] || audiences['A'];
        }

        // è·å–å­¦ä¹ æ–¹å¼
        function getLearningStyle(option) {
            const styles = {
                'A': 'ç†è®º+å®æ“ç»“åˆ',
                'B': 'ä»»åŠ¡é©±åŠ¨å®è·µ',
                'C': 'åˆ†å±‚é€’è¿›å­¦ä¹ ',
                'D': 'åœºæ™¯åŒ–åº”ç”¨'
            };
            return styles[option] || styles['A'];
        }

        // å¤„ç†å¤§çº²é¢„è§ˆ
        function handleOutlinePreview(option) {
            const selectedOutline = option === 'A' ? AppState.currentOutlineOptions.optionA : AppState.currentOutlineOptions.optionB;
            const outlineType = option === 'A' ? 'æ ‡å‡†æµç¨‹å‹' : 'åŸºäºä»»åŠ¡çš„å®è·µå‹';
            
            addMessage(`æ­£åœ¨ä¸ºæ‚¨å±•ç¤ºæ–¹æ¡ˆ${option}çš„è¯¦ç»†é¢„è§ˆä¸ç¼–è¾‘ç•Œé¢...`);
            
            setTimeout(() => {
                showOutlineEditModal(selectedOutline, outlineType, option);
            }, 800);
        }

        // æ˜¾ç¤ºå¯ç¼–è¾‘çš„å¤§çº²æ¨¡æ€æ¡†
        function showOutlineEditModal(outline, type, option) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-lg flex items-center justify-center">
                                <i class="fas fa-${option === 'A' ? 'list' : 'tasks'} text-white text-base"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">æ–¹æ¡ˆ${option}ï¼š${type}å¤§çº²</h3>
                                <p class="text-base text-gray-500 dark:text-gray-400">é¢„è§ˆä¸å¾®è°ƒç¼–è¾‘</p>
                            </div>
                        </div>
                        <button class="modal-close p-3 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <i class="fas fa-times text-gray-500 dark:text-gray-400 text-base"></i>
                        </button>
                    </div>

                    <!-- æ¨¡æ€æ¡†å†…å®¹ -->
                    <div class="flex flex-1 overflow-hidden">
                        <!-- å·¦ä¾§ï¼šå¤§çº²ç¼–è¾‘åŒºåŸŸ -->
                        <div class="flex-1 min-w-0 p-6 overflow-y-auto custom-scrollbar">
                            <div class="mb-4 flex items-center justify-between">
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">è¯¾ç¨‹å¤§çº²</h4>
                                <button id="addChapterBtn" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-sm rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-1"></i>æ·»åŠ ç« èŠ‚
                                </button>
                            </div>
                            <div id="editableOutlineContent" class="space-y-4">
                                <!-- å¯ç¼–è¾‘å¤§çº²å†…å®¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šè®¾ç½®åŒºåŸŸ -->
                        <div class="w-80 min-w-80 p-6 overflow-y-auto bg-gray-50 dark:bg-gray-750 border-l border-gray-200 dark:border-gray-700 custom-scrollbar">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">è¯¾ç¨‹è®¾ç½®</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">è¯¾ç¨‹æ—¶é•¿</label>
                                    <select id="editCourseDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                        <option value="1-2">1-2å°æ—¶</option>
                                        <option value="2-4" selected>2-4å°æ—¶</option>
                                        <option value="4-8">4-8å°æ—¶</option>
                                        <option value="1-day">1å¤©</option>
                                        <option value="2-days">2å¤©</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">éš¾åº¦çº§åˆ«</label>
                                    <select id="editCourseDifficulty" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
                                        <option value="beginner" selected>å…¥é—¨çº§</option>
                                        <option value="intermediate">ä¸­çº§</option>
                                        <option value="advanced">é«˜çº§</option>
                                        <option value="expert">ä¸“å®¶çº§</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ•™å­¦æ–¹å¼</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editTheory" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">ç†è®ºè®²è§£</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editPractice" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">å®æ“æ¼”ç¤º</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editExercise" checked class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">éšå ‚ç»ƒä¹ </span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="editCase" class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700 dark:text-gray-300">æ¡ˆä¾‹åˆ†æ</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å…¶ä»–éœ€æ±‚</label>
                                    <textarea id="editOtherRequirements" placeholder="è¯·è¾“å…¥å…¶ä»–ç‰¹æ®Šéœ€æ±‚..." class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
                    <div class="flex items-center justify-between p-6 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            å¯ä»¥ç¼–è¾‘ç« èŠ‚æ ‡é¢˜ã€å°èŠ‚å†…å®¹ï¼Œæ‹–æ‹½è°ƒæ•´é¡ºåº
                        </div>
                        <div class="flex space-x-3">
                            <button class="modal-close px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button id="confirmEditedOutline" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors" data-option="${option}">
                                <i class="fas fa-check mr-1"></i>ç¡®è®¤é€‰æ‹©
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // ç”Ÿæˆå¯ç¼–è¾‘çš„å¤§çº²å†…å®¹
            generateEditableOutlineContent(outline, option);
            
            // ç»‘å®šäº‹ä»¶
            bindEditModalEvents(modal, option);
        }
        
        // ç”Ÿæˆå¯ç¼–è¾‘çš„å¤§çº²å†…å®¹
        function generateEditableOutlineContent(outline, option) {
            const container = document.getElementById('editableOutlineContent');
            const color = option === 'A' ? 'blue' : 'green';
            
            container.innerHTML = outline.map((chapter, chapterIndex) => `
                <div class="chapter-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 group" data-chapter-index="${chapterIndex}">
                    <div class="flex items-start space-x-3 mb-3">
                        <div class="w-8 h-8 bg-${color}-100 dark:bg-${color}-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-${color}-600 dark:text-${color}-400 font-semibold text-sm">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" value="${chapter.title}" class="chapter-title w-full font-medium text-gray-900 dark:text-white bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="ç« èŠ‚æ ‡é¢˜">
                        </div>
                        <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="æ·»åŠ å°èŠ‚">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤ç« èŠ‚">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                            <div class="drag-handle p-1 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="æ‹–æ‹½æ’åº">
                                <i class="fas fa-grip-vertical text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="sections-container ml-11 space-y-2">
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section" data-section-index="${sectionIndex}">
                                <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                <input type="text" value="${section}" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="å°èŠ‚å†…å®¹">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="åˆ é™¤å°èŠ‚">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            // ç»‘å®šç¼–è¾‘äº‹ä»¶
            bindEditEvents();
        }
        
        // ç»‘å®šç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶
        function bindEditModalEvents(modal, option) {
            // å…³é—­äº‹ä»¶
            modal.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    document.body.style.overflow = 'auto';
                });
            });
            
            // ç¡®è®¤é€‰æ‹©äº‹ä»¶
            const confirmBtn = modal.querySelector('#confirmEditedOutline');
            confirmBtn.addEventListener('click', () => {
                const editedOutline = getEditedOutlineData();
                const settings = getEditedSettings();
                
                // ä¿å­˜ç¼–è¾‘åçš„å¤§çº²æ•°æ®
                if (option === 'A') {
                    AppState.currentOutlineOptions.optionA = editedOutline;
                } else {
                    AppState.currentOutlineOptions.optionB = editedOutline;
                }
                
                document.body.removeChild(modal);
                document.body.style.overflow = 'auto';
                
                // æ˜¾ç¤ºç¼–è¾‘åæ–¹æ¡ˆçš„ç¡®è®¤å¯¹è¯æ¡†
                const outlineType = option === 'A' ? 'æ ‡å‡†æµç¨‹å‹' : 'åŸºäºä»»åŠ¡çš„å®è·µå‹';
                showEditedOutlineConfirmDialog(option, editedOutline, outlineType, settings);
            });
        }

        // æ˜¾ç¤ºç¼–è¾‘åæ–¹æ¡ˆçš„ç¡®è®¤å¯¹è¯æ¡†
        function showEditedOutlineConfirmDialog(option, editedOutline, outlineType, settings) {
            // è·å–ç¼–è¾‘åçš„æ–¹æ¡ˆç‰¹ç‚¹
            const editedFeatures = getEditedOutlineFeatures(editedOutline, settings);
            
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            confirmModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-${option === 'A' ? 'blue' : 'green'}-100 dark:bg-${option === 'A' ? 'blue' : 'green'}-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-edit text-${option === 'A' ? 'blue' : 'green'}-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ç¡®è®¤é€‰æ‹©ç¼–è¾‘åçš„æ–¹æ¡ˆ${option}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${outlineType}å¤§çº²ï¼ˆå·²è‡ªå®šä¹‰ç¼–è¾‘ï¼‰</p>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 mb-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <i class="fas fa-magic text-orange-500"></i>
                                <span class="font-medium text-orange-700 dark:text-orange-300">æ‚¨çš„è‡ªå®šä¹‰ä¿®æ”¹</span>
                            </div>
                            <div class="text-sm text-orange-700 dark:text-orange-300">
                                åŸºäºåŸæ–¹æ¡ˆè¿›è¡Œäº†ä¸ªæ€§åŒ–ç¼–è¾‘ï¼Œæ›´ç¬¦åˆæ‚¨çš„å…·ä½“éœ€æ±‚
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3">
                                <i class="fas fa-list-check text-${option === 'A' ? 'blue' : 'green'}-500 mr-2"></i>ç¼–è¾‘åæ–¹æ¡ˆæ€»ç»“
                            </h4>
                            <div class="space-y-3">
                                ${editedFeatures.map(feature => `
                                    <div class="flex items-start space-x-2">
                                        <div class="w-1.5 h-1.5 bg-${option === 'A' ? 'blue' : 'green'}-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-sm text-gray-700 dark:text-gray-300">${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">ç« èŠ‚æ•°é‡</div>
                                <div class="font-medium text-gray-900 dark:text-white">${editedOutline.chapters ? editedOutline.chapters.length : editedOutline.length || 0}ä¸ªç« èŠ‚</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">è¯¾ç¨‹æ—¶é•¿</div>
                                <div class="font-medium text-gray-900 dark:text-white">${getDurationText(settings.duration || '2-4')}</div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-6">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                                <span class="text-sm text-blue-700 dark:text-blue-300">
                                    ç¡®è®¤åå°†ä¿å­˜æ‚¨çš„ä¸ªæ€§åŒ–æ–¹æ¡ˆå¹¶è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelEditedSelection" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>ç»§ç»­ç¼–è¾‘
                            </button>
                            <button id="confirmEditedSelection" class="flex-1 px-4 py-3 bg-${option === 'A' ? 'blue' : 'green'}-500 hover:bg-${option === 'A' ? 'blue' : 'green'}-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-check mr-2"></i>ç¡®è®¤é€‰æ‹©
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('cancelEditedSelection').addEventListener('click', () => {
                confirmModal.remove();
                // å¯ä»¥åœ¨è¿™é‡Œé‡æ–°æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†ï¼Œä½†ç°åœ¨å…ˆç®€å•å…³é—­
            });
            
            document.getElementById('confirmEditedSelection').addEventListener('click', () => {
                confirmModal.remove();
                
                // æ‰§è¡ŒåŸæœ‰çš„é€‰æ‹©é€»è¾‘
                addMessage(`âœ… æ‚¨å·²ç¡®è®¤é€‰æ‹©æ–¹æ¡ˆ${option}ï¼š${outlineType}å¤§çº²ï¼ˆå·²ç¼–è¾‘ï¼‰ã€‚æ­£åœ¨è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢...`, true);
                
                setTimeout(() => {
                    // ä¿å­˜é€‰æ‹©çš„å¤§çº²æ•°æ®åˆ°sessionStorageï¼Œä»¥ä¾¿åœ¨course-creationé¡µé¢ä½¿ç”¨
                    const courseData = {
                        selectedOutline: editedOutline,
                        selectedOutlineType: option,
                        outlineTypeName: outlineType,
                        detailedRequirements: AppState.detailedRequirements || {},
                        currentOutlineOptions: AppState.currentOutlineOptions || {},
                        editedSettings: settings || {}
                    };
                    
                    sessionStorage.setItem('courseData', JSON.stringify(courseData));
                    
                    // è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢
                    window.location.href = 'course-creation.html';
                }, 800);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    confirmModal.remove();
                }
            });
        }

        // è·å–ç¼–è¾‘åæ–¹æ¡ˆçš„ç‰¹ç‚¹
        function getEditedOutlineFeatures(editedOutline, settings) {
            const features = [];
            
            // å®‰å…¨è·å–ç« èŠ‚æ•°é‡
            const chapterCount = editedOutline.chapters ? editedOutline.chapters.length : (editedOutline.length || 0);
            
            // åŸºäºç« èŠ‚æ•°é‡
            if (chapterCount <= 3) {
                features.push('ç²¾ç®€é«˜æ•ˆï¼šå†…å®¹ç´§å‡‘ï¼Œé‡ç‚¹çªå‡ºï¼Œé€‚åˆå¿«é€Ÿå­¦ä¹ ');
            } else if (chapterCount <= 5) {
                features.push('ç»“æ„åˆç†ï¼šç« èŠ‚å®‰æ’é€‚ä¸­ï¼Œå­¦ä¹ èŠ‚å¥èˆ’é€‚');
            } else {
                features.push('å†…å®¹ä¸°å¯Œï¼šæ¶µç›–é¢å¹¿æ³›ï¼ŒçŸ¥è¯†ä½“ç³»å®Œæ•´æ·±å…¥');
            }
            
            // åŸºäºè®¾ç½®
            const difficulty = settings ? settings.difficulty : 'intermediate';
            if (difficulty === 'beginner') {
                features.push('å…¥é—¨å‹å¥½ï¼šå†…å®¹ç”±æµ…å…¥æ·±ï¼Œé€‚åˆé›¶åŸºç¡€å­¦å‘˜');
            } else if (difficulty === 'intermediate') {
                features.push('è¿›é˜¶æå‡ï¼šé€‚åˆæœ‰ä¸€å®šåŸºç¡€çš„å­¦å‘˜æ·±å…¥å­¦ä¹ ');
            } else if (difficulty === 'advanced') {
                features.push('é«˜çº§ä¸“ä¸šï¼šå†…å®¹æ·±åº¦è¾ƒå¤§ï¼Œé€‚åˆèµ„æ·±äººå‘˜');
            }
            
            // åŸºäºæ•™å­¦æ–¹å¼
            const teachingMethods = [];
            if (settings && settings.theory) teachingMethods.push('ç†è®ºè®²è§£');
            if (settings && settings.practice) teachingMethods.push('å®æ“æ¼”ç¤º');
            if (settings && settings.exercise) teachingMethods.push('éšå ‚ç»ƒä¹ ');
            if (settings && settings.case) teachingMethods.push('æ¡ˆä¾‹åˆ†æ');
            
            if (teachingMethods.length > 0) {
                features.push(`å¤šå…ƒåŒ–æ•™å­¦ï¼šç»“åˆ${teachingMethods.join('ã€')}ç­‰æ–¹å¼`);
            } else {
                // æä¾›é»˜è®¤çš„æ•™å­¦æ–¹å¼æè¿°
                features.push('å¤šå…ƒåŒ–æ•™å­¦ï¼šç†è®ºä¸å®è·µç›¸ç»“åˆ');
            }
            
            // åŸºäºæ—¶é•¿
            const duration = settings ? settings.duration : '2-4';
            if (duration === '1-2') {
                features.push('çŸ­æ—¶é«˜æ•ˆï¼š1-2å°æ—¶å¿«é€ŸæŒæ¡æ ¸å¿ƒè¦ç‚¹');
            } else if (duration === '2-4') {
                features.push('é€‚ä¸­æ—¶é•¿ï¼š2-4å°æ—¶ç³»ç»Ÿå­¦ä¹ ï¼Œæ—¶é—´å®‰æ’åˆç†');
            } else if (duration && duration.includes('day')) {
                features.push('æ·±åº¦åŸ¹è®­ï¼šå…¨å¤©æˆ–å¤šå¤©æ·±å…¥å­¦ä¹ ï¼Œå†…å®¹æ‰å®');
            }
            
            // ä¸ªæ€§åŒ–ç‰¹ç‚¹
            features.push('ä¸ªæ€§åŒ–å®šåˆ¶ï¼šæ ¹æ®æ‚¨çš„å…·ä½“éœ€æ±‚è°ƒæ•´ä¼˜åŒ–');
            
            return features;
        }


        
        // ç»‘å®šç¼–è¾‘äº‹ä»¶
        function bindEditEvents() {
            // æ·»åŠ å°èŠ‚æŒ‰é’®
            document.querySelectorAll('.add-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const chapterItem = btn.closest('.chapter-item');
                    addNewSection(chapterItem);
                });
            });
            
            // åˆ é™¤ç« èŠ‚æŒ‰é’®
            document.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const chapterItem = btn.closest('.chapter-item');
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿ')) {
                        chapterItem.remove();
                        updateChapterNumbers();
                    }
                });
            });
            
            // åˆ é™¤å°èŠ‚æŒ‰é’®
            document.querySelectorAll('.delete-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sectionItem = btn.closest('.section-item');
                    sectionItem.remove();
                    updateSectionNumbers();
                });
            });
        }
        
        // æ·»åŠ æ–°ç« èŠ‚
        function addNewChapter(option) {
            const container = document.getElementById('editableOutlineContent');
            const chapterIndex = container.children.length;
            const color = option === 'A' ? 'blue' : 'green';
            
            const newChapter = document.createElement('div');
            newChapter.className = 'chapter-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 group';
            newChapter.dataset.chapterIndex = chapterIndex;
            newChapter.innerHTML = `
                <div class="flex items-start space-x-3 mb-3">
                    <div class="w-8 h-8 bg-${color}-100 dark:bg-${color}-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="text-${color}-600 dark:text-${color}-400 font-semibold text-sm">${chapterIndex + 1}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <input type="text" value="æ–°ç« èŠ‚" class="chapter-title w-full font-medium text-gray-900 dark:text-white bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="ç« èŠ‚æ ‡é¢˜">
                    </div>
                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="add-section-btn p-1 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded transition-all" title="æ·»åŠ å°èŠ‚">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                        <button class="delete-chapter-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all" title="åˆ é™¤ç« èŠ‚">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                        <div class="drag-handle p-1 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="æ‹–æ‹½æ’åº">
                            <i class="fas fa-grip-vertical text-xs"></i>
                        </div>
                    </div>
                </div>
                <div class="sections-container ml-11 space-y-2">
                    <div class="section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section" data-section-index="0">
                        <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.1</span>
                        <input type="text" value="æ–°å†…å®¹" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="å°èŠ‚å†…å®¹">
                        <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="åˆ é™¤å°èŠ‚">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newChapter);
            bindEditEvents();
            updateChapterNumbers();
            
            // èšç„¦åˆ°æ–°ç« èŠ‚æ ‡é¢˜
            newChapter.querySelector('.chapter-title').focus();
            newChapter.querySelector('.chapter-title').select();
        }
        
        // æ·»åŠ æ–°å°èŠ‚
        function addNewSection(chapterItem) {
            const sectionsContainer = chapterItem.querySelector('.sections-container');
            const chapterIndex = Array.from(chapterItem.parentNode.children).indexOf(chapterItem);
            const sectionIndex = sectionsContainer.children.length;
            const option = document.getElementById('confirmEditedOutline').dataset.option;
            const color = option === 'A' ? 'blue' : 'green';
            
            const newSection = document.createElement('div');
            newSection.className = 'section-item flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded group/section';
            newSection.dataset.sectionIndex = sectionIndex;
            newSection.innerHTML = `
                <span class="text-gray-500 dark:text-gray-400 text-xs font-mono min-w-[2rem]">${chapterIndex + 1}.${sectionIndex + 1}</span>
                <input type="text" value="æ–°å†…å®¹" class="section-title flex-1 text-sm text-gray-700 dark:text-gray-200 bg-transparent border border-gray-300 dark:border-gray-600 rounded px-2 py-1 focus:ring-2 focus:ring-${color}-500 focus:border-${color}-500" placeholder="å°èŠ‚å†…å®¹">
                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover/section:opacity-100" title="åˆ é™¤å°èŠ‚">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            
            sectionsContainer.appendChild(newSection);
            bindEditEvents();
            updateSectionNumbers();
            
            // èšç„¦åˆ°æ–°å°èŠ‚
            newSection.querySelector('.section-title').focus();
            newSection.querySelector('.section-title').select();
        }
        
        // æ›´æ–°ç« èŠ‚ç¼–å·
        function updateChapterNumbers() {
            const chapters = document.querySelectorAll('.chapter-item');
            chapters.forEach((chapter, index) => {
                const numberSpan = chapter.querySelector('.w-8 span');
                if (numberSpan) {
                    numberSpan.textContent = index + 1;
                }
                chapter.dataset.chapterIndex = index;
                updateSectionNumbers(chapter);
            });
        }
        
        // æ›´æ–°å°èŠ‚ç¼–å·
        function updateSectionNumbers(chapterItem = null) {
            const chapters = chapterItem ? [chapterItem] : document.querySelectorAll('.chapter-item');
            chapters.forEach((chapter, chapterIndex) => {
                if (!chapterItem) {
                    chapterIndex = Array.from(chapter.parentNode.children).indexOf(chapter);
                }
                const sections = chapter.querySelectorAll('.section-item');
                sections.forEach((section, sectionIndex) => {
                    const numberSpan = section.querySelector('.text-xs.font-mono');
                    if (numberSpan) {
                        numberSpan.textContent = `${chapterIndex + 1}.${sectionIndex + 1}`;
                    }
                    section.dataset.sectionIndex = sectionIndex;
                });
            });
        }
        
        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            let draggedElement = null;
            
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    draggedElement = handle.closest('.chapter-item');
                    draggedElement.draggable = true;
                    draggedElement.style.opacity = '0.5';
                });
            });
            
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item) {
                        const rect = item.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        if (e.clientY < midpoint) {
                            item.parentNode.insertBefore(draggedElement, item);
                        } else {
                            item.parentNode.insertBefore(draggedElement, item.nextSibling);
                        }
                    }
                });
                
                item.addEventListener('dragend', () => {
                    if (draggedElement) {
                        draggedElement.style.opacity = '1';
                        draggedElement.draggable = false;
                        draggedElement = null;
                        updateChapterNumbers();
                    }
                });
            });
        }
        
        // è·å–ç¼–è¾‘åçš„å¤§çº²æ•°æ®
        function getEditedOutlineData() {
            const chapters = [];
            const chapterItems = document.querySelectorAll('.chapter-item');
            
            if (chapterItems.length === 0) {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç« èŠ‚é¡¹ï¼Œè¿”å›é»˜è®¤ç»“æ„
                return {
                    chapters: [
                        {
                            title: 'ç¬¬ä¸€ç«  åŸºç¡€çŸ¥è¯†',
                            sections: ['åŸºç¡€æ¦‚å¿µ', 'æ ¸å¿ƒåŸç†']
                        }
                    ]
                };
            }
            
            chapterItems.forEach(chapterItem => {
                const titleInput = chapterItem.querySelector('.chapter-title');
                const title = titleInput ? titleInput.value : '';
                const sections = [];
                
                chapterItem.querySelectorAll('.section-title').forEach(sectionInput => {
                    if (sectionInput.value && sectionInput.value.trim()) {
                        sections.push(sectionInput.value.trim());
                    }
                });
                
                if (title.trim()) {
                    chapters.push({
                        title: title.trim(),
                        sections: sections.length > 0 ? sections : ['å†…å®¹å°èŠ‚']
                    });
                }
            });
            
            return {
                chapters: chapters.length > 0 ? chapters : [
                    {
                        title: 'ç¬¬ä¸€ç«  åŸºç¡€çŸ¥è¯†',
                        sections: ['åŸºç¡€æ¦‚å¿µ', 'æ ¸å¿ƒåŸç†']
                    }
                ]
            };
        }
        
        // è·å–ç¼–è¾‘åçš„è®¾ç½®
        function getEditedSettings() {
            // å®‰å…¨è·å–è®¾ç½®å€¼ï¼Œæä¾›é»˜è®¤å€¼
            const getDuration = () => {
                const el = document.getElementById('editCourseDuration');
                return el ? el.value : '2-4';
            };
            
            const getDifficulty = () => {
                const el = document.getElementById('editCourseDifficulty');
                return el ? el.value : 'intermediate';
            };
            
            const getChecked = (id) => {
                const el = document.getElementById(id);
                return el ? el.checked : false;
            };
            
            const getTextValue = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            
            return {
                duration: getDuration(),
                difficulty: getDifficulty(),
                theory: getChecked('editTheory'),
                practice: getChecked('editPractice'),
                exercise: getChecked('editExercise'),
                case: getChecked('editCase'),
                otherRequirements: getTextValue('editOtherRequirements')
            };
        }

        // å¤„ç†ç”¨æˆ·è¾“å…¥
        function handleUserInput() {
            const message = elements.messageInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            elements.messageInput.value = '';
            
            // æ ¹æ®å½“å‰æ­¥éª¤å¤„ç†ä¸åŒé€»è¾‘
            setTimeout(() => {
                if (AppState.currentStep === 1) {
                    handleCourseTopicInput(message);
                } else if (AppState.isCollectingRequirements) {
                    // åœ¨éœ€æ±‚æ”¶é›†é˜¶æ®µï¼Œå¯ä»¥é€šè¿‡æ–‡æœ¬å›ç­”
                    handleTextAnswerDuringCollection(message);
                }
            }, 500);
        }

        // å¤„ç†éœ€æ±‚æ”¶é›†é˜¶æ®µçš„æ–‡æœ¬å›ç­”
        function handleTextAnswerDuringCollection(message) {
            // ç”¨æˆ·å¯ä»¥é€šè¿‡æ–‡æœ¬å›ç­”å½“å‰é—®é¢˜
            addMessage('æ”¶åˆ°æ‚¨çš„å›ç­”ï¼è®©æˆ‘ä¸ºæ‚¨åŒ¹é…æœ€åˆé€‚çš„é€‰é¡¹ï¼Œæˆ–è€…æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸Šé¢çš„é€‰é¡¹æŒ‰é’®ã€‚');
        }

        // å¤„ç†è¯¾ç¨‹ä¸»é¢˜è¾“å…¥
        function handleCourseTopicInput(topic) {
            AppState.courseTitle = topic;
            
            // åˆå§‹åŒ–é€æ­¥æ”¶é›†çš„çŠ¶æ€
            AppState.detailedRequirements = {
                duration: '',
                chapterCount: '',
                difficulty: '',
                teachingMethods: {},
                assessment: {},
                audience: {},
                deliveryFormat: '',
                specialRequirements: ''
            };
            AppState.currentQuestionStep = 1;
            
            addMessage(`å¥½çš„ï¼Œ"${topic}"ï¼Œè¿™ä¸ªä¸»é¢˜éå¸¸æ£’ï¼`);
            
            setTimeout(() => {
                addMessage('ä¸ºäº†ä¸ºæ‚¨é‡èº«å®šåˆ¶æœ€åˆé€‚çš„è¯¾ç¨‹ï¼Œæˆ‘éœ€è¦å†äº†è§£å‡ ä¸ªå…³é”®ä¿¡æ¯ã€‚è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼š');
                
                setTimeout(() => {
                    startStepByStepRequirements();
                }, 800);
            }, 1000);
        }

        // åˆå§‹åŒ–èŠå¤©å†…çš„æ–‡ä»¶ä¸Šä¼ 
        function initChatFileUpload(cardElement) {
            if (!cardElement) return;
            
            const uploadArea = cardElement.querySelector('#chatUploadArea');
            const uploadedFiles = cardElement.querySelector('#chatUploadedFiles');
            const skipButton = cardElement.querySelector('#skipUpload');
            
            if (!uploadArea) return;
            
            // ç‚¹å‡»ä¸Šä¼ 
            uploadArea.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            // è·³è¿‡ä¸Šä¼ 
            skipButton.addEventListener('click', () => {
                addMessage('å¥½çš„ï¼Œæˆ‘ä»¬ç›´æ¥å¼€å§‹ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹å†…å®¹ã€‚åŸºäºæ‚¨ç¡®è®¤çš„å¤§çº²å’Œè¯¦ç»†éœ€æ±‚ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ›å»ºä¸“ä¸šçš„è¯¾ç¨‹ã€‚');
                
                setTimeout(() => {
                    startFinalCourseGeneration();
                }, 1000);
            });
            
            // æ–‡ä»¶é€‰æ‹©
            const handleChatFiles = (event) => {
                const files = Array.from(event.target.files);
                
                files.forEach(file => {
                    if (AppState.uploadedFiles.find(f => f.name === file.name)) return;
                    
                    AppState.uploadedFiles.push(file);
                    addChatFileToUI(file, uploadedFiles);
                });
                
                if (AppState.uploadedFiles.length > 0) {
                    setTimeout(() => {
                        processChatUploadedFiles(cardElement);
                    }, 1000);
                }
            };
            
            elements.fileInput.addEventListener('change', handleChatFiles);
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'dark:border-blue-500');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'dark:border-blue-500');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'dark:border-blue-500');
                handleChatFiles({ target: { files: e.dataTransfer.files } });
            });
        }

        // æ·»åŠ æ–‡ä»¶åˆ°èŠå¤©UI
        function addChatFileToUI(file, container) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-500';
            
            const fileTypeIcons = {
                'pdf': 'fas fa-file-pdf text-red-500',
                'doc': 'fas fa-file-word text-blue-500',
                'docx': 'fas fa-file-word text-blue-500',
                'ppt': 'fas fa-file-powerpoint text-orange-500',
                'pptx': 'fas fa-file-powerpoint text-orange-500'
            };
            
            const extension = file.name.split('.').pop().toLowerCase();
            const iconClass = fileTypeIcons[extension] || 'fas fa-file text-gray-500';
            
            fileDiv.innerHTML = `
                <i class="${iconClass} text-sm"></i>
                <div class="flex-1 min-w-0">
                    <p class="font-medium text-gray-900 dark:text-white text-sm truncate">${file.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
                <button class="text-gray-400 hover:text-red-500 transition-colors text-sm" onclick="removeChatFile('${file.name}', this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(fileDiv);
        }

        // ç§»é™¤èŠå¤©æ–‡ä»¶
        function removeChatFile(fileName, buttonElement) {
            AppState.uploadedFiles = AppState.uploadedFiles.filter(f => f.name !== fileName);
            buttonElement.parentElement.remove();
        }

        // åˆå§‹åŒ–è¯¦ç»†éœ€æ±‚æ”¶é›†
        function initDetailedRequirements(cardElement) {
            if (!cardElement) return;
            
            const submitBtn = cardElement.querySelector('#submitDetailedRequirements');
            const detailDuration = cardElement.querySelector('#detailDuration');
            const chapterCount = cardElement.querySelector('#chapterCount');
            const customDurationDiv = cardElement.querySelector('#customDurationDiv');
            const customChapterDiv = cardElement.querySelector('#customChapterDiv');
            
            // å¤„ç†è‡ªå®šä¹‰æ—¶é•¿æ˜¾ç¤º/éšè—
            if (detailDuration) {
                detailDuration.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDurationDiv.classList.remove('hidden');
                    } else {
                        customDurationDiv.classList.add('hidden');
                    }
                });
            }
            
            // å¤„ç†è‡ªå®šä¹‰ç« èŠ‚æ•°æ˜¾ç¤º/éšè—
            if (chapterCount) {
                chapterCount.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customChapterDiv.classList.remove('hidden');
                    } else {
                        customChapterDiv.classList.add('hidden');
                    }
                });
            }
            
            // å¤„ç†æäº¤æŒ‰é’®
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    handleDetailedRequirementsSubmit(cardElement);
                });
            }
        }

        // å¤„ç†è¯¦ç»†éœ€æ±‚æäº¤
        function handleDetailedRequirementsSubmit(cardElement) {
            const requirements = collectDetailedRequirements(cardElement);
            
            // ä¿å­˜éœ€æ±‚æ•°æ®åˆ°åº”ç”¨çŠ¶æ€
            AppState.detailedRequirements = requirements;
            
            // æ·»åŠ æäº¤åé¦ˆ
            addMessage('å¤ªæ£’äº†ï¼æˆ‘å·²ç»æ”¶åˆ°äº†æ‚¨çš„è¯¦ç»†éœ€æ±‚ä¿¡æ¯ã€‚è®©æˆ‘æ¥ä¸ºæ‚¨æ€»ç»“ä¸€ä¸‹ï¼š');
            
            setTimeout(() => {
                const summary = generateRequirementsSummary(requirements);
                addMessage(summary, false, true);
                
                setTimeout(() => {
                    const uploadCard = addFileUploadCard();
                    AppState.currentStep = 2;
                    initChatFileUpload(uploadCard);
                }, 1000);
            }, 800);
            
            // ç¦ç”¨è¡¨å•ï¼Œé˜²æ­¢é‡å¤æäº¤
            const form = cardElement.querySelector('#detailedRequirementsForm');
            if (form) {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';
            }
            
            const submitBtn = cardElement.querySelector('#submitDetailedRequirements');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check mr-3"></i>éœ€æ±‚å·²æ”¶é›†å®Œæˆ';
                submitBtn.disabled = true;
                submitBtn.className = submitBtn.className.replace('from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700', 'bg-green-500');
            }
        }

        // æ”¶é›†è¯¦ç»†éœ€æ±‚æ•°æ®
        function collectDetailedRequirements(cardElement) {
            const getValue = (selector) => {
                const element = cardElement.querySelector(selector);
                return element ? element.value : '';
            };
            
            const getChecked = (selector) => {
                const element = cardElement.querySelector(selector);
                return element ? element.checked : false;
            };
            
            const getRadioValue = (name) => {
                const element = cardElement.querySelector(`input[name="${name}"]:checked`);
                return element ? element.value : '';
            };
            
            return {
                duration: getValue('#detailDuration') === 'custom' ? getValue('#customDuration') : getValue('#detailDuration'),
                chapterCount: getValue('#chapterCount') === 'custom' ? getValue('#customChapterCount') : getValue('#chapterCount'),
                difficulty: getRadioValue('difficulty'),
                teachingMethods: {
                    theory: getChecked('#includeTheory'),
                    practice: getChecked('#includePractice'),
                    cases: getChecked('#includeCases'),
                    group: getChecked('#includeGroup')
                },
                assessment: {
                    quiz: getChecked('#includeQuiz'),
                    assignment: getChecked('#includeAssignment'),
                    project: getChecked('#includeProject'),
                    feedback: getChecked('#includeFeedback')
                },
                audience: {
                    size: getValue('#audienceSize'),
                    background: getValue('#audienceBackground')
                },
                deliveryFormat: getRadioValue('deliveryFormat'),
                specialRequirements: getValue('#specialRequirements')
            };
        }

        // ç”Ÿæˆéœ€æ±‚æ€»ç»“
        function generateRequirementsSummary(requirements) {
            let summary = '<div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 rounded-xl p-8 space-y-5">';
            summary += '<h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-6"><i class="fas fa-clipboard-check text-blue-500 mr-3"></i>è¯¾ç¨‹éœ€æ±‚æ€»ç»“æŠ¥å‘Š</h4>';
            
            // ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"çµé­‚"
            summary += '<div class="border-l-4 border-blue-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">ğŸ“‹ ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"çµé­‚"ï¼ˆç›®æ ‡ä¸å­¦å‘˜ï¼‰</h5>';
            
            if (requirements.coreGoal) {
                const goalText = requirements.coreGoal.length > 50 ? requirements.coreGoal : getCoreGoalDisplayText(requirements.coreGoal);
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-bullseye text-blue-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>æ ¸å¿ƒç›®æ ‡ï¼š</strong>${goalText}</span></div>`;
            }
            
            if (requirements.learnerPersona) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-users text-purple-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>å­¦å‘˜ç”»åƒï¼š</strong>${getLearnerPersonaDisplayText(requirements.learnerPersona)}</span></div>`;
            }
            summary += '</div>';
            
            // ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"è¡€è‚‰"
            summary += '<div class="border-l-4 border-green-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">ğŸ¨ ç¬¬äºŒéƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"è¡€è‚‰"ï¼ˆå†…å®¹ä¸äº¤äº’ï¼‰</h5>';
            
            if (requirements.contentSource) {
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-book text-green-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>å†…å®¹æ¥æºï¼š</strong>${getContentSourceDisplayText(requirements.contentSource)}</span></div>`;
            }
            
            if (requirements.teachingActivities && Object.keys(requirements.teachingActivities).length > 0) {
                const selectedActivities = Object.entries(requirements.teachingActivities)
                    .filter(([key, value]) => value)
                    .map(([key, value]) => getTeachingActivityDisplayText(key));
                if (selectedActivities.length > 0) {
                    summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-chalkboard-teacher text-orange-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>æ•™å­¦æ´»åŠ¨ï¼š</strong>${selectedActivities.join('ã€')}</span></div>`;
                }
            }
            
            if (requirements.assessmentMethod) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-clipboard-check text-red-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>è¯„ä¼°æ–¹å¼ï¼š</strong>${getAssessmentMethodDisplayText(requirements.assessmentMethod)}</span></div>`;
            }
            summary += '</div>';
            
            // ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"è§„åˆ™"
            summary += '<div class="border-l-4 border-yellow-500 pl-4 mb-6">';
            summary += '<h5 class="text-lg font-medium text-gray-800 dark:text-gray-200 mb-3">âš™ï¸ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¯¾ç¨‹çš„"è§„åˆ™"ï¼ˆäº¤ä»˜ä¸ç®¡ç†ï¼‰</h5>';
            
            if (requirements.certification) {
                summary += `<div class="flex items-start space-x-3 mb-3"><i class="fas fa-certificate text-yellow-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>è®¤è¯è¦æ±‚ï¼š</strong>${getCertificationDisplayText(requirements.certification)}</span></div>`;
            }
            
            if (requirements.managementLevel) {
                summary += `<div class="flex items-start space-x-3"><i class="fas fa-cogs text-indigo-500 w-5 mt-1"></i><span class="text-gray-700 dark:text-gray-300"><strong>ç®¡ç†ä¸¥æ ¼åº¦ï¼š</strong>${getManagementLevelDisplayText(requirements.managementLevel)}</span></div>`;
            }
            summary += '</div>';
            
            // AIæ™ºèƒ½å»ºè®®
            summary += '<div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
            summary += '<h6 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i>AIæ™ºèƒ½å»ºè®®</h6>';
            summary += '<p class="text-sm text-gray-600 dark:text-gray-400">åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆç¬¦åˆä¸“ä¸šæ•™å­¦è®¾è®¡åŸåˆ™çš„è¯¾ç¨‹å¤§çº²ï¼Œç¡®ä¿æ¯ä¸ªç¯èŠ‚éƒ½èƒ½æœ‰æ•ˆè¾¾æˆæ‚¨è®¾å®šçš„å­¦ä¹ ç›®æ ‡ã€‚</p>';
            summary += '</div>';
            
            summary += '</div>';
            return summary;
        }

        // æ˜¾ç¤ºæ–‡æœ¬è½¬æ¢å‡½æ•°
        function getCoreGoalDisplayText(goal) {
            const goalMap = {
                'workflow': 'ç‹¬ç«‹å®Œæˆæ ‡å‡†åŒ–çš„å·¥ä½œæµç¨‹',
                'tool-usage': 'ç†Ÿç»ƒä½¿ç”¨ç‰¹å®šå·¥å…·æˆ–ç³»ç»Ÿ',
                'problem-solving': 'è§£å†³æŸç±»ä¸“ä¸šé—®é¢˜',
                'skill-mastery': 'æŒæ¡ç‰¹å®šæŠ€èƒ½æˆ–æ–¹æ³•'
            };
            return goalMap[goal] || goal;
        }

        function getLearnerPersonaDisplayText(persona) {
            const personaMap = {
                'new-employee': 'åˆšå…¥èŒçš„æ–°å‘˜å·¥ï¼Œé›¶åŸºç¡€æˆ–åŸºç¡€è–„å¼±',
                'junior-employee': 'å·¥ä½œ1-3å¹´çš„åˆçº§å‘˜å·¥ï¼Œæœ‰åŸºæœ¬äº†è§£',
                'mid-employee': 'å·¥ä½œ3-5å¹´çš„ä¸­çº§å‘˜å·¥ï¼Œæ‡‚ç†è®ºç¼ºå®æˆ˜',
                'senior-employee': 'å·¥ä½œ5å¹´ä»¥ä¸Šçš„èµ„æ·±å‘˜å·¥ï¼Œéœ€è¦æ›´æ–°çŸ¥è¯†',
                'management': 'ç®¡ç†å±‚äººå‘˜ï¼Œéœ€è¦å…¨å±€æ€§ç†è§£',
                'expert': 'æŠ€æœ¯ä¸“å®¶ï¼Œéœ€è¦æ·±åº¦ä¸“ä¸šçŸ¥è¯†'
            };
            return personaMap[persona] || persona;
        }

        function getContentSourceDisplayText(source) {
            const sourceMap = {
                'existing-materials': 'ç°æˆçš„æ–‡æ¡£/PPT/è§†é¢‘èµ„æ–™',
                'external-links': 'å¤–éƒ¨ç½‘ç«™ã€æ–‡ç« æˆ–è§†é¢‘',
                'ai-creation': 'AIä»é›¶å¼€å§‹åˆ›ä½œ',
                'hybrid-content': 'æ··åˆæ–¹å¼ï¼ˆç°æœ‰èµ„æ–™ + AIåˆ›ä½œï¼‰'
            };
            return sourceMap[source] || source;
        }

        function getTeachingActivityDisplayText(activity) {
            const activityMap = {
                'video-lecture': 'è§†é¢‘è®²è§£',
                'article-reading': 'æ–‡ç« é˜…è¯»',
                'case-analysis': 'æ¡ˆä¾‹åˆ†æ',
                'group-discussion': 'å°ç»„è®¨è®º',
                'hands-on-practice': 'å®æ“ç»ƒä¹ ',
                'guest-sharing': 'å˜‰å®¾åˆ†äº«',
                'role-playing': 'è§’è‰²æ‰®æ¼”'
            };
            return activityMap[activity] || activity;
        }

        function getAssessmentMethodDisplayText(method) {
            const methodMap = {
                'frequent-tests': 'æ¯ä¸ªé‡è¦çŸ¥è¯†ç‚¹åéƒ½æœ‰å°ç»ƒä¹ ',
                'final-exam': 'æœŸæœ«ç»¼åˆæ€§è€ƒè¯•',
                'project-assessment': 'é€šè¿‡å®é™…é¡¹ç›®æ£€éªŒå­¦ä¹ æˆæœ',
                'no-assessment': 'éè€ƒæ ¸çš„è‡ªå­¦è¯¾ç¨‹'
            };
            return methodMap[method] || method;
        }

        function getCertificationDisplayText(cert) {
            const certMap = {
                'formal-certificate': 'æ­£å¼çš„ç»“ä¸šè¯ä¹¦',
                'completion-record': 'å­¦ä¹ è®°å½•å’Œå®Œæˆè¯æ˜',
                'no-certification': 'æ— éœ€ä»»ä½•å‡­è¯'
            };
            return certMap[cert] || cert;
        }

        function getManagementLevelDisplayText(level) {
            const levelMap = {
                'strict-management': 'ä¸¥æ ¼ç®¡ç†ï¼Œæ­£å¼å¿…ä¿®è¯¾ç¨‹',
                'moderate-management': 'é€‚åº¦ç®¡ç†ï¼Œå…è®¸çµæ´»å­¦ä¹ ',
                'flexible-learning': 'ä¸éœ€è¦ç®¡ç†ï¼Œè‡ªç”±æ¢ç´¢'
            };
            return levelMap[level] || level;
        }

        // å¤„ç†èŠå¤©ä¸Šä¼ çš„æ–‡ä»¶
        function processChatUploadedFiles(cardElement) {
            addMessage('æ”¶åˆ°ï¼æ–‡ä»¶å·²ä¸Šä¼ ã€‚æˆ‘æ­£åœ¨å¿«é€Ÿ"é˜…è¯»"å’Œ"æ¶ˆåŒ–"å®ƒä»¬ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»...');
            
            setTimeout(() => {
                addMessage(`ğŸ“„ æ–‡ä»¶åˆ†æå®Œæˆï¼<br/>
                    ${AppState.uploadedFiles.map(file => `âœ… ${file.name}: å†…å®¹æ¸…æ™°ï¼Œè´¨é‡å¾ˆé«˜ã€‚`).join('<br/>')}<br/><br/>
                    ç´ æéå¸¸å®Œç¾ï¼ç°åœ¨è®©æˆ‘æ±‡æŠ¥ä¸€ä¸‹åˆ†æç»“æœã€‚`, false, true);
                
                setTimeout(() => {
                    // æ˜¾ç¤ºéœ€æ±‚åˆ†ææ±‡æŠ¥
                    showRequirementAnalysisReport();
                }, 1500);
            }, 2000);
        }

        // æ˜¾ç¤ºéœ€æ±‚åˆ†ææ±‡æŠ¥
        function showRequirementAnalysisReport() {
            addMessage('ğŸ“Š è®©æˆ‘å‘æ‚¨æ±‡æŠ¥åˆ†æç»“æœï¼š');
            
            setTimeout(() => {
                // ç”Ÿæˆéœ€æ±‚åˆ†ææŠ¥å‘Šå¡ç‰‡
                const analysisReport = generateRequirementAnalysisReport();
                const reportCard = addMessage(analysisReport, false, true, true);
                
                // åˆå§‹åŒ–æŠ¥å‘Šç¡®è®¤æŒ‰é’®
                initAnalysisReportActions(reportCard);
            }, 800);
        }

        // ç”Ÿæˆéœ€æ±‚åˆ†ææŠ¥å‘Š
        function generateRequirementAnalysisReport() {
            const requirements = AppState.detailedRequirements || {};
            const uploadedFilesInfo = AppState.uploadedFiles || [];
            
            // åˆ†æç”¨æˆ·éœ€æ±‚
            const analysisData = analyzeUserRequirements(requirements, uploadedFilesInfo);
            
            return `
                <div class="p-4 max-w-3xl mx-auto">
                    <!-- æ ‡é¢˜åŒºåŸŸ -->
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-chart-line text-blue-500 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">éœ€æ±‚åˆ†ææŠ¥å‘Š</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">åŸºäºæ‚¨çš„è¯¦ç»†éœ€æ±‚å’Œä¸Šä¼ èµ„æ–™çš„æ·±åº¦åˆ†æ</p>
                    </div>
                    
                    <!-- ä¸»è¦å†…å®¹ç½‘æ ¼ -->
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- è¯¾ç¨‹ç›®æ ‡åˆ†æ -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-bullseye text-blue-500 mr-2 text-sm"></i>è¯¾ç¨‹ç›®æ ‡åˆ†æ
                            </h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>ä¸»é¢˜ï¼š</strong>${AppState.courseTitle || 'ä¸“ä¸šæŠ€èƒ½åŸ¹è®­'}
                                    </span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>ç›®æ ‡ï¼š</strong>${analysisData.coreGoal}
                                    </span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-arrow-right text-blue-500 mt-1" style="font-size: 10px;"></i>
                                    <span class="text-gray-700 dark:text-gray-300">
                                        <strong>å­¦å‘˜ï¼š</strong>${analysisData.targetLearners}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ•™å­¦è®¾è®¡ -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-cogs text-green-500 mr-2 text-sm"></i>æ•™å­¦è®¾è®¡
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.teachingDesign.slice(0,3).map(item => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-green-500 rounded-full"></div>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- èµ„æ–™åˆ†æ -->
                        <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-file-alt text-purple-500 mr-2 text-sm"></i>èµ„æ–™åˆ†æ
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.materialAnalysis.slice(0,3).map(item => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-500 rounded-full"></div>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- é¢„æœŸè¯¾ç¨‹ç‰¹è‰² -->
                        <div class="bg-gradient-to-br from-orange-50 to-yellow-50 dark:from-orange-900/20 dark:to-yellow-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-star text-yellow-500 mr-2 text-sm"></i>è¯¾ç¨‹ç‰¹è‰²
                            </h4>
                            <div class="space-y-1.5 text-xs text-gray-600 dark:text-gray-300">
                                ${analysisData.courseFeatures.slice(0,3).map(feature => `
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-yellow-500 rounded-full"></div>
                                        <span>${feature}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯¾ç¨‹è§„æ¨¡é¢„ä¼° - ç´§å‡‘ç‰ˆ -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center justify-center">
                            <i class="fas fa-ruler text-gray-500 mr-2 text-sm"></i>è¯¾ç¨‹è§„æ¨¡é¢„ä¼°
                        </h4>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-blue-500">${analysisData.estimatedDuration}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">é¢„è®¡æ—¶é•¿</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-green-500">${analysisData.estimatedChapters}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">ç« èŠ‚æ•°é‡</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-purple-500">${analysisData.difficultyLevel}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">éš¾åº¦ç­‰çº§</div>
                            </div>
                            <div class="bg-white dark:bg-gray-600 rounded-lg p-2">
                                <div class="text-sm font-bold text-orange-500">${uploadedFilesInfo.length}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">å‚è€ƒèµ„æ–™</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¡®è®¤æŒ‰é’® -->
                    <div class="text-center">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4">
                            <p class="text-xs text-blue-700 dark:text-blue-300 mb-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                ä»¥ä¸Šæ˜¯åŸºäºæ‚¨çš„éœ€æ±‚å’Œèµ„æ–™è¿›è¡Œçš„æ™ºèƒ½åˆ†æ
                            </p>
                            <p class="text-xs text-blue-600 dark:text-blue-400">
                                ç¡®è®¤æ— è¯¯åï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆå¯¹åº”çš„è¯¾ç¨‹å¤§çº²æ–¹æ¡ˆ
                            </p>
                        </div>
                        
                        <div class="flex justify-center space-x-3">
                            <button id="modifyRequirements" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm">
                                <i class="fas fa-edit mr-1"></i>éœ€è¦è°ƒæ•´
                            </button>
                            <button id="confirmAnalysis" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors text-sm">
                                <i class="fas fa-check mr-1"></i>ç¡®è®¤æ— è¯¯ï¼Œç”Ÿæˆå¤§çº²
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ†æç”¨æˆ·éœ€æ±‚
        function analyzeUserRequirements(requirements, uploadedFiles) {
            const analysis = {
                coreGoal: getCoreGoalAnalysis(requirements.coreGoal),
                targetLearners: getTargetLearnersAnalysis(requirements.learnerPersona),
                teachingDesign: getTeachingDesignAnalysis(requirements),
                materialAnalysis: getMaterialAnalysis(uploadedFiles),
                courseFeatures: getCourseFeatures(requirements, uploadedFiles),
                estimatedDuration: getEstimatedDuration(requirements),
                estimatedChapters: getEstimatedChapters(requirements),
                difficultyLevel: getDifficultyLevel(requirements.learnerPersona)
            };
            
            return analysis;
        }

        // è·å–æ ¸å¿ƒç›®æ ‡åˆ†æ
        function getCoreGoalAnalysis(coreGoal) {
            if (!coreGoal) return 'å¸®åŠ©å­¦å‘˜æŒæ¡ä¸“ä¸šæŠ€èƒ½ï¼Œæå‡å·¥ä½œèƒ½åŠ›';
            
            if (coreGoal.includes('workflow') || coreGoal.includes('æµç¨‹')) {
                return 'ç†Ÿç»ƒæŒæ¡æ ‡å‡†åŒ–å·¥ä½œæµç¨‹ï¼Œæå‡å·¥ä½œæ•ˆç‡';
            } else if (coreGoal.includes('tool-usage') || coreGoal.includes('å·¥å…·')) {
                return 'ç²¾é€šç›¸å…³å·¥å…·çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿç‹¬ç«‹å®Œæˆæ—¥å¸¸å·¥ä½œ';
            } else if (coreGoal.includes('problem-solving') || coreGoal.includes('è§£å†³')) {
                return 'åŸ¹å…»åˆ†æå’Œè§£å†³å®é™…é—®é¢˜çš„èƒ½åŠ›';
            } else if (coreGoal.includes('skill-mastery') || coreGoal.includes('æŠ€èƒ½')) {
                return 'ç³»ç»ŸæŒæ¡æ ¸å¿ƒæŠ€èƒ½ï¼Œè¾¾åˆ°ä¸“ä¸šæ°´å‡†';
            }
            
            return coreGoal.length > 50 ? coreGoal.substring(0, 50) + '...' : coreGoal;
        }

        // è·å–ç›®æ ‡å­¦å‘˜åˆ†æ
        function getTargetLearnersAnalysis(learnerPersona) {
            const personas = {
                'new-employee': 'æ–°å…¥èŒå‘˜å·¥ï¼ˆé›¶åŸºç¡€æˆ–åŸºç¡€è–„å¼±ï¼‰',
                'junior-employee': 'åˆçº§å‘˜å·¥ï¼ˆå·¥ä½œ1-3å¹´ï¼Œæœ‰åŸºæœ¬äº†è§£ï¼‰',
                'mid-employee': 'ä¸­çº§å‘˜å·¥ï¼ˆå·¥ä½œ3-5å¹´ï¼Œæ‡‚ç†è®ºç¼ºå®æˆ˜ï¼‰',
                'senior-employee': 'èµ„æ·±å‘˜å·¥ï¼ˆå·¥ä½œ5å¹´ä»¥ä¸Šï¼Œéœ€è¦æ›´æ–°çŸ¥è¯†ï¼‰',
                'management': 'ç®¡ç†å±‚äººå‘˜ï¼ˆéœ€è¦å…¨å±€æ€§ç†è§£ï¼‰',
                'expert': 'æŠ€æœ¯ä¸“å®¶ï¼ˆéœ€è¦æ·±åº¦ä¸“ä¸šçŸ¥è¯†ï¼‰'
            };
            
            return personas[learnerPersona] || 'å„å±‚çº§å‘˜å·¥ï¼Œæ ¹æ®ä¸åŒåŸºç¡€åˆ†å±‚æ•™å­¦';
        }

        // è·å–æ•™å­¦è®¾è®¡åˆ†æ
        function getTeachingDesignAnalysis(requirements) {
            const designs = [];
            
            if (requirements.teachingActivities) {
                if (requirements.teachingActivities['interactive-lecture']) {
                    designs.push('äº’åŠ¨å¼è®²è§£ï¼Œå¢å¼ºå‚ä¸åº¦');
                }
                if (requirements.teachingActivities['hands-on-practice']) {
                    designs.push('å®æ“ç»ƒä¹ ä¸ºä¸»ï¼Œè¾¹å­¦è¾¹åš');
                }
                if (requirements.teachingActivities['case-analysis']) {
                    designs.push('æ¡ˆä¾‹åˆ†æé©±åŠ¨ï¼Œè´´è¿‘å®é™…');
                }
                if (requirements.teachingActivities['group-discussion']) {
                    designs.push('å°ç»„è®¨è®ºäº¤æµï¼Œä¿ƒè¿›æ€è€ƒ');
                }
                if (requirements.teachingActivities['role-playing']) {
                    designs.push('è§’è‰²æ‰®æ¼”æ¨¡æ‹Ÿï¼Œæƒ…å¢ƒåŒ–å­¦ä¹ ');
                }
            }
            
            if (designs.length === 0) {
                designs.push('ç†è®ºä¸å®è·µç›¸ç»“åˆ');
                designs.push('å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„');
                designs.push('å¤šå…ƒåŒ–æ•™å­¦æ–¹æ³•');
            }
            
            return designs;
        }

        // è·å–èµ„æ–™åˆ†æ
        function getMaterialAnalysis(uploadedFiles) {
            const analysis = [];
            
            if (uploadedFiles.length === 0) {
                analysis.push('åŸºäºAIæ™ºèƒ½ç”Ÿæˆå†…å®¹');
                analysis.push('å‚è€ƒè¡Œä¸šæœ€ä½³å®è·µ');
                analysis.push('ç»“åˆé€šç”¨ä¸šåŠ¡åœºæ™¯');
            } else {
                analysis.push(`å·²ä¸Šä¼ ${uploadedFiles.length}ä¸ªä¸“ä¸šèµ„æ–™`);
                
                const fileTypes = uploadedFiles.map(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['pdf', 'doc', 'docx'].includes(ext)) return 'æ–‡æ¡£èµ„æ–™';
                    if (['ppt', 'pptx'].includes(ext)) return 'PPTèµ„æ–™';
                    if (['xls', 'xlsx'].includes(ext)) return 'è¡¨æ ¼æ•°æ®';
                    return 'å…¶ä»–èµ„æ–™';
                });
                
                const uniqueTypes = [...new Set(fileTypes)];
                analysis.push(`åŒ…å«${uniqueTypes.join('ã€')}ç­‰ç±»å‹`);
                analysis.push('å°†æ·±åº¦èå…¥è¯¾ç¨‹è®¾è®¡');
            }
            
            return analysis;
        }

        // è·å–è¯¾ç¨‹ç‰¹è‰²
        function getCourseFeatures(requirements, uploadedFiles) {
            const features = [];
            
            // åŸºäºå­¦å‘˜ç±»å‹ç¡®å®šç‰¹è‰²
            if (requirements.learnerPersona === 'new-employee') {
                features.push('é›¶åŸºç¡€å‹å¥½ï¼Œå¾ªåºæ¸è¿›');
                features.push('å¤§é‡å®ä¾‹æ¼”ç¤ºå’Œç»ƒä¹ ');
            } else if (requirements.learnerPersona === 'expert') {
                features.push('é«˜æ·±åº¦ä¸“ä¸šå†…å®¹');
                features.push('å‰æ²¿æŠ€æœ¯å’Œè¶‹åŠ¿');
            } else {
                features.push('ç†è®ºä¸å®è·µå¹¶é‡');
                features.push('æ³¨é‡å®é™…åº”ç”¨èƒ½åŠ›');
            }
            
            // åŸºäºæ•™å­¦æ´»åŠ¨ç¡®å®šç‰¹è‰²
            if (requirements.teachingActivities?.['hands-on-practice']) {
                features.push('å®æ“æ€§å¼ºï¼Œå­¦ä»¥è‡´ç”¨');
            }
            if (requirements.teachingActivities?.['case-analysis']) {
                features.push('æ¡ˆä¾‹ä¸°å¯Œï¼Œè´´è¿‘å®é™…');
            }
            
            // åŸºäºä¸Šä¼ æ–‡ä»¶ç¡®å®šç‰¹è‰²
            if (uploadedFiles.length > 0) {
                features.push('èå…¥ä¼ä¸šå®é™…èµ„æ–™');
                features.push('å®šåˆ¶åŒ–ç¨‹åº¦é«˜');
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰4ä¸ªç‰¹è‰²
            while (features.length < 4) {
                const additionalFeatures = [
                    'å†…å®¹ä½“ç³»å®Œæ•´',
                    'å­¦ä¹ è·¯å¾„æ¸…æ™°',
                    'äº’åŠ¨æ€§å¼º',
                    'å¯æ“ä½œæ€§å¼º',
                    'çŸ¥è¯†ç‚¹è¦†ç›–å…¨é¢',
                    'å®ç”¨æ€§å¼º'
                ];
                
                for (const feature of additionalFeatures) {
                    if (!features.includes(feature) && features.length < 4) {
                        features.push(feature);
                    }
                }
            }
            
            return features;
        }

        // è·å–é¢„ä¼°æ—¶é•¿
        function getEstimatedDuration(requirements) {
            if (requirements.learnerPersona === 'new-employee') return '3-4å°æ—¶';
            if (requirements.learnerPersona === 'expert') return '4-6å°æ—¶';
            if (requirements.learnerPersona === 'management') return '2-3å°æ—¶';
            return '2-4å°æ—¶';
        }

        // è·å–é¢„ä¼°ç« èŠ‚æ•°
        function getEstimatedChapters(requirements) {
            if (requirements.learnerPersona === 'new-employee') return '4-5ç« ';
            if (requirements.learnerPersona === 'expert') return '5-6ç« ';
            if (requirements.learnerPersona === 'management') return '3-4ç« ';
            return '4-5ç« ';
        }

        // è·å–éš¾åº¦ç­‰çº§
        function getDifficultyLevel(learnerPersona) {
            if (learnerPersona === 'new-employee') return 'å…¥é—¨çº§';
            if (learnerPersona === 'junior-employee') return 'åˆçº§';
            if (learnerPersona === 'mid-employee') return 'ä¸­çº§';
            if (learnerPersona === 'senior-employee') return 'ä¸­é«˜çº§';
            if (learnerPersona === 'management') return 'ç®¡ç†çº§';
            if (learnerPersona === 'expert') return 'ä¸“å®¶çº§';
            return 'ä¸­çº§';
        }

        // åˆå§‹åŒ–åˆ†ææŠ¥å‘Šæ“ä½œ
        function initAnalysisReportActions(reportCard) {
            const modifyBtn = reportCard.querySelector('#modifyRequirements');
            const confirmBtn = reportCard.querySelector('#confirmAnalysis');
            
            if (modifyBtn) {
                modifyBtn.addEventListener('click', () => {
                    showRequirementAdjustmentInput();
                });
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    addMessage('âœ… åˆ†æç¡®è®¤å®Œæˆï¼ç°åœ¨åŸºäºè¿™äº›éœ€æ±‚ä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„è¯¾ç¨‹å¤§çº²æ–¹æ¡ˆ...', true);
                    
                    setTimeout(() => {
                        generateCourseOutlineFromRequirements();
                    }, 1000);
                });
            }
        }

        // æ˜¾ç¤ºéœ€æ±‚è°ƒæ•´è¾“å…¥ç•Œé¢
        function showRequirementAdjustmentInput() {
            addMessage('å¥½çš„ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨å¸Œæœ›è°ƒæ•´çš„å…·ä½“å†…å®¹ï¼š');
            
            setTimeout(() => {
                const adjustmentInput = generateAdjustmentInputCard();
                const inputCard = addMessage(adjustmentInput, false, true, true);
                
                // åˆå§‹åŒ–è°ƒæ•´è¾“å…¥åŠŸèƒ½
                initAdjustmentInput(inputCard);
            }, 800);
        }

        // ç”Ÿæˆè°ƒæ•´è¾“å…¥å¡ç‰‡
        function generateAdjustmentInputCard() {
            return `
                <div class="p-6 max-w-5xl mx-auto">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-edit text-orange-500 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">éœ€æ±‚è°ƒæ•´</h3>
                        <p class="text-gray-600 dark:text-gray-400">è¯·è¯¦ç»†æè¿°æ‚¨å¸Œæœ›è°ƒæ•´çš„å†…å®¹</p>
                    </div>
                    
                    <!-- å¸¸è§è°ƒæ•´é€‰é¡¹ -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                            <i class="fas fa-list text-blue-500 mr-2"></i>å¸¸è§è°ƒæ•´é¡¹ç›®ï¼ˆå¯ç‚¹å‡»å¿«é€Ÿé€‰æ‹©ï¼‰
                        </h4>
                        <div class="grid lg:grid-cols-3 md:grid-cols-2 gap-3">
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="target">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">ç›®æ ‡å­¦å‘˜è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">ä¿®æ”¹å­¦å‘˜ç±»å‹ã€åŸºç¡€æ°´å¹³ç­‰</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="duration">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">è¯¾ç¨‹æ—¶é•¿è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">å¢åŠ æˆ–å‡å°‘è¯¾ç¨‹æ—¶é•¿</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="difficulty">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">éš¾åº¦ç­‰çº§è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">æé«˜æˆ–é™ä½è¯¾ç¨‹éš¾åº¦</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="focus">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">é‡ç‚¹å†…å®¹è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">å¼ºè°ƒç‰¹å®šåŠŸèƒ½æˆ–æŠ€èƒ½</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="teaching">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">æ•™å­¦æ–¹å¼è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">æ”¹å˜æ•™å­¦æ´»åŠ¨å’Œäº’åŠ¨æ–¹å¼</div>
                            </button>
                            <button class="adjustment-quick-btn text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all" data-type="assessment">
                                <div class="font-medium text-gray-900 dark:text-white text-sm">è¯„ä¼°æ–¹å¼è°ƒæ•´</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">ä¿®æ”¹è€ƒæ ¸å’Œè¯„ä¼°æ–¹æ³•</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¯¦ç»†è°ƒæ•´è¯´æ˜è¾“å…¥æ¡† -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                            <i class="fas fa-comment-dots text-green-500 mr-2"></i>è¯¦ç»†è°ƒæ•´è¯´æ˜
                        </h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <textarea 
                                id="adjustmentInput" 
                                class="w-full h-28 p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" 
                                placeholder="è¯·è¯¦ç»†æè¿°æ‚¨å¸Œæœ›è°ƒæ•´çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ å¸Œæœ›å¢åŠ æ›´å¤šå®æ“ç»ƒä¹ ç¯èŠ‚&#10;â€¢ ç›®æ ‡å­¦å‘˜æ”¹ä¸ºæœ‰2å¹´ç»éªŒçš„ä¸­çº§å‘˜å·¥&#10;â€¢ è¯¾ç¨‹æ—¶é•¿è°ƒæ•´ä¸º4-6å°æ—¶&#10;â€¢ é‡ç‚¹å¼ºè°ƒæ•°æ®åˆ†æåŠŸèƒ½çš„ä½¿ç”¨&#10;â€¢ å¢åŠ å›¢é˜Ÿåä½œç›¸å…³çš„å†…å®¹"
                                maxlength="500"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-lightbulb mr-1"></i>æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸Šæ–¹çš„å¸¸è§è°ƒæ•´é¡¹ç›®å¿«é€Ÿå¡«å…¥
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <span id="charCount">0</span>/500å­—
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="text-center">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-4">
                            <p class="text-sm text-blue-700 dark:text-blue-300 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                æˆ‘å°†æ ¹æ®æ‚¨çš„è°ƒæ•´è¦æ±‚é‡æ–°åˆ†æéœ€æ±‚
                            </p>
                            <p class="text-xs text-blue-600 dark:text-blue-400">
                                è°ƒæ•´å®Œæˆåä¼šé‡æ–°ç”Ÿæˆåˆ†ææŠ¥å‘Š
                            </p>
                        </div>
                        
                        <div class="flex justify-center space-x-4">
                            <button id="cancelAdjustment" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-times mr-2"></i>å–æ¶ˆè°ƒæ•´
                            </button>
                            <button id="submitAdjustment" class="px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors" disabled>
                                <i class="fas fa-paper-plane mr-2"></i>æäº¤è°ƒæ•´è¦æ±‚
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆå§‹åŒ–è°ƒæ•´è¾“å…¥åŠŸèƒ½
        function initAdjustmentInput(inputCard) {
            const textarea = inputCard.querySelector('#adjustmentInput');
            const charCount = inputCard.querySelector('#charCount');
            const submitBtn = inputCard.querySelector('#submitAdjustment');
            const cancelBtn = inputCard.querySelector('#cancelAdjustment');
            const quickBtns = inputCard.querySelectorAll('.adjustment-quick-btn');
            
            // å­—ç¬¦è®¡æ•°å’ŒæŒ‰é’®çŠ¶æ€æ§åˆ¶
            if (textarea && charCount && submitBtn) {
                textarea.addEventListener('input', () => {
                    const length = textarea.value.length;
                    charCount.textContent = length;
                    
                    // æ§åˆ¶æäº¤æŒ‰é’®çŠ¶æ€
                    if (length > 10) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
                
                // è‡ªåŠ¨èšç„¦
                setTimeout(() => {
                    textarea.focus();
                }, 100);
            }
            
            // å¿«é€Ÿé€‰æ‹©æŒ‰é’®
            quickBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const suggestions = getAdjustmentSuggestions(type);
                    
                    // æ·»åŠ åˆ°è¾“å…¥æ¡†
                    const currentValue = textarea.value;
                    const newValue = currentValue ? `${currentValue}\nâ€¢ ${suggestions}` : `â€¢ ${suggestions}`;
                    textarea.value = newValue;
                    
                    // è§¦å‘inputäº‹ä»¶æ›´æ–°å­—ç¬¦è®¡æ•°
                    textarea.dispatchEvent(new Event('input'));
                    
                    // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
                    btn.classList.add('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-blue-900/30');
                    setTimeout(() => {
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-blue-900/30');
                    }, 2000);
                });
            });
            
            // å–æ¶ˆæŒ‰é’®
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    addMessage('å·²å–æ¶ˆè°ƒæ•´ï¼Œä¿æŒå½“å‰åˆ†æç»“æœã€‚');
                });
            }
            
            // æäº¤æŒ‰é’®
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const adjustmentText = textarea.value.trim();
                    if (adjustmentText.length > 10) {
                        processAdjustmentRequest(adjustmentText);
                    }
                });
            }
        }

        // è·å–è°ƒæ•´å»ºè®®æ–‡æœ¬
        function getAdjustmentSuggestions(type) {
            const suggestions = {
                'target': 'ç›®æ ‡å­¦å‘˜è°ƒæ•´ä¸º[å…·ä½“æè¿°ï¼Œå¦‚ï¼šæœ‰3å¹´å·¥ä½œç»éªŒçš„ä¸­çº§å‘˜å·¥]',
                'duration': 'è¯¾ç¨‹æ—¶é•¿è°ƒæ•´ä¸º[å…·ä½“æ—¶é•¿ï¼Œå¦‚ï¼š4-6å°æ—¶]',
                'difficulty': 'éš¾åº¦ç­‰çº§è°ƒæ•´ä¸º[å…·ä½“ç­‰çº§ï¼Œå¦‚ï¼šä¸­é«˜çº§]',
                'focus': 'é‡ç‚¹å¼ºè°ƒ[å…·ä½“å†…å®¹ï¼Œå¦‚ï¼šæ•°æ®åˆ†æå’ŒæŠ¥è¡¨åŠŸèƒ½]',
                'teaching': 'æ•™å­¦æ–¹å¼è°ƒæ•´ä¸º[å…·ä½“æ–¹å¼ï¼Œå¦‚ï¼šå¢åŠ æ›´å¤šå®æ“ç»ƒä¹ å’Œæ¡ˆä¾‹åˆ†æ]',
                'assessment': 'è¯„ä¼°æ–¹å¼è°ƒæ•´ä¸º[å…·ä½“æ–¹å¼ï¼Œå¦‚ï¼šé¡¹ç›®å®æˆ˜è¯„ä¼°]'
            };
            
            return suggestions[type] || 'è¯·æè¿°å…·ä½“çš„è°ƒæ•´éœ€æ±‚';
        }

        // å¤„ç†è°ƒæ•´è¯·æ±‚
        function processAdjustmentRequest(adjustmentText) {
            addMessage('âœ… æ”¶åˆ°æ‚¨çš„è°ƒæ•´è¦æ±‚ï¼æˆ‘æ­£åœ¨é‡æ–°åˆ†æå’Œè°ƒæ•´éœ€æ±‚...', true);
            
            setTimeout(() => {
                // åˆ†æè°ƒæ•´å†…å®¹å¹¶æ›´æ–°éœ€æ±‚
                updateRequirementsBasedOnAdjustment(adjustmentText);
                
                addMessage('ğŸ“ éœ€æ±‚è°ƒæ•´å®Œæˆï¼åŸºäºæ‚¨çš„è¦æ±‚ï¼Œæˆ‘å·²ç»æ›´æ–°äº†åˆ†æç»“æœï¼š');
                
                setTimeout(() => {
                    // é‡æ–°ç”Ÿæˆå¹¶æ˜¾ç¤ºåˆ†ææŠ¥å‘Š
                    showRequirementAnalysisReport();
                }, 1000);
            }, 1500);
        }

        // åŸºäºè°ƒæ•´å†…å®¹æ›´æ–°éœ€æ±‚
        function updateRequirementsBasedOnAdjustment(adjustmentText) {
            if (!AppState.detailedRequirements) {
                AppState.detailedRequirements = {};
            }
            
            const text = adjustmentText.toLowerCase();
            
            // åˆ†æå­¦å‘˜ç±»å‹è°ƒæ•´
            if (text.includes('æ–°å‘˜å·¥') || text.includes('æ–°å…¥èŒ') || text.includes('é›¶åŸºç¡€')) {
                AppState.detailedRequirements.learnerPersona = 'new-employee';
            } else if (text.includes('åˆçº§') || text.includes('1-3å¹´')) {
                AppState.detailedRequirements.learnerPersona = 'junior-employee';
            } else if (text.includes('ä¸­çº§') || text.includes('3-5å¹´')) {
                AppState.detailedRequirements.learnerPersona = 'mid-employee';
            } else if (text.includes('é«˜çº§') || text.includes('èµ„æ·±') || text.includes('5å¹´ä»¥ä¸Š')) {
                AppState.detailedRequirements.learnerPersona = 'senior-employee';
            } else if (text.includes('ç®¡ç†') || text.includes('é¢†å¯¼')) {
                AppState.detailedRequirements.learnerPersona = 'management';
            } else if (text.includes('ä¸“å®¶') || text.includes('æŠ€æœ¯ä¸“å®¶')) {
                AppState.detailedRequirements.learnerPersona = 'expert';
            }
            
            // åˆ†ææ—¶é•¿è°ƒæ•´
            if (text.includes('1-2å°æ—¶') || text.includes('1å°æ—¶') || text.includes('2å°æ—¶')) {
                AppState.detailedRequirements.duration = '1-2';
            } else if (text.includes('2-4å°æ—¶') || text.includes('3å°æ—¶') || text.includes('4å°æ—¶')) {
                AppState.detailedRequirements.duration = '2-4';
            } else if (text.includes('4-8å°æ—¶') || text.includes('6å°æ—¶') || text.includes('8å°æ—¶')) {
                AppState.detailedRequirements.duration = '4-8';
            } else if (text.includes('1å¤©') || text.includes('ä¸€å¤©')) {
                AppState.detailedRequirements.duration = '1-day';
            } else if (text.includes('2å¤©') || text.includes('ä¸¤å¤©')) {
                AppState.detailedRequirements.duration = '2-days';
            }
            
            // åˆ†ææ•™å­¦æ´»åŠ¨è°ƒæ•´
            if (!AppState.detailedRequirements.teachingActivities) {
                AppState.detailedRequirements.teachingActivities = {};
            }
            
            if (text.includes('å®æ“') || text.includes('åŠ¨æ‰‹') || text.includes('ç»ƒä¹ ')) {
                AppState.detailedRequirements.teachingActivities['hands-on-practice'] = true;
            }
            if (text.includes('æ¡ˆä¾‹') || text.includes('å®ä¾‹')) {
                AppState.detailedRequirements.teachingActivities['case-analysis'] = true;
            }
            if (text.includes('è®¨è®º') || text.includes('äº¤æµ')) {
                AppState.detailedRequirements.teachingActivities['group-discussion'] = true;
            }
            if (text.includes('è§’è‰²') || text.includes('æ¨¡æ‹Ÿ')) {
                AppState.detailedRequirements.teachingActivities['role-playing'] = true;
            }
            if (text.includes('äº’åŠ¨') || text.includes('è®²è§£')) {
                AppState.detailedRequirements.teachingActivities['interactive-lecture'] = true;
            }
            
            // è®°å½•åŸå§‹è°ƒæ•´æ–‡æœ¬
            AppState.detailedRequirements.adjustmentRequest = adjustmentText;
        }

        // å¼€å§‹æœ€ç»ˆè¯¾ç¨‹ç”Ÿæˆ
        function startFinalCourseGeneration() {
            addMessage('ç°åœ¨å¼€å§‹ä¸ºæ‚¨ç”Ÿæˆå®Œæ•´çš„è¯¾ç¨‹å†…å®¹ï¼');
            
            setTimeout(() => {
                addMessage('é­”æ³•æ­£åœ¨è¿›è¡Œä¸­...æˆ‘å°†æ ¹æ®æ‚¨ç¡®è®¤çš„å¤§çº²å’Œä¸Šä¼ çš„èµ„æ–™ï¼Œç”Ÿæˆä¸€é—¨ä¸“ä¸šå®Œæ•´çš„è¯¾ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦1-2åˆ†é’Ÿã€‚');
                
                elements.progressArea.classList.remove('hidden');
                AppState.currentStep = 5;
                startCourseGeneration();
            }, 1000);
        }

        // æ˜¾ç¤ºå¤§çº²é€‰æ‹©
        function showOutlineSelection() {
            let contextMessage = `æ ¹æ®æ‚¨"${AppState.courseTitle}"çš„ç›®æ ‡`;
            
            // æ·»åŠ è¯¦ç»†éœ€æ±‚ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
            if (AppState.detailedRequirements) {
                const req = AppState.detailedRequirements;
                let details = [];
                
                if (req.duration) details.push(`æ—¶é•¿ä¸º${getDurationDisplayText(req.duration)}`);
                if (req.chapterCount) details.push(`åŒ…å«${req.chapterCount}${isNaN(req.chapterCount) ? '' : 'ä¸ªç« èŠ‚'}`);
                if (req.difficulty) details.push(`é¢å‘${getDifficultyDisplayText(req.difficulty)}å­¦å‘˜`);
                
                if (details.length > 0) {
                    contextMessage += `ï¼Œä»¥åŠæ‚¨è¦æ±‚çš„${details.join('ã€')}`;
                }
            }
            
            if (AppState.uploadedFiles.length > 0) {
                contextMessage += `å’Œæ‚¨æä¾›çš„${AppState.uploadedFiles.length}ä¸ªä¸“ä¸šæ–‡ä»¶`;
            }
            
            addMessage(contextMessage + 'ï¼Œæˆ‘ä¸ºæ‚¨ç²¾å¿ƒç­–åˆ’äº†ä¸¤ç§ä¸åŒé£æ ¼çš„è¯¾ç¨‹å¤§çº²ã€‚è¿™äº›æ–¹æ¡ˆéƒ½ä¼šå……åˆ†èå…¥æ‚¨çš„è¯¦ç»†éœ€æ±‚ï¼š');
            
            setTimeout(() => {
                const outlineCard = addOutlineSelectionCard();
                AppState.currentStep = 3;
                
                // åˆå§‹åŒ–èŠå¤©å†…çš„å¤§çº²é€‰æ‹©åŠŸèƒ½
                initChatOutlineSelection(outlineCard);
            }, 1000);
        }

        // åˆå§‹åŒ–èŠå¤©å†…çš„å¤§çº²é€‰æ‹©
        function initChatOutlineSelection(cardElement) {
            if (!cardElement) return;
            
            // é€‰æ‹©æ–¹æ¡ˆæŒ‰é’®
            const selectButtons = cardElement.querySelectorAll('.outline-select-btn');
            selectButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedOption = button.dataset.option;
                    AppState.selectedOutline = selectedOption;
                    
                    // é«˜äº®é€‰ä¸­çš„å¡ç‰‡
                    const allCards = cardElement.querySelectorAll('.outline-option-chat');
                    allCards.forEach(card => {
                        card.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                        card.classList.remove('ring-2', 'ring-green-500', 'border-green-500');
                    });
                    
                    const selectedCard = button.closest('.outline-option-chat');
                    if (selectedOption === 'A') {
                        selectedCard.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                    } else {
                        selectedCard.classList.add('ring-2', 'ring-green-500', 'border-green-500');
                    }
                    
                    // è·³è½¬åˆ°è¯¾ç¨‹åˆ›å»ºé¡µé¢
                    setTimeout(() => {
                        const courseData = {
                            title: AppState.courseTitle,
                            outline: selectedOption,
                            files: AppState.uploadedFiles.map(f => f.name)
                        };
                        
                        // å°†æ•°æ®å­˜å‚¨åˆ°sessionStorage
                        sessionStorage.setItem('courseData', JSON.stringify(courseData));
                        
                        // è·³è½¬åˆ°æ–°é¡µé¢
                        window.location.href = 'course-creation.html';
                    }, 500);
                });
            });

            // é¢„è§ˆå¾®è°ƒæŒ‰é’®
            const previewButtons = cardElement.querySelectorAll('.outline-preview-btn');
            previewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const option = button.dataset.option;
                    showOutlineModal(option);
                });
            });

            // é‡æ–°ç”Ÿæˆæ–¹æ¡ˆæŒ‰é’®
            const regenerateButton = cardElement.querySelector('#regenerateOutlines');
            if (regenerateButton) {
                regenerateButton.addEventListener('click', () => {
                    regenerateOutlineOptions(cardElement);
                });
            }
        }

        // é‡æ–°ç”Ÿæˆå¤§çº²æ–¹æ¡ˆ
        function regenerateOutlineOptions(cardElement) {
            const regenerateButton = cardElement.querySelector('#regenerateOutlines');
            const originalText = regenerateButton.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            regenerateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';
            regenerateButton.disabled = true;
            regenerateButton.className = regenerateButton.className.replace('hover:text-blue-600 dark:hover:text-blue-400 hover:border-blue-400 dark:hover:border-blue-500', '');
            
            // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
            setTimeout(() => {
                // æ·»åŠ AIæ¶ˆæ¯æç¤ºæ­£åœ¨é‡æ–°ç”Ÿæˆ
                addMessage('å¥½çš„ï¼Œè®©æˆ‘ä¸ºæ‚¨é‡æ–°ç”Ÿæˆå…¶ä»–çš„è¯¾ç¨‹å¤§çº²æ–¹æ¡ˆ...');
                
                setTimeout(() => {
                    // ç”Ÿæˆæ–°çš„å¤§çº²é€‰æ‹©å¡ç‰‡
                    const newOutlineCard = generateAlternativeOutlines();
                    const newCardElement = addMessage(newOutlineCard, false, true, true);
                    
                    // éšè—åŸå¡ç‰‡
                    cardElement.style.opacity = '0.3';
                    cardElement.style.pointerEvents = 'none';
                    
                    // åˆå§‹åŒ–æ–°å¡ç‰‡çš„äº‹ä»¶
                    initChatOutlineSelection(newCardElement);
                    
                    addMessage('æ–°çš„æ–¹æ¡ˆå·²ç”Ÿæˆï¼æ‚¨å¯ä»¥ä»è¿™äº›å…¨æ–°çš„è§’åº¦æ¥è®¾è®¡æ‚¨çš„è¯¾ç¨‹ã€‚');
                }, 1500);
            }, 800);
        }

        // ç”Ÿæˆå¤‡é€‰çš„å¤§çº²æ–¹æ¡ˆ
        function generateAlternativeOutlines() {
            const alternativeOutlines = `
                <div class="p-6">
                    <div class="text-gray-800 dark:text-gray-200 leading-relaxed mb-6 text-center">
                        ğŸ¯ ä¸ºæ‚¨é‡æ–°è®¾è®¡äº†ä¸¤ç§å…¨æ–°çš„è¯¾ç¨‹å¤§çº²ç»“æ„ï¼š
                    </div>
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- æ–¹æ¡ˆC -->
                        <div class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-4 hover:border-purple-400 dark:hover:border-purple-500 hover:shadow-md transition-all" data-option="C">
                            <div class="flex items-start space-x-3 mb-3">
                                <div class="w-6 h-6 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-layers text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">æ–¹æ¡ˆCï¼šåˆ†å±‚é€’è¿›å‹å¤§çº²</h4>
                                    <p class="text-xs text-purple-500 dark:text-purple-400">å¾ªåºæ¸è¿›</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-xs text-gray-600 dark:text-gray-300 ml-9">
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">åŸºç¡€å±‚ï¼šCRMè®¤çŸ¥å»ºç«‹</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>ä»€ä¹ˆæ˜¯CRMåŠå…¶ä»·å€¼</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æˆ‘ä»¬çš„CRMç³»ç»Ÿä»‹ç»</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">åº”ç”¨å±‚ï¼šæ ¸å¿ƒåŠŸèƒ½æŒæ¡</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>å®¢æˆ·ç®¡ç†æ ¸å¿ƒæ“ä½œ</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>é”€å”®æµç¨‹ç®¡ç†æŠ€å·§</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">æå‡å±‚ï¼šé«˜æ•ˆå·¥ä½œæ–¹æ³•</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>è‡ªåŠ¨åŒ–å·¥å…·çš„ä½¿ç”¨</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æ‰¹é‡æ“ä½œä¸å¿«æ·æŠ€å·§</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-purple-400 rounded-full"></div>
                                        <span class="font-medium">ç²¾é€šå±‚ï¼šæ•°æ®é©±åŠ¨å†³ç­–</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æŠ¥è¡¨åˆ†æä¸ä¸šç»©æ´å¯Ÿ</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æŒç»­ä¼˜åŒ–æ”¹è¿›ç­–ç•¥</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button class="outline-select-btn px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg font-medium transition-colors" data-option="C">
                                    é€‰æ‹©æ­¤æ–¹æ¡ˆ
                                </button>
                                <button class="outline-preview-btn px-3 py-1.5 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs rounded-lg font-medium transition-colors" data-option="C">
                                    <i class="fas fa-eye mr-1"></i>é¢„è§ˆå¾®è°ƒ
                                </button>
                            </div>
                        </div>

                        <!-- æ–¹æ¡ˆD -->
                        <div class="outline-option-chat bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-4 hover:border-orange-400 dark:hover:border-orange-500 hover:shadow-md transition-all" data-option="D">
                            <div class="flex items-start space-x-3 mb-3">
                                <div class="w-6 h-6 bg-orange-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-lightbulb text-white text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 dark:text-white text-sm">æ–¹æ¡ˆDï¼šåœºæ™¯åŒ–åº”ç”¨å¤§çº²</h4>
                                    <p class="text-xs text-orange-500 dark:text-orange-400">æƒ…å¢ƒæ•™å­¦</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-xs text-gray-600 dark:text-gray-300 ml-9">
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">åœºæ™¯ä¸€ï¼šæ–°å®¢æˆ·å¼€å‘</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æ½œåœ¨å®¢æˆ·è¯†åˆ«ä¸å½•å…¥</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>åˆæ¬¡æ¥è§¦ä¿¡æ¯è®°å½•</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">åœºæ™¯äºŒï¼šå®¢æˆ·è·Ÿè¿›ç»´æŠ¤</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>è·Ÿè¿›ä»»åŠ¡åˆ¶å®šä¸æ‰§è¡Œ</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>å®¢æˆ·äº’åŠ¨å†å²ç®¡ç†</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">åœºæ™¯ä¸‰ï¼šé”€å”®æœºä¼šè½¬åŒ–</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>å•†æœºè¯†åˆ«ä¸è¯„ä¼°</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>æˆäº¤è¿‡ç¨‹å…¨ç¨‹è¿½è¸ª</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-1 h-1 bg-orange-400 rounded-full"></div>
                                        <span class="font-medium">åœºæ™¯å››ï¼šå®¢æˆ·ä»·å€¼æŒ–æ˜</span>
                                    </div>
                                    <div class="ml-3 space-y-0.5 text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>å®¢æˆ·ä»·å€¼åˆ†æè¯„ä¼°</span>
                                        </div>
                                        <div class="flex items-center space-x-1.5">
                                            <div class="w-0.5 h-0.5 bg-gray-400 rounded-full"></div>
                                            <span>äº¤å‰é”€å”®æœºä¼šå‘ç°</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <button class="outline-select-btn px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-xs rounded-lg font-medium transition-colors" data-option="D">
                                    é€‰æ‹©æ­¤æ–¹æ¡ˆ
                                </button>
                                <button class="outline-preview-btn px-3 py-1.5 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 text-xs rounded-lg font-medium transition-colors" data-option="D">
                                    <i class="fas fa-eye mr-1"></i>é¢„è§ˆå¾®è°ƒ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é‡æ–°ç”ŸæˆæŒ‰é’®åŒºåŸŸ -->
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600 text-center">
                        <button id="regenerateOutlines" class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 rounded-lg transition-colors font-medium text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>æ¢ä¸ªæ–¹æ¡ˆ
                        </button>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">ä»ç„¶ä¸æ»¡æ„ï¼Ÿç»§ç»­ç”Ÿæˆæ›´å¤šé€‰é¡¹</p>
                    </div>
                </div>
            `;
            
            return alternativeOutlines;
        }

        // æ˜¾ç¤ºè¯¦ç»†å¤§çº²
        function showDetailOutline(option) {
            addMessage(`å¾ˆæ£’çš„é€‰æ‹©ï¼"${option === 'A' ? 'æ ‡å‡†æµç¨‹å‹' : 'åŸºäºä»»åŠ¡çš„å®è·µ'}"å¤§çº²éå¸¸é€‚åˆä½“ç³»åŒ–çš„å­¦ä¹ ã€‚`);
            
            setTimeout(() => {
                addMessage('è¿™æ˜¯è¯¦ç»†çš„ç« èŠ‚å®‰æ’ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹ç›´æ¥æ‹–æ‹½æ’åºæˆ–ä¿®æ”¹æ ‡é¢˜ã€‚ç¡®è®¤æ— è¯¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å¡«å……å†…å®¹äº†ã€‚');
                
                elements.detailOutlineArea.classList.remove('hidden');
                generateDetailOutline(option);
            }, 1000);
        }

        // ç”Ÿæˆè¯¦ç»†å¤§çº²
        function generateDetailOutline(option) {
            const outlines = {
                'A': [
                    { title: 'CRMç³»ç»Ÿæ ¸å¿ƒç†å¿µ', subtitle: 'äº†è§£CRMçš„åŸºæœ¬æ¦‚å¿µå’Œä»·å€¼' },
                    { title: 'å®¢æˆ·ä¿¡æ¯å½•å…¥ä¸ç®¡ç†', subtitle: 'å­¦ä¹ å®¢æˆ·æ•°æ®çš„è§„èŒƒåŒ–ç®¡ç†' },
                    { title: 'é”€å”®çº¿ç´¢è·Ÿè¿›ä¸è½¬åŒ–', subtitle: 'æŒæ¡çº¿ç´¢ç®¡ç†å’Œè½¬åŒ–æŠ€å·§' },
                    { title: 'é”€å”®æ•°æ®åˆ†æä¸æŠ¥è¡¨', subtitle: 'åˆ©ç”¨æ•°æ®ä¼˜åŒ–é”€å”®ç­–ç•¥' }
                ],
                'B': [
                    { title: 'å½•å…¥ä½ çš„ç¬¬ä¸€ä¸ªå®¢æˆ·', subtitle: 'å®æ“ï¼šå®¢æˆ·ä¿¡æ¯å½•å…¥æµç¨‹' },
                    { title: 'åˆ›å»ºå¹¶è·Ÿè¿›é”€å”®çº¿ç´¢', subtitle: 'å®æ“ï¼šçº¿ç´¢åˆ›å»ºå’ŒçŠ¶æ€ç®¡ç†' },
                    { title: 'å®Œæˆé”€å”®è®°å½•', subtitle: 'å®æ“ï¼šé”€å”®æµç¨‹è®°å½•å’Œæ›´æ–°' },
                    { title: 'æŸ¥çœ‹å’Œåˆ†æé”€å”®æŠ¥è¡¨', subtitle: 'å®æ“ï¼šæ•°æ®åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆ' }
                ],
                'C': [
                    { title: 'CRMè®¤çŸ¥å»ºç«‹', subtitle: 'åŸºç¡€å±‚ï¼šå»ºç«‹æ­£ç¡®çš„CRMç†å¿µ' },
                    { title: 'æ ¸å¿ƒåŠŸèƒ½æŒæ¡', subtitle: 'åº”ç”¨å±‚ï¼šæŒæ¡æ ¸å¿ƒæ“ä½œæŠ€èƒ½' },
                    { title: 'é«˜æ•ˆå·¥ä½œæ–¹æ³•', subtitle: 'æå‡å±‚ï¼šå­¦ä¹ é«˜æ•ˆä½¿ç”¨æŠ€å·§' },
                    { title: 'æ•°æ®é©±åŠ¨å†³ç­–', subtitle: 'ç²¾é€šå±‚ï¼šåŸºäºæ•°æ®ä¼˜åŒ–å†³ç­–' }
                ],
                'D': [
                    { title: 'æ–°å®¢æˆ·å¼€å‘', subtitle: 'åœºæ™¯ä¸€ï¼šå®Œæ•´çš„å®¢æˆ·å¼€å‘æµç¨‹' },
                    { title: 'å®¢æˆ·è·Ÿè¿›ç»´æŠ¤', subtitle: 'åœºæ™¯äºŒï¼šç³»ç»ŸåŒ–çš„å®¢æˆ·ç»´æŠ¤' },
                    { title: 'é”€å”®æœºä¼šè½¬åŒ–', subtitle: 'åœºæ™¯ä¸‰ï¼šå•†æœºç®¡ç†ä¸è½¬åŒ–' },
                    { title: 'å®¢æˆ·ä»·å€¼æŒ–æ˜', subtitle: 'åœºæ™¯å››ï¼šæ·±åº¦æŒ–æ˜å®¢æˆ·ä»·å€¼' }
                ]
            };
            
            const selectedOutline = outlines[option];
            elements.outlineEditor.innerHTML = '';
            
            selectedOutline.forEach((item, index) => {
                const outlineItem = document.createElement('div');
                outlineItem.className = 'outline-item bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 cursor-move hover:shadow-md transition-shadow';
                outlineItem.draggable = true;
                outlineItem.dataset.index = index;
                
                outlineItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 dark:text-blue-400 font-semibold">${index + 1}</span>
                        </div>
                        <div class="flex-1">
                            <input type="text" value="${item.title}" class="w-full font-semibold text-gray-900 dark:text-white bg-transparent border-none focus:ring-0 p-0">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${item.subtitle}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                            <button class="text-gray-400 hover:text-red-500 transition-colors" onclick="removeOutlineItem(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                elements.outlineEditor.appendChild(outlineItem);
            });
            
            initDragAndDrop();
        }

        // åˆå§‹åŒ–æ‹–æ‹½æ’åº
        function initDragAndDrop() {
            const outlineItems = elements.outlineEditor.querySelectorAll('.outline-item');
            
            outlineItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                    item.classList.add('opacity-50');
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = e.dataTransfer.getData('text/plain');
                    const targetIndex = item.dataset.index;
                    
                    if (draggedIndex !== targetIndex) {
                        reorderOutlineItems(draggedIndex, targetIndex);
                    }
                });
            });
        }

        // é‡æ–°æ’åºå¤§çº²é¡¹ç›®
        function reorderOutlineItems(fromIndex, toIndex) {
            const items = Array.from(elements.outlineEditor.children);
            const draggedItem = items[fromIndex];
            const targetItem = items[toIndex];
            
            if (fromIndex < toIndex) {
                targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedItem, targetItem);
            }
            
            // æ›´æ–°ç´¢å¼•
            Array.from(elements.outlineEditor.children).forEach((item, index) => {
                item.dataset.index = index;
                const numberSpan = item.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
            });
        }

        // ç¡®è®¤å¤§çº²
        function confirmOutline() {
            addMessage('æ”¶åˆ°ï¼å¤§çº²å·²æœ€ç»ˆç¡®è®¤ã€‚');
            
            setTimeout(() => {
                addMessage('ç°åœ¨ï¼Œé­”æ³•å³å°†å¼€å§‹ï¼æˆ‘å°†æ ¹æ®è¿™ä»½å¤§çº²ï¼Œä¸ºæ‚¨ç”Ÿæˆä¸€é—¨å®Œæ•´çš„è¯¾ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦1-2åˆ†é’Ÿï¼Œæˆ‘ä¼šå®æ—¶å‘æ‚¨"ç›´æ’­"æˆ‘çš„åˆ›ä½œè¿›åº¦ã€‚');
                
                elements.progressArea.classList.remove('hidden');
                AppState.currentStep = 4;
                startCourseGeneration();
            }, 1000);
        }

        // å¼€å§‹è¯¾ç¨‹ç”Ÿæˆ
        function startCourseGeneration() {
            const progressSteps = [
                { text: 'âœ¨ æ­£åœ¨åˆ†æè¯¾ç¨‹ç»“æ„...', progress: 20 },
                { text: 'âœ¨ æ­£åœ¨ç”Ÿæˆ"ç¬¬ä¸€ç« "å†…å®¹...', progress: 40 },
                { text: 'âœ¨ æ­£åœ¨ä¸º"ç¬¬äºŒç« "è®¾è®¡éšå ‚ç»ƒä¹ é¢˜...', progress: 60 },
                { text: 'âœ¨ æ­£åœ¨å¯»æ‰¾åˆé€‚çš„é…å›¾...', progress: 80 },
                { text: 'âœ¨ æ­£åœ¨å®Œå–„è¯¾ç¨‹ç»†èŠ‚...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const updateProgress = () => {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    elements.progressText.textContent = step.text;
                    elements.progressBar.style.width = step.progress + '%';
                    currentStep++;
                    
                    setTimeout(updateProgress, 1500);
                } else {
                    setTimeout(() => {
                        showCoursePreview();
                    }, 1000);
                }
            };
            
            updateProgress();
        }

        // æ˜¾ç¤ºè¯¾ç¨‹é¢„è§ˆ
        function showCoursePreview() {
            addMessage('å®ï¼æ‚¨çš„ã€Š' + AppState.courseTitle + 'ã€‹è¯¾ç¨‹åˆç¨¿å·²å…¨éƒ¨ç”Ÿæˆå®Œæ¯•ï¼');
            
            setTimeout(() => {
                addMessage('æ‚¨ç°åœ¨å¯ä»¥é¢„è§ˆå’Œç¼–è¾‘æ¯ä¸€ä¸ªç»†èŠ‚ã€‚');
                elements.previewArea.classList.remove('hidden');
                elements.aiAssistant.classList.remove('hidden');
            }, 1000);
        }

        // åˆå§‹åŒ–é¢„è§ˆåŒºåŸŸæŒ‰é’®
        function initPreviewButtons() {
            document.getElementById('previewCourse').addEventListener('click', () => {
                alert('è¯¾ç¨‹é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...');
            });
            
            document.getElementById('editCourse').addEventListener('click', () => {
                alert('è¯¾ç¨‹ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
            });
            
            document.getElementById('publishCourse').addEventListener('click', () => {
                alert('ğŸ‰ è¯¾ç¨‹å‘å¸ƒæˆåŠŸï¼æ‚¨çš„è¯¾ç¨‹å·²ç»å¯ä»¥åˆ†äº«ç»™å›¢é˜Ÿæˆå‘˜äº†ã€‚');
            });
        }

        // æ¶ˆæ¯è¾“å…¥è‡ªé€‚åº”é«˜åº¦
        function initMessageInput() {
            elements.messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            elements.messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleUserInput();
                }
            });
        }

        // åˆå§‹åŒ–ä¸»é¢˜å»ºè®®
        function initTopicSuggestions() {
            // ä¸»é¢˜å»ºè®®ç‚¹å‡»äº‹ä»¶
            const topicSuggestions = document.querySelectorAll('.topic-suggestion');
            topicSuggestions.forEach(button => {
                button.addEventListener('click', () => {
                    const topic = button.dataset.topic;
                    elements.messageInput.value = topic;
                    
                    // æ·»åŠ é€‰ä¸­æ•ˆæœ
                    topicSuggestions.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'dark:border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/30');
                    });
                    button.classList.add('border-blue-500', 'dark:border-blue-400', 'bg-blue-50', 'dark:bg-blue-900/30');
                    
                    // è‡ªåŠ¨æäº¤
                    setTimeout(() => {
                        handleUserInput();
                    }, 300);
                });
            });

            // æ›´å¤šä¸»é¢˜æŒ‰é’®
            const moreTopicsBtn = document.getElementById('moreTopics');
            if (moreTopicsBtn) {
                moreTopicsBtn.addEventListener('click', () => {
                    showMoreTopics();
                });
            }
        }

        // æ˜¾ç¤ºæ›´å¤šä¸»é¢˜é€‰é¡¹
        function showMoreTopics() {
            const moreTopics = [
                { icon: 'fas fa-graduation-cap', color: 'text-blue-500', text: 'å‘˜å·¥å…¥èŒåŸ¹è®­ä½“ç³»' },
                { icon: 'fas fa-language', color: 'text-green-500', text: 'è·¨æ–‡åŒ–æ²Ÿé€šä¸åˆä½œ' },
                { icon: 'fas fa-brain', color: 'text-purple-500', text: 'åˆ›æ–°æ€ç»´ä¸é—®é¢˜è§£å†³' },
                { icon: 'fas fa-heart', color: 'text-red-500', text: 'å¿ƒç†å¥åº·ä¸å‹åŠ›ç®¡ç†' },
                { icon: 'fas fa-laptop', color: 'text-indigo-500', text: 'åŠå…¬è½¯ä»¶é«˜æ•ˆä½¿ç”¨' },
                { icon: 'fas fa-microscope', color: 'text-teal-500', text: 'è´¨é‡æ§åˆ¶ä¸å·¥è‰ºæ”¹è¿›' },
                { icon: 'fas fa-leaf', color: 'text-green-600', text: 'å¯æŒç»­å‘å±•ä¸ç¯ä¿æ„è¯†' },
                { icon: 'fas fa-rocket', color: 'text-orange-500', text: 'èŒä¸šå‘å±•è§„åˆ’æŒ‡å¯¼' }
            ];

            const moreTopicsHtml = `
                <div class="p-4">
                    <p class="text-gray-800 dark:text-gray-200 leading-relaxed mb-4">
                        æ›´å¤šè¯¾ç¨‹ä¸»é¢˜æ¨èï¼š
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${moreTopics.map(topic => `
                            <button class="topic-suggestion text-left p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 hover:shadow-md transition-all text-sm" data-topic="${topic.text}">
                                <i class="${topic.icon} ${topic.color} mr-2"></i>${topic.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage(moreTopicsHtml, false, true, true);
            
            setTimeout(() => {
                initTopicSuggestions();
            }, 100);
        }

        // æ˜¾ç¤ºå¤§çº²é¢„è§ˆæ¨¡æ€çª—å£
        function showOutlineModal(option) {
            const modal = document.getElementById('outlineModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalOutlineContent');
            
            // è®¾ç½®æ¨¡æ€çª—å£æ ·å¼å’Œæ ‡é¢˜
            if (option === 'A') {
                modalIcon.className = 'w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-list text-white text-sm"></i>';
                modalTitle.textContent = 'æ–¹æ¡ˆAï¼šæ ‡å‡†æµç¨‹å‹å¤§çº²';
            } else if (option === 'B') {
                modalIcon.className = 'w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-tasks text-white text-sm"></i>';
                modalTitle.textContent = 'æ–¹æ¡ˆBï¼šåŸºäºä»»åŠ¡çš„å®è·µå¤§çº²';
            } else if (option === 'C') {
                modalIcon.className = 'w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-layers text-white text-sm"></i>';
                modalTitle.textContent = 'æ–¹æ¡ˆCï¼šåˆ†å±‚é€’è¿›å‹å¤§çº²';
            } else if (option === 'D') {
                modalIcon.className = 'w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center';
                modalIcon.innerHTML = '<i class="fas fa-lightbulb text-white text-sm"></i>';
                modalTitle.textContent = 'æ–¹æ¡ˆDï¼šåœºæ™¯åŒ–åº”ç”¨å¤§çº²';
            }
            
            // ç”Ÿæˆè¯¦ç»†çš„å¯ç¼–è¾‘å¤§çº²
            generateEditableOutline(option, modalContent);
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // ç”Ÿæˆå¯ç¼–è¾‘çš„å¤§çº²å†…å®¹
        function generateEditableOutline(option, container) {
            const outlines = {
                'A': [
                    {
                        title: 'CRMç³»ç»Ÿæ ¸å¿ƒç†å¿µ',
                        subtitle: 'äº†è§£CRMçš„åŸºæœ¬æ¦‚å¿µå’Œä»·å€¼',
                        sections: ['CRMåŸºæœ¬æ¦‚å¿µä¸ä»·å€¼', 'ç³»ç»Ÿæ¶æ„ä¸æ¨¡å—ä»‹ç»']
                    },
                    {
                        title: 'å®¢æˆ·ä¿¡æ¯å½•å…¥ä¸ç®¡ç†',
                        subtitle: 'å­¦ä¹ å®¢æˆ·æ•°æ®çš„è§„èŒƒåŒ–ç®¡ç†',
                        sections: ['å®¢æˆ·ä¿¡æ¯æ ‡å‡†åŒ–å½•å…¥', 'å®¢æˆ·åˆ†ç±»ä¸æ ‡ç­¾ç®¡ç†']
                    },
                    {
                        title: 'é”€å”®çº¿ç´¢è·Ÿè¿›ä¸è½¬åŒ–',
                        subtitle: 'æŒæ¡çº¿ç´¢ç®¡ç†å’Œè½¬åŒ–æŠ€å·§',
                        sections: ['çº¿ç´¢åˆ›å»ºä¸çŠ¶æ€ç®¡ç†', 'è·Ÿè¿›è®°å½•ä¸è½¬åŒ–æŠ€å·§']
                    },
                    {
                        title: 'é”€å”®æ•°æ®åˆ†æä¸æŠ¥è¡¨',
                        subtitle: 'åˆ©ç”¨æ•°æ®ä¼˜åŒ–é”€å”®ç­–ç•¥',
                        sections: ['æ•°æ®ç»Ÿè®¡ä¸å¯è§†åŒ–', 'æŠ¥è¡¨ç”Ÿæˆä¸åˆ†æåº”ç”¨']
                    }
                ],
                'B': [
                    {
                        title: 'å½•å…¥ä½ çš„ç¬¬ä¸€ä¸ªå®¢æˆ·',
                        subtitle: 'å®æ“ï¼šå®¢æˆ·ä¿¡æ¯å½•å…¥æµç¨‹',
                        sections: ['å®¢æˆ·ä¿¡æ¯æ”¶é›†å‡†å¤‡', 'ç³»ç»Ÿå½•å…¥æ“ä½œå®è·µ']
                    },
                    {
                        title: 'åˆ›å»ºå¹¶è·Ÿè¿›é”€å”®çº¿ç´¢',
                        subtitle: 'å®æ“ï¼šçº¿ç´¢åˆ›å»ºå’ŒçŠ¶æ€ç®¡ç†',
                        sections: ['çº¿ç´¢åˆ›å»ºä¸åˆ†é…', 'è·Ÿè¿›è®¡åˆ’åˆ¶å®šä¸æ‰§è¡Œ']
                    },
                    {
                        title: 'å®Œæˆé”€å”®è®°å½•',
                        subtitle: 'å®æ“ï¼šé”€å”®æµç¨‹è®°å½•å’Œæ›´æ–°',
                        sections: ['é”€å”®æœºä¼šè®°å½•', 'æˆäº¤æµç¨‹ç®¡ç†']
                    },
                    {
                        title: 'æŸ¥çœ‹å’Œåˆ†æé”€å”®æŠ¥è¡¨',
                        subtitle: 'å®æ“ï¼šæ•°æ®åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆ',
                        sections: ['æŠ¥è¡¨æ•°æ®è§£è¯»', 'ä¸šç»©åˆ†æä¸æ”¹è¿›å»ºè®®']
                    }
                ],
                'C': [
                    {
                        title: 'CRMè®¤çŸ¥å»ºç«‹',
                        subtitle: 'åŸºç¡€å±‚ï¼šå»ºç«‹æ­£ç¡®çš„CRMç†å¿µ',
                        sections: ['ä»€ä¹ˆæ˜¯CRMåŠå…¶ä»·å€¼', 'æˆ‘ä»¬çš„CRMç³»ç»Ÿä»‹ç»']
                    },
                    {
                        title: 'æ ¸å¿ƒåŠŸèƒ½æŒæ¡',
                        subtitle: 'åº”ç”¨å±‚ï¼šæŒæ¡æ ¸å¿ƒæ“ä½œæŠ€èƒ½',
                        sections: ['å®¢æˆ·ç®¡ç†æ ¸å¿ƒæ“ä½œ', 'é”€å”®æµç¨‹ç®¡ç†æŠ€å·§']
                    },
                    {
                        title: 'é«˜æ•ˆå·¥ä½œæ–¹æ³•',
                        subtitle: 'æå‡å±‚ï¼šå­¦ä¹ é«˜æ•ˆä½¿ç”¨æŠ€å·§',
                        sections: ['è‡ªåŠ¨åŒ–å·¥å…·çš„ä½¿ç”¨', 'æ‰¹é‡æ“ä½œä¸å¿«æ·æŠ€å·§']
                    },
                    {
                        title: 'æ•°æ®é©±åŠ¨å†³ç­–',
                        subtitle: 'ç²¾é€šå±‚ï¼šåŸºäºæ•°æ®ä¼˜åŒ–å†³ç­–',
                        sections: ['æŠ¥è¡¨åˆ†æä¸ä¸šç»©æ´å¯Ÿ', 'æŒç»­ä¼˜åŒ–æ”¹è¿›ç­–ç•¥']
                    }
                ],
                'D': [
                    {
                        title: 'æ–°å®¢æˆ·å¼€å‘',
                        subtitle: 'åœºæ™¯ä¸€ï¼šå®Œæ•´çš„å®¢æˆ·å¼€å‘æµç¨‹',
                        sections: ['æ½œåœ¨å®¢æˆ·è¯†åˆ«ä¸å½•å…¥', 'åˆæ¬¡æ¥è§¦ä¿¡æ¯è®°å½•']
                    },
                    {
                        title: 'å®¢æˆ·è·Ÿè¿›ç»´æŠ¤',
                        subtitle: 'åœºæ™¯äºŒï¼šç³»ç»ŸåŒ–çš„å®¢æˆ·ç»´æŠ¤',
                        sections: ['è·Ÿè¿›ä»»åŠ¡åˆ¶å®šä¸æ‰§è¡Œ', 'å®¢æˆ·äº’åŠ¨å†å²ç®¡ç†']
                    },
                    {
                        title: 'é”€å”®æœºä¼šè½¬åŒ–',
                        subtitle: 'åœºæ™¯ä¸‰ï¼šå•†æœºç®¡ç†ä¸è½¬åŒ–',
                        sections: ['å•†æœºè¯†åˆ«ä¸è¯„ä¼°', 'æˆäº¤è¿‡ç¨‹å…¨ç¨‹è¿½è¸ª']
                    },
                    {
                        title: 'å®¢æˆ·ä»·å€¼æŒ–æ˜',
                        subtitle: 'åœºæ™¯å››ï¼šæ·±åº¦æŒ–æ˜å®¢æˆ·ä»·å€¼',
                        sections: ['å®¢æˆ·ä»·å€¼åˆ†æè¯„ä¼°', 'äº¤å‰é”€å”®æœºä¼šå‘ç°']
                    }
                ]
            };

            const selectedOutline = outlines[option];
            container.innerHTML = '';

            selectedOutline.forEach((chapter, chapterIndex) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-item bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 p-6 shadow-sm hover:shadow-md transition-all duration-200 group';
                chapterDiv.draggable = true;
                chapterDiv.dataset.index = chapterIndex;

                chapterDiv.innerHTML = `
                    <div class="flex items-start space-x-4 mb-4">
                        <div class="w-10 h-10 bg-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-100 dark:bg-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-900/30 rounded-lg flex items-center justify-center flex-shrink-0 transition-colors">
                            <span class="text-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-600 dark:text-${option === 'A' ? 'blue' : option === 'B' ? 'green' : option === 'C' ? 'purple' : 'orange'}-400 font-semibold text-base">${chapterIndex + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <input type="text" value="${chapter.title}" class="chapter-title w-full font-semibold text-gray-900 dark:text-white bg-transparent border-none focus:ring-0 p-0 text-lg mb-2 focus:outline-none">
                            <input type="text" value="${chapter.subtitle}" class="chapter-subtitle w-full text-base text-gray-600 dark:text-gray-400 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                        </div>
                        <div class="flex items-center space-x-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="add-section-btn p-2 text-gray-400 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/30 rounded-lg transition-all" title="æ·»åŠ å°èŠ‚">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                            <button class="delete-chapter-btn p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-all" title="åˆ é™¤ç« èŠ‚">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                            <div class="p-2 text-gray-400 cursor-move hover:text-gray-600 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" title="æ‹–æ‹½æ’åº">
                                <i class="fas fa-grip-vertical text-sm"></i>
                            </div>
                        </div>
                    </div>
                    <div class="sections-container ml-14 space-y-3">
                        ${chapter.sections.map((section, sectionIndex) => `
                            <div class="section-item flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-all group">
                                <div class="w-8 h-8 bg-gray-200 dark:bg-gray-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <span class="text-gray-600 dark:text-gray-300 text-sm font-medium">${chapterIndex + 1}.${sectionIndex + 1}</span>
                                </div>
                                <input type="text" value="${section}" class="section-title flex-1 text-base text-gray-700 dark:text-gray-200 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                                <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover:opacity-100" title="åˆ é™¤å°èŠ‚">
                                    <i class="fas fa-times text-sm"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(chapterDiv);
            });

            // åˆå§‹åŒ–ç¼–è¾‘åŠŸèƒ½
            initModalOutlineEditor(container, option);
            
            // åˆå§‹åŒ–æ¨¡æ¿æŒ‰é’®äº‹ä»¶ï¼ˆéœ€è¦å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå…ƒç´ å·²åŠ è½½ï¼‰
            setTimeout(() => {
                initTemplateButtons();
            }, 100);
        }

        // åˆå§‹åŒ–æ¨¡æ¿æŒ‰é’®äº‹ä»¶
        function initTemplateButtons() {
            const templateButtons = document.querySelectorAll('.template-btn');
            templateButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const templateType = btn.dataset.template;
                    applyTemplate(templateType);
                    
                    // æ·»åŠ è§†è§‰åé¦ˆ
                    btn.style.background = '#dbeafe';
                    setTimeout(() => {
                        btn.style.background = '';
                    }, 200);
                });
            });
        }

        // åˆå§‹åŒ–æ¨¡æ€çª—å£çš„ç¼–è¾‘åŠŸèƒ½
        function initModalOutlineEditor(container, option) {
            // æ·»åŠ å°èŠ‚æŒ‰é’®
            container.querySelectorAll('.add-section-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const chapterItem = e.target.closest('.chapter-item');
                    const sectionsContainer = chapterItem.querySelector('.sections-container');
                    const chapterIndex = parseInt(chapterItem.dataset.index);
                    const sectionCount = sectionsContainer.children.length;
                    
                    const newSection = document.createElement('div');
                    newSection.className = 'section-item flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-all group';
                    newSection.innerHTML = `
                        <div class="w-8 h-8 bg-gray-200 dark:bg-gray-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-medium">${chapterIndex + 1}.${sectionCount + 1}</span>
                        </div>
                        <input type="text" value="æ–°å°èŠ‚" class="section-title flex-1 text-base text-gray-700 dark:text-gray-200 bg-transparent border-none focus:ring-0 p-0 focus:outline-none">
                        <button class="delete-section-btn p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-all opacity-0 group-hover:opacity-100" title="åˆ é™¤å°èŠ‚">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    `;
                    
                    sectionsContainer.appendChild(newSection);
                    initSectionDeleteButton(newSection.querySelector('.delete-section-btn'));
                });
            });

            // åˆ é™¤ç« èŠ‚æŒ‰é’®
            container.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (container.children.length > 1) {
                        e.target.closest('.chapter-item').remove();
                        updateChapterNumbers(container);
                    } else {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç« èŠ‚');
                    }
                });
            });

            // åˆ é™¤å°èŠ‚æŒ‰é’®
            container.querySelectorAll('.delete-section-btn').forEach(btn => {
                initSectionDeleteButton(btn);
            });
        }

        function initSectionDeleteButton(btn) {
            btn.addEventListener('click', (e) => {
                const sectionItem = e.target.closest('.section-item');
                const sectionsContainer = sectionItem.parentElement;
                
                if (sectionsContainer.children.length > 1) {
                    sectionItem.remove();
                    updateSectionNumbers(sectionsContainer);
                } else {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå°èŠ‚');
                }
            });
        }

        function updateChapterNumbers(container) {
            Array.from(container.children).forEach((chapter, index) => {
                chapter.dataset.index = index;
                const numberSpan = chapter.querySelector('.w-8 span');
                numberSpan.textContent = index + 1;
                updateSectionNumbers(chapter.querySelector('.sections-container'));
            });
        }

        function updateSectionNumbers(sectionsContainer) {
            const chapterIndex = parseInt(sectionsContainer.closest('.chapter-item').dataset.index);
            Array.from(sectionsContainer.children).forEach((section, index) => {
                const numberSpan = section.querySelector('span');
                numberSpan.textContent = `${chapterIndex + 1}.${index + 1}`;
            });
        }

        // åˆå§‹åŒ–æ¨¡æ€çª—å£äº‹ä»¶
        function initModalEvents() {
            const modal = document.getElementById('outlineModal');
            const closeBtn = document.getElementById('closeModal');
            const confirmBtn = document.getElementById('confirmModalOutline');
            const resetBtn = document.getElementById('resetOutline');

            // å…³é—­æ¨¡æ€çª—å£
            const closeModal = () => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            };

            closeBtn.addEventListener('click', closeModal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // ç¡®è®¤é€‰æ‹©
            confirmBtn.addEventListener('click', () => {
                // è·å–ç¼–è¾‘åçš„å¤§çº²æ•°æ®å’Œé«˜çº§è®¾ç½®
                const editedOutline = getEditedOutlineData();
                const advancedSettings = getAdvancedSettings();
                
                // æ˜¾ç¤ºä¿å­˜æç¤º
                showSaveConfirmation(editedOutline, advancedSettings);
            });

            // é‡ç½®å¤§çº²
            resetBtn.addEventListener('click', () => {
                const titleText = modal.querySelector('#modalTitle').textContent;
                let option = 'A';
                if (titleText.includes('æ–¹æ¡ˆA')) option = 'A';
                else if (titleText.includes('æ–¹æ¡ˆB')) option = 'B';
                else if (titleText.includes('æ–¹æ¡ˆC')) option = 'C';
                else if (titleText.includes('æ–¹æ¡ˆD')) option = 'D';
                
                const container = document.getElementById('modalOutlineContent');
                generateEditableOutline(option, container);
                resetAdvancedSettings();
            });
        }

        // è·å–é«˜çº§è®¾ç½®æ•°æ®
        function getAdvancedSettings() {
            return {
                duration: document.getElementById('courseDuration')?.value || '2-4',
                difficulty: document.getElementById('courseDifficulty')?.value || 'beginner',
                teachingMethods: {
                    theory: document.getElementById('theory')?.checked || false,
                    practice: document.getElementById('practice')?.checked || false,
                    exercise: document.getElementById('exercise')?.checked || false,
                    case: document.getElementById('case')?.checked || false,
                    groupwork: document.getElementById('groupwork')?.checked || false
                },
                targetAudience: document.getElementById('targetAudience')?.value || '10-20',
                language: document.getElementById('courseLanguage')?.value || 'zh',
                assessment: {
                    quiz: document.getElementById('quiz')?.checked || false,
                    assignment: document.getElementById('assignment')?.checked || false,
                    project: document.getElementById('project')?.checked || false,
                    feedback: document.getElementById('feedback')?.checked || false
                },
                otherRequirements: document.getElementById('otherRequirements')?.value || ''
            };
        }

        // é‡ç½®é«˜çº§è®¾ç½®
        function resetAdvancedSettings() {
            document.getElementById('courseDuration').value = '2-4';
            document.getElementById('courseDifficulty').value = 'beginner';
            document.getElementById('theory').checked = true;
            document.getElementById('practice').checked = true;
            document.getElementById('exercise').checked = true;
            document.getElementById('case').checked = false;
            document.getElementById('groupwork').checked = false;
            document.getElementById('targetAudience').value = '10-20';
            document.getElementById('courseLanguage').value = 'zh';
            document.getElementById('quiz').checked = true;
            document.getElementById('assignment').checked = false;
            document.getElementById('project').checked = false;
            document.getElementById('feedback').checked = true;
            document.getElementById('otherRequirements').value = '';
        }

        // åº”ç”¨å¿«é€Ÿæ¨¡æ¿
        function applyTemplate(templateType) {
            switch(templateType) {
                case 'basic':
                    document.getElementById('courseDuration').value = '2-4';
                    document.getElementById('courseDifficulty').value = 'beginner';
                    document.getElementById('theory').checked = true;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = false;
                    document.getElementById('groupwork').checked = false;
                    document.getElementById('quiz').checked = true;
                    document.getElementById('assignment').checked = false;
                    document.getElementById('project').checked = false;
                    document.getElementById('feedback').checked = true;
                    break;
                case 'intensive':
                    document.getElementById('courseDuration').value = '1-day';
                    document.getElementById('courseDifficulty').value = 'intermediate';
                    document.getElementById('theory').checked = true;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = true;
                    document.getElementById('groupwork').checked = true;
                    document.getElementById('quiz').checked = true;
                    document.getElementById('assignment').checked = true;
                    document.getElementById('project').checked = true;
                    document.getElementById('feedback').checked = true;
                    break;
                case 'workshop':
                    document.getElementById('courseDuration').value = '4-8';
                    document.getElementById('courseDifficulty').value = 'intermediate';
                    document.getElementById('theory').checked = false;
                    document.getElementById('practice').checked = true;
                    document.getElementById('exercise').checked = true;
                    document.getElementById('case').checked = true;
                    document.getElementById('groupwork').checked = true;
                    document.getElementById('quiz').checked = false;
                    document.getElementById('assignment').checked = false;
                    document.getElementById('project').checked = true;
                    document.getElementById('feedback').checked = true;
                    break;
            }
        }

        // è·å–ç¼–è¾‘åçš„å¤§çº²æ•°æ®
        function getEditedOutlineData() {
            const container = document.getElementById('modalOutlineContent');
            const option = document.getElementById('modalTitle').textContent.includes('æ–¹æ¡ˆA') ? 'A' : 'B';
            const chapters = [];

            Array.from(container.children).forEach(chapterItem => {
                const chapterTitle = chapterItem.querySelector('.chapter-title').value;
                const chapterSubtitle = chapterItem.querySelector('.chapter-subtitle').value;
                const sections = [];

                chapterItem.querySelectorAll('.section-title').forEach(sectionInput => {
                    sections.push(sectionInput.value);
                });

                chapters.push({
                    title: chapterTitle,
                    subtitle: chapterSubtitle,
                    sections: sections
                });
            });

            return {
                option: option,
                chapters: chapters
            };
        }

        // æ˜¾ç¤ºä¿å­˜ç¡®è®¤æç¤º
        function showSaveConfirmation(editedOutline, advancedSettings) {
            // å…³é—­å½“å‰æ¨¡æ€çª—å£
            const modal = document.getElementById('outlineModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';

            // åˆ›å»ºä¿å­˜ç¡®è®¤æ¨¡æ€çª—å£
            const saveModal = document.createElement('div');
            saveModal.id = 'saveConfirmModal';
            saveModal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            saveModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                    <div class="p-6">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                                <i class="fas fa-save text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ä¿å­˜è¯¾ç¨‹è®¾ç½®</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">æ‚¨çš„è¯¾ç¨‹å¤§çº²å’Œè®¾ç½®å³å°†ä¿å­˜</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">è¯¾ç¨‹å¤§çº²ï¼š</span>
                                    <span class="font-medium text-gray-900 dark:text-white">æ–¹æ¡ˆ${editedOutline.option}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">ç« èŠ‚æ•°é‡ï¼š</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${editedOutline.chapters.length}ä¸ªç« èŠ‚</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">è¯¾ç¨‹æ—¶é•¿ï¼š</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${getDurationText(advancedSettings.duration)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">éš¾åº¦ç­‰çº§ï¼š</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${getDifficultyText(advancedSettings.difficulty)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center text-gray-600 dark:text-gray-400 text-sm mb-6">
                            <i class="fas fa-info-circle mr-1"></i>
                            ç‚¹å‡»ç¡®è®¤å°†ä¿å­˜è®¾ç½®å¹¶å¼€å§‹ç”Ÿæˆå®Œæ•´è¯¾ç¨‹å†…å®¹
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancelSave" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                            </button>
                            <button id="confirmSave" class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-rocket mr-2"></i>ç¡®è®¤å¹¶ç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(saveModal);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('cancelSave').addEventListener('click', () => {
                saveModal.remove();
                // é‡æ–°æ‰“å¼€å¤§çº²ç¼–è¾‘æ¨¡æ€çª—å£
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });
            
            document.getElementById('confirmSave').addEventListener('click', () => {
                // ä¿å­˜æ•°æ®åˆ°sessionStorage
                const courseData = {
                    title: AppState.courseTitle || 'æ–°è¯¾ç¨‹',
                    outline: editedOutline.option,
                    outlineData: editedOutline,
                    advancedSettings: advancedSettings,
                    createdAt: new Date().toISOString(),
                    uploadedFiles: AppState.uploadedFiles || []
                };
                
                sessionStorage.setItem('courseCreationData', JSON.stringify(courseData));
                
                // æ˜¾ç¤ºè·³è½¬æç¤º
                saveModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full animate-fade-in">
                        <div class="p-6 text-center">
                            <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-check text-green-500 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">ä¿å­˜æˆåŠŸï¼</h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">æ­£åœ¨è·³è½¬åˆ°è¯¾ç¨‹ç”Ÿæˆé¡µé¢...</p>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%" id="jumpProgress"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // è¿›åº¦æ¡åŠ¨ç”»
                const progressBar = document.getElementById('jumpProgress');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 20;
                    progressBar.style.width = progress + '%';
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                            saveModal.remove();
                            // è·³è½¬åˆ°course-creationé¡µé¢
                            window.location.href = 'course-creation.html';
                        }, 300);
                    }
                }, 200);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            saveModal.addEventListener('click', (e) => {
                if (e.target === saveModal) {
                    document.getElementById('cancelSave').click();
                }
            });
        }

        // è·å–æ—¶é•¿æ–‡æœ¬
        function getDurationText(duration) {
            const durationMap = {
                '1-2': '1-2å°æ—¶',
                '2-4': '2-4å°æ—¶',
                '4-8': '4-8å°æ—¶',
                '1-day': '1å¤©',
                '2-3-days': '2-3å¤©',
                'custom': 'è‡ªå®šä¹‰'
            };
            
            // å¤„ç†undefinedæˆ–ç©ºå€¼çš„æƒ…å†µ
            if (!duration) {
                return '2-4å°æ—¶'; // é»˜è®¤å€¼
            }
            
            return durationMap[duration] || duration;
        }

        // è·å–éš¾åº¦æ–‡æœ¬
        function getDifficultyText(difficulty) {
            const difficultyMap = {
                'beginner': 'åˆçº§',
                'intermediate': 'ä¸­çº§',
                'advanced': 'é«˜çº§',
                'expert': 'ä¸“å®¶çº§'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        // åˆå§‹åŒ–éœ€æ±‚è¾“å…¥æ¡†
        function initRequirementInput() {
            if (!elements.courseRequirementInput || !elements.submitRequirement || !elements.charCount) return;
            
            // å­—ç¬¦è®¡æ•°åŠŸèƒ½
            elements.courseRequirementInput.addEventListener('input', function() {
                const text = this.value;
                const charCount = text.length;
                elements.charCount.textContent = `${charCount}/1000`;
                
                // æ ¹æ®å­—ç¬¦æ•°æ”¹å˜é¢œè‰²
                if (charCount > 1000) {
                    elements.charCount.classList.add('text-red-500');
                    elements.charCount.classList.remove('text-gray-400');
                } else if (charCount > 800) {
                    elements.charCount.classList.add('text-yellow-500');
                    elements.charCount.classList.remove('text-gray-400', 'text-red-500');
                } else {
                    elements.charCount.classList.add('text-gray-400');
                    elements.charCount.classList.remove('text-red-500', 'text-yellow-500');
                }
                
                // å¯ç”¨/ç¦ç”¨æäº¤æŒ‰é’®
                elements.submitRequirement.disabled = charCount === 0 || charCount > 1000;
            });

            // è‡ªé€‚åº”é«˜åº¦
            elements.courseRequirementInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            elements.submitRequirement.addEventListener('click', () => {
                handleRequirementSubmit();
            });

            // å›è½¦æäº¤ï¼ˆCtrl+Enterï¼‰
            elements.courseRequirementInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    handleRequirementSubmit();
                }
            });

            // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            elements.submitRequirement.disabled = true;
        }

        // å¤„ç†éœ€æ±‚æäº¤
        function handleRequirementSubmit() {
            const requirement = elements.courseRequirementInput.value.trim();
            if (!requirement || requirement.length > 1000) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(requirement, true);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            elements.courseRequirementInput.value = '';
            elements.charCount.textContent = '0/1000';
            elements.submitRequirement.disabled = true;
            
            // éšè—éœ€æ±‚è¾“å…¥åŒºåŸŸå’Œä¸»é¢˜å»ºè®®
            hideRequirementInputArea();
            
            // å¤„ç†AIå›å¤
            setTimeout(() => {
                handleDetailedRequirement(requirement);
            }, 500);
        }

        // éšè—éœ€æ±‚è¾“å…¥åŒºåŸŸ
        function hideRequirementInputArea() {
            const requirementCard = document.querySelector('.chat-bubble:nth-child(2)'); // éœ€æ±‚è¾“å…¥å¡ç‰‡
            const topicCard = document.querySelector('.chat-bubble:nth-child(3)'); // ä¸»é¢˜å»ºè®®å¡ç‰‡
            
            if (requirementCard) {
                requirementCard.style.opacity = '0.5';
                requirementCard.style.pointerEvents = 'none';
            }
            if (topicCard) {
                topicCard.style.opacity = '0.5';
                topicCard.style.pointerEvents = 'none';
            }
        }

        // å¤„ç†è¯¦ç»†éœ€æ±‚
        function handleDetailedRequirement(requirement) {
            AppState.courseTitle = extractCourseTitle(requirement);
            
            // åˆå§‹åŒ–é€æ­¥æ”¶é›†çš„çŠ¶æ€
            AppState.detailedRequirements = {
                duration: '',
                chapterCount: '',
                difficulty: '',
                teachingMethods: {},
                assessment: {},
                audience: {},
                deliveryFormat: '',
                specialRequirements: ''
            };
            AppState.currentQuestionStep = 1;
            
            // AIåˆ†æå›å¤
            addMessage(`å¤ªæ£’äº†ï¼æˆ‘å·²ç»ç†è§£äº†æ‚¨çš„éœ€æ±‚ã€‚æ‚¨æƒ³è¦åˆ›å»ºä¸€é—¨å…³äº"${AppState.courseTitle}"çš„è¯¾ç¨‹ã€‚`);
            
            setTimeout(() => {
                addMessage('è®©æˆ‘æ¥åˆ†æä¸€ä¸‹æ‚¨çš„å…·ä½“è¦æ±‚ï¼š<br/><br/>' + 
                    'ğŸ“š <strong>è¯¾ç¨‹ä¸»é¢˜ï¼š</strong>' + AppState.courseTitle + '<br/>' +
                    'ğŸ¯ <strong>ç›®æ ‡å—ä¼—ï¼š</strong>' + extractTargetAudience(requirement) + '<br/>' +
                    'â±ï¸ <strong>é¢„æœŸæ—¶é•¿ï¼š</strong>' + extractDuration(requirement) + '<br/>' +
                    'ğŸ“ <strong>æ•™å­¦æ–¹å¼ï¼š</strong>' + extractTeachingMethod(requirement), false, true);
                
                setTimeout(() => {
                    addMessage('ä¸ºäº†ä¸ºæ‚¨é‡èº«å®šåˆ¶æœ€åˆé€‚çš„è¯¾ç¨‹ï¼Œæˆ‘éœ€è¦å†äº†è§£å‡ ä¸ªå…³é”®ä¿¡æ¯ã€‚è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼š');
                    
                    setTimeout(() => {
                        startStepByStepRequirements();
                    }, 800);
                }, 1000);
            }, 1000);
        }

        // æå–è¯¾ç¨‹æ ‡é¢˜
        function extractCourseTitle(requirement) {
            // ç®€å•çš„å…³é”®è¯æå–é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¼˜åŒ–
            const keywords = ['CRM', 'é”€å”®', 'åŸ¹è®­', 'ç®¡ç†', 'ç³»ç»Ÿ', 'å…¥é—¨', 'é«˜çº§', 'å®æˆ˜'];
            let title = '';
            
            // å¯»æ‰¾"åˆ›å»º"ã€"å»ºç«‹"ç­‰è¯åé¢çš„å†…å®¹
            const patterns = [
                /(?:åˆ›å»º|å»ºç«‹|è®¾è®¡|åˆ¶ä½œ).*?([^ï¼Œã€‚ï¼ï¼Ÿ\n]+?)(?:è¯¾ç¨‹|åŸ¹è®­|æ•™ç¨‹)/,
                /([^ï¼Œã€‚ï¼ï¼Ÿ\n]*?)(?:è¯¾ç¨‹|åŸ¹è®­|æ•™ç¨‹)/,
                /å…³äº([^ï¼Œã€‚ï¼ï¼Ÿ\n]+?)çš„/
            ];
            
            for (let pattern of patterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    title = match[1].trim();
                    break;
                }
            }
            
            return title || 'æ–°è¯¾ç¨‹åŸ¹è®­';
        }

        // æå–ç›®æ ‡å—ä¼—
        function extractTargetAudience(requirement) {
            const audiencePatterns = [
                /(?:ä¸º|ç»™|é’ˆå¯¹)([^ï¼Œã€‚ï¼ï¼Ÿ\n]*?)(?:åˆ›å»º|è®¾è®¡|åˆ¶ä½œ)/,
                /(æ–°å‘˜å·¥|è€å‘˜å·¥|é”€å”®|ç®¡ç†|æŠ€æœ¯|å®¢æœ|è´¢åŠ¡|HR).*?äººå‘˜/,
                /(å…¥èŒ|æ–°æ‰‹|åˆçº§|ä¸­çº§|é«˜çº§|èµ„æ·±).*?äººå‘˜/
            ];
            
            for (let pattern of audiencePatterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            
            return 'å›¢é˜Ÿæˆå‘˜';
        }

        // æå–æ—¶é•¿
        function extractDuration(requirement) {
            const durationPatterns = [
                /(?:æ—¶é•¿|æŒç»­|éœ€è¦).*?(\d+[-~åˆ°]\d+)\s*(?:å°æ—¶|hour)/,
                /(\d+)\s*(?:å°æ—¶|hour)/,
                /(\d+)\s*(?:å¤©|day)/
            ];
            
            for (let pattern of durationPatterns) {
                const match = requirement.match(pattern);
                if (match && match[1]) {
                    return match[1] + (requirement.includes('å¤©') ? 'å¤©' : 'å°æ—¶');
                }
            }
            
            return '2-3å°æ—¶';
        }

        // æå–æ•™å­¦æ–¹å¼
        function extractTeachingMethod(requirement) {
            const methods = [];
            if (requirement.includes('å®æ“') || requirement.includes('å®è·µ') || requirement.includes('æ“ä½œ')) {
                methods.push('å®æ“æ¼”ç¤º');
            }
            if (requirement.includes('ç†è®º') || requirement.includes('æ¦‚å¿µ') || requirement.includes('çŸ¥è¯†')) {
                methods.push('ç†è®ºè®²è§£');
            }
            if (requirement.includes('ç»ƒä¹ ') || requirement.includes('ä½œä¸š') || requirement.includes('æµ‹è¯•')) {
                methods.push('éšå ‚ç»ƒä¹ ');
            }
            if (requirement.includes('æ¡ˆä¾‹') || requirement.includes('ä¾‹å­')) {
                methods.push('æ¡ˆä¾‹åˆ†æ');
            }
            
            return methods.length > 0 ? methods.join('ã€') : 'ç†è®ºè®²è§£ã€å®æ“æ¼”ç¤º';
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initTheme();
            initMessageInput();
            initRequirementInput();
            initTopicSuggestions();
            initPreviewButtons();
            initModalEvents();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            elements.sendButton.addEventListener('click', handleUserInput);
            elements.confirmOutline.addEventListener('click', confirmOutline);
            
            // AIåŠ©æ‰‹æ‚¬æµ®çƒç‚¹å‡»äº‹ä»¶
            elements.aiAssistant.addEventListener('click', () => {
                alert('AIåŠ©æ‰‹åŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†ä¸ºæ‚¨æä¾›æ™ºèƒ½å»ºè®®å’Œå¸®åŠ©ï¼');
            });
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html> 